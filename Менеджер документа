#Область ЛогикаДанных

// ====== СЕКЦИЯ 1: ЛОГИКА ДАННЫХ (работа с объектом) ======

Функция СоздатьДокументПланированияИзГрафикаПоступлений(Документ, УИДСтрокиГрафика) Экспорт     
	
	СтруктураРезультат 	= Новый Структура; 
	СписокСообщений 	= Новый СписокЗначений;
	Результат 			= Неопределено;

	ВсеХорошо = Истина;
	
    // 1. Находим строку графика
    Отбор 			= Новый Структура("УИДСтроки", УИДСтрокиГрафика);
    СтрокиГрафика 	= Документ.ГрафикПоступлений.НайтиСтроки(Отбор);
	
	Если СтрокиГрафика.Количество() = 0 Тогда 
		Возврат Неопределено; 
	КонецЕсли;
    
    СтрокаГрафика = СтрокиГрафика[0];
    
    // 2. Создаем документ
    НовыйДокумент = Документы.бит_ПланируемоеПоступлениеДенежныхСредств.СоздатьДокумент(); 
	
	ДанныеЗаполнения = новый Структура;
	ДанныеЗаполнения.Вставить("ЭтоПланИсполненияДоговора", 	Истина);
	ДанныеЗаполнения.Вставить("ДокументОснование", 			Документ);
	ДанныеЗаполнения.Вставить("УИДСтрокиГрафика", 			СтрокаГрафика.УИДСтроки);
	
	НовыйДокумент.Заполнить(ДанныеЗаполнения);

	НовыйДокумент.Записать(); 
	
	Если ЗначениеЗаполнено(НовыйДокумент.Ссылка) Тогда
		Результат = НовыйДокумент.Ссылка;
		СписокСообщений.Добавить("Планируемое поступление создано");
	Иначе
		ВсеХорошо = Ложь;
		СписокСообщений.Добавить("Не удалось создать Планируемое поступление" + ОписаниеОшибки());
	КонецЕсли;
	
	СтруктураРезультат.Вставить("ВсеХорошо", 		ВсеХорошо);
	СтруктураРезультат.Вставить("Результат", 		Результат);
	СтруктураРезультат.Вставить("СписокСообщений", 	СписокСообщений);
	
	Возврат СтруктураРезультат;
	
КонецФункции  

Функция СоздатьДокументПланированияИзГрафикаПлатежей(Документ, УИДСтрокиГрафика) Экспорт     
	
	СтруктураРезультат 	= Новый Структура; 
	СписокСообщений 	= Новый СписокЗначений;
	Результат 			= Неопределено;

	ВсеХорошо = Истина;
	
    // 1. Находим строку графика
    Отбор 			= Новый Структура("УИДСтроки", УИДСтрокиГрафика);
    СтрокиГрафика 	= Документ.ГрафикПлатежей.НайтиСтроки(Отбор);
	
	Если СтрокиГрафика.Количество() = 0 Тогда 
		Возврат Неопределено; 
	КонецЕсли;
    
    СтрокаГрафика = СтрокиГрафика[0];
    
    // 2. Создаем документ
    НовыйДокумент = Документы.бит_ЗаявкаНаРасходованиеСредствОбщая.СоздатьДокумент(); 
	
	ДанныеЗаполнения = новый Структура;
	ДанныеЗаполнения.Вставить("ЭтоПланИсполненияДоговора", 	Истина);
	ДанныеЗаполнения.Вставить("Основание", 			Документ);
	ДанныеЗаполнения.Вставить("УИДСтроки", 			СтрокаГрафика.УИДСтроки);
	
	НовыйДокумент.Заполнить(ДанныеЗаполнения);

	НовыйДокумент.Записать(); 
	
	Если ЗначениеЗаполнено(НовыйДокумент.Ссылка) Тогда
		Результат = НовыйДокумент.Ссылка;
		СписокСообщений.Добавить("Прогноз платежа создан: " + Результат);
	Иначе
		ВсеХорошо = Ложь;
		СписокСообщений.Добавить("Не удалось создать Прогноз платежа " + ОписаниеОшибки());
	КонецЕсли;
	
	СтруктураРезультат.Вставить("ВсеХорошо", 		ВсеХорошо);
	СтруктураРезультат.Вставить("Результат", 		Результат);
	СтруктураРезультат.Вставить("СписокСообщений", 	СписокСообщений);
	
	Возврат СтруктураРезультат;
	
КонецФункции

Функция СоздатьЗНРДСИзГрафикаПлатежей(Документ, УИДСтрокиГрафика) Экспорт     
	
	СтруктураРезультат 	= Новый Структура; 
	СписокСообщений 	= Новый СписокЗначений;
	Результат 			= Неопределено;

	ВсеХорошо = Истина;
	
    // 1. Находим строку графика
    Отбор 			= Новый Структура("УИДСтроки", УИДСтрокиГрафика);
    СтрокиГрафика 	= Документ.ГрафикПлатежей.НайтиСтроки(Отбор);
	
	Если СтрокиГрафика.Количество() = 0 Тогда 
		Возврат Неопределено; 
	КонецЕсли;
    
    СтрокаГрафика = СтрокиГрафика[0]; 
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	бит_ЗаявкаНаРасходованиеСредствОбщая.Ссылка как ДокументПланирования,
	|	бит_ЗаявкаНаРасходованиеСредствОбщая.Сумма как ДокументПланированияСумма,
	|	бит_ЗаявкаНаРасходованиеСредствОбщая._УИДСтрокиДокументаОснования как УИДСтроки
	|ИЗ
	|	Документ.бит_ЗаявкаНаРасходованиеСредствОбщая КАК бит_ЗаявкаНаРасходованиеСредствОбщая
	|ГДЕ
	|	бит_ЗаявкаНаРасходованиеСредствОбщая.ПометкаУдаления = ЛОЖЬ
	|	И бит_ЗаявкаНаРасходованиеСредствОбщая._ДокументОснование = &_ДокументОснование
	|	И бит_ЗаявкаНаРасходованиеСредствОбщая._УИДСтрокиДокументаОснования В(&МассивУИДов)
	|	И НЕ бит_ЗаявкаНаРасходованиеСредствОбщая._УИДСтрокиДокументаОснования = &ПустойУИД";
	
	Запрос.УстановитьПараметр("_ДокументОснование", 	Документ.Ссылка);
	Запрос.УстановитьПараметр("МассивУИДов", 			УИДСтрокиГрафика);
	ПустойУИД = Новый УникальныйИдентификатор("00000000-0000-0000-0000-000000000000");
	Запрос.УстановитьПараметр("ПустойУИД", 				ПустойУИД);
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		Основание = Выборка.ДокументПланирования;
	КонецЦикла;
	
	НовыйДокумент = Документы.бит_ЗаявкаНаРасходованиеСредств.СоздатьДокумент();
	НовыйДокумент.Заполнить(Основание); 	
	НовыйДокумент.Записать();
	
	Если ЗначениеЗаполнено(НовыйДокумент.Ссылка) Тогда
		Результат = НовыйДокумент.Ссылка;
		СписокСообщений.Добавить("Заявка на расходование ДС создана: " + Результат);
	Иначе
		ВсеХорошо = Ложь;
		СписокСообщений.Добавить("Не удалось создать Заявку на расходование ДС " + ОписаниеОшибки());
	КонецЕсли;
	
	СтруктураРезультат.Вставить("ВсеХорошо", 		ВсеХорошо);
	СтруктураРезультат.Вставить("Результат", 		Результат);
	СтруктураРезультат.Вставить("СписокСообщений", 	СписокСообщений);
	
	Возврат СтруктураРезультат;
	
КонецФункции

Функция ПодготовитьВТДетализации(Документ) Экспорт
	
	Возврат Документ.ДетализацияГрафикаПоступлений.Выгрузить();
	
КонецФункции

Функция РассчитатьФактПоГрафику(Документ, УИДСтрокиГрафика) Экспорт
    
    // 1. Находим строку графика
    ОтборГрафика 	= Новый Структура("УИДСтроки", УИДСтрокиГрафика);
    СтрокиГрафика 	= Документ.ГрафикПоступлений.НайтиСтроки(ОтборГрафика);
    
    Если СтрокиГрафика.Количество() = 0 Тогда
        Возврат 0;
    КонецЕсли;
    
    СтрокаГрафика = СтрокиГрафика[0];
    
    // 2. Считаем сумму по детализации для этого графика
    ОтборДетализации 	= Новый Структура("УИДСтрокиГрафикаПоступлений", УИДСтрокиГрафика);
    СтрокиДетализации 	= Документ.ДетализацияГрафикаПоступлений.НайтиСтроки(ОтборДетализации);
    
    СуммаФакт = 0;
    Для Каждого СтрокаДетализации Из СтрокиДетализации Цикл
        СуммаФакт = СуммаФакт + СтрокаДетализации.СуммаПогашено;
    КонецЦикла;
    
    // 3. Обновляем факт в строке графика
    Возврат СуммаФакт;
    
КонецФункции

Функция ПолучитьВсеПлатежныеПорученияПоДоговору(
												Документ, 
												ДатаС = Неопределено, 
												ДатаПо = Неопределено) Экспорт  
	
	
	ДоговорКонтрагента = Справочники.ДоговорыКонтрагентов.ПустаяСсылка();
	
	Если ЗначениеЗаполнено(Документ.ДопУсловияПоДоговору) и ЗначениеЗаполнено(Документ.ДопУсловияПоДоговору.ДоговорКонтрагента) Тогда
		ДоговорКонтрагента = Документ.ДопУсловияПоДоговору.ДоговорКонтрагента;	
	КонецЕсли;
	
    Запрос = Новый Запрос;
    Запрос.Текст = 
	"ВЫБРАТЬ
	|	ПлатежноеПоручениеВходящее.Ссылка КАК ПлатежноеПоручениеВходящее,
	|	ПлатежноеПоручениеВходящее.Дата,
	|	ПлатежноеПоручениеВходящее.СуммаДокумента
	|ИЗ
	|	Документ.ПлатежноеПоручениеВходящее КАК ПлатежноеПоручениеВходящее
	|ГДЕ
	|	ПлатежноеПоручениеВходящее.Проведен = ИСТИНА
	|	И ПлатежноеПоручениеВходящее.ДоговорКонтрагента = &ДоговорКонтрагента
	|	И НЕ ПлатежноеПоручениеВходящее.ДоговорКонтрагента = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|	И ПлатежноеПоручениеВходящее.Дата >= ДАТАВРЕМЯ(2019, 1, 1)";
	
	
    // Фильтр по дате если заданы
    Если ЗначениеЗаполнено(ДатаС) Тогда
        Запрос.Текст = Запрос.Текст + 
				        "    И ПлатежноеПоручениеВходящее.Дата >= &ДатаС";
        Запрос.Параметры.Вставить("ДатаС", ДатаС);
    КонецЕсли;
    
    Если ЗначениеЗаполнено(ДатаПо) Тогда
        Запрос.Текст = Запрос.Текст + 
				        "    И ПлатежноеПоручениеВходящее.Дата <= &ДатаПо";
        Запрос.Параметры.Вставить("ДатаПо", КонецДня(ДатаПо));
    КонецЕсли;	
	
	
	Запрос.Параметры.Вставить("ДоговорКонтрагента", ДоговорКонтрагента);
	
    Результат = Запрос.Выполнить();
    Возврат Результат.Выгрузить();
    
КонецФункции  

Функция ПолучитьСвободныеПлатежки(
									ТЗВсеПлатежки, 
									ВТ_ДетализацияГрафика) Экспорт  
	
	
	ДоговорКонтрагента = Справочники.ДоговорыКонтрагентов.ПустаяСсылка();
	
    Запрос = Новый Запрос;
    Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТЗВсеПлатежки.ПлатежноеПоручениеВходящее,
	|   ТЗВсеПлатежки.Дата,
	|	ТЗВсеПлатежки.СуммаДокумента
	|ПОМЕСТИТЬ ВТ_ПлатежныеПоручения
	|ИЗ
	|	&ТЗВсеПлатежки КАК ТЗВсеПлатежки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_ДетализацияГрафика.ПлатежноеПоручениеВходящее,
	|	ВТ_ДетализацияГрафика.СуммаПогашено
	|ПОМЕСТИТЬ ВТ_ДетализацияГрафикаДанные
	|ИЗ
	|	&ВТ_ДетализацияГрафика КАК ВТ_ДетализацияГрафика
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_ДетализацияГрафикаДанные.ПлатежноеПоручениеВходящее,
	|	СУММА(ВТ_ДетализацияГрафикаДанные.СуммаПогашено) КАК СуммаПогашения
	|ПОМЕСТИТЬ ВТ_ДетализацияГрафика
	|ИЗ
	|	ВТ_ДетализацияГрафикаДанные КАК ВТ_ДетализацияГрафикаДанные
	|
	|СГРУППИРОВАТЬ ПО
	|	ВТ_ДетализацияГрафикаДанные.ПлатежноеПоручениеВходящее
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_ПлатежныеПоручения.ПлатежноеПоручениеВходящее,
	|	ВТ_ПлатежныеПоручения.Дата,
	|	ВТ_ПлатежныеПоручения.СуммаДокумента,
	|	ЕСТЬNULL(ВТ_ДетализацияГрафика.СуммаПогашения, 0) КАК СуммаПогашения
	|ПОМЕСТИТЬ ВТ_Данные
	|ИЗ
	|	ВТ_ПлатежныеПоручения КАК ВТ_ПлатежныеПоручения
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ДетализацияГрафика КАК ВТ_ДетализацияГрафика
	|		ПО (ВТ_ДетализацияГрафика.ПлатежноеПоручениеВходящее = ВТ_ПлатежныеПоручения.ПлатежноеПоручениеВходящее)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Данные.ПлатежноеПоручениеВходящее,
	|	ВТ_Данные.Дата,
	|	ВТ_Данные.СуммаДокумента,
	|	ВТ_Данные.СуммаПогашения,
	|	ВТ_Данные.СуммаДокумента - ВТ_Данные.СуммаПогашения КАК СвободныйОстаток
	|ИЗ
	|	ВТ_Данные КАК ВТ_Данные
	|ГДЕ
	|	ВТ_Данные.СуммаДокумента - ВТ_Данные.СуммаПогашения <> 0";
	Запрос.Параметры.Вставить("ТЗВсеПлатежки", 			ТЗВсеПлатежки);
	Запрос.Параметры.Вставить("ВТ_ДетализацияГрафика", 	ВТ_ДетализацияГрафика); 
	
    Результат = Запрос.Выполнить();
    Возврат Результат.Выгрузить();
    
КонецФункции  

Функция РассчитатьОстатокПоПлану(
									Документ, 
									УИДСтрокиГрафика, 
									ТЗмГрафикПоступлений) Экспорт

    Показатели = РассчитатьПоказателиСтрокиГрафика(
										            Документ,
										            УИДСтрокиГрафика,
										            ТЗмГрафикПоступлений
											        );
    Возврат Показатели.ОстатокПлана;
	
КонецФункции

Функция РассчитатьСвободныйОстатокПлатежа(
										    Документ, 
										    ПлатежноеПоручениеВходящее) Экспорт
    
    // Сумма документа из БД
    Запрос = Новый Запрос;
    Запрос.Текст = "
    |ВЫБРАТЬ
    |    ППВ.СуммаДокумента
    |ИЗ Документ.ПлатежноеПоручениеВходящее КАК ППВ
    |ГДЕ ППВ.Ссылка = &Ссылка";
    
    Запрос.Параметры.Вставить("Ссылка", ПлатежноеПоручениеВходящее);
    Результат = Запрос.Выполнить();
    
    Если Результат.Пустой() Тогда
        Возврат 0;
    КонецЕсли;
    
    Выборка = Результат.Выбрать();
    Если Выборка.Следующий() Тогда
        СуммаДокумента = Выборка.СуммаДокумента;
    КонецЕсли;
    
    // Уже привязано в этом документе
    СуммаУжеПривязано = 0;
    Для Каждого СтрокаДетализации Из Документ.ДетализацияГрафикаПоступлений Цикл
        Если СтрокаДетализации.ПлатежноеПоручениеВходящее = ПлатежноеПоручениеВходящее Тогда
            СуммаУжеПривязано = СуммаУжеПривязано + СтрокаДетализации.СуммаПогашено;
        КонецЕсли;
    КонецЦикла;
    
    Возврат СуммаДокумента - СуммаУжеПривязано;
    
КонецФункции

Функция РассчитатьПрогнозДляСтрокиГрафика(
											Документ, 
											УИДСтрокиГрафика, 
											СоответствиеУИД_ДокументПланирования) Экспорт
    
    // 1. Находим строку графика
    Отбор 			= Новый Структура("УИДСтроки", УИДСтрокиГрафика);
    СтрокиГрафика 	= Документ.ГрафикПоступлений.НайтиСтроки(Отбор);
    
    Если СтрокиГрафика.Количество() = 0 Тогда
        Возврат 0;
    КонецЕсли;
    
    СтрокаГрафика 	= СтрокиГрафика[0];
    
    // 2. Ищем документ планирования в переданном соответствии
    СсылкаНаДокументПланирования = Неопределено;
    
    Если СоответствиеУИД_ДокументПланирования <> Неопределено Тогда
        СсылкаНаДокументПланирования = СоответствиеУИД_ДокументПланирования[УИДСтрокиГрафика];
    КонецЕсли;

	БазоваяСумма = 0;
	
	Если ЗначениеЗаполнено(СсылкаНаДокументПланирования) Тогда
		
		// Сумма из документа планирования
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ ПП.СуммаДокумента
			|ИЗ Документ.бит_ПланируемоеПоступлениеДенежныхСредств КАК ПП
			|ГДЕ ПП.Ссылка = &Ссылка";
		
		Запрос.Параметры.Вставить("Ссылка", СсылкаНаДокументПланирования);
		Результат = Запрос.Выполнить();
		
		Если НЕ Результат.Пустой() Тогда
			Выборка = Результат.Выбрать();
			Если Выборка.Следующий() Тогда
				БазоваяСумма = Выборка.СуммаДокумента;
			КонецЕсли;
		КонецЕсли;
	Иначе
		// Сумма строки графика
		БазоваяСумма = СтрокаГрафика.Сумма;
	КонецЕсли;
	
	// 3. Вычитаем уже привязанное (Факт)
	Факт 		= РассчитатьФактПоГрафику(Документ, УИДСтрокиГрафика);
	Прогноз 	= БазоваяСумма - Факт;
	
	Возврат Прогноз;
    
КонецФункции

Процедура ПривязатьПлатежКПлану(
							    Документ, 
							    УИДСтрокиГрафика, 
							    ПлатежноеПоручениеВходящее,
							    СуммаПривязки) Экспорт
    
    // 1. Создаём строку в детализации      
	
    НоваяСтрока = Документ.ДетализацияГрафикаПоступлений.Добавить(); 
	
    НоваяСтрока.УИДСтроки 					= Новый УникальныйИдентификатор();
    НоваяСтрока.УИДСтрокиГрафикаПоступлений = УИДСтрокиГрафика;
    НоваяСтрока.ПлатежноеПоручениеВходящее 	= ПлатежноеПоручениеВходящее;
    НоваяСтрока.СуммаПогашено 				= СуммаПривязки;
    
КонецПроцедуры

Функция РассчитатьСуммуПривязки(
								Документ, 
								УИДСтрокиГрафика, 
								ПлатежноеПоручениеВходящее, 
								ТЗмГрафикПоступлений) Экспорт
    
  // 1. Получаем показатели
    Показатели = РассчитатьПоказателиСтрокиГрафика(
											        Документ,
											        УИДСтрокиГрафика,
											        ТЗмГрафикПоступлений
												    );
    
    ОстатокПлана = Показатели.ДоступныйОстаток;
    
    // 2. Свободный остаток платежа
    ОстатокПлатежки = РассчитатьСвободныйОстатокПлатежа(
												        Документ,
												        ПлатежноеПоручениеВходящее
														);
    
    // 3. Минимум
    Возврат Мин(ОстатокПлана, ОстатокПлатежки);
	
КонецФункции

Функция РассчитатьПоказателиСтрокиГрафика(
										    Документ,
										    УИДСтрокиГрафика,
										    ТЗмГрафикПоступлений) Экспорт
    
    СтруктураРезультат = Новый Структура;
    
    // 1. Находим строку в ТЗ
    Отбор = Новый Структура("УИДСтроки", УИДСтрокиГрафика);
    НайденныеВТЗ = ТЗмГрафикПоступлений.НайтиСтроки(Отбор);
    
    Если НайденныеВТЗ.Количество() = 0 Тогда
        СтруктураРезультат.Вставить("БазоваяСумма", 	0);
        СтруктураРезультат.Вставить("Факт", 			0);
        СтруктураРезультат.Вставить("ОстатокПлана", 	0);
        СтруктураРезультат.Вставить("Прогноз", 			0);
        Возврат СтруктураРезультат;
    КонецЕсли;
    
    СтрокаГрафика = НайденныеВТЗ[0];
    
    // 2. Базовая сумма
    БазоваяСумма = 0;
    Если СтрокаГрафика.ДокументПланированияСумма > 0 Тогда
        БазоваяСумма = СтрокаГрафика.ДокументПланированияСумма;
    Иначе
        БазоваяСумма = СтрокаГрафика.Сумма;
    КонецЕсли;
    
    // 3. Факт
    Факт = РассчитатьФактПоГрафику(Документ, УИДСтрокиГрафика);
    
    // 4. Остаток плана
    ОстатокПлана = БазоваяСумма - Факт;

	//Если ОстатокПлана < 0 Тогда
	//    ОстатокПлана = 0;
	//КонецЕсли;
    
	// 5. Прогноз (может быть отрицательным)
    Прогноз = БазоваяСумма - Факт;
    
    // 6. Доступный остаток (для привязки, не может быть отрицательным)
    ДоступныйОстаток = Макс(ОстатокПлана, 0);
    
    СтруктураРезультат.Вставить("БазоваяСумма", 	БазоваяСумма);
    СтруктураРезультат.Вставить("Факт",				Факт);
    СтруктураРезультат.Вставить("ОстатокПлана", 	ОстатокПлана);       	// Реальный (может быть <0)
    СтруктураРезультат.Вставить("ДоступныйОстаток", ДоступныйОстаток); 		// Для привязки (>=0)
    СтруктураРезультат.Вставить("Прогноз", 			Прогноз);
    
    Возврат СтруктураРезультат;
    
КонецФункции

Процедура РассчитатьСуммовыеПоказателиСтрокГрафикаПлатежей(Документ, ТЗ) Экспорт

	Для каждого Строка Из ТЗ Цикл
		
		Если ЗначениеЗаполнено(Строка.ПлатежноеПоручениеИсходящее) Тогда
			Строка.СуммаОсвоения = Строка.ПлатежноеПоручениеИсходящееСумма;
		ИначеЕсли ЗначениеЗаполнено(Строка.ЗаявкаНаРасходованиеДС) Тогда
			Строка.СуммаОсвоения = Строка.ЗаявкаНаРасходованиеДССумма;
		ИначеЕсли ЗначениеЗаполнено(Строка.ДокументПланирования) Тогда
			Строка.СуммаОсвоения = Строка.ДокументПланированияСумма;
		Иначе
			Строка.СуммаОсвоения = Строка.Сумма;
		КонецЕсли;
		
		Если Строка.Статус = Перечисления._СтатусыПрогнозированияБДДС.Оплачен Тогда
			Строка.Факт = Строка.СуммаОсвоения;
			Строка.Прогноз = 0;
		Иначе
			Строка.Факт = 0;
			Строка.Прогноз = Строка.СуммаОсвоения;
		КонецЕсли; 
		
	КонецЦикла;

КонецПроцедуры  

Функция РассчитатьИтогиПоГрафикуПлатежей(Документ, ТЗ) Экспорт
	
	СтруктураИтоги = Новый Структура;
	СтруктураИтоги.Вставить("КоличествоСтрок", 						0);
	СтруктураИтоги.Вставить("Сумма", 								0);
	СтруктураИтоги.Вставить("СуммаОсвоения", 						0);
	СтруктураИтоги.Вставить("Прогноз", 								0);
	СтруктураИтоги.Вставить("Факт", 								0);
	СтруктураИтоги.Вставить("ПредельнаяСуммаПоДоговоруПоКарточке", 	0);
	СтруктураИтоги.Вставить("ИтогПоСтарымЗаявкам", 					0);
	СтруктураИтоги.Вставить("КоличествоСтарыхЗаявок", 				0);
	
	СтруктураИтоги.КоличествоСтрок = ТЗ.Количество();
	
	Тз.Свернуть(, "Сумма, СуммаОсвоения, Прогноз, Факт");
	
	Если Тз.Количество() <> 0 Тогда
		ЗаполнитьЗначенияСвойств(СтруктураИтоги, ТЗ[0], "Сумма, СуммаОсвоения, Прогноз, Факт");
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Документ.ДопУсловияПоДоговору.ДоговорКонтрагента) и ЗначениеЗаполнено(Документ.ДопУсловияПоДоговору.ДоговорКонтрагента._КарточкаДоговора) Тогда
		КарточкаДоговора = Документ.ДопУсловияПоДоговору.ДоговорКонтрагента._КарточкаДоговора;
		СтруктураИтоги.ПредельнаяСуммаПоДоговоруПоКарточке = КарточкаДоговора.Сумма;
	КонецЕсли;	
	
	ДанныеСтарыхЗаявок = РассчитатьИтогПоСтарымОплаченнымЗаявкам(Документ);
	
	СтруктураИтоги.ИтогПоСтарымЗаявкам 		= ДанныеСтарыхЗаявок.ИтогПоСтарымЗаявкам;
	СтруктураИтоги.КоличествоСтарыхЗаявок 	= ДанныеСтарыхЗаявок.КоличествоСтарыхЗаявок;
	
	Возврат СтруктураИтоги;
	
КонецФункции  

Функция РассчитатьИтогПоСтарымОплаченнымЗаявкам(Документ)
	
	СтруктураРезультат = Новый Структура;
	СтруктураРезультат.Вставить("ИтогПоСтарымЗаявкам", 		0);
	СтруктураРезультат.Вставить("КоличествоСтарыхЗаявок", 	0);
	
	Если Не ЗначениеЗаполнено(Документ.ДопУсловияПоДоговору.ДоговорКонтрагента) Тогда
		Возврат СтруктураРезультат;
	Иначе 
		ДоговорКонтрагента = Документ.ДопУсловияПоДоговору.ДоговорКонтрагента;	
	КонецЕсли;
	
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ЕстьNULL(СУММА(Документбит_ЗаявкаНаРасходованиеСредств.Сумма), 0) КАК Итог,
	|	Количество(Документбит_ЗаявкаНаРасходованиеСредств.Ссылка) КАК Количество
	|ИЗ
	|	Документ.бит_ЗаявкаНаРасходованиеСредств КАК Документбит_ЗаявкаНаРасходованиеСредств
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.бит_СтатусыОбъектов КАК СтатусыОбъектов_Статус
	|		ПО Документбит_ЗаявкаНаРасходованиеСредств.Ссылка = СтатусыОбъектов_Статус.Объект
	|			И (СтатусыОбъектов_Статус.ВидСтатуса = ЗНАЧЕНИЕ(Перечисление.бит_ВидыСтатусовОбъектов.Статус))
	|ГДЕ
	|	ИСТИНА
	|	И Документбит_ЗаявкаНаРасходованиеСредств.ДатаРасхода >= ДАТАВРЕМЯ(2019, 1, 1)
	|	И Документбит_ЗаявкаНаРасходованиеСредств.ДоговорКонтрагента = &ДоговорКонтрагента
	|	И НЕ Документбит_ЗаявкаНаРасходованиеСредств.ДоговорКонтрагента = НЕОПРЕДЕЛЕНО
	|	И НЕ Документбит_ЗаявкаНаРасходованиеСредств.ДоговорКонтрагента = ЗНАЧЕНИЕ(справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|	И Документбит_ЗаявкаНаРасходованиеСредств.Проведен = ИСТИНА
	|	И НЕ Документбит_ЗаявкаНаРасходованиеСредств.ДокументОснование ССЫЛКА Документ.бит_ЗаявкаНаРасходованиеСредствОбщая
	|	И ЕСТЬNULL(СтатусыОбъектов_Статус.Статус, ЗНАЧЕНИЕ(Справочник.бит_СтатусыОбъектов.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.бит_СтатусыОбъектов.Заявка_Оплачена)";
	
	Запрос.Параметры.Вставить("ДоговорКонтрагента", ДоговорКонтрагента); 
	РезультатЗапроса = Запрос.Выполнить();
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		СтруктураРезультат.ИтогПоСтарымЗаявкам 		= ВыборкаДетальныеЗаписи.Итог; 
		СтруктураРезультат.КоличествоСтарыхЗаявок 	= ВыборкаДетальныеЗаписи.Количество; 
	КонецЦикла;
	
	Возврат СтруктураРезультат;
	
КонецФункции

Процедура УстановитьСтатусыСтрокГрафикаПлатежей(ТЗ) Экспорт
	
		//Заполняем платежные поручения
		МассивЗНРДС = Новый Массив;
		Для каждого Строка Из ТЗ Цикл
			МассивЗНРДС.Добавить(Строка.ЗаявкаНаРасходованиеДС);
		КонецЦикла;
	
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	Документбит_ЗаявкаНаРасходованиеСредств.Ссылка как ЗаявкаНаРасходованиеДС,
		|	ЕСТЬNULL(СтатусыОбъектов_Статус.Статус, ЗНАЧЕНИЕ(Справочник.бит_СтатусыОбъектов.ПустаяСсылка)) КАК Статус
		|ИЗ
		|	Документ.бит_ЗаявкаНаРасходованиеСредств КАК Документбит_ЗаявкаНаРасходованиеСредств
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.бит_СтатусыОбъектов КАК СтатусыОбъектов_Статус
		|		ПО Документбит_ЗаявкаНаРасходованиеСредств.Ссылка = СтатусыОбъектов_Статус.Объект
		|			И (СтатусыОбъектов_Статус.ВидСтатуса = ЗНАЧЕНИЕ(Перечисление.бит_ВидыСтатусовОбъектов.Статус))
		|ГДЕ
		|	Документбит_ЗаявкаНаРасходованиеСредств.Ссылка в (&МассивЗНРДС)
		|";
		
		Запрос.Параметры.Вставить("МассивЗНРДС", МассивЗНРДС); 

		СтатусыЗНРДС = Запрос.Выполнить().Выгрузить();
		
		Для каждого Строка Из ТЗ Цикл  
			Отбор 			= Новый Структура("ЗаявкаНаРасходованиеДС", Строка.ЗаявкаНаРасходованиеДС);
			НайденныеСтроки = СтатусыЗНРДС.НайтиСтроки(Отбор);

			Если НайденныеСтроки.Количество() <> 0 Тогда
				СтрокаСтатусЗНРДС = НайденныеСтроки[0];
				Если СтрокаСтатусЗНРДС.Статус = Справочники.бит_СтатусыОбъектов.Заявка_Оплачена Тогда
					Строка.Статус = Перечисления._СтатусыПрогнозированияБДДС.Оплачен;
				Иначе
					Строка.Статус = Перечисления._СтатусыПрогнозированияБДДС.ВОплате;
				КонецЕсли;
			ИначеЕсли ЗначениеЗаполнено(Строка.ДокументПланирования) Тогда
				Строка.Статус = Перечисления._СтатусыПрогнозированияБДДС.Прогноз;
			Иначе
				Строка.Статус = Перечисления._СтатусыПрогнозированияБДДС.Черновик;
			КонецЕсли;				
		КонецЦикла;

КонецПроцедуры

Функция ПолучитьСуммуПоБюджетуПлатежейБ(Документ) Экспорт

	Результат = 0;
	Если ЗначениеЗаполнено(Документ.ДопУсловияПоДоговору) и ЗначениеЗаполнено(Документ.ДопУсловияПоДоговору.ДоговорКонтрагента) Тогда
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ
			|	СУММА(ДоговорыКонтрагентов_ПТЭ_Условия_Договора.Сумма) КАК Сумма
			|ИЗ
			|	Справочник.ДоговорыКонтрагентов._ПТЭ_Условия_Договора КАК ДоговорыКонтрагентов_ПТЭ_Условия_Договора
			|ГДЕ
			|	ДоговорыКонтрагентов_ПТЭ_Условия_Договора.Ссылка = &Ссылка"; 
		
		Запрос.УстановитьПараметр("Ссылка", Документ.ДопУсловияПоДоговору.ДоговорКонтрагента);
		РезультатЗапроса = Запрос.Выполнить();
		ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
		
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			Результат =  ВыборкаДетальныеЗаписи.Сумма;
		КонецЦикла;
		

	КонецЕсли;
	Возврат Результат;

КонецФункции // ()

#КонецОбласти

#Область ДанныеДляФормы
	
// ====== СЕКЦИЯ 2: ДАННЫЕ ДЛЯ ФОРМЫ ======

Функция ПолучитьГрафикПлатежейДляФормы(Документ, ТЗДляЗаполнения, СоответствиеНомеровНовыхСтрок = Неопределено) Экспорт

	ТЗГрафикПлатежей = Документ.ГрафикПлатежей.Выгрузить();
	//ТЗГрафикПлатежей.Сортировать("Порядок");
	ТЗГрафикПлатежей.Сортировать("Период");
	
	//Счетчик = 0;
	Для каждого СтрокаТЗГрафикПлатежей Из ТЗГрафикПлатежей Цикл
		//Счетчик = Счетчик + 1 ;
		НоваяСтрока = ТЗДляЗаполнения.Добавить();
		//НоваяСтрока.НомерСтрокиДляОтображения = Счетчик;
		//СтрокаТЗГрафикПлатежей.Порядок = Счетчик;
		ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТЗГрафикПлатежей);
	КонецЦикла; 
	
	Если ТЗДляЗаполнения.количество() > 0 Тогда
		
		//Заполняем ДокументыПланирования
		МассивУИДов = Новый Массив;
		Для каждого Строка Из ТЗДляЗаполнения Цикл
			МассивУИДов.Добавить(Строка.УИДСтроки);
		КонецЦикла;
				
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	бит_ЗаявкаНаРасходованиеСредствОбщая.Ссылка как ДокументПланирования,
		|	бит_ЗаявкаНаРасходованиеСредствОбщая.Сумма как ДокументПланированияСумма,
		|	бит_ЗаявкаНаРасходованиеСредствОбщая._УИДСтрокиДокументаОснования как УИДСтроки
		|ИЗ
		|	Документ.бит_ЗаявкаНаРасходованиеСредствОбщая КАК бит_ЗаявкаНаРасходованиеСредствОбщая
		|ГДЕ
		|	бит_ЗаявкаНаРасходованиеСредствОбщая.ПометкаУдаления = ЛОЖЬ
		|	И бит_ЗаявкаНаРасходованиеСредствОбщая._ДокументОснование = &_ДокументОснование
		|	И бит_ЗаявкаНаРасходованиеСредствОбщая._УИДСтрокиДокументаОснования В(&МассивУИДов)
		|	И НЕ бит_ЗаявкаНаРасходованиеСредствОбщая._УИДСтрокиДокументаОснования = &ПустойУИД";
		
		Запрос.УстановитьПараметр("_ДокументОснование", 	Документ.Ссылка);
		Запрос.УстановитьПараметр("МассивУИДов", 			МассивУИДов);
		ПустойУИД = Новый УникальныйИдентификатор("00000000-0000-0000-0000-000000000000");
		Запрос.УстановитьПараметр("ПустойУИД", 				ПустойУИД);
		
		РезультатЗапроса = Запрос.Выполнить();
		Выборка = РезультатЗапроса.Выбрать();
		Пока Выборка.Следующий() Цикл

			Отбор 			= Новый Структура("УИДСтроки", Выборка.УИДСтроки);
			НайденныеСтроки = ТЗДляЗаполнения.НайтиСтроки(Отбор); 
			Если НайденныеСтроки.Количество() = 0 Тогда
				Продолжить;
			КонецЕсли;
			
			Для каждого НайденнаяСтрока Из НайденныеСтроки Цикл
				ЗаполнитьЗначенияСвойств(НайденнаяСтрока, Выборка, "ДокументПланирования, ДокументПланированияСумма");
			КонецЦикла;
			
		КонецЦикла;

		//ЗаполняемЗНРДС
		МассивДокументовПланирования = Новый Массив;
		Для каждого Строка Из ТЗДляЗаполнения Цикл
			МассивДокументовПланирования.Добавить(Строка.ДокументПланирования);
		КонецЦикла;
				
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	бит_ЗаявкаНаРасходованиеСредств.Ссылка как ЗаявкаНаРасходованиеДС,
		|   бит_ЗаявкаНаРасходованиеСредств.ДокументОснование как ДокументПланирования,
		|	бит_ЗаявкаНаРасходованиеСредств.Сумма как ЗаявкаНаРасходованиеДССумма
		|ИЗ
		|	Документ.бит_ЗаявкаНаРасходованиеСредств КАК бит_ЗаявкаНаРасходованиеСредств
		|ГДЕ
		|	бит_ЗаявкаНаРасходованиеСредств.ПометкаУдаления = ЛОЖЬ
		|	И бит_ЗаявкаНаРасходованиеСредств.ДокументОснование в (&МассивДокументовПланирования)
		|	";
		
		Запрос.УстановитьПараметр("МассивДокументовПланирования", 	МассивДокументовПланирования);
		
		РезультатЗапроса = Запрос.Выполнить();
		Выборка = РезультатЗапроса.Выбрать();
		Пока Выборка.Следующий() Цикл

			Отбор 			= Новый Структура("ДокументПланирования", Выборка.ДокументПланирования);
			НайденныеСтроки = ТЗДляЗаполнения.НайтиСтроки(Отбор); 
			Если НайденныеСтроки.Количество() = 0 Тогда
				Продолжить;
			КонецЕсли;
			
			Для каждого НайденнаяСтрока Из НайденныеСтроки Цикл
				ЗаполнитьЗначенияСвойств(НайденнаяСтрока, Выборка, "ЗаявкаНаРасходованиеДС, ЗаявкаНаРасходованиеДССумма");
			КонецЦикла;
			
		КонецЦикла;
		
		//Заполняем платежные поручения
		МассивЗНРДС = Новый Массив;
		Для каждого Строка Из ТЗДляЗаполнения Цикл
			МассивЗНРДС.Добавить(Строка.ЗаявкаНаРасходованиеДС);
		КонецЦикла;
				
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ПлатежноеПоручениеИсходящее.Ссылка КАК ПлатежноеПоручениеИсходящее,
		|	ПлатежноеПоручениеИсходящее.ДокументОснование КАК ЗаявкаНаРасходованиеДС,
		|	ПлатежноеПоручениеИсходящее.СуммаДокумента КАК ПлатежноеПоручениеИсходящееСумма
		|ИЗ
		|	Документ.ПлатежноеПоручениеИсходящее КАК ПлатежноеПоручениеИсходящее
		|ГДЕ
		|	ПлатежноеПоручениеИсходящее.ПометкаУдаления = ЛОЖЬ
		|	И ПлатежноеПоручениеИсходящее.ДокументОснование В(&МассивЗНРДС)";
		
		Запрос.УстановитьПараметр("МассивЗНРДС", 	МассивЗНРДС);
		
		РезультатЗапроса = Запрос.Выполнить();
		Выборка = РезультатЗапроса.Выбрать();
		Пока Выборка.Следующий() Цикл

			Отбор 			= Новый Структура("ЗаявкаНаРасходованиеДС", Выборка.ЗаявкаНаРасходованиеДС);
			НайденныеСтроки = ТЗДляЗаполнения.НайтиСтроки(Отбор); 
			Если НайденныеСтроки.Количество() = 0 Тогда
				Продолжить;
			КонецЕсли;
			
			Для каждого НайденнаяСтрока Из НайденныеСтроки Цикл
				ЗаполнитьЗначенияСвойств(НайденнаяСтрока, Выборка, "ПлатежноеПоручениеИсходящее, ПлатежноеПоручениеИсходящееСумма");
			КонецЦикла;
			
		КонецЦикла;
		
	КонецЕсли;
	
		// Обеспечим отдельную сортировку новых строк
	Если Не СоответствиеНомеровНовыхСтрок=Неопределено Тогда
		Для Каждого Строка Из ТЗДляЗаполнения Цикл
			Строка.ПорядокНовыхСтрок = ?(СоответствиеНомеровНовыхСтрок[Строка.УИДСтроки] = Неопределено, 0, СоответствиеНомеровНовыхСтрок[Строка.УИДСтроки]);
		КонецЦикла;
	КонецЕсли;
	
	УстановитьСтатусыСтрокГрафикаПлатежей(ТЗДляЗаполнения);
	РассчитатьСуммовыеПоказателиСтрокГрафикаПлатежей(Документ, ТЗДляЗаполнения);
	
	Возврат ТЗДляЗаполнения;

КонецФункции 

Функция ПолучитьГрафикПлатежейБДляФормы(Документ, ТЗДляЗаполнения, СоответствиеНомеровНовыхСтрок = Неопределено) Экспорт

	ТЗГрафикПлатежей = Документ.ГрафикПлатежей.Выгрузить();
	//ТЗГрафикПлатежей.Сортировать("Порядок"); 
	//ТЗГрафикПлатежей.Сортировать("Период"); 
	
	//Счетчик = 0;
	Для каждого СтрокаТЗГрафикПлатежей Из ТЗГрафикПлатежей Цикл
		//Счетчик = Счетчик + 1 ;
		НоваяСтрока = ТЗДляЗаполнения.Добавить();
		//НоваяСтрока.НомерСтрокиДляОтображения = Счетчик;
		//СтрокаТЗГрафикПлатежей.Порядок = Счетчик;
		ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТЗГрафикПлатежей);
	КонецЦикла; 
	
	Если ТЗДляЗаполнения.количество() > 0 Тогда
		МассивУИДов = Новый Массив;
		Для каждого Строка Из ТЗДляЗаполнения Цикл
			МассивУИДов.Добавить(Строка.УИДСтроки);
		КонецЦикла;
				
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	бит_ЗаявкаНаРасходованиеСредствОбщая.Ссылка КАК ДокументПланирования,
		|	ЕСТЬNULL(бит_ЗаявкаНаРасходованиеСредств.Сумма, 0) КАК ЗаявкаНаРасходованиеДССумма,
		|	ЕСТЬNULL(СтатусыОбъектов_Статус.Статус, ЗНАЧЕНИЕ(Справочник.бит_СтатусыОбъектов.ПустаяСсылка)) КАК Статус
		|ПОМЕСТИТЬ ВТ_Данные
		|ИЗ
		|	Документ.бит_ЗаявкаНаРасходованиеСредствОбщая КАК бит_ЗаявкаНаРасходованиеСредствОбщая
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.бит_ЗаявкаНаРасходованиеСредств КАК бит_ЗаявкаНаРасходованиеСредств
		|			ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.бит_СтатусыОбъектов КАК СтатусыОбъектов_Статус
		|			ПО бит_ЗаявкаНаРасходованиеСредств.Ссылка = СтатусыОбъектов_Статус.Объект
		|				И (СтатусыОбъектов_Статус.ВидСтатуса = ЗНАЧЕНИЕ(Перечисление.бит_ВидыСтатусовОбъектов.Статус))
		|		ПО (бит_ЗаявкаНаРасходованиеСредств.ДокументОснование = бит_ЗаявкаНаРасходованиеСредствОбщая.Ссылка)
		|			И (бит_ЗаявкаНаРасходованиеСредств.ПометкаУдаления = ЛОЖЬ)
		|ГДЕ
		|	бит_ЗаявкаНаРасходованиеСредствОбщая.ПометкаУдаления = ЛОЖЬ
		|	И бит_ЗаявкаНаРасходованиеСредствОбщая._ДокументОснование = &_ДокументОснование
		|	И бит_ЗаявкаНаРасходованиеСредствОбщая._УИДСтрокиДокументаОснования В(&МассивУИДов)
		|	И НЕ бит_ЗаявкаНаРасходованиеСредствОбщая._УИДСтрокиДокументаОснования = &ПустойУИД
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Данные.ДокументПланирования,
		|	ВТ_Данные.ЗаявкаНаРасходованиеДССумма,
		|	ВТ_Данные.Статус,
		|	ВЫБОР
		|		КОГДА ВТ_Данные.Статус = ЗНАЧЕНИЕ(Справочник.бит_СтатусыОбъектов.Заявка_Оплачена)
		|			ТОГДА ВТ_Данные.ЗаявкаНаРасходованиеДССумма
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Факт,
		|	ВЫБОР
		|		КОГДА ВТ_Данные.Статус = ЗНАЧЕНИЕ(Справочник.бит_СтатусыОбъектов.Заявка_Оплачена)
		|			ТОГДА 0
		|		ИНАЧЕ ВТ_Данные.ЗаявкаНаРасходованиеДССумма
		|	КОНЕЦ КАК ЗаявкаНаРасходованиеДСПрогноз
		|ПОМЕСТИТЬ ВТ_Данные1
		|ИЗ
		|	ВТ_Данные КАК ВТ_Данные
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Данные1.ДокументПланирования,
		|	СУММА(ВТ_Данные1.Факт) КАК Факт,
		|	СУММА(ВТ_Данные1.ЗаявкаНаРасходованиеДСПрогноз) КАК ЗаявкаНаРасходованиеДСПрогноз
		|ПОМЕСТИТЬ ВТ_Данные2
		|ИЗ
		|	ВТ_Данные1 КАК ВТ_Данные1
		|
		|СГРУППИРОВАТЬ ПО
		|	ВТ_Данные1.ДокументПланирования
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Данные2.ДокументПланирования,
		|	ВТ_Данные2.Факт,
		|	ВТ_Данные2.ЗаявкаНаРасходованиеДСПрогноз,
		|	ВТ_Данные2.ДокументПланирования.Сумма КАК ДокументПланированияСумма,
		|	ВТ_Данные2.ДокументПланирования._УИДСтрокиДокументаОснования как УИДСтроки
		|ИЗ
		|	ВТ_Данные2 КАК ВТ_Данные2";
		
		Запрос.УстановитьПараметр("_ДокументОснование", 	Документ.Ссылка);
		Запрос.УстановитьПараметр("МассивУИДов", 			МассивУИДов);
		ПустойУИД = Новый УникальныйИдентификатор("00000000-0000-0000-0000-000000000000");
		Запрос.УстановитьПараметр("ПустойУИД", 				ПустойУИД);
		
		РезультатЗапроса = Запрос.Выполнить();
		Выборка = РезультатЗапроса.Выбрать();
		Пока Выборка.Следующий() Цикл

			Отбор 			= Новый Структура("УИДСтроки", Выборка.УИДСтроки);
			НайденныеСтроки = ТЗДляЗаполнения.НайтиСтроки(Отбор); 
			Если НайденныеСтроки.Количество() = 0 Тогда
				Продолжить;
			КонецЕсли;
			
			Для каждого НайденнаяСтрока Из НайденныеСтроки Цикл
				ЗаполнитьЗначенияСвойств(НайденнаяСтрока, Выборка, "ДокументПланирования, ДокументПланированияСумма, Факт");
				Если Выборка.ЗаявкаНаРасходованиеДСПрогноз <> 0 Тогда
					НайденнаяСтрока.Прогноз = Выборка.ЗаявкаНаРасходованиеДСПрогноз;
				ИначеЕсли Выборка.ДокументПланированияСумма <> 0 и Выборка.ЗаявкаНаРасходованиеДСПрогноз = 0 и Выборка.Факт = 0 Тогда					
					НайденнаяСтрока.Прогноз = Выборка.ДокументПланированияСумма;
                ИначеЕсли Выборка.ДокументПланированияСумма = 0 и Выборка.ЗаявкаНаРасходованиеДСПрогноз = 0 и Выборка.Факт = 0 Тогда 
					НайденнаяСтрока.Прогноз = НайденнаяСтрока.Сумма;
				КонецЕсли; 
				НайденнаяСтрока.СуммаПлатежа = НайденнаяСтрока.Прогноз + НайденнаяСтрока.Факт;
			КонецЦикла;
			
		КонецЦикла;
		
	КонецЕсли; 
	
	// Обеспечим отдельную сортировку новых строк
	Если Не СоответствиеНомеровНовыхСтрок=Неопределено Тогда
		Для Каждого Строка Из ТЗДляЗаполнения Цикл
			Строка.ПорядокНовыхСтрок = ?(СоответствиеНомеровНовыхСтрок[Строка.УИДСтроки] = Неопределено, 0, СоответствиеНомеровНовыхСтрок[Строка.УИДСтроки]);
		КонецЦикла;
	КонецЕсли;
	
	Для каждого Строка Из ТЗДляЗаполнения Цикл 
		Если Не ЗначениеЗаполнено(Строка.ДокументПланирования) Тогда
			Строка.СуммаПлатежа = Строка.Сумма;		
			Строка.Прогноз = Строка.Сумма;		
		КонецЕсли;
	КонецЦикла;
	
	Возврат ТЗДляЗаполнения;

КонецФункции 

Функция ПолучитьДанныеЗНРДСДляГрафикаПлатежейБДляФормы(Документ, ДокументПрогнозирования, ТЗДляЗаполнения) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Документбит_ЗаявкаНаРасходованиеСредств.Ссылка КАК ЗаявкаНаРасходованиеДС,
		|	ЕСТЬNULL(Документбит_ЗаявкаНаРасходованиеСредств.Сумма, 0) КАК ЗаявкаНаРасходованиеДССумма,
		|	ЕСТЬNULL(СтатусыОбъектов_Статус.Статус, ЗНАЧЕНИЕ(Справочник.бит_СтатусыОбъектов.ПустаяСсылка)) КАК ЗаявкаНаРасходованиеДССтатус,
		|	СтатусыОбъектов_Статус.ДатаИзмененияСтатуса КАК ЗаявкаНаРасходованиеДСДатаИзмененияСтатуса
		|ПОМЕСТИТЬ ВТ_Данные
		|ИЗ
		|	Документ.бит_ЗаявкаНаРасходованиеСредств КАК Документбит_ЗаявкаНаРасходованиеСредств
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.бит_СтатусыОбъектов КАК СтатусыОбъектов_Статус
		|		ПО Документбит_ЗаявкаНаРасходованиеСредств.Ссылка = СтатусыОбъектов_Статус.Объект
		|			И (СтатусыОбъектов_Статус.ВидСтатуса = ЗНАЧЕНИЕ(Перечисление.бит_ВидыСтатусовОбъектов.Статус))
		|ГДЕ
		|	ИСТИНА
		|	И Документбит_ЗаявкаНаРасходованиеСредств.ДатаРасхода >= ДАТАВРЕМЯ(2019, 1, 1)
		|	И Документбит_ЗаявкаНаРасходованиеСредств.ДокументОснование = &ДокументПрогнозирования
		|	И Документбит_ЗаявкаНаРасходованиеСредств.ПометкаУдаления = ЛОЖЬ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Данные.ЗаявкаНаРасходованиеДС,
		|	ВТ_Данные.ЗаявкаНаРасходованиеДССумма,
		|	ВТ_Данные.ЗаявкаНаРасходованиеДССтатус,
		|	ВТ_Данные.ЗаявкаНаРасходованиеДСДатаИзмененияСтатуса,
		|	ВЫБОР
		|		КОГДА ВТ_Данные.ЗаявкаНаРасходованиеДССтатус = ЗНАЧЕНИЕ(Справочник.бит_СтатусыОбъектов.Заявка_Оплачена)
		|			ТОГДА ВТ_Данные.ЗаявкаНаРасходованиеДССумма
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК ЗаявкаНаРасходованиеДСФакт,
		|	ВЫБОР
		|		КОГДА ВТ_Данные.ЗаявкаНаРасходованиеДССтатус = ЗНАЧЕНИЕ(Справочник.бит_СтатусыОбъектов.Заявка_Оплачена)
		|			ТОГДА 0
		|		ИНАЧЕ ВТ_Данные.ЗаявкаНаРасходованиеДССумма
		|	КОНЕЦ КАК ЗаявкаНаРасходованиеДСПрогноз		
		|ИЗ
		|	ВТ_Данные КАК ВТ_Данные
		|";
	
	
	Запрос.Параметры.Вставить("ДокументПрогнозирования", ДокументПрогнозирования);
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции	

Функция ПолучитьГрафикиПоступленийДляФормы(Документ, СоответствиеНомеровНовыхСтрок = Неопределено) Экспорт
    
    // 1. Получаем данные из объекта
    ТЗ = Документ.ГрафикПоступлений.Выгрузить();
	ТЗ.Колонки.Добавить("НомерСтрокиДляОтображения", 	Новый ОписаниеТипов("Число"));
	ТЗ.Колонки.Добавить("ДокументПланирования", 		Новый ОписаниеТипов("ДокументСсылка.бит_ПланируемоеПоступлениеДенежныхСредств"));
    ТЗ.Колонки.Добавить("Факт", 						Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
    ТЗ.Колонки.Добавить("Прогноз", 						Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
    ТЗ.Колонки.Добавить("СуммаПлатежа", 				Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));	
	ТЗ.Колонки.Добавить("ДокументПланированияСумма", 	Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2))); 
	ТЗ.Колонки.Добавить("ПорядокНовыхСтрок", 			Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 0)));

	
    // 2. Сортируем по полю "Порядок"
    //ТЗ.Сортировать("Порядок");
	//ТЗ.Сортировать("Период");
	
	// 3. Запрашиваем связанные документы планирования
    Если ТЗ.Количество() > 0 Тогда
		
		МассивУИДов = Новый Массив;
        Для Каждого Строка Из ТЗ Цикл
            МассивУИДов.Добавить(Строка.УИДСтроки);
        КонецЦикла;
        
        // Запрос к документам планирования
        Запрос = Новый Запрос;
        Запрос.Текст = 
        "ВЫБРАТЬ
        |	ПП.Ссылка,
        |	ПП._УИДСтрокиПланаИсполненияДоговора
        |ИЗ
        |	Документ.бит_ПланируемоеПоступлениеДенежныхСредств КАК ПП
        |ГДЕ
        |	ПП.ДокументОснование = &Основание
        |	И ПП._УИДСтрокиПланаИсполненияДоговора В(&МассивУИДов)
        |	И НЕ ПП._УИДСтрокиПланаИсполненияДоговора = &ПустойУИД
        |	И ПП.ПометкаУдаления = ЛОЖЬ";
        
        Запрос.Параметры.Вставить("Основание", 		Документ.Ссылка);
        Запрос.Параметры.Вставить("МассивУИДов", 	МассивУИДов);
		ПустойУИД 									= Новый УникальныйИдентификатор("00000000-0000-0000-0000-000000000000");
        Запрос.УстановитьПараметр("ПустойУИД", 		ПустойУИД);
		
        Результат = Запрос.Выполнить();
        Соответствие = Новый Соответствие;
        Выборка = Результат.Выбрать();
        Пока Выборка.Следующий() Цикл
            Соответствие.Вставить(Выборка._УИДСтрокиПланаИсполненияДоговора, Выборка.Ссылка);
        КонецЦикла;
        
        // Заполняем поле ДокументПланирования
        Для Каждого Строка Из ТЗ Цикл
            Если Соответствие[Строка.УИДСтроки] <> Неопределено Тогда
                Строка.ДокументПланирования 		= Соответствие[Строка.УИДСтроки]; 
				Строка.ДокументПланированияСумма 	= Соответствие[Строка.УИДСтроки].СуммаДокумента;
            КонецЕсли;
		КонецЦикла;
		
	КонецЕсли; 
	
	// Обеспечим отдельную сортировку новых строк
	Если Не СоответствиеНомеровНовыхСтрок=Неопределено Тогда
		Для Каждого Строка Из ТЗ Цикл
			Строка.ПорядокНовыхСтрок = ?(СоответствиеНомеровНовыхСтрок[Строка.УИДСтроки] = Неопределено, 0, СоответствиеНомеровНовыхСтрок[Строка.УИДСтроки]);
		КонецЦикла;
	КонецЕсли;	
	
	
	// 4. Заполняем номера
	//Номер = 1;
	Для Каждого Строка Из ТЗ Цикл
		//	Строка.НомерСтрокиДляОтображения = Номер;
		//Номер = Номер + 1;
		
		Строка.Факт = РассчитатьФактПоГрафику(Документ, Строка.УИДСтроки);
		Строка.Прогноз = РассчитатьПрогнозДляСтрокиГрафика(
															Документ, 
															Строка.УИДСтроки,
															Соответствие
															);
		Строка.СуммаПлатежа = Строка.Прогноз + Строка.Факт;	
	КонецЦикла;
	
	Возврат ТЗ;
    
КонецФункции

Функция ПолучитьГрафикПоступленийБДляФормы(Документ, ТЗДляЗаполнения, СоответствиеНомеровНовыхСтрок = Неопределено) Экспорт
    
    // 1. Получаем данные из объекта
    ТЗГрафикПоступлений = Документ.ГрафикПоступлений.Выгрузить();
	
    // 2. Сортируем по полю "Порядок"
    //ТЗ.Сортировать("Порядок");
	//ТЗГрафикПоступлений.Сортировать("Период");
	
	Счетчик = 0;
	Для каждого СтрокаТЗГрафикПоступлений Из ТЗГрафикПоступлений Цикл
		
		Счетчик 								= Счетчик + 1 ;
		НоваяСтрока 							= ТЗДляЗаполнения.Добавить();
		//НоваяСтрока.НомерСтрокиДляОтображения 	= Счетчик;
		//СтрокаТЗГрафикПоступлений.Порядок 		= Счетчик;
		ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТЗГрафикПоступлений);
		
	КонецЦикла;	
	
	// 3. Запрашиваем связанные документы планирования
    Если ТЗДляЗаполнения.Количество() > 0 Тогда
		
		МассивУИДов = Новый Массив;
        Для Каждого Строка Из ТЗДляЗаполнения Цикл
            МассивУИДов.Добавить(Строка.УИДСтроки);
        КонецЦикла;
        
        // Запрос к документам планирования
        Запрос = Новый Запрос;
        Запрос.Текст = 
        "ВЫБРАТЬ
        |	ПП.Ссылка,
        |	ПП._УИДСтрокиПланаИсполненияДоговора
        |ИЗ
        |	Документ.бит_ПланируемоеПоступлениеДенежныхСредств КАК ПП
        |ГДЕ
        |	ПП.ДокументОснование = &Основание
        |	И ПП._УИДСтрокиПланаИсполненияДоговора В(&МассивУИДов)
        |	И НЕ ПП._УИДСтрокиПланаИсполненияДоговора = &ПустойУИД
        |	И ПП.ПометкаУдаления = ЛОЖЬ";
        
        Запрос.Параметры.Вставить("Основание", 		Документ.Ссылка);
        Запрос.Параметры.Вставить("МассивУИДов", 	МассивУИДов);
		ПустойУИД 									= Новый УникальныйИдентификатор("00000000-0000-0000-0000-000000000000");
        Запрос.УстановитьПараметр("ПустойУИД", 		ПустойУИД);
		
        Результат 		= Запрос.Выполнить();
        Соответствие 	= Новый Соответствие;
        Выборка 		= Результат.Выбрать();
		
        Пока Выборка.Следующий() Цикл
            Соответствие.Вставить(Выборка._УИДСтрокиПланаИсполненияДоговора, Выборка.Ссылка);
        КонецЦикла;
        
        // Заполняем поле ДокументПланирования
        Для Каждого Строка Из ТЗДляЗаполнения Цикл
            Если Соответствие[Строка.УИДСтроки] <> Неопределено Тогда
                Строка.ДокументПланирования 		= Соответствие[Строка.УИДСтроки]; 
				Строка.ДокументПланированияСумма 	= Соответствие[Строка.УИДСтроки].СуммаДокумента;
            КонецЕсли;
		КонецЦикла;
		
	КонецЕсли; 
	
	// Обеспечим отдельную сортировку новых строк
	Если Не СоответствиеНомеровНовыхСтрок=Неопределено Тогда
		Для Каждого Строка Из ТЗДляЗаполнения Цикл
			Строка.ПорядокНовыхСтрок = ?(СоответствиеНомеровНовыхСтрок[Строка.УИДСтроки] = Неопределено, 0, СоответствиеНомеровНовыхСтрок[Строка.УИДСтроки]);
		КонецЦикла;
	КонецЕсли;
	
	//ТЗДляЗаполнения.Сортировать("ПорядокНовыхСтрок, Период");	
	

//	Номер = 1;
	Для Каждого Строка Из ТЗДляЗаполнения Цикл
//		Строка.НомерСтрокиДляОтображения = Номер;
//		Номер = Номер + 1;
		//Строка.Факт = РассчитатьФактПоГрафику(Документ, Строка.УИДСтроки);
		Строка.Прогноз = ?(Строка.ДокументПланированияСумма <> 0, Строка.ДокументПланированияСумма , Строка.Сумма);
		//Строка.СуммаПлатежа = Строка.Прогноз + Строка.Факт;	
	КонецЦикла;

		
	Возврат ТЗДляЗаполнения;
    
КонецФункции

Функция ПолучитьДетализациюПоГрафикуПоступлений(Документ, УИДСтрокиГрафикаПоступлений) Экспорт  
    
    // 1. Создаём ТЗ
    ТЗ = Документ.ДетализацияГрафикаПоступлений.Выгрузить();
    ТЗ.Очистить();
    ТЗ.Колонки.Добавить("НомерСтрокиДляОтображения", 	Новый ОписаниеТипов("Число"));
    ТЗ.Колонки.Добавить("СуммаДокумента", 				Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
    ТЗ.Колонки.Добавить("Остаток", 						Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)));
	
    // 2. Находим строки
    Отбор 			= Новый Структура("УИДСтрокиГрафикаПоступлений", УИДСтрокиГрафикаПоступлений);
    НайденныеСтроки = Документ.ДетализацияГрафикаПоступлений.НайтиСтроки(Отбор); 
    
    // 3. Если строк нет - возвращаем пустую ТЗ
    Если НайденныеСтроки.Количество() = 0 Тогда
        Возврат ТЗ;
    КонецЕсли;
    
    // 4. Собираем ссылки на платежные поручения для массовой загрузки
    МассивППВ = Новый Массив;
    
    Для Каждого СтрокаТЧ Из НайденныеСтроки Цикл
        Если СтрокаТЧ.ПлатежноеПоручениеВходящее <> Неопределено Тогда
            МассивППВ.Добавить(СтрокаТЧ.ПлатежноеПоручениеВходящее);
        КонецЕсли;
    КонецЦикла;
    
    // 5. Загружаем все суммы платежек одним запросом
    СоответствиеППВ = Новый Соответствие;
	Если МассивППВ.Количество() > 0 Тогда
		
        Запрос = Новый Запрос;
        Запрос.Текст = "ВЫБРАТЬ
                       |	ПлатежноеПоручениеВходящее.Ссылка КАК Ссылка,
                       |	ПлатежноеПоручениеВходящее.СуммаДокумента КАК СуммаДокумента
                       |ИЗ
                       |	Документ.ПлатежноеПоручениеВходящее КАК ПлатежноеПоручениеВходящее
                       |ГДЕ
                       |	ПлатежноеПоручениеВходящее.Ссылка В(&МассивППВ)";
        
        Запрос.УстановитьПараметр("МассивППВ", МассивППВ);
        
        Результат 	= Запрос.Выполнить();
        Выборка 	= Результат.Выбрать();
        
        Пока Выборка.Следующий() Цикл
            СоответствиеППВ.Вставить(Выборка.Ссылка, Выборка.СуммаДокумента);
		КонецЦикла; 
		
    КонецЕсли;
    
    // 6. Используем временную ТЗ для сортировки
    ТЗДляСортировки = Новый ТаблицаЗначений;
    ТЗДляСортировки.Колонки.Добавить("СтрокаОбъекта");
    ТЗДляСортировки.Колонки.Добавить("Порядок", Новый ОписаниеТипов("Число"));
    
    // 7. Заполняем временную ТЗ
    Для Каждого СтрокаТЧ Из НайденныеСтроки Цикл
        НоваяСтрокаВременнойТЗ 					= ТЗДляСортировки.Добавить();
        НоваяСтрокаВременнойТЗ.СтрокаОбъекта 	= СтрокаТЧ;
        НоваяСтрокаВременнойТЗ.Порядок 			= СтрокаТЧ.Порядок; 
    КонецЦикла;
    
    // 8. Сортируем временную ТЗ
    ТЗДляСортировки.Сортировать("Порядок");
    
    // 9. Копируем с нумерацией и заполняем суммы
    Номер = 1;
	Для Каждого СтрокаСортировки Из ТЗДляСортировки Цикл  
		
        СтрокаТЧ 								= СтрокаСортировки.СтрокаОбъекта;
        НоваяСтрокаТЗ 							= ТЗ.Добавить(); 
        НоваяСтрокаТЗ.НомерСтрокиДляОтображения = Номер;
        Номер 									= Номер + 1; 
        
        ЗаполнитьЗначенияСвойств(НоваяСтрокаТЗ, СтрокаТЧ);
        
        // Заполняем суммы из соответствия
        ППВ = СтрокаТЧ.ПлатежноеПоручениеВходящее;
        Если ППВ <> Неопределено Тогда
            СуммаППВ = СоответствиеППВ[ППВ];
			Если СуммаППВ <> Неопределено Тогда
				
                НоваяСтрокаТЗ.СуммаДокумента 	= СуммаППВ; 
                НоваяСтрокаТЗ.Остаток 			= СуммаППВ - НоваяСтрокаТЗ.СуммаПогашено; 
				
            КонецЕсли;
        КонецЕсли;
    КонецЦикла;	
    
    Возврат ТЗ;    
    
КонецФункции

Процедура ОбновитьПорядокГрафикаВОбъекте(Документ, ТЗИзФормы) Экспорт
    
    // ТЗИзФормы - таблица из формы, строки в НОВОМ порядке
    
    // 1. Создаем соответствие: УИД -> НовыйПорядок
    Соответствие = Новый Соответствие;
    НовыйПорядок = 1;
    
    Для Каждого СтрокаТЗ Из ТЗИзФормы Цикл
        Соответствие.Вставить(СтрокаТЗ.УИДСтроки, НовыйПорядок);
        НовыйПорядок = НовыйПорядок + 1;
    КонецЦикла;
    
    // 2. Обновляем порядок в объекте
    Для Каждого СтрокаОбъекта Из Документ.ГрафикПоступлений Цикл
        УИД = СтрокаОбъекта.УИДСтроки;
        Если Соответствие[УИД] <> Неопределено Тогда
            СтрокаОбъекта.Порядок = Соответствие[УИД];
        КонецЕсли;
    КонецЦикла;
    
КонецПроцедуры

Функция ПолучитьСтатьиБДДСДляВыбора(Документ) Экспорт
	
	СтруктураРезультат 	= Новый Структура; 
	СписокСообщений 	= Новый СписокЗначений;
	СписокВыбора 		= Новый СписокЗначений;

	ВсеХорошо = Истина;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ГН.СтатьяОборотовНачисления
	|ПОМЕСТИТЬ ВТ_СписокСтатейБДР
	|ИЗ
	|	Документ.бит_ДополнительныеУсловияПоДоговору.ГрафикНачислений КАК ГН
	|ГДЕ
	|	ГН.Ссылка = &Ссылка
	|	И НЕ ГН.СтатьяОборотовНачисления = НЕОПРЕДЕЛЕНО
	|	И НЕ ГН.СтатьяОборотовНачисления = ЗНАЧЕНИЕ(справочник.бит_СтатьиОборотов.ПустаяСсылка)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_СписокСтатейБДР.СтатьяОборотовНачисления
	|ИЗ
	|	ВТ_СписокСтатейБДР КАК ВТ_СписокСтатейБДР
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	РС.СтатьяБДДС КАК СтатьяБДДС
	|ПОМЕСТИТЬ ВТ_Соответствия
	|ИЗ
	|	РегистрСведений._СоответствиеСтатейОборотовБДРиБДДС КАК РС
	|ГДЕ
	|	РС.СтатьяБДР В
	|			(ВЫБРАТЬ
	|				ВТ_СписокСтатейБДР.СтатьяОборотовНачисления
	|			ИЗ
	|				ВТ_СписокСтатейБДР)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Соответствия.СтатьяБДДС
	|ИЗ
	|	ВТ_Соответствия КАК ВТ_Соответствия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Соответствия.СтатьяБДДС
	|ИЗ
	|	ВТ_Соответствия КАК ВТ_Соответствия
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	ГН.Ссылка.ДоговорКонтрагента.бит_ОсновнаяСтатьяОборотов
	|ИЗ
	|	Документ.бит_ДополнительныеУсловияПоДоговору.ГрафикНачислений КАК ГН
	|ГДЕ
	|	ГН.Ссылка = &Ссылка
	|	И НЕ ГН.Ссылка.ДоговорКонтрагента.бит_ОсновнаяСтатьяОборотов = ЗНАЧЕНИЕ(справочник.бит_СтатьиОборотов.ПустаяСсылка)";
	
	
	Запрос.УстановитьПараметр("Ссылка", Документ.ДопУсловияПоДоговору.Ссылка); 
	
	РезультатЗапроса	= Запрос.ВыполнитьПакет();
	МаксимальныйИндекс	= РезультатЗапроса.ВГраница();
	
	ТаблицаСтатейОборотовБДДС = РезультатЗапроса[МаксимальныйИндекс - 0].Выгрузить();
	
	Для каждого Строка Из ТаблицаСтатейОборотовБДДС Цикл
		СписокВыбора.Добавить(Строка.СтатьяБДДС);
	КонецЦикла;
	
	ТаблицаСоответствияСтатейОборотовБДРиБДДС = РезультатЗапроса[МаксимальныйИндекс - 1].Выгрузить();
	Если ТаблицаСоответствияСтатейОборотовБДРиБДДС.Количество() = 0 Тогда
		ТаблицаСтатейБДР = РезультатЗапроса[МаксимальныйИндекс - 3].Выгрузить();
		Для каждого Строка Из ТаблицаСтатейБДР Цикл
			ВсеХорошо = Ложь;
			СписокСообщений.Добавить("Не найдено соответствие для статьи оборотов БДР [" + Строка.СтатьяОборотовНачисления + "]");
		КонецЦикла;
	КонецЕсли;
	
	Если ТаблицаСтатейОборотовБДДС.Количество()=0 Тогда
		Если Не ЗначениеЗаполнено(Документ.ДопУсловияПоДоговору.ДоговорКонтрагента) Тогда
			ВсеХорошо = Ложь;
			СписокСообщений.Добавить("В ДопУсловиях не заполнен договор -> не определена основная статья оборотов БДДС");		
		ИначеЕсли Не ЗначениеЗаполнено(Документ.ДопУсловияПоДоговору.ДоговорКонтрагента.бит_ОсновнаяСтатьяОборотов) Тогда
			ВсеХорошо = Ложь;
			СписокСообщений.Добавить("В договоре не заполнена основная статья оборотов БДДС");		
		КонецЕсли;		
	КонецЕсли;
	
	СтруктураРезультат.Вставить("ВсеХорошо", 		ВсеХорошо);
	СтруктураРезультат.Вставить("СписокВыбора", 	СписокВыбора);
	СтруктураРезультат.Вставить("СписокСообщений", 	СписокСообщений);
	
	Возврат СтруктураРезультат;
	
КонецФункции

Функция ПолучитьСтатьиБДДСДляВыбораБездоговорная(Документ) Экспорт
	
	СтруктураРезультат 	= Новый Структура; 
	СписокСообщений 	= Новый СписокЗначений;
	СписокВыбора 		= Новый СписокЗначений;

	ВсеХорошо = Истина;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	справочникДоговорыКонтрагентовбит_СтатьиОборотов.СтатьяОборотов как СтатьяБДДС
		|ИЗ
		|	Документ.бит_ДополнительныеУсловияПоДоговору КАК бит_ДополнительныеУсловияПоДоговору
		|	левое соединение справочник.ДоговорыКонтрагентов.бит_СтатьиОборотов как справочникДоговорыКонтрагентовбит_СтатьиОборотов
		|	по справочникДоговорыКонтрагентовбит_СтатьиОборотов.Ссылка = бит_ДополнительныеУсловияПоДоговору.ДоговорКонтрагента
		|ГДЕ
		|	бит_ДополнительныеУсловияПоДоговору.Ссылка = &Ссылка
		|	
		|Объединить
		|
		|ВЫБРАТЬ
		|	Документбит_ПроектДоговораСтатьиОборотов.СтатьяОборотов
		|ИЗ
		|	Документ.бит_ДополнительныеУсловияПоДоговору КАК бит_ДополнительныеУсловияПоДоговору
		|	левое соединение Документ.бит_ПроектДоговора.СтатьиОборотов как Документбит_ПроектДоговораСтатьиОборотов
		|	по Документбит_ПроектДоговораСтатьиОборотов.Ссылка = бит_ДополнительныеУсловияПоДоговору.ПроектДоговора
		|ГДЕ
		|	бит_ДополнительныеУсловияПоДоговору.Ссылка = &Ссылка	
		|";	
	
	Запрос.УстановитьПараметр("Ссылка", Документ.ДопУсловияПоДоговору.Ссылка); 
	
	РезультатЗапроса	= Запрос.Выполнить();
	
	ТаблицаСтатейОборотовБДДС = РезультатЗапроса.Выгрузить();
	
	Для каждого Строка Из ТаблицаСтатейОборотовБДДС Цикл
		СписокВыбора.Добавить(Строка.СтатьяБДДС);
	КонецЦикла;
	Если ТаблицаСтатейОборотовБДДС.Количество()=0 Тогда
		Если Не ЗначениеЗаполнено(Документ.ДопУсловияПоДоговору.ДоговорКонтрагента) Тогда
			ВсеХорошо = Ложь;
			СписокСообщений.Добавить("В ДопУсловиях не заполнен договор -> не определена основная статья оборотов БДДС");		
		ИначеЕсли Не ЗначениеЗаполнено(Документ.ДопУсловияПоДоговору.ДоговорКонтрагента.бит_ОсновнаяСтатьяОборотов) Тогда
			ВсеХорошо = Ложь;
			СписокСообщений.Добавить("В договоре не заполнена основная статья оборотов БДДС");		
		КонецЕсли;		
	КонецЕсли;
	
	СтруктураРезультат.Вставить("ВсеХорошо", 		ВсеХорошо);
	СтруктураРезультат.Вставить("СписокВыбора", 	СписокВыбора);
	СтруктураРезультат.Вставить("СписокСообщений", 	СписокСообщений);
	
	Возврат СтруктураРезультат;
	
КонецФункции

Функция ПолучитьМероприятияДляВыбора(Документ) Экспорт

	СтруктураРезультат 	= Новый Структура; 
	СписокСообщений 	= Новый СписокЗначений;
	СписокВыбора 		= Новый СписокЗначений;

	ВсеХорошо = Истина;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_4 КАК Мероприятие
	|ИЗ
	|	Документ.бит_ДополнительныеУсловияПоДоговору.ГрафикНачислений КАК бит_ДополнительныеУсловияПоДоговоруГрафикНачислений
	|ГДЕ
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Ссылка = &Ссылка
	|	И НЕ бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_4 = НЕОПРЕДЕЛЕНО
	|  	И НЕ бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_4 = Значение(Справочник._МероприятияПрограмм.ПустаяСсылка)
	|СГРУППИРОВАТЬ ПО
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_4";
	
	Запрос.УстановитьПараметр("Ссылка", Документ.ДопУсловияПоДоговору); 
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой() Тогда
		ВсеХорошо = Ложь;
		//СписокСообщений.Добавить("В графике начислений ДопУсловий не найдены мероприятия");
	КонецЕсли;
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
		
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		СписокВыбора.Добавить(ВыборкаДетальныеЗаписи.Мероприятие);
	КонецЦикла;
	
	СтруктураРезультат.Вставить("ВсеХорошо", 		ВсеХорошо);
	СтруктураРезультат.Вставить("СписокВыбора", 	СписокВыбора);
	СтруктураРезультат.Вставить("СписокСообщений", 	СписокСообщений);
	
	Возврат СтруктураРезультат;

КонецФункции

#КонецОбласти 

#Область МетодыОбъекта
	
// ====== СЕКЦИЯ 3: Методы объекта, которые в режиме совместимости не видны из формы  ======

Функция СоздатьСтрокуГрафикаПлатежей(Документ) Экспорт
	
	НоваяСтрока 			= Документ.ГрафикПлатежей.Добавить();
	НоваяСтрока.УИДСтроки 	= Новый УникальныйИдентификатор();
	
	// Заполнение по умолчанию
	НоваяСтрока.Период = ТекущаяДата();
	
	Если ЗначениеЗаполнено(Документ.ДопУсловияПоДоговору.ПроектДоговора) Тогда
		НоваяСтрока.ЦФО =  Документ.ДопУсловияПоДоговору.ПроектДоговора.ЦФО;
	КонецЕсли;
	
	
	Возврат НоваяСтрока.УИДСтроки;
	
КонецФункции 

Функция СоздатьСтрокуГрафикаПоступлений(Документ) Экспорт
	
	НоваяСтрока 			= Документ.ГрафикПоступлений.Добавить();
	НоваяСтрока.УИДСтроки 	= Новый УникальныйИдентификатор();
	
	// Заполнение по умолчанию
	НоваяСтрока.Период = ТекущаяДата();
	
	Возврат НоваяСтрока.УИДСтроки;
	
КонецФункции  

Процедура УдалитьСтрокуГрафикаПоступлений(Документ, УИДДляУдаления) Экспорт
	
	// 1. Находим строку для удаления в ТЧ объекта
	МассивСтрокДляУдаления 	= Новый Массив;    
	ПараметрыОтбора 		= Новый Структура;
	ПараметрыОтбора.Вставить("УИДСтроки", УИДДляУдаления);
	НайденныеСтроки 		= Документ.ГрафикПоступлений.НайтиСтроки(ПараметрыОтбора);
	
	// 2. Собираем массив для удаления
	Для каждого Строка Из НайденныеСтроки Цикл
		МассивСтрокДляУдаления.Добавить(Строка);
	КонецЦикла;

	// 3. Удаляем строки и связанную детализацию
	Для каждого Строка Из МассивСтрокДляУдаления Цикл
		// Сначала удаляем детализацию
		УдалитьДетализациюПоСтрокеГрафикаПоступлений(Документ, Строка.УИДСтроки);
		// Затем удаляем саму строку графика
		Документ.ГрафикПоступлений.Удалить(Строка);
	КонецЦикла;
	
КонецПроцедуры

Процедура УдалитьСтрокуГрафикаПлатежей(Документ, УИДДляУдаления) Экспорт
	
	// 1. Находим строку для удаления в ТЧ объекта
	МассивСтрокДляУдаления 	= Новый Массив;    
	ПараметрыОтбора 		= Новый Структура;
	ПараметрыОтбора.Вставить("УИДСтроки", УИДДляУдаления);
	НайденныеСтроки 		= Документ.ГрафикПлатежей.НайтиСтроки(ПараметрыОтбора);
	
	// 2. Собираем массив для удаления
	Для каждого Строка Из НайденныеСтроки Цикл
		МассивСтрокДляУдаления.Добавить(Строка);
	КонецЦикла;

	// 3. Удаляем строки и связанную детализацию
	Для каждого Строка Из МассивСтрокДляУдаления Цикл
		// Сначала удаляем детализацию
	//	УдалитьДетализациюПоСтрокеГрафикаПоступлений(Документ, Строка.УИДСтроки);
		// Затем удаляем саму строку графика
		Документ.ГрафикПлатежей.Удалить(Строка);
	КонецЦикла;
	
КонецПроцедуры

Процедура УдалитьДетализациюПоСтрокеГрафикаПоступлений(Документ, УИДСтрокиГрафикаПоступлений) Экспорт
	
	МассивСтрокДляУдаления = Новый Массив;    
	
	// Находим все строки детализации для этой строки графика
	ПараметрыОтбора = Новый Структура;
	ПараметрыОтбора.Вставить("УИДСтрокиГрафикаПоступлений", УИДСтрокиГрафикаПоступлений);
	НайденныеСтроки = Документ.ДетализацияГрафикаПоступлений.НайтиСтроки(ПараметрыОтбора);
	
	// Собираем в массив
	Для каждого Строка Из НайденныеСтроки Цикл
		МассивСтрокДляУдаления.Добавить(Строка);
	КонецЦикла;
	
	// Удаляем
	Для каждого Строка Из МассивСтрокДляУдаления Цикл
		Документ.ДетализацияГрафикаПоступлений.Удалить(Строка);
	КонецЦикла;
	
КонецПроцедуры 

Функция СкопироватьСтрокуГрафикаПлатежей(Документ, УИДДляКопирования) Экспорт
    
    // 1. Находим оригинал
    Отбор = Новый Структура("УИДСтроки", УИДДляКопирования);
    Оригиналы = Документ.ГрафикПлатежей.НайтиСтроки(Отбор);
    
    Если Оригиналы.Количество() = 0 Тогда
        Возврат Неопределено;
    КонецЕсли;
    
    Оригинал = Оригиналы[0];
    
    // 2. Создаём новую строку (используем существующий метод)
    УИДНовойСтроки = СоздатьСтрокуГрафикаПлатежей(Документ);
    
    // 3. Находим только что созданную строку
    ОтборНовый = Новый Структура("УИДСтроки", УИДНовойСтроки);
    НовыеСтроки = Документ.ГрафикПлатежей.НайтиСтроки(ОтборНовый);
    
    Если НовыеСтроки.Количество() = 0 Тогда
        Возврат Неопределено;
    КонецЕсли;
    
    Копия = НовыеСтроки[0];
    
    // 4. Копируем нужные поля
    Копия.СтатьяОборотовБДДС 		= Оригинал.СтатьяОборотовБДДС;
    Копия.МероприятиеПКВ 			= Оригинал.МероприятиеПКВ;
	Копия.ЦФО 						= Оригинал.ЦФО;
	Копия.НазначениеПлатежа 		= Оригинал.НазначениеПлатежа;
	Копия.Комментарии 				= Оригинал.Комментарии;
	
    // ... другие поля которые НУЖНО копировать
	
	Копия.Период 					= ?(Оригинал.Период < НачалоДня(ТекущаяДата()), ТекущаяДата(), Оригинал.Период);	
	
    // 5. ОЧИЩАЕМ 
	//Копия.Период = ТекущаяДата();           	// Очищаем период
    Копия.Сумма = 0;                       		// Очищаем сумму
    //Копия.ПакетнаяОбработка = Ложь;       	// Сбрасываем флаг
    // УИД уже новый (не нужно очищать)
    
    Возврат Копия.УИДСтроки;
    
КонецФункции

Функция СкопироватьСтрокуГрафикаПоступлений(Документ, УИДДляКопирования) Экспорт
    
    // 1. Находим оригинал
    Отбор = Новый Структура("УИДСтроки", УИДДляКопирования);
    Оригиналы = Документ.ГрафикПоступлений.НайтиСтроки(Отбор);
    
    Если Оригиналы.Количество() = 0 Тогда
        Возврат Неопределено;
    КонецЕсли;
    
    Оригинал = Оригиналы[0];
    
    // 2. Создаём новую строку (используем существующий метод)
    УИДНовойСтроки = СоздатьСтрокуГрафикаПоступлений(Документ);
    
    // 3. Находим только что созданную строку
    ОтборНовый = Новый Структура("УИДСтроки", УИДНовойСтроки);
    НовыеСтроки = Документ.ГрафикПоступлений.НайтиСтроки(ОтборНовый);
    
    Если НовыеСтроки.Количество() = 0 Тогда
        Возврат Неопределено;
    КонецЕсли;
    
    Копия = НовыеСтроки[0];
    
    // 4. Копируем нужные поля
    Копия.СтатьяОборотовБДДС = Оригинал.СтатьяОборотовБДДС;
    Копия.МероприятиеПКВ = Оригинал.МероприятиеПКВ;
    // ... другие поля которые НУЖНО копировать
	
	Копия.Период 					= ?(Оригинал.Период < НачалоДня(ТекущаяДата()), ТекущаяДата(), Оригинал.Период);	
    
    // 5. ОЧИЩАЕМ 
	//Копия.Период = ТекущаяДата();           	// Очищаем период
    Копия.Сумма = 0;                       		// Очищаем сумму
    //Копия.ПакетнаяОбработка = Ложь;       	// Сбрасываем флаг
    // УИД уже новый (не нужно очищать)
    
    Возврат Копия.УИДСтроки;
    
КонецФункции

Функция ОбновитьСтрокуГрафикаНаСервере(
										Документ, 
										УИДСтроки, 
										ТЗ) Экспорт

	СтруктураВалидации 	= ПолучитьСтруктуруВалидации();	
	
	// 1. Находим строку в объекте
	Отбор = Новый Структура("УИДСтроки", УИДСтроки);
	НайденныеВОбъекте = Документ.ГрафикПоступлений.НайтиСтроки(Отбор);
	Если НайденныеВОбъекте.Количество() = 0 Тогда
	    Возврат СтруктураВалидации;
	КонецЕсли;
	СтрокаВОбъекте = НайденныеВОбъекте[0];

	НайденныеВ_ТЗ = ТЗ.НайтиСтроки(Отбор);
	Если НайденныеВ_ТЗ.Количество() = 0 Тогда
	    Возврат СтруктураВалидации;
	КонецЕсли;
	СтрокаВТЗ = НайденныеВ_ТЗ[0];
	
	РезультатПроверки = ПроверитьСтрокуГрафикаПоступлений(СтрокаВТЗ);
   	СписокИсключаемыхПолей = СтрСоединить(РезультатПроверки.СписокПолейСОшибками, ",");
	
	ЗаполнитьЗначенияСвойств(СтрокаВОбъекте, СтрокаВТЗ,,СписокИсключаемыхПолей);
	
	Возврат РезультатПроверки;
	
КонецФункции  

Функция ОбновитьСтрокуГрафикаПлатежейНаСервере(
										Документ, 
										УИДСтроки, 
										ТЗ) Экспорт
										
	СтруктураВалидации 	= ПолучитьСтруктуруВалидации();										
										
	// 1. Находим строку в объекте
	Отбор = Новый Структура("УИДСтроки", УИДСтроки);
	НайденныеВОбъекте = Документ.ГрафикПлатежей.НайтиСтроки(Отбор);
	Если НайденныеВОбъекте.Количество() = 0 Тогда
	    Возврат СтруктураВалидации;
	КонецЕсли;
	СтрокаВОбъекте = НайденныеВОбъекте[0];

	НайденныеВ_ТЗ = ТЗ.НайтиСтроки(Отбор);
	Если НайденныеВ_ТЗ.Количество() = 0 Тогда
	    Возврат СтруктураВалидации;
	КонецЕсли;
	СтрокаВТЗ = НайденныеВ_ТЗ[0]; 
	
	РезультатПроверки = ПроверитьСтрокуГрафикаПлатежей(СтрокаВТЗ);
	
	СписокИсключаемыхПолей = СтрСоединить(РезультатПроверки.СписокПолейСОшибками, ",");
	
	ЗаполнитьЗначенияСвойств(СтрокаВОбъекте, СтрокаВТЗ,,СписокИсключаемыхПолей);
	
	Возврат РезультатПроверки;
	
КонецФункции  

Процедура ОбновитьСтрокуДетализацииГрафикаНаСервере(Документ, УИДСтроки, ТЗ) Экспорт
    
	// 1. Находим строку в объекте
	Отбор = Новый Структура("УИДСтроки", УИДСтроки);
	НайденныеВОбъекте = Документ.ДетализацияГрафикаПоступлений.НайтиСтроки(Отбор);
	Если НайденныеВОбъекте.Количество() = 0 Тогда
	    Возврат;
	КонецЕсли;
	СтрокаВОбъекте = НайденныеВОбъекте[0];

	НайденныеВ_ТЗ = ТЗ.НайтиСтроки(Отбор);
	Если НайденныеВ_ТЗ.Количество() = 0 Тогда
	    Возврат;
	КонецЕсли;
	СтрокаВТЗ = НайденныеВ_ТЗ[0];

	ЗаполнитьЗначенияСвойств(СтрокаВОбъекте, СтрокаВТЗ);
    
КонецПроцедуры

Функция ДобавитьПлатежВДетализацию(Документ, УИДСтрокиГрафика) Экспорт
	
	// Создаём новую строку в детализации
	НоваяСтрока = Документ.ДетализацияГрафикаПоступлений.Добавить();
	НоваяСтрока.УИДСтроки = Новый УникальныйИдентификатор();
	НоваяСтрока.УИДСтрокиГрафикаПоступлений = УИДСтрокиГрафика;
	
	// Можно установить значения по умолчанию
	// НоваяСтрока.СуммаПогашено = 0;
	
	Возврат НоваяСтрока.УИДСтроки;
	
КонецФункции

Процедура УдалитьПлатежИзДетализации(Документ, УИДПлатежа) Экспорт
	
	// Находим и удаляем строку
	Отбор = Новый Структура("УИДСтроки", УИДПлатежа);
	НайденныеСтроки = Документ.ДетализацияГрафикаПоступлений.НайтиСтроки(Отбор);
	
	Для Каждого Строка Из НайденныеСтроки Цикл
		Документ.ДетализацияГрафикаПоступлений.Удалить(Строка);
	КонецЦикла; 
	
КонецПроцедуры

#КонецОбласти

#Область Валидация
// ====== СЕКЦИЯ 4: Валидация

Функция ПолучитьСтруктуруВалидации()

	СтруктураВалидации 		= Новый Структура;
    СписокСообщений 		= Новый СписокЗначений;
	СписокПолейСОшибками	= Новый СписокЗначений;
    ВсеХорошо 				= Истина;
	
	СтруктураВалидации.Вставить("СписокСообщений"		, СписокСообщений);
	СтруктураВалидации.Вставить("ВсеХорошо"				, ВсеХорошо);
	СтруктураВалидации.Вставить("СписокПолейСОшибками"	, СписокПолейСОшибками);

	Возврат СтруктураВалидации;

КонецФункции // ПолучитьСтруктуруВалидации()

Функция ОсуществитьВалидациюДокумента(Документ, ТЗ_ГрафикПоступлений, ТЗ_ГрафикПлатежей, ТЗ_нГрафикПлатежей, ТЗ_нГрафикПоступлений) Экспорт

	СтруктураВалидации 	= ПолучитьСтруктуруВалидации(); 
	
	БездоговорнаяСхема 	= ?(ЗначениеЗаполнено(Документ.ДопУсловияПоДоговору.ДоговорКонтрагента), Документ.ДопУсловияПоДоговору.ДоговорКонтрагента._БездоговорнаяСхема, Ложь);
	ДоговорнаяСхема		= Не БездоговорнаяСхема;
	Расходная 			= ?(Документ.ДопУсловияПоДоговору.РасходДоход = Перечисления.бит_РасходДоход.Расходование	, 	Истина, Ложь); 
	Доходная 			= ?(Документ.ДопУсловияПоДоговору.РасходДоход = Перечисления.бит_РасходДоход.Поступление	, 	Истина, Ложь);
	
	Если БездоговорнаяСхема и Расходная Тогда
		ПроверитьЗаполнениеГрафикаПлатежейБ(ТЗ_нГрафикПлатежей, СтруктураВалидации);
	ИначеЕсли БездоговорнаяСхема и Доходная Тогда
		ПроверитьЗаполнениеГрафикаПоступленийБ(ТЗ_нГрафикПоступлений, СтруктураВалидации);
	ИначеЕсли ДоговорнаяСхема и Расходная Тогда
		ПроверитьЗаполнениеГрафикаПлатежей(ТЗ_ГрафикПлатежей, СтруктураВалидации);
	ИначеЕсли ДоговорнаяСхема и Доходная Тогда
		ПроверитьЗаполнениеГрафикаПоступлений(ТЗ_ГрафикПоступлений, СтруктураВалидации);	
	КонецЕсли;
	
	Возврат СтруктураВалидации;

КонецФункции // ()

Функция ПроверитьЗаполнениеГрафикаПоступлений(ТЗ_ГрафикПоступлений, СтруктураВалидации = Неопределено) Экспорт
	
	Если СтруктураВалидации = Неопределено Тогда
		СтруктураВалидации 	= ПолучитьСтруктуруВалидации();
	КонецЕсли;
	
    Для Каждого СтрокаГрафика Из ТЗ_ГрафикПоступлений Цикл
        // 1. Период
        Если НЕ ЗначениеЗаполнено(СтрокаГрафика.Период) Тогда
            СтруктураВалидации.ВсеХорошо = Ложь;
            СтруктураВалидации.СписокСообщений.Добавить("Строка " + СтрокаГрафика.НомерСтрокиДляОтображения + " Графика Поступлений : не заполнен период");
		КонецЕсли; 
		
		//// 1.1 Если строка новая, а период ранее текущей даты
		//Если не значениеЗаполнено(СтрокаГрафика.ДокументПланирования) и НЕ (СтрокаГрафика.Период >= НачалоДня(ТекущаяДата()))  Тогда
		//    СтруктураВалидации.ВсеХорошо = Ложь;
		//    СтруктураВалидации.СписокСообщений.Добавить("Строка " + СтрокаГрафика.НомерСтрокиДляОтображения + " Графика Поступлений : дата поступления должна быть не ранее текущей даты");
		//КонецЕсли;  
        
        // 2. Сумма
        Если СтрокаГрафика.Сумма <= 0 Тогда
            СтруктураВалидации.ВсеХорошо = Ложь;
            СтруктураВалидации.СписокСообщений.Добавить("Строка " + СтрокаГрафика.НомерСтрокиДляОтображения + " Графика Поступлений : сумма должна быть больше 0");
		КонецЕсли;    
		
        Если НЕ ЗначениеЗаполнено(СтрокаГрафика.СтатьяОборотовБДДС) Тогда
            СтруктураВалидации.ВсеХорошо = Ложь;
            СтруктураВалидации.СписокСообщений.Добавить("Строка " + СтрокаГрафика.НомерСтрокиДляОтображения + " Графика Поступлений : не заполнена СтатьяОборотовБДДС");
        КонецЕсли;
		
	КонецЦикла;  
	
	Возврат СтруктураВалидации;
    
КонецФункции

Функция ПроверитьЗаполнениеГрафикаПоступленийБ(ТЗ_нГрафикПоступлений, СтруктураВалидации = Неопределено) Экспорт
	
	Если СтруктураВалидации = Неопределено Тогда
		СтруктураВалидации 	= ПолучитьСтруктуруВалидации();
	КонецЕсли;
	
    Для Каждого СтрокаГрафика Из ТЗ_нГрафикПоступлений Цикл
        // 1. Период
        Если НЕ ЗначениеЗаполнено(СтрокаГрафика.Период) Тогда
            СтруктураВалидации.ВсеХорошо = Ложь;
            СтруктураВалидации.СписокСообщений.Добавить("Строка " + СтрокаГрафика.НомерСтрокиДляОтображения + " Графика Поступлений : не заполнен период");
		КонецЕсли; 
		
		//// 1.1 Если строка новая, а период ранее текущей даты
		//Если не значениеЗаполнено(СтрокаГрафика.ДокументПланирования) и НЕ (СтрокаГрафика.Период >= НачалоДня(ТекущаяДата()))  Тогда
		//    СтруктураВалидации.ВсеХорошо = Ложь;
		//    СтруктураВалидации.СписокСообщений.Добавить("Строка " + СтрокаГрафика.НомерСтрокиДляОтображения + " Графика Поступлений : дата поступления должна быть не ранее текущей даты");
		//КонецЕсли;  
        
        // 2. Сумма
        Если СтрокаГрафика.Сумма <= 0 Тогда
            СтруктураВалидации.ВсеХорошо = Ложь;
            СтруктураВалидации.СписокСообщений.Добавить("Строка " + СтрокаГрафика.НомерСтрокиДляОтображения + " Графика Поступлений : сумма должна быть больше 0");
		КонецЕсли;    
		
        Если НЕ ЗначениеЗаполнено(СтрокаГрафика.СтатьяОборотовБДДС) Тогда
            СтруктураВалидации.ВсеХорошо = Ложь;
            СтруктураВалидации.СписокСообщений.Добавить("Строка " + СтрокаГрафика.НомерСтрокиДляОтображения + " Графика Поступлений : не заполнена СтатьяОборотовБДДС");
        КонецЕсли;
		
	КонецЦикла;  
	
	Возврат СтруктураВалидации;
    
КонецФункции

Функция ПроверитьЗаполнениеГрафикаПлатежей(ТЗ_ГрафикПлатежей, СтруктураВалидации = Неопределено) Экспорт
	
	Если СтруктураВалидации = Неопределено Тогда
		СтруктураВалидации 	= ПолучитьСтруктуруВалидации();
	КонецЕсли;
	
	Для Каждого СтрокаГрафика Из ТЗ_ГрафикПлатежей Цикл
        // 1. Период
        Если НЕ ЗначениеЗаполнено(СтрокаГрафика.Период) Тогда
            СтруктураВалидации.ВсеХорошо = Ложь;
            СтруктураВалидации.СписокСообщений.Добавить("Строка " + СтрокаГрафика.НомерСтрокиДляОтображения + " Графика Платежей : не заполнен период");
		КонецЕсли; 
		
		//// 1.1 Если строка новая, а период ранее текущей даты
		//Если не значениеЗаполнено(СтрокаГрафика.ДокументПланирования) и НЕ (СтрокаГрафика.Период >= НачалоДня(ТекущаяДата()))  Тогда
		//    СтруктураВалидации.ВсеХорошо = Ложь;
		//    СтруктураВалидации.СписокСообщений.Добавить("Строка " + СтрокаГрафика.НомерСтрокиДляОтображения + " Графика Платежей : дата платежа должна быть не ранее текущей даты");
		//КонецЕсли;  
        
        // 2. Сумма
        Если СтрокаГрафика.Сумма <= 0 Тогда
            СтруктураВалидации.ВсеХорошо = Ложь;
            СтруктураВалидации.СписокСообщений.Добавить("Строка " + СтрокаГрафика.НомерСтрокиДляОтображения + " Графика Платежей : сумма должна быть больше 0");
		КонецЕсли;    
		
        Если НЕ ЗначениеЗаполнено(СтрокаГрафика.СтатьяОборотовБДДС) Тогда
            СтруктураВалидации.ВсеХорошо = Ложь;
            СтруктураВалидации.СписокСообщений.Добавить("Строка " + СтрокаГрафика.НомерСтрокиДляОтображения + " Графика Платежей : не заполнена СтатьяОборотовБДДС");
		КонецЕсли;
		
       	Если НЕ ЗначениеЗаполнено(СтрокаГрафика.ЦФО) Тогда
            СтруктураВалидации.ВсеХорошо = Ложь;
            СтруктураВалидации.СписокСообщений.Добавить("Строка " + СтрокаГрафика.НомерСтрокиДляОтображения + " Графика Платежей : не заполнено ЦФО");
        КонецЕсли;		
		
	КонецЦикла; 
	
	Возврат СтруктураВалидации;
    
КонецФункции
	
Функция ПроверитьЗаполнениеГрафикаПлатежейБ(ТЗ_нГрафикПлатежей, СтруктураВалидации = Неопределено) Экспорт
	
	Если СтруктураВалидации = Неопределено Тогда
		СтруктураВалидации 	= ПолучитьСтруктуруВалидации();
	КонецЕсли;
	
	Для Каждого СтрокаГрафика Из ТЗ_нГрафикПлатежей Цикл
        // 1. Период
        Если НЕ ЗначениеЗаполнено(СтрокаГрафика.Период) Тогда
            СтруктураВалидации.ВсеХорошо = Ложь;
            СтруктураВалидации.СписокСообщений.Добавить("Строка " + СтрокаГрафика.НомерСтрокиДляОтображения + " Графика Платежей : не заполнен период");
		КонецЕсли; 
		
		//// 1.1 Если строка новая, а период ранее текущей даты
		//Если не значениеЗаполнено(СтрокаГрафика.ДокументПланирования) и НЕ (СтрокаГрафика.Период >= НачалоДня(ТекущаяДата()))  Тогда
		//    СтруктураВалидации.ВсеХорошо = Ложь;
		//    СтруктураВалидации.СписокСообщений.Добавить("Строка " + СтрокаГрафика.НомерСтрокиДляОтображения + " Графика Платежей : дата платежа должна быть не ранее текущей даты");
		//КонецЕсли;  
        
        // 2. Сумма
        Если СтрокаГрафика.Сумма <= 0 Тогда
            СтруктураВалидации.ВсеХорошо = Ложь;
            СтруктураВалидации.СписокСообщений.Добавить("Строка " + СтрокаГрафика.НомерСтрокиДляОтображения + " Графика Платежей : сумма должна быть больше 0");
		КонецЕсли;    
		
        Если НЕ ЗначениеЗаполнено(СтрокаГрафика.СтатьяОборотовБДДС) Тогда
            СтруктураВалидации.ВсеХорошо = Ложь;
            СтруктураВалидации.СписокСообщений.Добавить("Строка " + СтрокаГрафика.НомерСтрокиДляОтображения + " Графика Платежей : не заполнена СтатьяОборотовБДДС");
		КонецЕсли;
		
       	Если НЕ ЗначениеЗаполнено(СтрокаГрафика.ЦФО) Тогда
            СтруктураВалидации.ВсеХорошо = Ложь;
            СтруктураВалидации.СписокСообщений.Добавить("Строка " + СтрокаГрафика.НомерСтрокиДляОтображения + " Графика Платежей : не заполнено ЦФО");
        КонецЕсли;		
		
	КонецЦикла;
	
	Возврат СтруктураВалидации;
    
КонецФункции

Функция ПроверитьСтрокуГрафикаПлатежей(Строка)

	СтруктураВалидации 	= ПолучитьСтруктуруВалидации();
	
    Если Строка.Период < НачалоДня(ТекущаяДата()) Тогда
        СтруктураВалидации.ВсеХорошо = Ложь;
        СтруктураВалидации.СписокСообщений.Добавить("Строка " + Строка.НомерСтрокиДляОтображения + " Графика Платежей : запрещено указывать даты в прошлом");
		Если СтруктураВалидации.СписокПолейСОшибками.НайтиПоЗначению("Период") = Неопределено Тогда
			СтруктураВалидации.СписокПолейСОшибками.Добавить("Период"); 
		КонецЕсли;
    КонецЕсли;
	
	Возврат СтруктураВалидации;

КонецФункции // ()   

Функция ПроверитьСтрокуГрафикаПоступлений(Строка)

	СтруктураВалидации 	= ПолучитьСтруктуруВалидации();
	
    Если Строка.Период < НачалоДня(ТекущаяДата()) Тогда
        СтруктураВалидации.ВсеХорошо = Ложь;
        СтруктураВалидации.СписокСообщений.Добавить("Строка " + Строка.НомерСтрокиДляОтображения + " Графика Поступлений : запрещено указывать даты в прошлом");
		Если СтруктураВалидации.СписокПолейСОшибками.НайтиПоЗначению("Период") = Неопределено Тогда
			СтруктураВалидации.СписокПолейСОшибками.Добавить("Период"); 
		КонецЕсли;
    КонецЕсли;
	
	Возврат СтруктураВалидации;

КонецФункции // ()

#КонецОбласти

//ОПИСАНИЕ: ПОСТУПЛЕНИЕ ДЕНЕЖНЫХ СРЕДСТВ, ТРЕХЭТАПНАЯ МОДЕЛЬ ДВИЖЕНИЙ ПО РЕГИСТРАМ
#Область Описание

// ============================================================================
// ПОСТУПЛЕНИЕ ДЕНЕЖНЫХ СРЕДСТВ: ТРЕХЭТАПНАЯ МОДЕЛЬ ДВИЖЕНИЙ ПО РЕГИСТРАМ
// ============================================================================
//
// 1. ПЛАН (ДокументПрогнозирования / "План исполнения договора")
//    Действие: Создаёт движения "Должны получить по договору"
//    Статус: Исходный план (что должно быть)
//    Пример: "По договору №123 должны получить 100к в январе"
//
// 2. ПРОГНОЗ ПОСТУПЛЕНИЯ (бит_ПланируемоеПоступлениеДенежныхСредств / "Планируемое поступление")
//    Действие: 
//      - СТОРНО движений п.1 (полностью вытесняет исходный план)
//      - Создаёт новые движения "Планируем получить фактически"
//    Статус: Утверждённый прогноз (как планируем получить)
//    Пример: "Планируем получить эти 100к 15 января на счёт XXX"
//
// 3. ФАКТ ПОСТУПЛЕНИЯ (привязка платежек в ДокументПрогнозирования)
//    Действие: 
//      - СТОРНО движений п.2 на сумму пришедших денег (погашение)
//      - Остаток движений п.2 остаётся активным (непогашенный прогноз)
//      - Движения п.1 сохраняются как история (не удаляются)
//    Статус: Фактическое поступление (что реально пришло)
//    Пример: "Фактически пришло 80к 20 января, осталось ожидать 20к"
//
// ВИЗУАЛИЗАЦИЯ РЕГИСТРА:
// ┌─────────────────────────────────────────────────────────────┐
// │ Движение 1: +100к (План)                                    │
// │ Движение 2: -100к (Сторно Плана)                            │
// │ Движение 3: +100к (Прогноз)                                 │
// │ Движение 4: -80к  (Сторно Прогноза)                         │
// │ Остаток в регистре: +20к (непогашенный прогноз)             │
// └─────────────────────────────────────────────────────────────┘
//
// КЛЮЧЕВЫЕ ПРИНЦИПЫ:
// - ИСТОРИЯ: Движения п.1 сохраняются для "аудита"
// - ЗАМЕЩЕНИЕ: п.2 полностью вытесняет п.1 (не дополняет)
// - ЧАСТИЧНОЕ ПОГАШЕНИЕ: п.3 может погасить п.2 частично
// - FIFO: Старые прогнозы погашаются первыми
//
// ============================================================================
// Киблицкий Денис, 17.12.2025
// ============================================================================

#КонецОбласти

#Область РаботаСРегистрами

Процедура ДобавитьВДвиженияПланируемогоРасходаСторноПоСтрокеГрафикаПлатежей (ТаблицаДвижений, ДокументПрогнозированияСсылка, УИДСтрокиГрафикаПлатежей) Экспорт
	
	Если НЕ ТипЗнч(ДокументПрогнозированияСсылка) = тип("ДокументСсылка._ДокументПрогнозирования") Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		//"ВЫБРАТЬ
		//|	бит_ПланируемыйРасходДенежныхСредств.Период,
		//|	бит_ПланируемыйРасходДенежныхСредств.Регистратор,
		//|	бит_ПланируемыйРасходДенежныхСредств.НомерСтроки,
		//|	бит_ПланируемыйРасходДенежныхСредств.Активность,
		//|	бит_ПланируемыйРасходДенежныхСредств.ВидДвижения,
		//|	бит_ПланируемыйРасходДенежныхСредств.Организация,
		//|	бит_ПланируемыйРасходДенежныхСредств.ВидДенежныхСредств,
		//|	бит_ПланируемыйРасходДенежныхСредств.Валюта,
		//|	бит_ПланируемыйРасходДенежныхСредств.ДокументПланирования,
		//|	бит_ПланируемыйРасходДенежныхСредств.ЦФО,
		//|	бит_ПланируемыйРасходДенежныхСредств.СтатьяОборотов,
		//|	бит_ПланируемыйРасходДенежныхСредств.Проект,
		//|	бит_ПланируемыйРасходДенежныхСредств.НоменклатурнаяГруппа,
		//|	бит_ПланируемыйРасходДенежныхСредств.Контрагент,
		//|	бит_ПланируемыйРасходДенежныхСредств.ДоговорКонтрагента,
		//|	бит_ПланируемыйРасходДенежныхСредств.БанковскийСчет,
		//|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_1,
		//|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_2,
		//|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_3,
		//|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_4,
		//|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_5,
		//|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_6,
		//|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_7,
		//|	бит_ПланируемыйРасходДенежныхСредств._СуммаБезНДС,
		//|	бит_ПланируемыйРасходДенежныхСредств._СуммаНДС,
		//|	бит_ПланируемыйРасходДенежныхСредств.Сумма,
		//|	бит_ПланируемыйРасходДенежныхСредств.СуммаРегл,
		//|	бит_ПланируемыйРасходДенежныхСредств.СуммаУпр,
		//|	бит_ПланируемыйРасходДенежныхСредств.СуммаВзаиморасчеты,
		//|	бит_ПланируемыйРасходДенежныхСредств._УИДСтрокиДокументаПрогнозирования,
		//|	бит_ПланируемыйРасходДенежныхСредств._БездоговорнаяСхема
		//|ИЗ
		//|	РегистрНакопления.бит_ПланируемыйРасходДенежныхСредств КАК бит_ПланируемыйРасходДенежныхСредств
		//|ГДЕ
		//|	бит_ПланируемыйРасходДенежныхСредств.Регистратор = &ДокументПрогнозированияСсылка  
		//|	И бит_ПланируемыйРасходДенежныхСредств.Активность = ИСТИНА
		//|	И бит_ПланируемыйРасходДенежныхСредств._УИДСтрокиДокументаПрогнозирования = &УИДСтрокиДокументаПрогнозирования";
		"ВЫБРАТЬ
		|	бит_ПланируемыйРасходДенежныхСредств.Период,
		|	бит_ПланируемыйРасходДенежныхСредств.Активность,
		|	бит_ПланируемыйРасходДенежныхСредств.ВидДвижения,
		|	бит_ПланируемыйРасходДенежныхСредств.Организация,
		|	бит_ПланируемыйРасходДенежныхСредств.ВидДенежныхСредств,
		|	бит_ПланируемыйРасходДенежныхСредств.Валюта,
		|	бит_ПланируемыйРасходДенежныхСредств.ДокументПланирования,
		|	бит_ПланируемыйРасходДенежныхСредств.ЦФО,
		|	бит_ПланируемыйРасходДенежныхСредств._Инициатор,		
		|	бит_ПланируемыйРасходДенежныхСредств.СтатьяОборотов,
		|	бит_ПланируемыйРасходДенежныхСредств.Проект,
		|	бит_ПланируемыйРасходДенежныхСредств.НоменклатурнаяГруппа,
		|	бит_ПланируемыйРасходДенежныхСредств.Контрагент,
		|	бит_ПланируемыйРасходДенежныхСредств.ДоговорКонтрагента,
		|	бит_ПланируемыйРасходДенежныхСредств.БанковскийСчет,
		|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_1,
		|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_2,
		|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_3,
		|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_4,
		|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_5,
		|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_6,
		|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_7,
		|	СУММА(бит_ПланируемыйРасходДенежныхСредств._СуммаБезНДС) КАК _СуммаБезНДС,
		|	СУММА(бит_ПланируемыйРасходДенежныхСредств._СуммаНДС) КАК _СуммаНДС,
		|	СУММА(бит_ПланируемыйРасходДенежныхСредств.Сумма) КАК Сумма,
		|	СУММА(бит_ПланируемыйРасходДенежныхСредств.СуммаРегл) КАК СуммаРегл,
		|	СУММА(бит_ПланируемыйРасходДенежныхСредств.СуммаУпр) КАК СуммаУпр,
		|	СУММА(бит_ПланируемыйРасходДенежныхСредств.СуммаВзаиморасчеты) КАК СуммаВзаиморасчеты,
		|	бит_ПланируемыйРасходДенежныхСредств._УИДСтрокиДокументаПрогнозирования,
		|	бит_ПланируемыйРасходДенежныхСредств._БездоговорнаяСхема
		|ИЗ
		|	РегистрНакопления.бит_ПланируемыйРасходДенежныхСредств КАК бит_ПланируемыйРасходДенежныхСредств
		|ГДЕ
		|	бит_ПланируемыйРасходДенежныхСредств.ДокументПланирования ССЫЛКА Документ._ДокументПрогнозирования
		|	И НЕ бит_ПланируемыйРасходДенежныхСредств.Регистратор ССЫЛКА Документ.бит_ЗаявкаНаРасходованиеСредствОбщая
		|	И бит_ПланируемыйРасходДенежныхСредств.Активность = ИСТИНА
		|	И бит_ПланируемыйРасходДенежныхСредств._УИДСтрокиДокументаПрогнозирования = &УИДСтрокиДокументаПрогнозирования
		|
		|СГРУППИРОВАТЬ ПО
		|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_7,
		|	бит_ПланируемыйРасходДенежныхСредств.Период,
		|	бит_ПланируемыйРасходДенежныхСредств.Активность,
		|	бит_ПланируемыйРасходДенежныхСредств._УИДСтрокиДокументаПрогнозирования,
		|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_6,
		|	бит_ПланируемыйРасходДенежныхСредств._БездоговорнаяСхема,
		|	бит_ПланируемыйРасходДенежныхСредств.Организация,
		|	бит_ПланируемыйРасходДенежныхСредств.ВидДенежныхСредств,
		|	бит_ПланируемыйРасходДенежныхСредств.ВидДвижения,
		|	бит_ПланируемыйРасходДенежныхСредств.Валюта,
		|	бит_ПланируемыйРасходДенежныхСредств.ДокументПланирования,
		|	бит_ПланируемыйРасходДенежныхСредств.ЦФО,
		|	бит_ПланируемыйРасходДенежныхСредств._Инициатор,		
		|	бит_ПланируемыйРасходДенежныхСредств.СтатьяОборотов,
		|	бит_ПланируемыйРасходДенежныхСредств.Проект,
		|	бит_ПланируемыйРасходДенежныхСредств.НоменклатурнаяГруппа,
		|	бит_ПланируемыйРасходДенежныхСредств.Контрагент,
		|	бит_ПланируемыйРасходДенежныхСредств.ДоговорКонтрагента,
		|	бит_ПланируемыйРасходДенежныхСредств.БанковскийСчет,
		|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_1,
		|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_2,
		|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_3,
		|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_4,
		|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_5
		|
		|ИМЕЮЩИЕ
		|	(СУММА(бит_ПланируемыйРасходДенежныхСредств._СуммаБезНДС) <> 0
		|		ИЛИ СУММА(бит_ПланируемыйРасходДенежныхСредств._СуммаНДС) <> 0
		|		ИЛИ СУММА(бит_ПланируемыйРасходДенежныхСредств.Сумма) <> 0
		|		ИЛИ СУММА(бит_ПланируемыйРасходДенежныхСредств.СуммаРегл) <> 0
		|		ИЛИ СУММА(бит_ПланируемыйРасходДенежныхСредств.СуммаУпр) <> 0
		|		ИЛИ СУММА(бит_ПланируемыйРасходДенежныхСредств.СуммаВзаиморасчеты) <> 0)
		|";
		Запрос.Параметры.Вставить("УИДСтрокиДокументаПрогнозирования", УИДСтрокиГрафикаПлатежей); 
	
	//Запрос.УстановитьПараметр("ДокументПрогнозированияСсылка", 		ДокументПрогнозированияСсылка); 
	//Запрос.УстановитьПараметр("УИДСтрокиДокументаПрогнозирования", 	УИДСтрокиГрафикаПлатежей);
	
	ТаблицаДвиженийДокументаОснования = Запрос.Выполнить().Выгрузить(); 
	
	Для каждого СтрокаДвиженияОснования Из ТаблицаДвиженийДокументаОснования Цикл 
		
		СтрокаДвижений = ТаблицаДвижений.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаДвижений, СтрокаДвиженияОснования,, "Активность");

		СтрокаДвижений._СуммаБезНДС			= -СтрокаДвижений._СуммаБезНДС;
		СтрокаДвижений._СуммаНДС 			= -СтрокаДвижений._СуммаНДС;
		СтрокаДвижений.Сумма 				= -СтрокаДвижений.Сумма;
		СтрокаДвижений.СуммаРегл 			= -СтрокаДвижений.СуммаРегл;
		СтрокаДвижений.СуммаУпр 			= -СтрокаДвижений.СуммаУпр;
		СтрокаДвижений.СуммаВзаиморасчеты 	= -СтрокаДвижений.СуммаВзаиморасчеты;
		
	КонецЦикла;

КонецПроцедуры

Процедура ДобавитьВДвиженияПланируемогоПоступленияСторноПоСтрокеГрафикаПоступлений (ТаблицаДвижений, ДокументПрогнозированияСсылка, УИДСтрокиГрафикаПлатежей) Экспорт

	Если НЕ ТипЗнч(ДокументПрогнозированияСсылка) = тип("ДокументСсылка._ДокументПрогнозирования") Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	//	"ВЫБРАТЬ
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.Период,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.Регистратор,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.НомерСтроки,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.Активность,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.Организация,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.ВидДенежныхСредств,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.Валюта,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.ДокументПланирования,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.ЦФО,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.СтатьяОборотов,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.Проект,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.НоменклатурнаяГруппа,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.Контрагент,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.ДоговорКонтрагента,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.БанковскийСчет,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_1,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_2,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_3,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_4,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_5,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_6,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_7,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.Сумма,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.СуммаРегл,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.СуммаУпр,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.СуммаВзаиморасчеты,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.СтрокаИД,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств._УИДСтрокиДокументаПрогнозирования,
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств._БездоговорнаяСхема
	//	|ИЗ
	//	|	РегистрНакопления.бит_ПланируемоеПоступлениеДенежныхСредств КАК бит_ПланируемоеПоступлениеДенежныхСредств
	//	|ГДЕ
	//	|	бит_ПланируемоеПоступлениеДенежныхСредств.Регистратор = &ДокументПрогнозированияСсылка
	//	|	И бит_ПланируемоеПоступлениеДенежныхСредств.Регистратор = бит_ПланируемоеПоступлениеДенежныхСредств.ДокументПланирования
	//	|	И бит_ПланируемоеПоступлениеДенежныхСредств._УИДСтрокиДокументаПрогнозирования = &_УИДСтрокиДокументаПрогнозирования
	//	|	И бит_ПланируемоеПоступлениеДенежныхСредств.Активность = ИСТИНА";
	//
	//Запрос.УстановитьПараметр("ДокументПрогнозированияСсылка", 			ДокументПрогнозированияСсылка); 
	//Запрос.УстановитьПараметр("_УИДСтрокиДокументаПрогнозирования", 	УИДСтрокиГрафикаПлатежей);
		"ВЫБРАТЬ
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Активность,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Период,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Организация,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.ВидДенежныхСредств,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Валюта,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.ДокументПланирования,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.ЦФО,
		|	бит_ПланируемоеПоступлениеДенежныхСредств._Инициатор,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.СтатьяОборотов,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Проект,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.НоменклатурнаяГруппа,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Контрагент,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.ДоговорКонтрагента,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.БанковскийСчет,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_1,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_2,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_3,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_4,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_5,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_6,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_7,
		|	СУММА(бит_ПланируемоеПоступлениеДенежныхСредств.Сумма) КАК Сумма,
		|	СУММА(бит_ПланируемоеПоступлениеДенежныхСредств.СуммаРегл) КАК СуммаРегл,
		|	СУММА(бит_ПланируемоеПоступлениеДенежныхСредств.СуммаУпр) КАК СуммаУпр,
		|	СУММА(бит_ПланируемоеПоступлениеДенежныхСредств.СуммаВзаиморасчеты) КАК СуммаВзаиморасчеты,
		|	бит_ПланируемоеПоступлениеДенежныхСредств._УИДСтрокиДокументаПрогнозирования,
		|	бит_ПланируемоеПоступлениеДенежныхСредств._БездоговорнаяСхема
		|ИЗ
		|	РегистрНакопления.бит_ПланируемоеПоступлениеДенежныхСредств КАК бит_ПланируемоеПоступлениеДенежныхСредств
		|ГДЕ
		//|	  (
		|бит_ПланируемоеПоступлениеДенежныхСредств.ДокументПланирования ССЫЛКА Документ._ДокументПрогнозирования и не Регистратор ссылка Документ.бит_ПланируемоеПоступлениеДенежныхСредств
		//|			ИЛИ 
		//|		(бит_ПланируемоеПоступлениеДенежныхСредств.Регистратор ССЫЛКА Документ._ЗакрытиеПлановИсполненияБюджетов и не ДокументПланирования ссылка Документ.бит_ПланируемоеПоступлениеДенежныхСредств)
		//|   )
		|	И бит_ПланируемоеПоступлениеДенежныхСредств._УИДСтрокиДокументаПрогнозирования = &_УИДСтрокиДокументаПрогнозирования
		|	И бит_ПланируемоеПоступлениеДенежныхСредств.Активность = ИСТИНА
		|
		|СГРУППИРОВАТЬ ПО
		|	бит_ПланируемоеПоступлениеДенежныхСредств.ЦФО,
		|	бит_ПланируемоеПоступлениеДенежныхСредств._Инициатор,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Период,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.ДоговорКонтрагента,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Организация,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.СтатьяОборотов,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.ДокументПланирования,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.ВидДенежныхСредств,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_6,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Валюта,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Активность,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Проект,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Контрагент,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.СтрокаИД,
		|	бит_ПланируемоеПоступлениеДенежныхСредств._УИДСтрокиДокументаПрогнозирования,
		|	бит_ПланируемоеПоступлениеДенежныхСредств._БездоговорнаяСхема,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.НоменклатурнаяГруппа,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_7,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_5,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_4,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_3,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_2,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.БанковскийСчет,
		|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_1
		|
		|ИМЕЮЩИЕ
		|	(СУММА(бит_ПланируемоеПоступлениеДенежныхСредств.Сумма) <> 0
		|		ИЛИ СУММА(бит_ПланируемоеПоступлениеДенежныхСредств.СуммаРегл) <> 0
		|		ИЛИ СУММА(бит_ПланируемоеПоступлениеДенежныхСредств.СуммаУпр) <> 0
		|		ИЛИ СУММА(бит_ПланируемоеПоступлениеДенежныхСредств.СуммаВзаиморасчеты) <> 0)
		|";
	Запрос.Параметры.Вставить("_УИДСтрокиДокументаПрогнозирования", УИДСтрокиГрафикаПлатежей); 
	
	ТаблицаДвиженийДокументаОснования = Запрос.Выполнить().Выгрузить(); 
	
	Для каждого СтрокаДвиженияОснования Из ТаблицаДвиженийДокументаОснования Цикл 
		
		СтрокаДвижений = ТаблицаДвижений.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаДвижений, СтрокаДвиженияОснования,, "Активность");
		//СтрокаДвижений.Период				= НачалоДня(ДокументПрогнозированияСсылка.Дата);
		СтрокаДвижений.Сумма 				= -СтрокаДвижений.Сумма;
		СтрокаДвижений.СуммаРегл 			= -СтрокаДвижений.СуммаРегл;
		СтрокаДвижений.СуммаУпр 			= -СтрокаДвижений.СуммаУпр;
		СтрокаДвижений.СуммаВзаиморасчеты 	= -СтрокаДвижений.СуммаВзаиморасчеты;
		
	КонецЦикла;

КонецПроцедуры

Функция ПодготовитьТаблицуДвиженийДляПогашенияГрафикаПоступлений(ТаблицаДвижений, СтруктураПараметры) Экспорт

	СтруктураРезультат 	= Новый Структура; 
	СписокСообщений 	= Новый СписокЗначений;

	ВсеХорошо = Истина;
	
	
	Объект 			= СтруктураПараметры.Объект;
	ТЗГрафик 		= Объект.ГрафикПоступлений.Выгрузить();
	ТЗДетализация   = Объект.ДетализацияГрафикаПоступлений.Выгрузить(); 
	
	Для каждого СтрокаГрафика Из ТЗГрафик Цикл  
		
		// 1. Сумма погашения по этой строке графика
		СуммаПогашения = РассчитатьФактПоГрафику(Объект, СтрокаГрафика.УИДСтроки); 
		
		Если СуммаПогашения = 0 Тогда
			Продолжить;
		КонецЕсли;
		
		// 2. Получаем активные записи регистра для этого УИД 
		//Записи для сторно расположены в хронологическом порядке, что обеспечивает FIFO, как и хотели
		
		ЗаписиДляСторнирования = ПолучитьЗаписиОстатковПоПлановымДоходамПоУИД(СтрокаГрафика.УИДСтроки);
		Если ЗаписиДляСторнирования.Количество() = 0 Тогда
			// Нет записей для сторнирования
			Продолжить;
		КонецЕсли;
		
		// 3. Сторнируем записи, пока не исчерпаем сумму погашения
		ОстатокДляСторнирования = СуммаПогашения;
		Для каждого ЗаписьРегистра Из ЗаписиДляСторнирования Цикл  
			
			Если ОстатокДляСторнирования <= 0 Тогда
				Прервать;
			КонецЕсли;
			
			// Сумма для сторнирования из этой записи
			СуммаВЗаписи = ЗаписьРегистра.Сумма;
			СуммаСторно = Мин(СуммаВЗаписи, ОстатокДляСторнирования);
			
			// 4. Добавляем движение на сторнирование
			Движение = ТаблицаДвижений.Добавить();
			
			//Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
			//Движение.Период = ТекущаяДата(); 	// или дата документа
			Движение.Активность = Истина; 		// Сторнируем
			
			// Копируем все измерения из записи регистра
			ЗаполнитьЗначенияСвойств(Движение, ЗаписьРегистра);
			
			// Устанавливаем сумму сторно
			Движение.Сумма 				= -СуммаСторно; // Отрицательная сумма для сторно
			Движение.СуммаРегл			= -СуммаСторно; 
			Движение.СуммаУпр			= -СуммаСторно; 
			Движение.СуммаВзаиморасчеты	= -СуммаСторно; 
			
			// Уменьшаем остаток
			ОстатокДляСторнирования = ОстатокДляСторнирования - СуммаСторно;
			
		КонецЦикла;
		
		// Проверяем, что вся сумма погашена
		Если ОстатокДляСторнирования > 0 Тогда
			// Ошибка: сумма погашения больше, чем доступно в регистре
			ВсеХорошо = Ложь;
			СписокСообщений.Добавить("Для строки графика УИД=" + СтрокаГрафика.УИДСтроки + 
									" сумма погашения (" + СуммаПогашения + 
									") превышает остаток в регистре");
		КонецЕсли;
		
	КонецЦикла; 
	
	СтруктураРезультат.Вставить("ВсеХорошо", 		ВсеХорошо);
	СтруктураРезультат.Вставить("СписокСообщений", 	СписокСообщений);
	
	Возврат СтруктураРезультат;

КонецФункции

Функция ПолучитьЗаписиОстатковПоПлановымДоходамПоУИД(УИДСтроки)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Период КАК Период,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Организация,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.ВидДенежныхСредств,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Валюта,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.ДокументПланирования,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.ЦФО,
	|	бит_ПланируемоеПоступлениеДенежныхСредств._Инициатор,
	|	бит_ПланируемоеПоступлениеДенежныхСредств._инициатор,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.СтатьяОборотов,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Проект,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.НоменклатурнаяГруппа,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Контрагент,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.ДоговорКонтрагента,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.БанковскийСчет,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_1,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_2,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_3,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_4,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_5,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_6,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_7,
	|	СУММА(бит_ПланируемоеПоступлениеДенежныхСредств.Сумма) КАК Сумма,
	|	бит_ПланируемоеПоступлениеДенежныхСредств._УИДСтрокиДокументаПрогнозирования,
	|	бит_ПланируемоеПоступлениеДенежныхСредств._БездоговорнаяСхема
	|ИЗ
	|	РегистрНакопления.бит_ПланируемоеПоступлениеДенежныхСредств КАК бит_ПланируемоеПоступлениеДенежныхСредств
	|ГДЕ
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Активность = ИСТИНА
	|	И бит_ПланируемоеПоступлениеДенежныхСредств._УИДСтрокиДокументаПрогнозирования = &УИДСтрокиГрафикаПоступлений
	|	И бит_ПланируемоеПоступлениеДенежныхСредств.Регистратор ССЫЛКА Документ.бит_ПланируемоеПоступлениеДенежныхСредств
	|	И бит_ПланируемоеПоступлениеДенежныхСредств.ДокументПланирования ССЫЛКА Документ.бит_ПланируемоеПоступлениеДенежныхСредств
	|
	|СГРУППИРОВАТЬ ПО
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_3,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_1,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_4,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.НоменклатурнаяГруппа,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_6,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Контрагент,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_2,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.ДоговорКонтрагента,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_5,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.БанковскийСчет,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Аналитика_7,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.СтатьяОборотов,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.ЦФО,
	|	бит_ПланируемоеПоступлениеДенежныхСредств._Инициатор,
	|	бит_ПланируемоеПоступлениеДенежныхСредств._инициатор,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.ДокументПланирования,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Проект,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.ВидДенежныхСредств,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Валюта,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Период,
	|	бит_ПланируемоеПоступлениеДенежныхСредств.Организация,
	|	бит_ПланируемоеПоступлениеДенежныхСредств._УИДСтрокиДокументаПрогнозирования,
	|	бит_ПланируемоеПоступлениеДенежныхСредств._БездоговорнаяСхема
	|
	|УПОРЯДОЧИТЬ ПО
	|	Период";
	Запрос.Параметры.Вставить("УИДСтрокиГрафикаПоступлений", УИДСтроки); 	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции 

Процедура СторнироватьПланируемыйРасходДС_ДокументаПланированияБездоговорнаяСхема(ЗаявкаНаРасходованиеСредств) Экспорт
	
	Если НЕ ЗначениеЗаполнено(ЗаявкаНаРасходованиеСредств) Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ЗаявкаНаРасходованиеСредств.ДокументОснование) Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ТипЗнч(ЗаявкаНаРасходованиеСредств.ДокументОснование) = ТИП("ДокументСсылка.бит_ЗаявкаНаРасходованиеСредствОбщая") Тогда
		Возврат;
	КонецЕсли;
	
	ДокументПланирования = ЗаявкаНаРасходованиеСредств.ДокументОснование;
	УИДСтрокиДокументаПрогнозирования = ДокументПланирования._УИДСтрокиДокументаОснования;
	
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	//	"ВЫБРАТЬ
	//	|	бит_ПланируемыйРасходДенежныхСредств.Период,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Регистратор,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Активность,
	//	|	бит_ПланируемыйРасходДенежныхСредств.ВидДвижения,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Организация,
	//	|	бит_ПланируемыйРасходДенежныхСредств.ВидДенежныхСредств,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Валюта,
	//	|	бит_ПланируемыйРасходДенежныхСредств.ДокументПланирования,
	//	|	бит_ПланируемыйРасходДенежныхСредств.ЦФО,
	//	|	бит_ПланируемыйРасходДенежныхСредств.СтатьяОборотов,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Проект,
	//	|	бит_ПланируемыйРасходДенежныхСредств.НоменклатурнаяГруппа,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Контрагент,
	//	|	бит_ПланируемыйРасходДенежныхСредств.ДоговорКонтрагента,
	//	|	бит_ПланируемыйРасходДенежныхСредств.БанковскийСчет,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_1,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_2,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_3,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_4,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_5,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_6,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_7,
	//	|	-СУММА(бит_ПланируемыйРасходДенежныхСредств._СуммаБезНДС) КАК _СуммаБезНДС,
	//	|	-СУММА(бит_ПланируемыйРасходДенежныхСредств._СуммаНДС) КАК _СуммаНДС,
	//	|	-СУММА(бит_ПланируемыйРасходДенежныхСредств.Сумма) КАК Сумма,
	//	|	-СУММА(бит_ПланируемыйРасходДенежныхСредств.СуммаРегл) КАК СуммаРегл,
	//	|	-СУММА(бит_ПланируемыйРасходДенежныхСредств.СуммаУпр) КАК СуммаУпр,
	//	|	-СУММА(бит_ПланируемыйРасходДенежныхСредств.СуммаВзаиморасчеты) КАК СуммаВзаиморасчеты,
	//	|	бит_ПланируемыйРасходДенежныхСредств._УИДСтрокиДокументаПрогнозирования,
	//	|	бит_ПланируемыйРасходДенежныхСредств._БездоговорнаяСхема
	//	|ИЗ
	//	|	РегистрНакопления.бит_ПланируемыйРасходДенежныхСредств КАК бит_ПланируемыйРасходДенежныхСредств
	//	|ГДЕ
	//	|	бит_ПланируемыйРасходДенежныхСредств._УИДСтрокиДокументаПрогнозирования = &_УИДСтрокиДокументаПрогнозирования
	//	|	И бит_ПланируемыйРасходДенежныхСредств.ДокументПланирования = бит_ПланируемыйРасходДенежныхСредств.Регистратор
	//	|	и Активность = Истина
	//	|
	//	|СГРУППИРОВАТЬ ПО
	//	|	бит_ПланируемыйРасходДенежныхСредств.Контрагент,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_1,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_2,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_3,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_4,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_5,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_6,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_7,
	//	|	бит_ПланируемыйРасходДенежныхСредств._УИДСтрокиДокументаПрогнозирования,
	//	|	бит_ПланируемыйРасходДенежныхСредств.ВидДенежныхСредств,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Регистратор,
	//	|	бит_ПланируемыйРасходДенежныхСредств.ЦФО,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Организация,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Активность,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Валюта,
	//	|	бит_ПланируемыйРасходДенежныхСредств.ВидДвижения,
	//	|	бит_ПланируемыйРасходДенежныхСредств.СтатьяОборотов,
	//	|	бит_ПланируемыйРасходДенежныхСредств.НоменклатурнаяГруппа,
	//	|	бит_ПланируемыйРасходДенежныхСредств.ДокументПланирования,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Период,
	//	|	бит_ПланируемыйРасходДенежныхСредств.Проект,
	//	|	бит_ПланируемыйРасходДенежныхСредств.ДоговорКонтрагента,
	//	|	бит_ПланируемыйРасходДенежныхСредств.БанковскийСчет,
	//	|	бит_ПланируемыйРасходДенежныхСредств._БездоговорнаяСхема";

	//Запрос.Параметры.Вставить("_УИДСтрокиДокументаПрогнозирования", УИДСтрокиДокументаПрогнозирования); 
		"ВЫБРАТЬ
		|			бит_ПланируемыйРасходДенежныхСредств.Период,
		|			//бит_ПланируемыйРасходДенежныхСредств.Регистратор,
		|			бит_ПланируемыйРасходДенежныхСредств.Активность,
		|			бит_ПланируемыйРасходДенежныхСредств.ВидДвижения,
		|			бит_ПланируемыйРасходДенежныхСредств.Организация,
		|			бит_ПланируемыйРасходДенежныхСредств.ВидДенежныхСредств,
		|			бит_ПланируемыйРасходДенежныхСредств.Валюта,
		|			бит_ПланируемыйРасходДенежныхСредств.ДокументПланирования,
		|			бит_ПланируемыйРасходДенежныхСредств.ЦФО,
		|			бит_ПланируемыйРасходДенежныхСредств._Инициатор,
		|			бит_ПланируемыйРасходДенежныхСредств.СтатьяОборотов,
		|			бит_ПланируемыйРасходДенежныхСредств.Проект,
		|			бит_ПланируемыйРасходДенежныхСредств.НоменклатурнаяГруппа,
		|			бит_ПланируемыйРасходДенежныхСредств.Контрагент,
		|			бит_ПланируемыйРасходДенежныхСредств.ДоговорКонтрагента,
		|			бит_ПланируемыйРасходДенежныхСредств.БанковскийСчет,
		|			бит_ПланируемыйРасходДенежныхСредств.Аналитика_1,
		|			бит_ПланируемыйРасходДенежныхСредств.Аналитика_2,
		|			бит_ПланируемыйРасходДенежныхСредств.Аналитика_3,
		|			бит_ПланируемыйРасходДенежныхСредств.Аналитика_4,
		|			бит_ПланируемыйРасходДенежныхСредств.Аналитика_5,
		|			бит_ПланируемыйРасходДенежныхСредств.Аналитика_6,
		|			бит_ПланируемыйРасходДенежныхСредств.Аналитика_7,
		|			-СУММА(бит_ПланируемыйРасходДенежныхСредств._СуммаБезНДС) КАК _СуммаБезНДС,
		|			-СУММА(бит_ПланируемыйРасходДенежныхСредств._СуммаНДС) КАК _СуммаНДС,
		|			-СУММА(бит_ПланируемыйРасходДенежныхСредств.Сумма) КАК Сумма,
		|			-СУММА(бит_ПланируемыйРасходДенежныхСредств.СуммаРегл) КАК СуммаРегл,
		|			-СУММА(бит_ПланируемыйРасходДенежныхСредств.СуммаУпр) КАК СуммаУпр,
		|			-СУММА(бит_ПланируемыйРасходДенежныхСредств.СуммаВзаиморасчеты) КАК СуммаВзаиморасчеты,
		|			бит_ПланируемыйРасходДенежныхСредств._УИДСтрокиДокументаПрогнозирования,
		|			бит_ПланируемыйРасходДенежныхСредств._БездоговорнаяСхема
		|		ИЗ
		|			РегистрНакопления.бит_ПланируемыйРасходДенежныхСредств КАК бит_ПланируемыйРасходДенежныхСредств
		|		ГДЕ
		|			бит_ПланируемыйРасходДенежныхСредств._УИДСтрокиДокументаПрогнозирования = &УИДСтрокиДокументаПрогнозирования
		|			и бит_ПланируемыйРасходДенежныхСредств._БездоговорнаяСхема = ИСТИНА
		|			и Активность = Истина
		|		    И бит_ПланируемыйРасходДенежныхСредств.ДокументПланирования ссылка документ.бит_ЗаявкаНаРасходованиеСредствОбщая
		|		    и _СторноЗНРДС = ЛОЖЬ
		|		    
		|		СГРУППИРОВАТЬ ПО
		|			бит_ПланируемыйРасходДенежныхСредств.Контрагент,
		|			бит_ПланируемыйРасходДенежныхСредств.Аналитика_1,
		|			бит_ПланируемыйРасходДенежныхСредств.Аналитика_2,
		|			бит_ПланируемыйРасходДенежныхСредств.Аналитика_3,
		|			бит_ПланируемыйРасходДенежныхСредств.Аналитика_4,
		|			бит_ПланируемыйРасходДенежныхСредств.Аналитика_5,
		|			бит_ПланируемыйРасходДенежныхСредств.Аналитика_6,
		|			бит_ПланируемыйРасходДенежныхСредств.Аналитика_7,
		|			бит_ПланируемыйРасходДенежныхСредств._УИДСтрокиДокументаПрогнозирования,
		|			бит_ПланируемыйРасходДенежныхСредств.ВидДенежныхСредств,
		|			//бит_ПланируемыйРасходДенежныхСредств.Регистратор,
		|			бит_ПланируемыйРасходДенежныхСредств.ЦФО,
		|			бит_ПланируемыйРасходДенежныхСредств._Инициатор,
		|			бит_ПланируемыйРасходДенежныхСредств.Организация,
		|			бит_ПланируемыйРасходДенежныхСредств.Активность,
		|			бит_ПланируемыйРасходДенежныхСредств.Валюта,
		|			бит_ПланируемыйРасходДенежныхСредств.ВидДвижения,
		|			бит_ПланируемыйРасходДенежныхСредств.СтатьяОборотов,
		|			бит_ПланируемыйРасходДенежныхСредств.НоменклатурнаяГруппа,
		|			бит_ПланируемыйРасходДенежныхСредств.ДокументПланирования,
		|			бит_ПланируемыйРасходДенежныхСредств.Период,
		|			бит_ПланируемыйРасходДенежныхСредств.Проект,
		|			бит_ПланируемыйРасходДенежныхСредств.ДоговорКонтрагента,
		|			бит_ПланируемыйРасходДенежныхСредств.БанковскийСчет,
		|			бит_ПланируемыйРасходДенежныхСредств._БездоговорнаяСхема
		|Имеющие
		|
		|			СУММА(бит_ПланируемыйРасходДенежныхСредств._СуммаБезНДС) <> 0
		|			или СУММА(бит_ПланируемыйРасходДенежныхСредств._СуммаНДС) <> 0
		|			или СУММА(бит_ПланируемыйРасходДенежныхСредств.Сумма)  <> 0
		|			или СУММА(бит_ПланируемыйРасходДенежныхСредств.СуммаРегл)  <> 0
		|			или СУММА(бит_ПланируемыйРасходДенежныхСредств.СуммаУпр)  <> 0
		|			или СУММА(бит_ПланируемыйРасходДенежныхСредств.СуммаВзаиморасчеты)  <> 0
		|			
		|";
	Запрос.Параметры.Вставить("УИДСтрокиДокументаПрогнозирования", УИДСтрокиДокументаПрогнозирования); 
	
	РезультатЗапроса = Запрос.Выполнить();
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	НаборЗаписей = РегистрыНакопления.бит_ПланируемыйРасходДенежныхСредств.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Регистратор.Значение = ДокументПланирования;
    НаборЗаписей.Прочитать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Если ВыборкаДетальныеЗаписи.Сумма <> 0 Тогда
			СтрокаСторно = НаборЗаписей.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаСторно, ВыборкаДетальныеЗаписи);
			СтрокаСторно._СторноЗНРДС = Истина;
		КонецЕсли;
	КонецЦикла;
	
	НаборЗаписей.Записать();
	
КонецПроцедуры 

Процедура ОтменитьСторноПланируемогоРасходаДС_ДокументаПланированияБездоговорнаяСхема(ЗаявкаНаРасходованиеСредств) Экспорт
	
	Если НЕ ЗначениеЗаполнено(ЗаявкаНаРасходованиеСредств) Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ЗаявкаНаРасходованиеСредств.ДокументОснование) Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ТипЗнч(ЗаявкаНаРасходованиеСредств.ДокументОснование) = ТИП("ДокументСсылка.бит_ЗаявкаНаРасходованиеСредствОбщая") Тогда
		Возврат;
	КонецЕсли;
	
	ДокументПланирования = ЗаявкаНаРасходованиеСредств.ДокументОснование;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	бит_ЗаявкаНаРасходованиеСредств.Ссылка
		|ИЗ
		|	Документ.бит_ЗаявкаНаРасходованиеСредств КАК бит_ЗаявкаНаРасходованиеСредств
		|ГДЕ
		|	бит_ЗаявкаНаРасходованиеСредств.Проведен = Истина
		|	и не бит_ЗаявкаНаРасходованиеСредств.Ссылка = &ЗаявкаНаРасходованиеСредств
		|	И бит_ЗаявкаНаРасходованиеСредств.ДокументОснование = &ДокументОснование"; 
			
	Запрос.УстановитьПараметр("ЗаявкаНаРасходованиеСредств", 	ЗаявкаНаРасходованиеСредств);
	Запрос.УстановитьПараметр("ДокументОснование", 				ДокументПланирования);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если Не РезультатЗапроса.Пустой() Тогда
		Возврат;
	КонецЕсли;	
	
 	НаборЗаписей = РегистрыНакопления.бит_ПланируемыйРасходДенежныхСредств.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Регистратор.Значение = ДокументПланирования;
    НаборЗаписей.Прочитать();
	
	МассивСтрокДляУдаления = Новый Массив;
	
	ТребуетсяЗапись = Ложь;
	
	Для каждого Строка Из НаборЗаписей Цикл
		Если Строка._СторноЗНРДС Тогда
			МассивСтрокДляУдаления.Добавить(Строка);
			ТребуетсяЗапись = Истина;
		КонецЕсли;	
	КонецЦикла;
	
	Для каждого Строка Из МассивСтрокДляУдаления Цикл
		НаборЗаписей.Удалить(Строка );	
	КонецЦикла;

	Если ТребуетсяЗапись Тогда
		НаборЗаписей.Записать();	
	КонецЕсли;

КонецПроцедуры 

Функция ПодготовитьТаблицуДляСторноЗНРДС_БездоговорнаяСхема (ЗНРДС_Ссылка) Экспорт
	
	УИДСтрокиДокументаПрогнозирования = ЗНРДС_Ссылка.ДокументОснование._УИДСтрокиДокументаОснования;
	
	Запрос = новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	бит_ПланируемыйРасходДенежныхСредств.Период,
	|	бит_ПланируемыйРасходДенежныхСредств.Регистратор,
	|	бит_ПланируемыйРасходДенежныхСредств.НомерСтроки,
	|	бит_ПланируемыйРасходДенежныхСредств.Активность,
	|	бит_ПланируемыйРасходДенежныхСредств.ВидДвижения,
	|	бит_ПланируемыйРасходДенежныхСредств.Организация,
	|	бит_ПланируемыйРасходДенежныхСредств.ВидДенежныхСредств,
	|	бит_ПланируемыйРасходДенежныхСредств.Валюта,
	|	бит_ПланируемыйРасходДенежныхСредств.ДокументПланирования,
	|	бит_ПланируемыйРасходДенежныхСредств.ЦФО,
	|	бит_ПланируемыйРасходДенежныхСредств._Инициатор,
	|	бит_ПланируемыйРасходДенежныхСредств.СтатьяОборотов,
	|	бит_ПланируемыйРасходДенежныхСредств.Проект,
	|	бит_ПланируемыйРасходДенежныхСредств.НоменклатурнаяГруппа,
	|	бит_ПланируемыйРасходДенежныхСредств.Контрагент,
	|	бит_ПланируемыйРасходДенежныхСредств.ДоговорКонтрагента,
	|	бит_ПланируемыйРасходДенежныхСредств.БанковскийСчет,
	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_1,
	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_2,
	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_3,
	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_4,
	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_5,
	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_6,
	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_7,
	|	бит_ПланируемыйРасходДенежныхСредств._БездоговорнаяСхема,
	|	бит_ПланируемыйРасходДенежныхСредств._СуммаБезНДС,
	|	бит_ПланируемыйРасходДенежныхСредств._СуммаНДС,
	|	бит_ПланируемыйРасходДенежныхСредств.Сумма,
	|	бит_ПланируемыйРасходДенежныхСредств.СуммаРегл,
	|	бит_ПланируемыйРасходДенежныхСредств.СуммаУпр,
	|	бит_ПланируемыйРасходДенежныхСредств.СуммаВзаиморасчеты,
	|	бит_ПланируемыйРасходДенежныхСредств._УИДСтрокиДокументаПрогнозирования,
	|	бит_ПланируемыйРасходДенежныхСредств._СторноЗНРДС
	|ПОМЕСТИТЬ ВТ
	|ИЗ
	|	РегистрНакопления.бит_ПланируемыйРасходДенежныхСредств КАК бит_ПланируемыйРасходДенежныхСредств
	|ГДЕ
	|	//бит_ПланируемыйРасходДенежныхСредств.ДокументПланирования = &Регистратор
	|   бит_ПланируемыйРасходДенежныхСредств.ДокументПланирования ССЫЛКА Документ.бит_ЗаявкаНаРасходованиеСредств
	|	И НЕ бит_ПланируемыйРасходДенежныхСредств.Регистратор ссылка Документ.бит_ПлатежнаяПозиция
	|   И бит_ПланируемыйРасходДенежныхСредств._УИДСтрокиДокументаПрогнозирования = &УИДСтрокиДокументаПрогнозирования
	|  	И бит_ПланируемыйРасходДенежныхСредств.Активность = ИСТИНА
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ.Период,
	|	ВТ.Активность,
	|	ВТ.ВидДвижения,
	|	ВТ.Организация,
	|	ВТ.ВидДенежныхСредств,
	|	ВТ.Валюта,
	|	ВТ.ДокументПланирования,
	|	ВТ.ЦФО,
	|	ВТ._Инициатор,
	|	ВТ.СтатьяОборотов,
	|	ВТ.Проект,
	|	ВТ.НоменклатурнаяГруппа,
	|	ВТ.Контрагент,
	|	ВТ.ДоговорКонтрагента,
	|	ВТ.БанковскийСчет,
	|	ВТ.Аналитика_1,
	|	ВТ.Аналитика_2,
	|	ВТ.Аналитика_3,
	|	ВТ.Аналитика_4,
	|	ВТ.Аналитика_5,
	|	ВТ.Аналитика_6,
	|	ВТ.Аналитика_7,
	|	ВТ._БездоговорнаяСхема,
	|	СУММА(ВТ._СуммаБезНДС) КАК _СуммаБезНДС,
	|	СУММА(ВТ._СуммаНДС) КАК _СуммаНДС,
	|	СУММА(ВТ.Сумма) КАК Сумма,
	|	СУММА(ВТ.СуммаРегл) КАК СуммаРегл,
	|	СУММА(ВТ.СуммаУпр) КАК СуммаУпр,
	|	СУММА(ВТ.СуммаВзаиморасчеты) КАК СуммаВзаиморасчеты,
	|	ВТ._УИДСтрокиДокументаПрогнозирования,
	|	ВТ._СторноЗНРДС
	|ИЗ
	|	ВТ КАК ВТ
	|
	|СГРУППИРОВАТЬ ПО
	|	ВТ.Аналитика_2,
	|	ВТ.Аналитика_3,
	|	ВТ.ЦФО,
	|	ВТ._Инициатор,
	|	ВТ.Проект,
	|	ВТ.НоменклатурнаяГруппа,
	|	ВТ.БанковскийСчет,
	|	ВТ.ВидДенежныхСредств,
	|	ВТ.Организация,
	|	ВТ.ВидДвижения,
	|	ВТ.Аналитика_4,
	|	ВТ.ДокументПланирования,
	|	ВТ.Валюта,
	|	ВТ._СторноЗНРДС,
	|	ВТ._УИДСтрокиДокументаПрогнозирования,
	|	ВТ._БездоговорнаяСхема,
	|	ВТ.Аналитика_6,
	|	ВТ.Контрагент,
	|	ВТ.Период,
	|	ВТ.Активность,
	|	ВТ.Аналитика_7,
	|	ВТ.Аналитика_5,
	|	ВТ.Аналитика_1,
	|	ВТ.ДоговорКонтрагента,
	|	ВТ.СтатьяОборотов
	|
	|ИМЕЮЩИЕ
	|	(СУММА(ВТ._СуммаБезНДС) <> 0
	|		ИЛИ СУММА(ВТ._СуммаНДС) <> 0
	|		ИЛИ СУММА(ВТ.Сумма) <> 0
	|		ИЛИ СУММА(ВТ.СуммаРегл) <> 0
	|		ИЛИ СУММА(ВТ.СуммаУпр) <> 0
	|		ИЛИ СУММА(ВТ.СуммаВзаиморасчеты) <> 0)
	|";
	Запрос.Параметры.Вставить("Регистратор", ЗНРДС_Ссылка);
	Запрос.Параметры.Вставить("УИДСтрокиДокументаПрогнозирования", УИДСтрокиДокументаПрогнозирования); 
	
	Возврат Запрос.Выполнить().Выгрузить();
	

КонецФункции // ()

Функция ПодготовитьТаблицуДляСторноПлатежнойПозиции_БездоговорнаяСхема (ПлатежнаяПозиция_Ссылка) Экспорт
	Запрос = новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	бит_ПланируемыйРасходДенежныхСредств.Период,
	|	бит_ПланируемыйРасходДенежныхСредств.Регистратор,
	|	бит_ПланируемыйРасходДенежныхСредств.НомерСтроки,
	|	бит_ПланируемыйРасходДенежныхСредств.Активность,
	|	бит_ПланируемыйРасходДенежныхСредств.ВидДвижения,
	|	бит_ПланируемыйРасходДенежныхСредств.Организация,
	|	бит_ПланируемыйРасходДенежныхСредств.ВидДенежныхСредств,
	|	бит_ПланируемыйРасходДенежныхСредств.Валюта,
	|	бит_ПланируемыйРасходДенежныхСредств.ДокументПланирования,
	|	бит_ПланируемыйРасходДенежныхСредств.ЦФО,
	|	бит_ПланируемыйРасходДенежныхСредств._Инициатор,
	|	бит_ПланируемыйРасходДенежныхСредств.СтатьяОборотов,
	|	бит_ПланируемыйРасходДенежныхСредств.Проект,
	|	бит_ПланируемыйРасходДенежныхСредств.НоменклатурнаяГруппа,
	|	бит_ПланируемыйРасходДенежныхСредств.Контрагент,
	|	бит_ПланируемыйРасходДенежныхСредств.ДоговорКонтрагента,
	|	бит_ПланируемыйРасходДенежныхСредств.БанковскийСчет,
	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_1,
	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_2,
	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_3,
	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_4,
	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_5,
	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_6,
	|	бит_ПланируемыйРасходДенежныхСредств.Аналитика_7,
	|	бит_ПланируемыйРасходДенежныхСредств._БездоговорнаяСхема,
	|	бит_ПланируемыйРасходДенежныхСредств._СуммаБезНДС,
	|	бит_ПланируемыйРасходДенежныхСредств._СуммаНДС,
	|	бит_ПланируемыйРасходДенежныхСредств.Сумма,
	|	бит_ПланируемыйРасходДенежныхСредств.СуммаРегл,
	|	бит_ПланируемыйРасходДенежныхСредств.СуммаУпр,
	|	бит_ПланируемыйРасходДенежныхСредств.СуммаВзаиморасчеты,
	|	бит_ПланируемыйРасходДенежныхСредств._УИДСтрокиДокументаПрогнозирования,
	|	бит_ПланируемыйРасходДенежныхСредств._СторноЗНРДС
	|ПОМЕСТИТЬ ВТ
	|ИЗ
	|	РегистрНакопления.бит_ПланируемыйРасходДенежныхСредств КАК бит_ПланируемыйРасходДенежныхСредств
	|ГДЕ
	|	бит_ПланируемыйРасходДенежныхСредств.ДокументПланирования = &Регистратор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ.Период,
	|	ВТ.Активность,
	|	ВТ.ВидДвижения,
	|	ВТ.Организация,
	|	ВТ.ВидДенежныхСредств,
	|	ВТ.Валюта,
	|	ВТ.ДокументПланирования,
	|	ВТ.ЦФО,
	|	ВТ._инициатор,
	|	ВТ.СтатьяОборотов,
	|	ВТ.Проект,
	|	ВТ.НоменклатурнаяГруппа,
	|	ВТ.Контрагент,
	|	ВТ.ДоговорКонтрагента,
	|	ВТ.БанковскийСчет,
	|	ВТ.Аналитика_1,
	|	ВТ.Аналитика_2,
	|	ВТ.Аналитика_3,
	|	ВТ.Аналитика_4,
	|	ВТ.Аналитика_5,
	|	ВТ.Аналитика_6,
	|	ВТ.Аналитика_7,
	|	ВТ._БездоговорнаяСхема,
	|	СУММА(ВТ._СуммаБезНДС) КАК _СуммаБезНДС,
	|	СУММА(ВТ._СуммаНДС) КАК _СуммаНДС,
	|	СУММА(ВТ.Сумма) КАК Сумма,
	|	СУММА(ВТ.СуммаРегл) КАК СуммаРегл,
	|	СУММА(ВТ.СуммаУпр) КАК СуммаУпр,
	|	СУММА(ВТ.СуммаВзаиморасчеты) КАК СуммаВзаиморасчеты,
	|	ВТ._УИДСтрокиДокументаПрогнозирования,
	|	ВТ._СторноЗНРДС
	|ИЗ
	|	ВТ КАК ВТ
	|
	|СГРУППИРОВАТЬ ПО
	|	ВТ.Аналитика_2,
	|	ВТ.Аналитика_3,
	|	ВТ.ЦФО,
	|	ВТ._инициатор,
	|	ВТ.Проект,
	|	ВТ.НоменклатурнаяГруппа,
	|	ВТ.БанковскийСчет,
	|	ВТ.ВидДенежныхСредств,
	|	ВТ.Организация,
	|	ВТ.ВидДвижения,
	|	ВТ.Аналитика_4,
	|	ВТ.ДокументПланирования,
	|	ВТ.Валюта,
	|	ВТ._СторноЗНРДС,
	|	ВТ._УИДСтрокиДокументаПрогнозирования,
	|	ВТ._БездоговорнаяСхема,
	|	ВТ.Аналитика_6,
	|	ВТ.Контрагент,
	|	ВТ.Период,
	|	ВТ.Активность,
	|	ВТ.Аналитика_7,
	|	ВТ.Аналитика_5,
	|	ВТ.Аналитика_1,
	|	ВТ.ДоговорКонтрагента,
	|	ВТ.СтатьяОборотов
	|
	|ИМЕЮЩИЕ
	|	(СУММА(ВТ._СуммаБезНДС) <> 0
	|		ИЛИ СУММА(ВТ._СуммаНДС) <> 0
	|		ИЛИ СУММА(ВТ.Сумма) <> 0
	|		ИЛИ СУММА(ВТ.СуммаРегл) <> 0
	|		ИЛИ СУММА(ВТ.СуммаУпр) <> 0
	|		ИЛИ СУММА(ВТ.СуммаВзаиморасчеты) <> 0)
	|";
	Запрос.Параметры.Вставить("Регистратор", ПлатежнаяПозиция_Ссылка); 
	Возврат Запрос.Выполнить().Выгрузить();
	

КонецФункции // ()

#КонецОбласти

#Область Общие

Функция ЭтоБездоговорнаяСхемаПоЗНРДС(ЗаявкаНаРасходованиеСредств) Экспорт
	
	Результат = Ложь;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
			|	ДоговорыКонтрагентов.Ссылка,
			|	ДоговорыКонтрагентов._БездоговорнаяСхема
			|ИЗ
			|	Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.бит_ДополнительныеУсловияПоДоговору КАК Документбит_ДополнительныеУсловияПоДоговору
			|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ._ДокументПрогнозирования КАК документ_ДокументПрогнозирования
			|				ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.бит_ЗаявкаНаРасходованиеСредствОбщая КАК документбит_ЗаявкаНаРасходованиеСредствОбщая
			|					ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.бит_ЗаявкаНаРасходованиеСредств КАК документбит_ЗаявкаНаРасходованиеСредств
			|					ПО (документбит_ЗаявкаНаРасходованиеСредств.ДокументОснование = документбит_ЗаявкаНаРасходованиеСредствОбщая.Ссылка)
			|						И (документбит_ЗаявкаНаРасходованиеСредств.Ссылка = &ЗаявкаНаРасходованиеСредств)
			|				ПО (документбит_ЗаявкаНаРасходованиеСредствОбщая._ДокументОснование = документ_ДокументПрогнозирования.Ссылка)
			|					//И (документбит_ЗаявкаНаРасходованиеСредствОбщая.ПометкаУдаления = ЛОЖЬ)
			|			ПО (документ_ДокументПрогнозирования.ДопУсловияПоДоговору = Документбит_ДополнительныеУсловияПоДоговору.Ссылка)
			|				//И (документ_ДокументПрогнозирования.ПометкаУдаления = ЛОЖЬ)
			|		ПО (Документбит_ДополнительныеУсловияПоДоговору.ДоговорКонтрагента = ДоговорыКонтрагентов.Ссылка)
			|			//И (Документбит_ДополнительныеУсловияПоДоговору.ПометкаУдаления = ЛОЖЬ)
			|";
		Запрос.Параметры.Вставить("ЗаявкаНаРасходованиеСредств", ЗаявкаНаРасходованиеСредств); 

	
	РезультатЗапроса = Запрос.Выполнить();
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Результат = ВыборкаДетальныеЗаписи._БездоговорнаяСхема;
	КонецЦикла;
	
	Возврат Результат;

КонецФункции  

Функция ЭтоБездоговорнаяСхемаПоЗаявкеОбщей(ЗаявкаНаРасходованиеСредствОбщая) Экспорт
	
	Результат = Ложь;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	ДоговорыКонтрагентов.Ссылка,
		|	ДоговорыКонтрагентов._БездоговорнаяСхема
		|ИЗ
		|	Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.бит_ДополнительныеУсловияПоДоговору КАК Документбит_ДополнительныеУсловияПоДоговору
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ._ДокументПрогнозирования КАК документ_ДокументПрогнозирования
		|				ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.бит_ЗаявкаНаРасходованиеСредствОбщая КАК документбит_ЗаявкаНаРасходованиеСредствОбщая
		|				ПО (документбит_ЗаявкаНаРасходованиеСредствОбщая._ДокументОснование = документ_ДокументПрогнозирования.Ссылка)
		|					И (документбит_ЗаявкаНаРасходованиеСредствОбщая.Ссылка = &ЗаявкаНаРасходованиеСредствОбщая)
		|			ПО (документ_ДокументПрогнозирования.ДопУсловияПоДоговору = Документбит_ДополнительныеУсловияПоДоговору.Ссылка)
		|		ПО (Документбит_ДополнительныеУсловияПоДоговору.ДоговорКонтрагента = ДоговорыКонтрагентов.Ссылка)";
		Запрос.Параметры.Вставить("ЗаявкаНаРасходованиеСредствОбщая", ЗаявкаНаРасходованиеСредствОбщая); 

	
	РезультатЗапроса = Запрос.Выполнить();
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Результат = ВыборкаДетальныеЗаписи._БездоговорнаяСхема;
	КонецЦикла;
	
	Возврат Результат;

КонецФункции 

Функция ЭтоБездоговорнаяСхема(ДокументПрогнозирования) Экспорт
	
	Результат = Ложь;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	ДоговорыКонтрагентов.Ссылка,
		|	ДоговорыКонтрагентов._БездоговорнаяСхема
		|ИЗ
		|	Справочник.ДоговорыКонтрагентов КАК ДоговорыКонтрагентов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.бит_ДополнительныеУсловияПоДоговору КАК Документбит_ДополнительныеУсловияПоДоговору
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ._ДокументПрогнозирования КАК документ_ДокументПрогнозирования
		|			ПО (документ_ДокументПрогнозирования.ДопУсловияПоДоговору = Документбит_ДополнительныеУсловияПоДоговору.Ссылка)
		|				и (документ_ДокументПрогнозирования.Ссылка = &ДокументПрогнозирования)
		|		ПО (Документбит_ДополнительныеУсловияПоДоговору.ДоговорКонтрагента = ДоговорыКонтрагентов.Ссылка)";
		Запрос.Параметры.Вставить("ДокументПрогнозирования", ДокументПрогнозирования); 

	
	РезультатЗапроса = Запрос.Выполнить();
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Результат = ВыборкаДетальныеЗаписи._БездоговорнаяСхема;
	КонецЦикла;
	
	Возврат Результат;

КонецФункции 

Функция ПолучитьИнициатораТекущегоПользователя() Экспорт
	
	Инициатор = Справочники.Подразделения.ПустаяСсылка();
	ФИОСотрудника 	= ПараметрыСеанса.ТекущийПользователь;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	_СоответствиеЦФОиСотрудников.ЦФО,
	|	_СоответствиеЦФОиСотрудников.Сотрудник
	|ИЗ
	|	РегистрСведений._СоответствиеЦФОиСотрудников КАК _СоответствиеЦФОиСотрудников
	|Где 
	|	_СоответствиеЦФОиСотрудников.Сотрудник.Наименование = &ФИОСотрудника
	|";
	
	Запрос.Параметры.Вставить("ФИОСотрудника", Строка(ФИОСотрудника));	
	РезультатЗапроса = Запрос.Выполнить();
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Инициатор = ВыборкаДетальныеЗаписи.ЦФО;
	КонецЦикла;
	
	Возврат Инициатор;
	
КонецФункции

Функция ИнициаторПрименяетСхемуФинпланированияСтруктура(Инициатор) Экспорт
	
	СтруктураРезультат = Новый Структура;
	СтруктураРезультат.Вставить("Применяет", Ложь);
	СтруктураРезультат.Вставить("НачалоПрименения", Дата(1,1,1));
	
	Если ЗначениеЗаполнено(Инициатор) Тогда
	
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	СУММА(1) КАК Количество,
		|	""бит_ПланируемыйРасходДенежныхСредств"" КАК Регистр,
		|	МИНИМУМ(бит_ПланируемыйРасходДенежныхСредств.Период) КАК Период
		|ПОМЕСТИТЬ ВТ
		|ИЗ
		|	РегистрНакопления.бит_ПланируемыйРасходДенежныхСредств КАК бит_ПланируемыйРасходДенежныхСредств
		|ГДЕ
		|	бит_ПланируемыйРасходДенежныхСредств._Инициатор = &Инициатор
		|	И бит_ПланируемыйРасходДенежныхСредств._УИДСтрокиДокументаПрогнозирования <> &ПустойУИД
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	СУММА(1),
		|	""бит_ПланируемоеПоступлениеДенежныхСредств"",
		|	МИНИМУМ(бит_ПланируемоеПоступлениеДенежныхСредств.Период)
		|ИЗ
		|	РегистрНакопления.бит_ПланируемоеПоступлениеДенежныхСредств КАК бит_ПланируемоеПоступлениеДенежныхСредств
		|ГДЕ
		|	бит_ПланируемоеПоступлениеДенежныхСредств._Инициатор = &Инициатор
		|	И бит_ПланируемоеПоступлениеДенежныхСредств._УИДСтрокиДокументаПрогнозирования <> &ПустойУИД
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СУММА(естьnull(ВТ.Количество,0)) КАК Количество,
		|	МИНИМУМ(естьnull(ВТ.Период,ДатаВремя(1,1,1))) КАК Период
		|ИЗ
		|	ВТ КАК ВТ
		|";	
		ПустойУИД = Новый УникальныйИдентификатор("00000000-0000-0000-0000-000000000000");
		Запрос.Параметры.Вставить("ПустойУИД", ПустойУИД); 
		Запрос.Параметры.Вставить("Инициатор", Инициатор); 
		РезультатЗапроса = Запрос.Выполнить();
		ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
		
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			Если ВыборкаДетальныеЗаписи.Количество > 0 Тогда
				СтруктураРезультат.Применяет 		= Истина;
				СтруктураРезультат.НачалоПрименения = НачалоМесяца(ВыборкаДетальныеЗаписи.Период);
			КонецЕсли; 
		КонецЦикла; 
	
	КонецЕсли;
	
	Возврат СтруктураРезультат;

КонецФункции 
	
#КонецОбласти 
