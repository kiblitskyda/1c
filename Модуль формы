#Область Переменные

&НаКлиенте
Перем РедактируемоеПоле; // хранит имя поля редактируемое в данный момент в таблице

&НаКлиенте
Перем ФормаМодифицированна; // хранит значение модифицированности формы перед началом редактирования строки в таблице   

#КонецОбласти

#Область Легаси

&НаКлиенте
Процедура ПолучитьОбъектСтроительства(Команда)
	
	ПриНажатииНаКнопкуПолучитьОбъектСтроительства();
	
КонецПроцедуры

&НаКлиентеНаСервереБезКонтекста
Процедура ОпределитьСписокДоступныхВидовДоговоровПоОперации(ВидОперации, РасходДоход, КэшЗначений)
	
	СписокВидовДоговоров = Новый СписокЗначений;
	ВидыДоговоровКонтрагентов = КэшЗначений.Перечисления.ВидыДоговоровКонтрагентов;	
	
	Если ВидОперации = КэшЗначений.Перечисления.бит_ВидыОперацийЗаявкаНаРасходование.ВозвратДенежныхСредствПокупателю Тогда
		
		СписокВидовДоговоров.Добавить(ВидыДоговоровКонтрагентов.СПокупателем);
		СписокВидовДоговоров.Добавить(ВидыДоговоровКонтрагентов.СКомитентом);
		СписокВидовДоговоров.Добавить(ВидыДоговоровКонтрагентов.СКомиссионером);
		бит_ДоговораКлиентСервер.ДобавитьВидДоговора(СписокВидовДоговоров, ВидыДоговоровКонтрагентов, "СКомиссионеромНаЗакупку");
		бит_ДоговораКлиентСервер.ДобавитьВидДоговора(СписокВидовДоговоров, ВидыДоговоровКонтрагентов, "СКомитентомНаЗакупку");						
		
		
	ИначеЕсли ВидОперации = КэшЗначений.Перечисления.бит_ВидыОперацийЗаявкаНаРасходование.ОплатаПоставщику Тогда
		
		СписокВидовДоговоров.Добавить(ВидыДоговоровКонтрагентов.СПоставщиком);
		СписокВидовДоговоров.Добавить(ВидыДоговоровКонтрагентов.СКомитентом);
		СписокВидовДоговоров.Добавить(ВидыДоговоровКонтрагентов.СКомиссионером);
		бит_ДоговораКлиентСервер.ДобавитьВидДоговора(СписокВидовДоговоров, ВидыДоговоровКонтрагентов, "СКомиссионеромНаЗакупку");
		бит_ДоговораКлиентСервер.ДобавитьВидДоговора(СписокВидовДоговоров, ВидыДоговоровКонтрагентов, "СКомитентомНаЗакупку");						
		
		
	ИначеЕсли РасходДоход = КэшЗначений.Перечисления.бит_РасходДоход.Поступление Тогда
		
		СписокВидовДоговоров.Добавить(ВидыДоговоровКонтрагентов.СПокупателем);
		СписокВидовДоговоров.Добавить(ВидыДоговоровКонтрагентов.СКомиссионером);
		СписокВидовДоговоров.Добавить(ВидыДоговоровКонтрагентов.Прочее);
		бит_ДоговораКлиентСервер.ДобавитьВидДоговора(СписокВидовДоговоров, ВидыДоговоровКонтрагентов, "СКомиссионеромНаЗакупку");
		бит_ДоговораКлиентСервер.ДобавитьВидДоговора(СписокВидовДоговоров, ВидыДоговоровКонтрагентов, "СКомитентомНаЗакупку");						
		
	Иначе
		СписокВидовДоговоров.Добавить(КэшЗначений.Перечисления.ВидыДоговоровКонтрагентов.Прочее);
	КонецЕсли; 
	
	КэшЗначений.Вставить("СписокВидовДоговоров", СписокВидовДоговоров);
	
КонецПроцедуры

&НаКлиенте
Процедура ПолучитьСтатьюОборотов(Команда)
	
	ПриНажатииНаКнопкуПолучитьСтатьюОборотов();
	
КонецПроцедуры

&НаСервере
Функция ПолучитьТекущийСтатусОбъекта(Ссылка)
	
	ТекущийСтатус = Новый Структура("Статус, ДатаИзмененияСтатуса");
	
	Если ЗначениеЗаполнено(Ссылка) Тогда
		//Получаем ссылку на внутренний заказ
		Если ТипЗнч(Ссылка) = Тип("ДокументСсылка._ДокументПрогнозирования") Тогда
			ДокументПрогнозирования = Ссылка;
		Иначе
			Возврат "";
		КонецЕсли;
		
		//Получаем текущий статус
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	бит_СтатусыОбъектов.ДатаИзмененияСтатуса,
		|	бит_СтатусыОбъектов.Статус
		|ПОМЕСТИТЬ ВТ_Статусы
		|ИЗ
		|	РегистрСведений.бит_СтатусыОбъектов КАК бит_СтатусыОбъектов
		|ГДЕ
		|	бит_СтатусыОбъектов.Объект = &ДокументПрогнозирования
		|	И бит_СтатусыОбъектов.ВидСтатуса = &ВидСтатусаСтатус
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Статусы.Статус,
		|	ВТ_Статусы.ДатаИзмененияСтатуса
		|ИЗ
		|	ВТ_Статусы КАК ВТ_Статусы
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|			МАКСИМУМ(ВТ_Статусы.ДатаИзмененияСтатуса) КАК ДатаИзмененияСтатуса
		|		ИЗ
		|			ВТ_Статусы КАК ВТ_Статусы) КАК ПодзапросСрезПоДате
		|		ПО ВТ_Статусы.ДатаИзмененияСтатуса = ПодзапросСрезПоДате.ДатаИзмененияСтатуса";
		
		Запрос.УстановитьПараметр("ДокументПрогнозирования",	ДокументПрогнозирования);
		Запрос.УстановитьПараметр("ВидСтатусаСтатус",		Перечисления.бит_ВидыСтатусовОбъектов.Статус);
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Если Выборка.Следующий() Тогда
			ЗаполнитьЗначенияСвойств(ТекущийСтатус, Выборка);
		КонецЕсли;
	КонецЕсли;
	
	Возврат бит_ОбщегоНазначенияКлиентСервер.СформироватьИнформациюСтатус(ТекущийСтатус);
	
КонецФункции

&НаКлиенте 
Процедура УстановитьЗаголовокФормыДокумента()
	
	СтруктураЗаголовка = Новый Структура;
	СтруктураЗаголовка.Вставить("ПредставлениеОбъекта", мКэшЗначений.ПредставлениеОбъекта);
	СтруктураЗаголовка.Вставить("СтрокаВидаОперации"  , Строка(Объект.ДопУсловияПоДоговору.ВидОперации));
	СтруктураЗаголовка.Вставить("ЭтоНовый"			  , Параметры.Ключ.Пустая());
	СтруктураЗаголовка.Вставить("ДокументПроведен"	  , Объект.Проведен);
	
	бит_РаботаСДиалогамиКлиент.УстановитьЗаголовокФормыДокумента(ЭтаФорма,СтруктураЗаголовка);
	
КонецПроцедуры // УстановитьЗаголовокФормыДокумента()

&НаКлиенте                      
Процедура УстановитьСтатусВФорме(пСтатус, пДатаИзмененияСтатуса) Экспорт
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("Статус"			   , пСтатус);
	СтруктураПараметров.Вставить("ДатаИзмененияСтатуса", пДатаИзмененияСтатуса);
	
	ИнформацияСтатус = бит_ОбщегоНазначенияКлиентСервер.СформироватьИнформациюСтатус(СтруктураПараметров);
	
	мКэшЗначений.Вставить("ТекущийСтатус"		, пСтатус);
	мКэшЗначений.Вставить("ДатаИзмененияСтатуса", пДатаИзмененияСтатуса);
	
	ЭтаФорма.Статус 			  = пСтатус;
	ЭтаФорма.ДатаИзмененияСтатуса = пДатаИзмененияСтатуса;
	
	ЭтаФорма.ТолькоПросмотр = (Строка(мКэшЗначений.ТекущийСтатус) = "Утвержден"); 
	
	
	//// {PTE-0000034126 Федосеев Артем Александрович 2020/05/14
	//ПроверитьЗначениеСхемыОплаты(ЭтаФорма.РежимДиалога);
	//
	//Если Не ЭтаФорма.РежимДиалога Тогда
	//	ЭтаФорма.РежимДиалога = Истина;		
	//КонецЕсли;
	//// }PTE-0000034126
	
КонецПроцедуры // УстановитьСтатусВФорме()

&НаСервере
Функция ЗначениеРеквизита(Объект, ИмяРеквизита);
	
	Возврат Объект[ИмяРеквизита];
	
КонецФункции

&НаСервере
Процедура ЗаполнитьКэшРеквизитовФормы()
	
	Для Каждого КэшРеквизита Из фКэшРеквизитов Цикл
		
		//фКэшРеквизитов[КэшРеквизита.Ключ] = Объект[КэшРеквизита.Ключ];
		
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьВизы() Экспорт
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("СтруктурноеПодразделение", Объект.ДопУсловияПоДоговору.Организация);
	СтруктураПараметров.Вставить("ЦФО"					   , Объект.ДопУсловияПоДоговору.ЦФО);		
	
	бит_Визирование.ОбновитьПереченьВиз(Объект.Ссылка, Объект.Дата, СтруктураПараметров);
	
КонецПроцедуры //ЗаполнитьВизы()

&НаСервере
Процедура ОчиститьЭлемент(рекв)
	Попытка
		ЭтаФорма[рекв].Очистить();
	Исключение КонецПопытки;
	Попытка
		ЭтаФорма[рекв] = Неопределено
	Исключение КонецПопытки;
КонецПроцедуры

#КонецОбласти //Легаси_Разобрать

#Область ОбщаяЛогикаФормы

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	ЭтоНовый = Параметры.Ключ.Пустая();	
	
	// Вывести в заголовке формы вид операции и статус документа (новый, не проведен, проведен).
	УстановитьЗаголовокФормыДокумента();
	
	ЭтаФорма.Статус 			  = мКэшЗначений.ТекущийСтатус;
	ЭтаФорма.ДатаИзмененияСтатуса = мКэшЗначений.ДатаИзмененияСтатуса;
	
	// Установим текущий статус.
	УстановитьСтатусВФорме(мКэшЗначений.ТекущийСтатус, мКэшЗначений.ДатаИзмененияСтатуса);
	
	УправлениеЭлементамиФормы(); 
	мГрафикНачисленийОбновитьСтолбцы();
	//мГрафикПлатежейОбновитьСтолбцы();  
	
	ПроверитьВхождениеПользователяВЦФО();  
	
	БездоговорнаяСхема = Ложь;
	
	Если ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору) Тогда

		//Видимость вариантов схемы Договорная / Бездоговорная
		Если ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору.ДоговорКонтрагента) и Объект.ДопУсловияПоДоговору.ДоговорКонтрагента._БездоговорнаяСхема Тогда
			Элементы.ГруппаГрафикПлатежейБездоговорная.Видимость 	= Истина;
			Элементы.ГруппаГрафикПлатежей.Видимость 				= Ложь;
			БездоговорнаяСхема 										= Истина;
		Иначе
			Элементы.ГруппаГрафикПлатежей.Видимость 				= Истина;
			Элементы.ГруппаГрафикПлатежейБездоговорная.Видимость 	= Ложь;
		КонецЕсли;

		//Выбор текущей вкладки
		Если Объект.ДопУсловияПоДоговору.РасходДоход = Перечисления.бит_РасходДоход.Расходование и БездоговорнаяСхема Тогда
			Элементы.ГруппаСтраницы.ТекущаяСтраница 				= Элементы.ГруппаГрафикПлатежейБездоговорная;          
		ИначеЕсли Объект.ДопУсловияПоДоговору.РасходДоход = Перечисления.бит_РасходДоход.Расходование Тогда
			Элементы.ГруппаСтраницы.ТекущаяСтраница 				= Элементы.ГруппаГрафикПлатежей;            
		Иначе 
			Элементы.ГруппаСтраницы.ТекущаяСтраница 				= Элементы.ГруппаГрафикПоступлений;            
		КонецЕсли;
		
	КонецЕсли; 
	
	ЗаполнитьГрафикПоступленийНаСервере();
	ЗаполнитьГрафикПлатежейНаСервере();
	ЗаполнитьГрафикПлатежейБНаСервере();
	
КонецПроцедуры // ПриОткрытии()

&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
	
	// Вывести в заголовке формы вид операции и статус документа (новый, не проведен, проведен).
	УстановитьЗаголовокФормыДокумента(); 
	
КонецПроцедуры // ПослеЗаписи()

&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
	
	ПроверитьПериодПоставки(Отказ); 
	ПроверитьПериодНачисления(Отказ);
	ПроверитьСтавкиНДС(Отказ);
	ПроверитьЗаполнениеЦФО(Отказ);
	ПроверитьЗаполнениеСтатусовДС(Отказ);
	ПроверитьСуммаНачисления(Отказ);
	//ПлатежиПроверитьПериода(Отказ);
	//ПроверитьЗаполнениеСтатьиОборотов(Отказ);
	//ПлатежиПроверитьЗаполнениеСумм(Отказ);  
	
    РезультатВалидации = ВалидацияНаСервере();
    
    Если НЕ РезультатВалидации.ВсеХорошо Тогда
        Отказ = Истина;
        // Показываем ошибки
        Для Каждого Сообщение Из РезультатВалидации.СписокСообщений Цикл
            Сообщить(Сообщение.Значение);
        КонецЦикла;
    КонецЕсли;	
	
	
КонецПроцедуры  

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	//// Стандартные действия при создании на сервере
	//бит_РаботаСДиалогамиСервер.ФормаОбъектаПриСозданииНаСервере(Отказ, СтандартнаяОбработка, ЭтаФорма, Объект);
	
	МетаданныеОбъекта = Объект.Ссылка.Метаданные();
	
	Если НЕ ЗначениеЗаполнено(Объект.Сценарий) Тогда
		Объект.Сценарий = Справочники.СценарииПланирования.ПРОГНОЗ_ЦФО;	
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Объект.АвторПоследнихИзменений) Тогда
		Объект.АвторПоследнихИзменений 		= ПараметрыСеанса.ТекущийПользователь;  
		Объект.ВремяПоследнихИзменений 		= ТекущаяДата();
	КонецЕсли;
	
	// Зададим имена реквизитов, подлежащих кешированию.
	фКэшРеквизитов = Новый Структура;
	фКэшРеквизитов.Вставить("Организация");
	фКэшРеквизитов.Вставить("Контрагент");
	фКэшРеквизитов.Вставить("ДоговорКонтрагента");
	фКэшРеквизитов.Вставить("ВалютаДокумента");
	фКэшРеквизитов.Вставить("КурсДокумента");
	фКэшРеквизитов.Вставить("КратностьДокумента");
	фКэшРеквизитов.Вставить("Периодичность");
	фКэшРеквизитов.Вставить("ПериодичностьНачисления");
	фКэшРеквизитов.Вставить("ДатаНачала");
	фКэшРеквизитов.Вставить("ДатаОкончания");
	фКэшРеквизитов.Вставить("ДатаНачалаНачисления");
	фКэшРеквизитов.Вставить("ДатаОкончанияНачисления");
	
	// Запомним текущие значения реквизитов формы.
	ЗаполнитьКэшРеквизитовФормы();
	
	фКэшРеквизитов.Вставить("ВидДоговораКонтрагента", Объект.ДопУсловияПоДоговору.ДоговорКонтрагента.ВидДоговора);
	фКэшРеквизитов.Вставить("бит_ТипДоговора", Объект.ДопУсловияПоДоговору.ДоговорКонтрагента.бит_ТипДоговора);
	
	ЗаполнитьКэшЗначений();
	
	// Настроим отображение полей доп. аналитик в табличном поле ГрафикПлатежей.
	бит_МеханизмДопИзмерений.ОтобразитьДополнительныеИзмеренияВТабличномПоле_Управляемая(ЭтаФорма
	,"ГрафикПлатежей"
	,мКэшЗначений.ИзмеренияДоп
	,мКэшЗначений.НастройкиИзмерений);
	
	// Настроим отображение полей доп. аналитик в табличном поле ГрафикНачислений.
	бит_МеханизмДопИзмерений.ОтобразитьДополнительныеИзмеренияВТабличномПоле_Управляемая(ЭтаФорма
	,"ГрафикНачислений"
	,мКэшЗначений.ИзмеренияДоп
	,мКэшЗначений.НастройкиИзмерений);																					
	
	Если ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору) Тогда
		СтарыеОплаченныеЗаявки.Параметры.УстановитьЗначениеПараметра("ДоговорКонтрагента", Объект.ДопУсловияПоДоговору.ДоговорКонтрагента);
		ПлатежныеПорученияВходящие.Параметры.УстановитьЗначениеПараметра("ДоговорКонтрагента", Объект.ДопУсловияПоДоговору.ДоговорКонтрагента);
		
	Иначе
		СтарыеОплаченныеЗаявки.Параметры.УстановитьЗначениеПараметра("ДоговорКонтрагента", Справочники.ДоговорыКонтрагентов.ПустаяСсылка());
		ПлатежныеПорученияВходящие.Параметры.УстановитьЗначениеПараметра("ДоговорКонтрагента", Справочники.ДоговорыКонтрагентов.ПустаяСсылка());
	КонецЕсли;
	
	Для каждого СтрокаИсточник Из Объект.ГрафикНачислений Цикл
		СтрокаПриемник = мГрафикНачислений.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаПриемник, СтрокаИсточник);
	КонецЦикла;
	
	ПустойУИД = Новый УникальныйИдентификатор("00000000-0000-0000-0000-000000000000");
	ОплаченныеЗаявкиБ.Параметры.УстановитьЗначениеПараметра("_ДокументОснование", Объект.Ссылка);	
	ОплаченныеЗаявкиБ.Параметры.УстановитьЗначениеПараметра("ПустойУИД", ПустойУИД);	
	
	
	//Для каждого СтрокаИсточник Из Объект.ГрафикПлатежей Цикл
	//	СтрокаПриемник = мГрафикПлатежей.Добавить();
	//	ЗаполнитьЗначенияСвойств(СтрокаПриемник, СтрокаИсточник);
	//КонецЦикла;
	
	//Для каждого СтрокаИсточник Из Объект.ГрафикПоступлений Цикл
	//	СтрокаПриемник = мГрафикПоступлений.Добавить();
	//	ЗаполнитьЗначенияСвойств(СтрокаПриемник, СтрокаИсточник);
	//КонецЦикла; 
	//
	//Для каждого СтрокаИсточник Из Объект.ДетализацияГрафикаПоступлений Цикл
	//	СтрокаПриемник = мДетализацияГрафикаПоступлений.Добавить();
	//	ЗаполнитьЗначенияСвойств(СтрокаПриемник, СтрокаИсточник);
	//КонецЦикла;
	
	//ПолучитьПредельнуюСуммуПоДоговору(); 
	//РассчитатьИтогПоСтарымОплаченнымЗаявкам(); 
	//РассчитатьИтогПоПлатежнымПоручениям();
	
    //ЗагрузитьСвободныеПлатежки();
	
	ЗагрузитьВсеПлатежныеПоручения();
	ПересчитатьАгрегатыНаСервере();
	
	
КонецПроцедуры // ПриСозданииНаСервере()

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	СохранитьТЗмГрафикНачислений(ТекущийОбъект);
	
	
	//СохранитьТЗмГрафикПлатежей(ТекущийОбъект);	
	//СохранитьТЗмГрафикПоступлений(ТекущийОбъект);	
	
	ТекСтатус = ПолучитьТекущийСтатусОбъекта(Объект.Ссылка);
	
	Если Строка(ТекущийОбъект.мТекущийСтатус) = "Утвержден" Тогда
		Отказ = Истина;
		Сообщить("Документ не может быть сохранен. Текущий статус: " + ТекСтатус + Символы.ПС + "Сохранение введенных данных возможно в случае снятия визы 'Утверждено'.");
	КонецЕсли;
	
	//СохранитьПообъектныйГрафикПлатежей(ТекущийОбъект);
	
КонецПроцедуры // ПередЗаписьюНаСервере()

&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)
	
	Если ПараметрыЗаписи.РежимЗаписи <> РежимЗаписиДокумента.ОтменаПроведения Тогда
		
		СтруктураПараметров = Новый Структура;
		СтруктураПараметров.Вставить("Объект", Объект.Ссылка);
		КоличествоВиз = бит_Визирование.ОпределитьКоличествоВиз(СтруктураПараметров); 
		
		Если КоличествоВиз = 0 Тогда
			ЗаполнитьВизы();
		КонецЕсли; 
		
	КонецЕсли; 
	
	ТекущийСтатус 		 = ТекущийОбъект.мТекущийСтатус;
	ДатаИзмененияСтатуса = ТекущийОбъект.мДатаИзмененияСтатуса;
	
	мКэшЗначений.Вставить("ТекущийСтатус"		, ТекущийСтатус);
	мКэшЗначений.Вставить("ДатаИзмененияСтатуса", ДатаИзмененияСтатуса);
	
	ЭтаФорма.Статус               = ТекущийСтатус;
	ЭтаФорма.ДатаИзмененияСтатуса = ДатаИзмененияСтатуса;
	
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("Статус"			   , ТекущийСтатус);
	СтруктураПараметров.Вставить("ДатаИзмененияСтатуса", ДатаИзмененияСтатуса);
	
	ЭтаФорма.ИнформацияСтатус = бит_ОбщегоНазначенияКлиентСервер.СформироватьИнформациюСтатус(СтруктураПараметров);
	
	//ОбновитьДокументыПланирования();
	//
	УправлениеЭлементамиФормы();
	
КонецПроцедуры // ПослеЗаписиНаСервере()

&НаКлиенте
Процедура ДатаНачалаПриИзменении(Элемент)
	
	Отказ = Ложь;
	ПроверитьПериод(Отказ);
	
КонецПроцедуры

&НаКлиенте
Процедура ДатаОкончанияПриИзменении(Элемент)
	
	Отказ = Ложь;
	ПроверитьПериод(Отказ);
	
КонецПроцедуры

&НаКлиенте
Процедура ПриНажатииНаКнопкуПолучитьСтатьюОборотов()
	
	Если НЕ ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору.СтатьяОборотовНачисления) Тогда
		Возврат;
	КонецЕсли;
	
	ПриНажатииНаКнопкуПолучитьСтатьюОборотовНаСервере();
	
	ЭтаФорма.Прочитать();
	
КонецПроцедуры

&НаСервере
Процедура ПриНажатииНаКнопкуПолучитьСтатьюОборотовНаСервере()
	
	МассивОбъектов = _ПТЭ.ПолучитьСписокОбъектовДляЗаполненияСтатейОборотов(Объект.ДопУсловияПоДоговору.ДоговорКонтрагента);
	
	Для Каждого Эл Из МассивОбъектов Цикл
		ДействиеВыполнено = _ПТЭ.ДобавитьСтатьюОборотовССопоставлением(Эл);
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ПриНажатииНаКнопкуПолучитьОбъектСтроительства()
	
	ТекущиеДанные = Элементы.ГрафикНачислений.ТекущиеДанные;
	//СтрокаГрафика = ТекущиеДанные;
	
	Если НЕ ЗначениеЗаполнено(ТекущиеДанные.Аналитика_4) Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОбъектыСтроительства.Ссылка КАК ОбъектСтроительства,
	|	ОбъектыСтроительства.Код,
	|	ОбъектыСтроительства.Родитель КАК Группа,
	|	ОбъектыСтроительства._ОсновноеМероприятие,
	|	ОбъектыСтроительства._ОсновноеМероприятие.Код,
	|	ОбъектыСтроительства._ОсновноеМероприятие.Кодификатор,
	|	ОбъектыСтроительства._ОсновнойПроект,
	|	ОбъектыСтроительства._ОсновнойПроект.Код
	|ИЗ
	|	Справочник.ОбъектыСтроительства КАК ОбъектыСтроительства
	|ГДЕ
	|	ОбъектыСтроительства._ОсновноеМероприятие = &_ОсновноеМероприятие
	|	И ОбъектыСтроительства.ПометкаУдаления = Ложь";
	
	Запрос.УстановитьПараметр("_ОсновноеМероприятие", ТекущиеДанные.Аналитика_4);
	
	РезультатЗапроса = Запрос.Выполнить();
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Если ВыборкаДетальныеЗаписи.Количество() = 1  Тогда   
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			ТекущиеДанные.Аналитика_2 = ВыборкаДетальныеЗаписи.ОбъектСтроительства;
		КонецЦикла;
	ИначеЕсли ВыборкаДетальныеЗаписи.Количество() > 1 Тогда
		
		ВыбраннаяСтрока = РезультатЗапроса.Выгрузить().ВыбратьСтроку("Выберите объект строительства");
		Если НЕ ВыбраннаяСтрока = Неопределено Тогда
			ВыбранныйОбъектСтроительства = 	  ВыбраннаяСтрока.ОбъектСтроительства;
		КонецЕсли;
		
		Если 	ТипЗнч(ВыбранныйОбъектСтроительства ) = Тип("СправочникСсылка.ОбъектыСтроительства") 
			и 
			НЕ ВыбранныйОбъектСтроительства  = Справочники.ОбъектыСтроительства.ПустаяСсылка()
			Тогда
			ТекущиеДанные.Аналитика_2 = ВыбранныйОбъектСтроительства;
		КонецЕсли;
		
	ИначеЕсли ВыборкаДетальныеЗаписи.Количество() = 0 Тогда
		Если Вопрос("Не найден объект строительства. Создать новый?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Да Тогда 
			ВыборГруппы = ОткрытьФормуМодально("Справочник.ОбъектыСтроительства.ФормаВыбораГруппы");
			Если НЕ ВыборГруппы = Неопределено Тогда 
				НовыйОбъектСтроительства = Справочники.ОбъектыСтроительства.СоздатьЭлемент();
				НовыйОбъектСтроительства.Родитель = ВыборГруппы;
				НовыйОбъектСтроительства._ОсновноеМероприятие = ТекущиеДанные.Аналитика_4;
				НовыйОбъектСтроительства._ОсновнойПроект = ТекущиеДанные.Проект;
				НовыйОбъектСтроительства.Наименование = ТекущиеДанные.Аналитика_4.Наименование;
				НовыйОбъектСтроительства.Записать();
				ТекущиеДанные.Аналитика_2 = НовыйОбъектСтроительства.Ссылка;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗакупкаГКПЗПриИзменении(Элемент) 
	
	ВыбраннаяЗакупка = объект.ЗакупкаГКПЗ;
	
	Если ЗначениеЗаполнено(объект.ЗакупкаГКПЗ) Тогда
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	бит_ДополнительныеУсловияПоДоговору.Ссылка,
		|	бит_ДополнительныеУсловияПоДоговору.Контрагент,
		|	бит_ДополнительныеУсловияПоДоговору.ДоговорКонтрагента,
		|	бит_ДополнительныеУсловияПоДоговору.ПроектДоговора,
		|	бит_ДополнительныеУсловияПоДоговору.ЦФО,
		|	бит_ДополнительныеУсловияПоДоговору.Инициатор
		|ИЗ
		|	Документ.бит_ДополнительныеУсловияПоДоговору КАК бит_ДополнительныеУсловияПоДоговору
		|ГДЕ
		|	бит_ДополнительныеУсловияПоДоговору.ПроектДоговора._ЗакупкаГКПЗ = &_ЗакупкаГКПЗ";
		
		Запрос.УстановитьПараметр("_ЗакупкаГКПЗ", объект.ЗакупкаГКПЗ);
		РезультатЗапроса = Запрос.Выполнить();
		
		Если РезультатЗапроса.Пустой() Тогда
			Предупреждение("Не найдены дополнительные условия по договору по указанной закупке");
			Объект.ДопУсловияПоДоговору = Неопределено;
			Объект.Основание 			= Неопределено;
		Иначе
			ТЗ = РезультатЗапроса.Выгрузить();
			Если ТЗ.Количество() = 1 Тогда
				ОчиститьРеквизитыИТабличныеЧасти();				
				Объект.ДопУсловияПоДоговору = ТЗ[0].Ссылка;
				Объект.Основание 			= ТЗ[0].Ссылка;
				Объект.ЗакупкаГКПЗ 			= ВыбраннаяЗакупка;
			Иначе
				ВыбраннаяСтрока = ТЗ.ВыбратьСтроку("Выберите нужный элемент");
				Если НЕ ВыбраннаяСтрока = Неопределено Тогда    
					ОчиститьРеквизитыИТабличныеЧасти();				
					Объект.ДопУсловияПоДоговору = ВыбраннаяСтрока.Ссылка;
					Объект.Основание 			= ВыбраннаяСтрока.Ссылка;
					Объект.ЗакупкаГКПЗ 			= ВыбраннаяЗакупка;
				КонецЕсли;
			КонецЕсли;	
		КонецЕсли;	
	КонецЕсли;
	
	//ОбновитьСуммуБезНДСПоДоговору();
	
	УстановитьНастройкиДоступностиЭлементов();
	
КонецПроцедуры

&НаКлиенте
Процедура мСтрокаПоискаДоговораПриИзменении(Элемент) 
	
	Если СокрЛП(мСтрокаПоискаДоговора) = "" Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	бит_ДополнительныеУсловияПоДоговору.ДоговорКонтрагента.Владелец КАК Контрагент,
	|	бит_ДополнительныеУсловияПоДоговору.ДоговорКонтрагента.Наименование КАК Наименование,
	|	бит_ДополнительныеУсловияПоДоговору.ДоговорКонтрагента.Номер КАК Номер,
	|	бит_ДополнительныеУсловияПоДоговору.ДоговорКонтрагента.Дата КАК Дата,
	|	бит_ДополнительныеУсловияПоДоговору.Ссылка КАК ДопУсловия
	|ИЗ
	|	Документ.бит_ДополнительныеУсловияПоДоговору КАК бит_ДополнительныеУсловияПоДоговору
	|ГДЕ
	|	бит_ДополнительныеУсловияПоДоговору.ПометкаУдаления = ЛОЖЬ
	|	И бит_ДополнительныеУсловияПоДоговору.ДоговорКонтрагента.Номер ПОДОБНО ""%"" + &СтрокаПоискаДоговора + ""%""";
	
	Запрос.УстановитьПараметр("СтрокаПоискаДоговора", мСтрокаПоискаДоговора);
	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой()  Тогда
		Предупреждение("Договор не найден");
	Иначе
		ТЗ = РезультатЗапроса.Выгрузить();
		Строка = тз.ВыбратьСтроку("Выберите договор");
		Если Не Строка = Неопределено Тогда
			ОчиститьРеквизитыИТабличныеЧасти();
			Объект.ДопУсловияПоДоговору = Строка.ДопУсловия;
			Объект.Основание 			= Строка.ДопУсловия;
			Если ЗначениеЗаполнено(Строка.ДопУсловия.ПроектДоговора) Тогда
				Объект.ЗакупкаГКПЗ = Строка.ДопУсловия.ПроектДоговора._ЗакупкаГКПЗ;
			КонецЕсли;
			УстановитьНастройкиДоступностиЭлементов();
			Модифицированность = Истина;
		КонецЕсли;
	КонецЕсли;
	
	
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьВхождениеПользователяВЦФО() 
	
	ФИОСотрудника 	= ПараметрыСеанса.ТекущийПользователь;
	ЦФОСотрудника	= Неопределено; 
	ЦФОДокумента 	= Неопределено;
	ЦФОФинУп		= Справочники.Подразделения.НайтиПоКоду("000000257");
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	_СоответствиеЦФОиСотрудников.ЦФО,
	|	_СоответствиеЦФОиСотрудников.Сотрудник
	|ИЗ
	|	РегистрСведений._СоответствиеЦФОиСотрудников КАК _СоответствиеЦФОиСотрудников
	|Где 
	|	_СоответствиеЦФОиСотрудников.Сотрудник.Наименование = &ФИОСотрудника
	|";
	
	Запрос.Параметры.Вставить("ФИОСотрудника", Строка(ФИОСотрудника));	
	РезультатЗапроса = Запрос.Выполнить();
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		ЦФОСотрудника = ВыборкаДетальныеЗаписи.ЦФО;
	КонецЦикла;
	
	Если ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору) и ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору.Инициатор) Тогда
		ЦФОДокумента = Объект.ДопУсловияПоДоговору.Инициатор;
	КонецЕсли;                                                              
	
	Если ЦФОДокумента = Неопределено Тогда
		Сообщить("Подразделение-инициатор для договора не определено. Запись документа ограничена.");	
	КонецЕсли; 
	
	Если РольДоступна("ПолныеПрава") или РольДоступна("_ПТЭ_ПолныеПрава") или РольДоступна("_ПТЭ_ПолныеПраваБезШтатногоРасписания") Тогда
		Возврат;
	КонецЕсли;
	
	Если ЦФОСотрудника = ЦФОФинУп Тогда
		Возврат;
	КонецЕсли; 
	
	Если ЦФОСотрудника = ЦФОДокумента и ЦФОДокумента <> Неопределено и ЦФОСотрудника <> Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ЭтаФорма.ТолькоПросмотр = Истина;
	
	//Сообщить("Запись документа доступна только для сотрудников соответствующего подразделения-инициатора");
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьКэшЗначений()
	
	ДокументОбъект = РеквизитФормыВЗначение("Объект");
	
	мКэшЗначений = Новый Структура;
	
	// Запишем параметр для формирования заголовка.
	мКэшЗначений.Вставить("ПредставлениеОбъекта", Объект.Ссылка.Метаданные().ПредставлениеОбъекта);
	
	КэшПеречисления = Новый Структура;
	
	КэшПеречисления.Вставить("бит_РасходДоход"					   , бит_ОбщегоНазначения.КэшироватьЗначенияПеречисления(Перечисления.бит_РасходДоход));
	КэшПеречисления.Вставить("ВидыДоговоровКонтрагентов"		   , бит_ОбщегоНазначения.КэшироватьЗначенияПеречисления(Перечисления.ВидыДоговоровКонтрагентов));
	КэшПеречисления.Вставить("бит_ВидыОперацийЗаявкаНаРасходование", бит_ОбщегоНазначения.КэшироватьЗначенияПеречисления(Перечисления.бит_ВидыОперацийЗаявкаНаРасходование));
	КэшПеречисления.Вставить("бит_ВидыДенежныхСредств"			   , бит_ОбщегоНазначения.КэшироватьЗначенияПеречисления(Перечисления.бит_ВидыДенежныхСредств));
	КэшПеречисления.Вставить("бит_ТипыСтатейОборотов"			   , бит_ОбщегоНазначения.КэшироватьЗначенияПеречисления(Перечисления.бит_ТипыСтатейОборотов));
	КэшПеречисления.Вставить("бит_ПериодичностьПланирования"	   , бит_ОбщегоНазначения.КэшироватьЗначенияПеречисления(Перечисления.бит_ПериодичностьПланирования));
	
	мКэшЗначений.Вставить("Перечисления", КэшПеречисления);
	
	СтруктураСтатусов = Новый Структура;
	СтруктураСтатусов.Вставить("ДополнительныеУсловияПоДоговору_Утвержден", Справочники.бит_СтатусыОбъектов.ДополнительныеУсловияПоДоговору_Утвержден);
	
	мКэшЗначений.Вставить("СтатусыДокумента", СтруктураСтатусов);            
	
	// Сформируем список доступных валют.
	СписокВалют = бит_Казначейство.СформироватьСписокДоступныхВалют(Объект.ДопУсловияПоДоговору);
	
	мКэшЗначений.Вставить("СписокВалют", СписокВалют);
	
	мКэшЗначений.Вставить("ВалютаРегламентированногоУчета", Константы.ВалютаРегламентированногоУчета.Получить());
	
	ОпределитьСписокДоступныхВидовДоговоровПоОперации(Объект.ДопУсловияПоДоговору.ВидОперации, Объект.ДопУсловияПоДоговору.РасходДоход, мКэшЗначений);
	
	мКэшЗначений.Вставить("ТекущийСтатус"       , ДокументОбъект.мТекущийСтатус);
	мКэшЗначений.Вставить("ДатаИзмененияСтатуса", ДокументОбъект.мДатаИзмененияСтатуса);
	
	мКэшЗначений.Вставить("ИзмеренияДоп"      , ДокументОбъект.мИзмеренияДоп);
	мКэшЗначений.Вставить("НастройкиИзмерений", ДокументОбъект.мНастройкиИзмерений);
	
	КолАн = бит_МеханизмДопИзмерений.ПолучитьМаксимальноеКоличествоДополнительныхИзмерений();
	мКэшЗначений.Вставить("МаксКолвоДопАналитик", КолАн);
	
	//мКэшЗначений.Вставить("ПериодичностьСоставляющейОсновнойДолг", ОпределитьПериодичностьСоставляющейОсновнойДолг());
	
	// чтобы не возникало ошибок, проверим, достаточно ли у текущего пользователя прав на просмотр определенных типов документов
	МетаЗаявкаНаРасходДС = Метаданные.Документы.бит_ЗаявкаНаРасходованиеСредств;
	МетаЗаявкаНаЗатраты	 = Метаданные.Документы.бит_ЗаявкаНаЗатраты;
	
	мКэшЗначений.Вставить("ЕстьПравоПросмотрЗаявкаНаРасходДС", ПравоДоступа("Просмотр", МетаЗаявкаНаРасходДС));
	мКэшЗначений.Вставить("ЕстьПравоПросмотрЗаявкаНаЗатраты" , ПравоДоступа("Просмотр", МетаЗаявкаНаЗатраты));
	
КонецПроцедуры // ЗаполнитьКэшЗначений()

&НаСервере
Процедура УправлениеЭлементамиФормы() 
	
	элементы.мГрафикПлатежейПрогноз.Видимость = Ложь;
	элементы.мГрафикПлатежейФакт.Видимость = Ложь;
	
	ЦветФонаСветлоСерый = Новый Цвет(240, 240, 240);
	ЦветТекстаСерый = Новый Цвет(100, 100, 100);   
	
	//Шапка
	Элементы.ДопУсловияПоДоговоруДоговорКонтрагентаОсновнаяСтатьяДвиженияДенежныхСредств.Видимость = Ложь;
	
	//График начислений
	Элементы.мГрафикНачисленийИнициатор.ТолькоПросмотр 				= Истина;
	Элементы.мГрафикНачисленийСтатьяБюджета.ТолькоПросмотр 			= Истина;
	Элементы.мГрафикНачисленийНомерСтроки.ТолькоПросмотр 			= Истина;
	Элементы.мГрафикНачисленийНДС.ТолькоПросмотр 					= Истина;
	Элементы.мГрафикНачисленийСумма.ТолькоПросмотр 					= Истина;  
	Элементы.мГрафикПлатежейСуммаОсвоения.ТолькоПросмотр			= Истина; 
	Элементы.мГрафикПлатежейПрогноз.ТолькоПросмотр					= Истина; 
	Элементы.мГрафикПлатежейФакт.ТолькоПросмотр						= Истина; 
	
	Элементы.мГрафикНачисленийИнициатор.ЦветТекста 					= ЦветТекстаСерый;
	Элементы.мГрафикНачисленийСтатьяБюджета.ЦветТекста 				= ЦветТекстаСерый;
	Элементы.мГрафикНачисленийНомерСтроки.ЦветТекста 				= ЦветТекстаСерый;
	Элементы.мГрафикНачисленийАналитика_7Код.ЦветТекста 			= ЦветТекстаСерый;
	Элементы.мГрафикНачисленийПроект.ЦветТекста 					= ЦветТекстаСерый;
	Элементы.мГрафикНачисленийАналитика_6.ЦветТекста 				= ЦветТекстаСерый;
	Элементы.мГрафикНачисленийАналитика_1.ЦветТекста 				= ЦветТекстаСерый;
	Элементы.мГрафикНачисленийСтатьяОборотовНачисления.ЦветТекста 	= ЦветТекстаСерый;
	Элементы.мГрафикНачисленийСтатьяБюджета.ЦветТекста 				= ЦветТекстаСерый;
	Элементы.мГрафикНачисленийСтатьяБюджета_Раздел.ЦветТекста 		= ЦветТекстаСерый;
	Элементы.мГрафикНачисленийАналитика_4.ЦветТекста 				= ЦветТекстаСерый;
	Элементы.мГрафикНачисленийНДС.ЦветТекста 						= ЦветТекстаСерый;
	Элементы.мГрафикНачисленийСумма.ЦветТекста 						= ЦветТекстаСерый;
	
	Элементы.мГрафикНачисленийИнициатор.ЦветФона 					= ЦветФонаСветлоСерый;
	Элементы.мГрафикНачисленийСтатьяБюджета.ЦветФона 				= ЦветФонаСветлоСерый;
	Элементы.мГрафикНачисленийНомерСтроки.ЦветФона 					= ЦветФонаСветлоСерый;
	Элементы.мГрафикНачисленийАналитика_7Код.ЦветФона 				= ЦветФонаСветлоСерый;
	Элементы.мГрафикНачисленийПроект.ЦветФона 						= ЦветФонаСветлоСерый;
	Элементы.мГрафикНачисленийАналитика_6.ЦветФона 					= ЦветФонаСветлоСерый;
	Элементы.мГрафикНачисленийАналитика_1.ЦветФона 					= ЦветФонаСветлоСерый;
	Элементы.мГрафикНачисленийСтатьяОборотовНачисления.ЦветФона 	= ЦветФонаСветлоСерый;
	Элементы.мГрафикНачисленийСтатьяБюджета.ЦветФона 				= ЦветФонаСветлоСерый;
	Элементы.мГрафикНачисленийСтатьяБюджета_Раздел.ЦветФона 		= ЦветФонаСветлоСерый;
	Элементы.мГрафикНачисленийАналитика_4.ЦветФона 					= ЦветФонаСветлоСерый; 
	Элементы.мГрафикНачисленийНДС.ЦветФона 							= ЦветФонаСветлоСерый;
	Элементы.мГрафикНачисленийСумма.ЦветФона 						= ЦветФонаСветлоСерый;
	
	//График платежей
	Элементы.мГрафикПлатежейНомерСтроки.ТолькоПросмотр 							= Истина;
	Элементы.мГрафикПлатежейНДС.ТолькоПросмотр 									= Истина;
	Элементы.мГрафикПлатежейСтатус.ТолькоПросмотр 								= Истина; 
	
	Элементы.мГрафикПлатежейНомерСтроки.ЦветТекста 									= ЦветТекстаСерый;
	Элементы.мГрафикПлатежейСтатус.ЦветТекста 										= ЦветТекстаСерый;
	Элементы.мГрафикПлатежейДокументПланирования.ЦветТекста 						= ЦветТекстаСерый;
	Элементы.мГрафикПлатежейЗаявкаНаРасходованиеДС.ЦветТекста 						= ЦветТекстаСерый;
	Элементы.мГрафикПлатежейПлатежноеПоручениеИсходящее.ЦветТекста 					= ЦветТекстаСерый;
	Элементы.мГрафикПлатежейНДС.ЦветТекста 											= ЦветТекстаСерый;
	Элементы.мГрафикПлатежейДокументПланированияСумма.ЦветТекста					= ЦветТекстаСерый;
	Элементы.мГрафикПлатежейЗаявкаНаРасходованиеДССумма.ЦветТекста					= ЦветТекстаСерый;
	Элементы.мГрафикПлатежейПлатежноеПоручениеИсходящееСуммаДокумента.ЦветТекста	= ЦветТекстаСерый;
	Элементы.мГрафикПлатежейСуммаОсвоения.ЦветТекста								= ЦветТекстаСерый;
	Элементы.мГрафикПлатежейФакт.ЦветТекста 										= ЦветТекстаСерый;
	Элементы.мГрафикПлатежейПрогноз.ЦветТекста 										= ЦветТекстаСерый;
	
	
	
	Элементы.мГрафикПлатежейНомерСтроки.ЦветФона 									= ЦветФонаСветлоСерый;
	Элементы.мГрафикПлатежейСтатус.ЦветФона 										= ЦветФонаСветлоСерый; 
	Элементы.мГрафикПлатежейДокументПланирования.ЦветФона 							= ЦветФонаСветлоСерый; 
	Элементы.мГрафикПлатежейЗаявкаНаРасходованиеДС.ЦветФона 						= ЦветФонаСветлоСерый;
	Элементы.мГрафикПлатежейПлатежноеПоручениеИсходящее.ЦветФона 					= ЦветФонаСветлоСерый;
	Элементы.мГрафикПлатежейНДС.ЦветФона 											= ЦветФонаСветлоСерый;
	Элементы.мГрафикПлатежейДокументПланированияСумма.ЦветФона						= ЦветФонаСветлоСерый;
	Элементы.мГрафикПлатежейЗаявкаНаРасходованиеДССумма.ЦветФона					= ЦветФонаСветлоСерый;
	Элементы.мГрафикПлатежейПлатежноеПоручениеИсходящееСуммаДокумента.ЦветФона		= ЦветФонаСветлоСерый;
	Элементы.мГрафикПлатежейСуммаОсвоения.ЦветФона									= ЦветФонаСветлоСерый;
	Элементы.мГрафикПлатежейДокументПланированияПроведен.ЦветФона					= ЦветФонаСветлоСерый;
	Элементы.мГрафикПлатежейЗаявкаНаРасходованиеДСПроведен.ЦветФона					= ЦветФонаСветлоСерый;
	Элементы.мГрафикПлатежейПлатежноеПоручениеИсходящееПроведен.ЦветФона			= ЦветФонаСветлоСерый; 
	Элементы.мГрафикПлатежейПрогноз.ЦветФона										= ЦветФонаСветлоСерый;
	Элементы.мГрафикПлатежейФакт.ЦветФона											= ЦветФонаСветлоСерый;  
	
	
	//График поступлений
	Элементы.мГрафикПоступленийНомерСтрокиДляОтображения.ТолькоПросмотр 				= Истина;
	Элементы.мГрафикПоступленийСтатус.ТолькоПросмотр 									= Истина; 
	
	Элементы.мГрафикПоступленийНомерСтрокиДляОтображения.ЦветТекста 					= ЦветТекстаСерый;
	Элементы.мГрафикПоступленийСтатус.ЦветТекста 										= ЦветТекстаСерый;
	Элементы.мГрафикПоступленийДокументПланирования.ЦветТекста 							= ЦветТекстаСерый;
	//Элементы.мГрафикПоступленийПлатежноеПоручениеВходящее.ЦветТекста 					= ЦветТекстаСерый;
	Элементы.мГрафикПоступленийДокументПланированияСумма.ЦветТекста						= ЦветТекстаСерый;
	//Элементы.мГрафикПоступленийПлатежноеПоручениеВходящееСуммаДокумента.ЦветТекста	= ЦветТекстаСерый;
	Элементы.мГрафикПоступленийСуммаПлатежа.ЦветТекста									= ЦветТекстаСерый;
	Элементы.мГрафикПоступленийФакт.ЦветТекста 											= ЦветТекстаСерый;
	Элементы.мГрафикПоступленийПрогноз.ЦветТекста 										= ЦветТекстаСерый;
	
	Элементы.мГрафикПоступленийНомерСтрокиДляОтображения.ЦветФона 						= ЦветФонаСветлоСерый;
	Элементы.мГрафикПоступленийСтатус.ЦветФона 											= ЦветФонаСветлоСерый; 
	Элементы.мГрафикПоступленийДокументПланирования.ЦветФона 							= ЦветФонаСветлоСерый; 
	//Элементы.мГрафикПоступленийПлатежноеПоручениеВходящее.ЦветФона 					= ЦветФонаСветлоСерый;
	Элементы.мГрафикПоступленийДокументПланированияСумма.ЦветФона						= ЦветФонаСветлоСерый;
	//Элементы.мГрафикПоступленийПлатежноеПоручениеВходящееСуммаДокумента.ЦветФона		= ЦветФонаСветлоСерый;
	Элементы.мГрафикПоступленийСуммаПлатежа.ЦветФона									= ЦветФонаСветлоСерый;
	Элементы.мГрафикПоступленийДокументПланированияПроведен.ЦветФона					= ЦветФонаСветлоСерый;
	//Элементы.мГрафикПоступленийПлатежноеПоручениеВходящееПроведен.ЦветФона			= ЦветФонаСветлоСерый; 
	Элементы.мГрафикПоступленийПрогноз.ЦветФона											= ЦветФонаСветлоСерый;
	Элементы.мГрафикПоступленийФакт.ЦветФона											= ЦветФонаСветлоСерый;   
	
	//ДетализацияГрафикаПоступлений   
	
	Элементы.мДетализацияГрафикаПоступленийНомерСтрокиДляОтображения.ТолькоПросмотр 		= Истина;
	
   	Элементы.мДетализацияГрафикаПоступленийНомерСтрокиДляОтображения.ЦветТекста 			= ЦветТекстаСерый; 
	Элементы.мДетализацияГрафикаПоступленийНомерСтрокиДляОтображения.ЦветФона 				= ЦветФонаСветлоСерый;
   	Элементы.мДетализацияГрафикаПоступленийПлатежноеПоручениеВходящее.ЦветТекста 			= ЦветТекстаСерый; 
	Элементы.мДетализацияГрафикаПоступленийПлатежноеПоручениеВходящее.ЦветФона 				= ЦветФонаСветлоСерый;
   	Элементы.мДетализацияГрафикаПоступленийСуммаДокумента.ЦветТекста 						= ЦветТекстаСерый; 
	Элементы.мДетализацияГрафикаПоступленийСуммаДокумента.ЦветФона 							= ЦветФонаСветлоСерый;
	
	//ГрафикПлатежейБ
	
	Элементы.нГрафикПлатежейНомерСтрокиДляОтображения.ТолькоПросмотр 							= Истина;
	//Элементы.нГрафикПлатежейДокументПланирования.ТолькоПросмотр 								= Истина;
	Элементы.нГрафикПлатежейДокументПланированияСумма.ТолькоПросмотр 							= Истина;
	Элементы.нГрафикПлатежейДокументПланированияПроведен.ТолькоПросмотр 						= Истина;
	Элементы.нГрафикПлатежейСуммаПлатежа.ТолькоПросмотр 										= Истина;
	Элементы.нГрафикПлатежейПрогноз.ТолькоПросмотр 												= Истина;
	Элементы.нГрафикПлатежейФакт.ТолькоПросмотр 												= Истина;

	Элементы.нГрафикПлатежейНомерСтрокиДляОтображения.ЦветФона									= ЦветФонаСветлоСерый;
	Элементы.нГрафикПлатежейДокументПланирования.ЦветФона										= ЦветФонаСветлоСерый;
	Элементы.нГрафикПлатежейДокументПланированияСумма.ЦветФона									= ЦветФонаСветлоСерый;
	Элементы.нГрафикПлатежейДокументПланированияПроведен.ЦветФона								= ЦветФонаСветлоСерый;
	Элементы.нГрафикПлатежейСуммаПлатежа.ЦветФона												= ЦветФонаСветлоСерый;
	Элементы.нГрафикПлатежейПрогноз.ЦветФона													= ЦветФонаСветлоСерый;
	Элементы.нГрафикПлатежейФакт.ЦветФона														= ЦветФонаСветлоСерый;
	
	Элементы.нГрафикПлатежейНомерСтрокиДляОтображения.ЦветТекста 								= ЦветТекстаСерый;
	Элементы.нГрафикПлатежейДокументПланирования.ЦветТекста 									= ЦветТекстаСерый;
	Элементы.нГрафикПлатежейДокументПланированияСумма.ЦветТекста 								= ЦветТекстаСерый;
	Элементы.нГрафикПлатежейДокументПланированияПроведен.ЦветТекста 							= ЦветТекстаСерый;
	Элементы.нГрафикПлатежейСуммаПлатежа.ЦветТекста 											= ЦветТекстаСерый;
	Элементы.нГрафикПлатежейПрогноз.ЦветТекста 													= ЦветТекстаСерый;
	Элементы.нГрафикПлатежейФакт.ЦветТекста 													= ЦветТекстаСерый;
	
	
	// Детализация графика платежей Б
	
	//Элементы.нДетализацияГрафикаПлатежейЗаявкаНаРасходованиеДС.ТолькоПросмотр 				= Истина;
	Элементы.нДетализацияГрафикаПлатежейЗаявкаНаРасходованиеДСПроведен.ТолькоПросмотр 			= Истина;
	Элементы.нДетализацияГрафикаПлатежейЗаявкаНаРасходованиеДССумма.ТолькоПросмотр 				= Истина;
	Элементы.нДетализацияГрафикаПлатежейЗаявкаНаРасходованиеДССтатус.ТолькоПросмотр 			= Истина;
	
	//Элементы.нДетализацияГрафикаПлатежейЗаявкаНаРасходованиеДС.ЦветФона							= ЦветФонаСветлоСерый;
	//Элементы.нДетализацияГрафикаПлатежейЗаявкаНаРасходованиеДСПроведен.ЦветФона					= ЦветФонаСветлоСерый;
	//Элементы.нДетализацияГрафикаПлатежейЗаявкаНаРасходованиеДССумма.ЦветФона					= ЦветФонаСветлоСерый;
	//Элементы.нДетализацияГрафикаПлатежейЗаявкаНаРасходованиеДССтатус.ЦветФона					= ЦветФонаСветлоСерый;
	//
	//Элементы.нДетализацияГрафикаПлатежейЗаявкаНаРасходованиеДС.ЦветТекста 						= ЦветТекстаСерый;
	//Элементы.нДетализацияГрафикаПлатежейЗаявкаНаРасходованиеДСПроведен.ЦветТекста 				= ЦветТекстаСерый;
	//Элементы.нДетализацияГрафикаПлатежейЗаявкаНаРасходованиеДССумма.ЦветТекста 					= ЦветТекстаСерый;
	//Элементы.нДетализацияГрафикаПлатежейЗаявкаНаРасходованиеДССтатус.ЦветТекста 				= ЦветТекстаСерый;
	
	УстановитьНастройкиДоступностиЭлементов();
	
КонецПроцедуры

&НаСервере
Процедура УстановитьНастройкиДоступностиЭлементов() 
	
	Если ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору) Тогда
		Элементы.ГруппаГрафикПлатежей.Доступность 	= Истина;
		Элементы.СтраницаГрафикНачислений.Доступность = Истина; 
	Иначе
		Элементы.ГруппаГрафикПлатежей.Доступность 	= Ложь;
		Элементы.СтраницаГрафикНачислений.Доступность = Ложь; 
	КонецЕсли;
	
	// Получение таблицы настроек доступности элементов управления.
	ТаблицаНастроекДоступности = бит_ОбщегоНазначения.ПолучитьНастройкиДоступностиЭлементовУправления(Объект, Истина);
	
	// Фильтр таблицы настроек по статусу.
	ДокументОбъект 			  = РеквизитФормыВЗначение("Объект");
	ТекущийСтатус			  = ДокументОбъект.мТекущийСтатус;
	ТаблицаАктуальныхНастроек = бит_ОбщегоНазначения.ПолучитьАктуальныеНастройки(ТаблицаНастроекДоступности
	,ТекущийСтатус);
	
	// Структура параметров для проверки произвольного условия.
	ПараметрыУсловия = Новый Структура;
	ПараметрыУсловия.Вставить("ТекущийОбъект", Объект);
	ПараметрыУсловия.Вставить("Статус"		 , ТекущийСтатус);
	
	// Применяем настройки.
	бит_ОбщегоНазначения.УстановитьДоступностьЭлементовУправленияПоНастройкам(ЭтаФорма
	,ТаблицаАктуальныхНастроек
	,ПараметрыУсловия);
	
КонецПроцедуры // УстановитьНастройкиДоступностиЭлементов() 

&НаКлиенте
Процедура ОчиститьРеквизитыИТабличныеЧасти()
	
	мГрафикНачислений.Очистить();
	мГрафикПлатежей.Очистить();
	Объект.ГрафикНачислений.Очистить();
	объект.ГрафикПлатежей.Очистить();
	ОчиститьНаСервере();
	
	ПриСозданииНаСервере(Ложь, Истина);	
	
КонецПроцедуры  

&НаСервере
Функция ОчиститьНаСервере()
	
	для Каждого рекв из ЭтаФорма.ПолучитьРеквизиты() Цикл
		
		Если рекв.имя = "Объект" Тогда
			об    = РеквизитФормыВЗначение("Объект");
			Для Каждого р Из об.Метаданные().Реквизиты Цикл
				Объект[р.Имя]    = Неопределено
			КонецЦикла;
			Для Каждого р Из об.Метаданные().ТабличныеЧасти Цикл
				Объект[р.Имя].Очистить()
			КонецЦикла;
		Иначе
			ОчиститьЭлемент(рекв.имя)
		КонецЕсли;
	КонецЦикла;
	
КонецФункции 

&НаКлиенте
Процедура ПроверитьПериод(Отказ)
	
	ДатаНачала = Объект.ДатаНачала;
	ДатаОкончания = Объект.ДатаОкончания;
	
	ДатаНачалаНачисленияПоДоговору = Объект.ДопУсловияПоДоговору.ДатаНачалаНачисления;
	ДатаОкончанияНачисленияПоДоговору = Объект.ДопУсловияПоДоговору.ДатаОкончанияНачисления;
	
	Если ДатаНачала > ДатаОкончания Тогда
		Отказ = Истина;
		ТекстСообщения = СтрШаблон("На вкладке 'График платежей' Дата начала (%1) больше Даты окончания (%2)", ДатаНачала, ДатаОкончания);
		Сообщить(ТекстСообщения);
	КонецЕсли;
	
	//Если НЕ (ДатаНачала >= ДатаНачалаНачисленияПоДоговору и ДатаОкончания <= ДатаОкончанияНачисленияПоДоговору) Тогда //и Не ЕстьПодготовкаДС() Тогда
	//	Отказ = Истина;
	//	ТекстСообщения = СтрШаблон("Период на вкладке 'График платежей' выходит за пределы периода по договору на вкладке 'Основные'");
	//    Сообщить(ТекстСообщения);
	//КонецЕсли;
	
КонецПроцедуры 

&НаКлиенте
Процедура ПроверитьЗаполнениеЦФО(Отказ)
	
	Для каждого Строка Из мГрафикНачислений Цикл
		Если Не ЗначениеЗаполнено(Строка.ЦФО) Тогда
			Отказ = Истина;
			ТекстСообщения = СтрШаблон("В строке %1 на вкладке 'График начислений' не заполнено ЦФО", 
			Строка.НомерСтроки);
			Сообщить(ТекстСообщения);
		КонецЕсли;
	КонецЦикла;
	
	//Для каждого Строка Из мГрафикПлатежей Цикл
	//	Если Не ЗначениеЗаполнено(Строка.ЦФО) Тогда
	//		Отказ = Истина;
	//		ТекстСообщения = СтрШаблон("В строке %1 на вкладке 'График платежей' не заполнено ЦФО", 
	//		Строка.НомерСтроки);
	//		Сообщить(ТекстСообщения);
	//	КонецЕсли;
	//КонецЦикла;
	
	
КонецПроцедуры 

&НаКлиенте
Процедура РассчитатьСуммы(Строка) 
	
	СуммаВключаетНДС = Ложь;
	УчитыватьНДС = Истина;
	
	Строка.НДС = УчетНДС.РассчитатьСуммуНДС(Строка.СуммаБезНДС,
	УчитыватьНДС, СуммаВключаетНДС,
	УчетНДС.ПолучитьСтавкуНДС(Строка.СтавкаНДС));	
	
	Строка.Сумма = Строка.СуммаБезНДС + Строка.НДС;											
	
КонецПроцедуры

#КонецОбласти  //ОбщаяЛогикаФормы

#Область ГрафикиНачислений 

&НаКлиенте
Процедура мГрафикНачисленийПериодПриИзменении(Элемент)
	
	СтрокаТЧ = Элементы.мГрафикНачислений.ТекущиеДанные;
	ПроверитьПериодНачисления(Ложь, СтрокаТЧ);
	
КонецПроцедуры

&НаКлиенте
Процедура мГрафикНачисленийСуммаБезНДСПриИзменении(Элемент)
	
	Строка = Элементы.мГрафикНачислений.ТекущиеДанные;
	РассчитатьСуммы(Строка);
	
КонецПроцедуры

&НаКлиенте
Процедура мГрафикНачисленийСтавкаНДСПриИзменении(Элемент)
	
	Строка = Элементы.мГрафикНачислений.ТекущиеДанные;
	РассчитатьСуммы(Строка);
	
КонецПроцедуры 

&НаКлиенте
Процедура мГрафикНачисленийПодготовкаДСПриИзменении(Элемент)
	
	Строка = Элементы.мГрафикНачислений.ТекущиеДанные;
	Если НЕ Строка.ПодготовкаДС Тогда
		Строка.СтатусДС = Неопределено;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ГрафикНачисленийАналитика_7ПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.ГрафикНачислений.ТекущиеДанные;
	ТекущиеДанные.КодПотребности = ЗначениеРеквизита(ТекущиеДанные.Аналитика_7, "Код");
	
	
	// {PTE-0000081633 Кораблев Владимир Александрович 2024/07/12
	ТекущиеДанные.ЦФО  =  ЗначениеРеквизита(ТекущиеДанные.Аналитика_7, "ЦФО"); 
	ТекущиеДанные.СтатьяОборотовНачисления    =  ЗначениеРеквизита(ТекущиеДанные.Аналитика_7, "СтатьяОборотов");   
	ТекущиеДанные.Аналитика_6 				  =  ЗначениеРеквизита(ТекущиеДанные.Аналитика_7, "СубъектРФ");    
	ТекущиеДанные.Проект                      =  ЗначениеРеквизита(ТекущиеДанные.Аналитика_7, "Проект"); 
	ТекущиеДанные.Аналитика_1                 =  ЗначениеРеквизита(ТекущиеДанные.Аналитика_7, "ВидРасхода");    
	ТекущиеДанные.Аналитика_4                 =  ЗначениеРеквизита(ТекущиеДанные.Аналитика_7, "Мероприятие"); 
	Если Число(Строка(Формат(Объект.ДатаОкончанияНачисления, "ДФ=гггг"))) < ЗначениеРеквизита(ТекущиеДанные.Аналитика_7, "Год") Тогда
		Сообщить("Период по Дату , меньше чем Год указанный в потребности, выбиретие другую потребность или измените окончание периода" ) ;   
	КонецЕсли;
	// }PTE-0000081633
	
КонецПроцедуры

&НаКлиенте
Процедура мГрафикНачисленийЦФОПриИзменении(Элемент)
	
	ПотребностьЗаполнитьСписокВыбора();
	ПроверитьНеобходимостьСброситьПотребность();
	ПроверитьНеобходимостьСброситьОбъектСтроительства();
	
КонецПроцедуры

&НаКлиенте
Процедура мГрафикНачисленийПриИзменении(Элемент)
	
	мГрафикНачисленийОбновитьСтолбцы();
	
КонецПроцедуры 

&НаКлиенте
Процедура мГрафикНачисленийАналитика_7ПриИзменении(Элемент)
	
	мГрафикНачисленийОбновитьСтолбцы(); 
	ОбъектыСтроительстваЗаполнитьСписокВыбора();	
	ПроверитьНеобходимостьСброситьОбъектСтроительства();
	
КонецПроцедуры

&НаКлиенте
Процедура мГрафикНачисленийПередНачаломИзменения(Элемент, Отказ)
	
	ЦФОЗаполнитьСписокВыбора();
	ПотребностьЗаполнитьСписокВыбора();
	ОбъектыСтроительстваЗаполнитьСписокВыбора();
	
КонецПроцедуры

&НаКлиенте
Процедура ДатаНачалаНачисленияПриИзменении(Элемент)
	
	Отказ = Ложь;
	ПроверитьПериодПоставки(Отказ);
	
КонецПроцедуры

&НаКлиенте
Процедура ДатаОкончанияНачисленияПриИзменении(Элемент)
	
	Отказ = Ложь;
	ПроверитьПериодПоставки(Отказ);
	
КонецПроцедуры

&НаКлиенте
Процедура НастройкаПериодаНачисления(Команда)
	
	бит_РаботаСДиалогамиКлиент.НастроитьПериодПоДатам(Объект.ДатаНачалаНачисления, Объект.ДатаОкончанияНачисления);
	
	Отказ = Ложь;
	ПроверитьПериодПоставки(Отказ);
	
	
КонецПроцедуры

&НаКлиенте
Процедура ПолучитьТЧНачислений(Команда)
	
	Если НЕ мГрафикНачислений.Количество() = 0 Тогда
		Результат = Вопрос("Табличная часть будет очищена, продолжить?", РежимДиалогаВопрос.ДаНет);
		Если  Результат = КодВозвратаДиалога.Нет Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	ПолучитьТЧНачисленийНаСервере();
	мГрафикНачисленийОбновитьСтолбцы();
	
	Объект.ДатаНачалаНачисления = Объект.ДопУсловияПоДоговору.ДатаНачалаНачисления;
	Объект.ДатаОкончанияНачисления = Объект.ДопУсловияПоДоговору.ДатаОкончанияНачисления;
	
	Модифицированность = Истина;
КонецПроцедуры

&НаСервере
Процедура ПолучитьТЧНачисленийНаСервере()
	
	мГрафикНачислений.Очистить();
	Для каждого СтрокаИсточник Из Объект.ДопУсловияПоДоговору.ГрафикНачислений Цикл
		СтрокаПолучатель = мГрафикНачислений.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаПолучатель, СтрокаИсточник);
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура СохранитьТЗмГрафикНачислений(ТекущийОбъект)
	
	ТекущийОбъект.ГрафикНачислений.Очистить();
	Для каждого СтрокаИсточник Из мГрафикНачислений Цикл
		СтрокаПриемник = ТекущийОбъект.ГрафикНачислений.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаПриемник, СтрокаИсточник);
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура мГрафикНачисленийОбновитьСтолбцы()
	
	МастерБюджет = Справочники.бит_Бюджеты.НайтиПоКоду("000000024");
	
	Счетчик = 0;
	Для каждого Строка Из мГрафикНачислений Цикл
		Счетчик = Счетчик + 1;
		
		Строка.НомерСтроки = Счетчик;
		
		Если Не ЗначениеЗаполнено(Строка.Инициатор) Тогда
			Строка.Инициатор = Объект.ДопУсловияПоДоговору.ПроектДоговора.Инициатор;
		КонецЕсли; 
		
		Если ЗначениеЗаполнено(Строка.Аналитика_7) и ЗначениеЗаполнено(Строка.Аналитика_7.СтатьяОборотов) Тогда
			Запрос = Новый Запрос;
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	бит_СтатьиБюджета.Ссылка как СтатьяБюджета
			|ИЗ
			|	Справочник.бит_СтатьиБюджета КАК бит_СтатьиБюджета
			|ГДЕ
			|	бит_СтатьиБюджета.Владелец = &Владелец
			|	И бит_СтатьиБюджета.СтатьяОборотов = &СтатьяОборотов";
			
			
			Запрос.УстановитьПараметр("Владелец", МастерБюджет);
			Запрос.УстановитьПараметр("СтатьяОборотов", Строка.Аналитика_7.СтатьяОборотов);
			
			РезультатЗапроса = Запрос.Выполнить();
			
			ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
			
			Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
				Строка.СтатьяБюджета = ВыборкаДетальныеЗаписи.СтатьяБюджета;
			КонецЦикла;
		Иначе
			Строка.СтатьяБюджета = Неопределено;
		КонецЕсли;
		
	КонецЦикла;  
	
	мСумма = Формат(мГрафикНачислений.Итог("Сумма"),"ЧДЦ=2");
	мНДС = Формат(мГрафикНачислений.Итог("НДС"), "ЧДЦ=2");
	мСуммаБезНДС = Формат(мГрафикНачислений.Итог("СуммаБезНДС"), "ЧДЦ=2");
	
	Элементы.мГрафикНачисленийСумма.ТекстПодвала = мСумма;
	Элементы.мГрафикНачисленийНДС.ТекстПодвала = мНДС;
	Элементы.мГрафикНачисленийСуммаБезНДС.ТекстПодвала = мСуммаБезНДС;
	
	Объект.СуммаРасходНачисления = мСуммаБезНДС;
	Объект.СуммаНДСРасходНачисления = мНДС;
	Объект.СуммаСНДСРасходНачисления = мСумма;
	
	
	Элементы.мГрафикНачисленийНомерСтроки.ТекстПодвала = Счетчик; 
	
КонецПроцедуры

&НаКлиенте
Процедура ЦФОЗаполнитьСписокВыбора()
	
	СтрокаТЧ = Элементы.мГрафикНачислений.ТекущиеДанные;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.ЦФО КАК ЦФО
	|ИЗ
	|	Документ.бит_ДополнительныеУсловияПоДоговору.ГрафикНачислений КАК бит_ДополнительныеУсловияПоДоговоруГрафикНачислений
	|ГДЕ
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Ссылка = &Ссылка и  не бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.ЦФО = Неопределено
	|
	|СГРУППИРОВАТЬ ПО
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.ЦФО";
	
	Запрос.УстановитьПараметр("Ссылка", объект.ДопУсловияПоДоговору); 
	РезультатЗапроса = Запрос.Выполнить();
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	Элементы.мГрафикНачисленийЦФО.СписокВыбора.Очистить();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Элементы.мГрафикНачисленийЦФО.СписокВыбора.Добавить(ВыборкаДетальныеЗаписи.ЦФО);
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ПотребностьЗаполнитьСписокВыбора()
	
	СтрокаТЧ = Элементы.мГрафикНачислений.ТекущиеДанные;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ 
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_7 КАК Потребность, бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_7.Код как Код 
	|ИЗ
	|	Документ.бит_ДополнительныеУсловияПоДоговору.ГрафикНачислений КАК бит_ДополнительныеУсловияПоДоговоруГрафикНачислений
	|ГДЕ
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Ссылка = &Ссылка
	|	И бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.ЦФО = &ЦФО  и не бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_7 = неопределено
	|
	|СГРУППИРОВАТЬ ПО
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_7";
	
	Запрос.УстановитьПараметр("Ссылка", объект.ДопУсловияПоДоговору); 
	Запрос.УстановитьПараметр("ЦФО", СтрокаТЧ.ЦФО);
	
	РезультатЗапроса = Запрос.Выполнить();
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	//СписокЦФО		= Новый СписокЗначений;	
	
	Элементы.мГрафикНачисленийАналитика_7.СписокВыбора.Очистить();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		
		Представление = СтрШаблон("%1 (%2)", ВыборкаДетальныеЗаписи.Потребность, ВыборкаДетальныеЗаписи.Код);
		НовыйЭлементСписка = Элементы.мГрафикНачисленийАналитика_7.СписокВыбора.Добавить(ВыборкаДетальныеЗаписи.Потребность, Представление);
		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбъектыСтроительстваЗаполнитьСписокВыбора()
	
	СтрокаТЧ = Элементы.мГрафикНачислений.ТекущиеДанные;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ 
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_2 КАК ОбъектСтроительства, бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_2.Код как Код 
	|ИЗ
	|	Документ.бит_ДополнительныеУсловияПоДоговору.ГрафикНачислений КАК бит_ДополнительныеУсловияПоДоговоруГрафикНачислений
	|ГДЕ
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Ссылка = &Ссылка
	|	И бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_4 = &Аналитика_4  и не бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_2 = Неопределено
	|
	|СГРУППИРОВАТЬ ПО
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_2";
	
	Запрос.УстановитьПараметр("Ссылка", объект.ДопУсловияПоДоговору); 
	Запрос.УстановитьПараметр("Аналитика_4", СтрокаТЧ.Аналитика_7.Мероприятие);
	
	РезультатЗапроса = Запрос.Выполнить();
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	//СписокЦФО		= Новый СписокЗначений;	
	
	Элементы.мГрафикНачисленийАналитика_2.СписокВыбора.Очистить();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		
		Представление = СтрШаблон("%1 (%2)", ВыборкаДетальныеЗаписи.ОбъектСтроительства, ВыборкаДетальныеЗаписи.Код);
		НовыйЭлементСписка = Элементы.мГрафикНачисленийАналитика_2.СписокВыбора.Добавить(ВыборкаДетальныеЗаписи.ОбъектСтроительства, Представление);
		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьНеобходимостьСброситьОбъектСтроительства()
	
	СтрокаТЧ = Элементы.мГрафикНачислений.ТекущиеДанные;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_2 КАК ОбъектСтроительства
	|ИЗ
	|	Документ.бит_ДополнительныеУсловияПоДоговору.ГрафикНачислений КАК бит_ДополнительныеУсловияПоДоговоруГрафикНачислений
	|ГДЕ
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Ссылка = &Ссылка
	//|	И бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.ЦФО = &ЦФО
	|	И бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_4 = &Аналитика_4
	|   и не бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_2 = неопределено
	|СГРУППИРОВАТЬ ПО
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_2";
	
	Запрос.УстановитьПараметр("Ссылка", объект.ДопУсловияПоДоговору); 
	//Запрос.УстановитьПараметр("ЦФО", СтрокаТЧ.ЦФО);
	Запрос.УстановитьПараметр("Аналитика_4", СтрокаТЧ.Аналитика_7.Мероприятие);
	
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() Тогда
		СтрокаТЧ.Аналитика_2 = Неопределено;	
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьНеобходимостьСброситьПотребность()
	
	СтрокаТЧ = Элементы.мГрафикНачислений.ТекущиеДанные;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_7 КАК Потребность
	|ИЗ
	|	Документ.бит_ДополнительныеУсловияПоДоговору.ГрафикНачислений КАК бит_ДополнительныеУсловияПоДоговоруГрафикНачислений
	|ГДЕ
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Ссылка = &Ссылка
	|	И бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.ЦФО = &ЦФО
	|	И бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_7 = &Аналитика_7
	|   и не бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_7 = неопределено
	|СГРУППИРОВАТЬ ПО
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_7";
	
	Запрос.УстановитьПараметр("Ссылка", объект.ДопУсловияПоДоговору); 
	Запрос.УстановитьПараметр("ЦФО", СтрокаТЧ.ЦФО);
	Запрос.УстановитьПараметр("Аналитика_7", СтрокаТЧ.Аналитика_7);
	
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() Тогда
		СтрокаТЧ.Аналитика_7 = Неопределено;	
	КонецЕсли;	
	
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьПериодПоставки(Отказ)
	
	ДатаНачалаНачисления = Объект.ДатаНачалаНачисления;
	ДатаОкончанияНачисления = Объект.ДатаОкончанияНачисления;
	
	ДатаНачалаНачисленияПоДоговору = Объект.ДопУсловияПоДоговору.ДатаНачалаНачисления;
	ДатаОкончанияНачисленияПоДоговору = Объект.ДопУсловияПоДоговору.ДатаОкончанияНачисления;
	
	Если ДатаНачалаНачисления > ДатаОкончанияНачисления Тогда
		Отказ = Истина;
		ТекстСообщения = СтрШаблон("На вкладке 'График начислений' Дата начала (%1) больше Даты окончания (%2)", ДатаНачалаНачисления, ДатаОкончанияНачисления);
		Сообщить(ТекстСообщения);
	КонецЕсли;
	
	Если НЕ (ДатаНачалаНачисления >= ДатаНачалаНачисленияПоДоговору и ДатаОкончанияНачисления <= ДатаОкончанияНачисленияПоДоговору) и Не ЕстьПодготовкаДС() и НЕ мГрафикНачислений.Количество() = 0 Тогда
		Отказ = Истина;
		ТекстСообщения = СтрШаблон("Период на вкладке 'График начислений' выходит за пределы периода по договору на вкладке 'Основные', при отсутствии признака подготовки ДС");
		Сообщить(ТекстСообщения);
	КонецЕсли;
	
КонецПроцедуры 

&НаСервере
Функция ЕстьПодготовкаДС()
	
	Результат = Ложь;
	
	ТЗ = мГрафикНачислений.Выгрузить(,"ПодготовкаДС");
	НайденнаяСтрока =  ТЗ.Найти(Истина,"ПодготовкаДС");
	Если НЕ НайденнаяСтрока = Неопределено Тогда
		Результат = Истина;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции // ПодготовкаДС()

&НаКлиенте
Процедура ПроверитьПериодНачисления(Отказ, СтрокаТЧ = Неопределено)
	
	ДатаНачалаНачисления = Объект.ДатаНачалаНачисления;
	ДатаОкончанияНачисления = Объект.ДатаОкончанияНачисления;
	
	ДатаНачалаНачисленияПоДоговору = Объект.ДопУсловияПоДоговору.ДатаНачалаНачисления;
	ДатаОкончанияНачисленияПоДоговору = Объект.ДопУсловияПоДоговору.ДатаОкончанияНачисления;
	
	Если НЕ СтрокаТЧ = Неопределено Тогда
		ПроверитьПериодНачисленияСтроки(Отказ, СтрокаТЧ, ДатаНачалаНачисления, ДатаОкончанияНачисления);
	Иначе		
		Для каждого Строка Из мГрафикНачислений Цикл
			ПроверитьПериодНачисленияСтроки(Отказ, Строка, ДатаНачалаНачисления, ДатаОкончанияНачисления);
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьПериодНачисленияСтроки(Отказ, Строка, ДатаНачалаНачисления, ДатаОкончанияНачисления)

	
	Если НЕ ЗначениеЗаполнено(Строка.Период) Тогда
		Отказ = Истина;
		ТекстСообщения = СтрШаблон("Период в строке %1 на вкладке 'График начислений' не заполнен!" 
		, 
		Строка.НомерСтроки);
		Сообщить(ТекстСообщения);
	ИначеЕсли НЕ (ДатаНачалаНачисления <= Строка.Период и Строка.Период <= ДатаОкончанияНачисления) и Не Строка.ПодготовкаДС Тогда
		Отказ = Истина;
		ТекстСообщения = СтрШаблон("Период в строке %1 на вкладке 'График начислений' выходит за пределы периода выполнения работ/оказания услуг/поставки на вкладке 'График начислений', при отсутствии признака подготовки ДС" 
		, 
		Строка.НомерСтроки);
		Сообщить(ТекстСообщения);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьСуммаНачисления(Отказ)
	
	СуммаРасходНачисления = Объект.СуммаРасходНачисления;
	СуммаБезНДСРасходНачисленияПоДоговору = Объект.ДопУсловияПоДоговору._СуммаБезНДСРасходНачисления;
	
	Если НЕ (СуммаБезНДСРасходНачисленияПоДоговору >= СуммаРасходНачисления) и Не ЕстьПодготовкаДС() Тогда
		Отказ = Истина;
		ТекстСообщения = СтрШаблон("Общая Сумма (без НДС) табличной части 'График начислений' превышает Сумму по договору (%1 > %2), при отсутствии признака подготовки ДС" 
		, 
		СуммаРасходНачисления,
		СуммаБезНДСРасходНачисленияПоДоговору);
		Сообщить(ТекстСообщения);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьЗаполнениеСтатусовДС(Отказ)
	
	Для каждого Строка Из мГрафикНачислений Цикл
		Если Строка.ПодготовкаДС и не ЗначениеЗаполнено(строка.СтатусДС) Тогда
			Отказ = Истина;
			ТекстСообщения = СтрШаблон("В строке %1 на вкладке 'График начислений' не заполнен статус подготовки ДС" 
			, 
			Строка.НомерСтроки);
			Сообщить(ТекстСообщения);
		КонецЕсли;
	КонецЦикла;
	
	
КонецПроцедуры 

&НаКлиенте
Процедура ПроверитьСтавкиНДС(Отказ)
	
	Для каждого Строка Из мГрафикНачислений Цикл
		Если Не ЗначениеЗаполнено(Строка.СтавкаНДС) Тогда
			Отказ = Истина;
			ТекстСообщения = СтрШаблон("В строке %1 на вкладке 'График начислений' не заполнена ставка НДС", 
			Строка.НомерСтроки);
			Сообщить(ТекстСообщения);
		КонецЕсли;
	КонецЦикла;
	
	//Для каждого Строка Из мГрафикПлатежей Цикл
	//	Если Не ЗначениеЗаполнено(Строка.СтавкаНДС) Тогда
	//		Отказ = Истина;
	//		ТекстСообщения = СтрШаблон("В строке %1 на вкладке 'График платежей' не заполнена ставка НДС", 
	//									Строка.НомерСтроки);
	//	    Сообщить(ТекстСообщения);
	//	КонецЕсли;
	//КонецЦикла;
	
	
КонецПроцедуры 


#КонецОбласти //ГрафикиНачислений

#Область ГрафикиПлатежей

&НаСервере
Процедура ЗаполнитьГрафикПлатежейНаСервере()
	
	// 1. Получаем данные из менеджера 
	мГрафикПлатежей.Очистить();
	ТЗ = мГрафикПлатежей.Выгрузить();
	ДанныеГрафика = _ДокументПрогнозированияМенеджер.ПолучитьГрафикПлатежейДляФормы(Объект, ТЗ); 
	
	//// 2. Загружаем в реквизит формы (ТаблицаЗначений)
	мГрафикПлатежей.Загрузить(ДанныеГрафика); 
	
	Итоги = _ДокументПрогнозированияМенеджер.РассчитатьИтогиПоГрафикуПлатежей(Объект, ТЗ);
	
	РассчитатьИтогиПоГрафикуПлатежейНаСервере(Итоги);
	
КонецПроцедуры 

&НаСервере
Процедура ЗаполнитьПодвалГрафикаПлатежейНаСервере(Итоги)

	Элементы.мГрафикПлатежейНомерСтроки.ТекстПодвала 	= Итоги.КоличествоСтрок;
	Элементы.мГрафикПлатежейСумма.ТекстПодвала 			= Формат(Итоги.Сумма,"ЧДЦ=2");
	Элементы.мГрафикПлатежейСуммаОсвоения.ТекстПодвала 	= Формат(Итоги.СуммаОсвоения,"ЧДЦ=2");
	Элементы.мГрафикПлатежейПрогноз.ТекстПодвала 		= Формат(Итоги.Прогноз,"ЧДЦ=2");
	Элементы.мГрафикПлатежейФакт.ТекстПодвала 			= Формат(Итоги.Факт, "ЧДЦ=2");
	
КонецПроцедуры 

&НаСервере
Процедура РассчитатьИтогиПоГрафикуПлатежейНаСервере(Итоги)
	
	
	ЗаполнитьПодвалГрафикаПлатежейНаСервере(Итоги);
	
	Объект.СуммаСНДСРасход 					= Итоги.Сумма; //Сумма по графику  
	мПредельнаяСуммаПоДоговоруПоКарточке 	= Итоги.ПредельнаяСуммаПоДоговоруПоКарточке; //Сумма договора
	мИтогПоОплаченнымЗаявкам  				= Итоги.ИтогПоСтарымЗаявкам + Итоги.Факт; //Факт оплаты
	мПрогноз 								= Итоги.Прогноз; //Сумма прогноза платежей   
	мИтогоОсвоение 							= мПрогноз + мИтогПоОплаченнымЗаявкам;
	мСуммаОстатокПоКарточке  				= мПредельнаяСуммаПоДоговоруПоКарточке - мИтогоОсвоение;//Остаток по договору
	
	//Заголовок вкладки
	Если Итоги.КоличествоСтрок = 0 Тогда
		ЗаголовокГруппаГрафикПлатежейГрафик = "График";
	Иначе	
		ЗаголовокГруппаГрафикПлатежейГрафик = СтрШаблон("График (%1)", Итоги.КоличествоСтрок);
	КонецЕсли;
	Элементы.ГруппаГрафикПлатежейГрафик.Заголовок = ЗаголовокГруппаГрафикПлатежейГрафик;

КонецПроцедуры

&НаСервере
Процедура ПересчитатьАгрегатыГрафикПлатежейНаСервере()

КонецПроцедуры

&НаКлиенте
Процедура ВосстановитьФокусНаСтрокеГрафикПлатежей(УИДСтроки)
    
    // Ищем строку с этим УИД в обновленной таблице
    Для Каждого Строка Из мГрафикПлатежей Цикл
        Если Строка.УИДСтроки = УИДСтроки Тогда
            Элементы.мГрафикПлатежей.ТекущаяСтрока = Строка.ПолучитьИдентификатор();
            Прервать;
        КонецЕсли;
    КонецЦикла;
    
КонецПроцедуры

&НаКлиенте
Процедура мГрафикПлатежейПриИзменении(Элемент)

	Если Элемент.ТекущийЭлемент.Имя = "мГрафикПлатежейПакетнаяОбработка" Тогда
		Возврат;
	КонецЕсли;
	
	//мГрафикПлатежейОбновитьСтолбцы();
	
	Модифицированность = Истина;
    ТекущаяСтрока = Элемент.ТекущиеДанные;
    Если ТекущаяСтрока = Неопределено Тогда
        Возврат;
    КонецЕсли; 
    
    // ЗАПОМИНАЕМ текущую строку
    УИДТекущейСтроки = ТекущаяСтрока.УИДСтроки;
    
    ОбновитьСтроку_ГрафикаПлатежейНаСервере(УИДТекущейСтроки);
    
	//// Перезагружаем график
	//ПересчитатьАгрегатыГрафикПлатежейНаСервере();
	ОбновитьГрафикПлатежейИзОбъекта();
	
    // ВОССТАНАВЛИВАЕМ фокус
    ВосстановитьФокусНаСтрокеГрафикПлатежей(УИДТекущейСтроки);

КонецПроцедуры 	
	
&НаСервере
Процедура ОбновитьСтроку_ГрафикаПлатежейНаСервере(УИДСтроки)
	
	ТТЗ = РеквизитФормыВЗначение("мГрафикПлатежей");	
	_ДокументПрогнозированияМенеджер.ОбновитьСтрокуГрафикаПлатежейНаСервере(Объект, УИДСтроки, ТТЗ);	
	
КонецПроцедуры

&НаКлиенте
Процедура мГрафикПлатежейСуммаБезНДСПриИзменении(Элемент)
	
	Строка = Элементы.мГрафикПлатежей.ТекущиеДанные;
	РассчитатьСуммы(Строка);
	
КонецПроцедуры

&НаКлиенте
Процедура мГрафикПлатежейСтавкаНДСПриИзменении(Элемент)
	
	Строка = Элементы.мГрафикПлатежей.ТекущиеДанные;
	РассчитатьСуммы(Строка);
	
КонецПроцедуры 

&НаКлиенте
Процедура мГрафикПлатежейПередНачаломИзменения(Элемент, Отказ)
	
	ПлатежиЦФОЗаполнитьСписокВыбора();
	//ПлатежиПотребностьЗаполнитьСписокВыбора();
	//ПлатежиОбъектыСтроительстваЗаполнитьСписокВыбора();
	ПлатежиМероприятияЗаполнитьСписокВыбора();
	ПлатежиДокументПланированияЗаполнитьСписокВыбора(); 
	ПлатежиСтатьяОборотовЗаполнитьСписокВыбора(); 
	ПлатежиЗНРДСЗаполнитьСписокВыбора();
	ПлатежиПлатежноеПоручениеЗаполнитьСписокВыбора();
	
	СтрокаТЧ = Элементы.мГрафикПлатежей.ТекущиеДанные;
	
	Если Элемент.ТекущийЭлемент.Имя = "мГрафикПлатежейДокументПланирования" Тогда
		ПоказатьЗначение(,СтрокаТЧ.ДокументПланирования);
		Отказ = Истина;
	КонецЕсли;
	
	Если Элемент.ТекущийЭлемент.Имя = "мГрафикПлатежейЗаявкаНаРасходованиеДС" Тогда
		ПоказатьЗначение(,СтрокаТЧ.ЗаявкаНаРасходованиеДС);
		Отказ = Истина;
	КонецЕсли;
	
	Если Элемент.ТекущийЭлемент.Имя = "мГрафикПлатежейПлатежноеПоручениеИсходящее" Тогда
		ПоказатьЗначение(,СтрокаТЧ.ПлатежноеПоручениеИсходящее);
		Отказ = Истина;
	КонецЕсли;
	
	Если СтрокаТЧ.Статус <> Перечисления._СтатусыПрогнозированияБДДС.Черновик Тогда
		Отказ = Истина;
	КонецЕсли;	
	
КонецПроцедуры

&НаКлиенте
Процедура мГрафикПлатежейПередУдалением(Элемент, Отказ)
	
    Отказ = Истина;
    
    ТекущаяСтрока = Элементы.мГрафикПлатежей.ТекущиеДанные;
    Если ТекущаяСтрока = Неопределено Тогда
        Возврат;
	КонецЕсли; 
	
	// Проверяем документ планирования
	Если ЗначениеЗаполнено(ТекущаяСтрока.ДокументПланирования) Тогда
	    Сообщить("Удаление запрещено: по строке создан документ планирования " + 
	             ТекущаяСтрока.ДокументПланирования);
	    Возврат;
	КонецЕсли;	
	    
    // 1. ЗАПОМИНАЕМ ПОЗИЦИЮ в таблице (индекс строки)
    ПозицияВТаблице = Неопределено;
    Для i = 0 По мГрафикПлатежей.Количество() - 1 Цикл
        Если мГрафикПлатежей[i].УИДСтроки = ТекущаяСтрока.УИДСтроки Тогда
            ПозицияВТаблице = i; // Номер строки сверху (0, 1, 2...)
            Прервать;
        КонецЕсли;
    КонецЦикла;
    
    // 2. УДАЛЯЕМ
    УдалитьСтрокуГрафикаПлатежейНаСервере(ТекущаяСтрока.УИДСтроки);
    
    // 3. ВОССТАНАВЛИВАЕМ ФОКУС НА ТОЙ ЖЕ ПОЗИЦИИ
    Если ПозицияВТаблице <> Неопределено Тогда
        // Ждём обновления таблицы
        // ОбновитьГрафикИзОбъекта() уже вызвался в УдалитьСтрокуГрафикаНаСервере()
        
        Если мГрафикПлатежей.Количество() = 0 Тогда
            // Если строк не осталось
            
            Возврат;
        КонецЕсли;
        
        // Выбираем строку на ТОЙ ЖЕ ПОЗИЦИИ
        // Если позиция больше, чем строк осталось — берём последнюю
        НоваяПозиция = ?(ПозицияВТаблице < мГрафикПлатежей.Количество(),
                         ПозицияВТаблице,
                         мГрафикПлатежей.Количество() - 1);
        
        // Ищем строку по позиции и ставим фокус
        Если НоваяПозиция < мГрафикПлатежей.Количество() Тогда
            СтрокаНаПозиции = мГрафикПлатежей[НоваяПозиция];
            Элементы.мГрафикПлатежей.ТекущаяСтрока = СтрокаНаПозиции.ПолучитьИдентификатор();
        КонецЕсли;
    КонецЕсли;
	
КонецПроцедуры 

&НаСервере
Функция УдалитьСтрокуГрафикаПлатежейНаСервере(УИДДляУдаления)
	
	_ДокументПрогнозированияМенеджер.УдалитьСтрокуГрафикаПлатежей(Объект, УИДДляУдаления);
	Модифицированность = Истина;	
	ОбновитьГрафикПлатежейИзОбъекта();
	//ПересчитатьАгрегатыНаСервере();
	
	// Возвращаем признак успешности
	Возврат Истина;
	
КонецФункции

&НаКлиенте
Процедура мГрафикПлатежейПакетнаяОбработкаПриИзменении(Элемент)
	
	Строка = Элемент.Родитель.ТекущиеДанные;	
	Если ЗначениеЗаполнено(Строка.ДокументПланирования) Тогда
		Строка.ПакетнаяОбработка = Ложь ;
	КонецЕсли;	
	
КонецПроцедуры

&НаКлиенте
Процедура мГрафикПлатежейАналитика_7ПриИзменении(Элемент)
	мГрафикПлатежейОбновитьСтолбцы(); 
	ПлатежиОбъектыСтроительстваЗаполнитьСписокВыбора();	
	ПлатежиПроверитьНеобходимостьСброситьОбъектСтроительства();
КонецПроцедуры

&НаКлиенте
Процедура мГрафикПлатежейПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	
	Отказ = Истина;  
	СтрокаТЧ = Элементы.мГрафикПлатежей.ТекущиеДанные; 

	Если Копирование Тогда 
	    ТекущаяСтрока = Элементы.мГрафикПлатежей.ТекущиеДанные;
	    Если ТекущаяСтрока = Неопределено Тогда
	        Сообщить("Выберите строку для копирования");
	        Возврат;
	    КонецЕсли;		
		
		УИДНовойСтроки = СкопироватьСтрокуГрафикаПлатежейНаСервере(ТекущаяСтрока.УИДСтроки);
	Иначе
		УИДНовойСтроки = СоздатьСтрокуГрафикаПлатежейНаСервере();  
	КонецЕсли; 
	
 	ВыделитьСозданнуюСтрокуГрафикаПлатежей(УИДНовойСтроки);
	
КонецПроцедуры 

&НаСервере
Функция СкопироватьСтрокуГрафикаПлатежейНаСервере(УИДДляКопирования)
    
    Модифицированность = Истина; 
    
    УИДКопии = _ДокументПрогнозированияМенеджер.СкопироватьСтрокуГрафикаПлатежей(
																			        Объект, 
																			        УИДДляКопирования
																			  		);   
	
	ОбновитьГрафикПлатежейИзОбъекта();
    
    Возврат УИДКопии;
    
КонецФункции

&НаСервере
Функция СоздатьСтрокуГрафикаПлатежейНаСервере()
	
	// 1. Создаём строку в объекте
	УИДНовойСтроки = _ДокументПрогнозированияМенеджер.СоздатьСтрокуГрафикаПлатежей(Объект);

	Модифицированность = Истина;
	
	// 2. Обновляем ВЕСЬ график из объекта (просто и надёжно)
	ОбновитьГрафикПлатежейИзОбъекта(); 
	
	// 3. Возвращаем УИД для выделения
	Возврат УИДНовойСтроки;
	
КонецФункции  

&НаСервере
Процедура ОбновитьГрафикПлатежейИзОбъекта()
	
	мГрафикПлатежей.Очистить();
	ТЗ = мГрафикПлатежей.Выгрузить();

	ДанныеГрафика = _ДокументПрогнозированияМенеджер.ПолучитьГрафикПлатежейДляФормы(Объект, ТЗ);
	
	мГрафикПлатежей.Очистить();
	мГрафикПлатежей.Загрузить(ДанныеГрафика);

	Итоги = _ДокументПрогнозированияМенеджер.РассчитатьИтогиПоГрафикуПлатежей(Объект, ТЗ);
	РассчитатьИтогиПоГрафикуПлатежейНаСервере(Итоги);
	
КонецПроцедуры

&НаКлиенте
Процедура ВыделитьСозданнуюСтрокуГрафикаПлатежей(УИДНовойСтроки)
	
	// Ищем строку с этим УИД в ОБНОВЛЁННОЙ таблице
	Для Каждого Строка Из мГрафикПлатежей Цикл
		Если Строка.УИДСтроки = УИДНовойСтроки Тогда
			Индекс = Строка.ПолучитьИдентификатор();
			Элементы.мГрафикПлатежей.ТекущаяСтрока = Индекс;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры 

&НаКлиенте
Процедура мГрафикПлатежейПериодПриИзменении(Элемент)
	
	//СтрокаТЧ = Элементы.мГрафикПлатежей.ТекущиеДанные;
	//ПроверитьПериодПлатежей(СтрокаТЧ, Ложь);
	
КонецПроцедуры

&НаКлиенте
Процедура НастройкаПериода(Команда)
	
	бит_РаботаСДиалогамиКлиент.НастроитьПериодПоДатам(Объект.ДатаНачала, Объект.ДатаОкончания);
	
	Отказ = Ложь;
	ПроверитьПериод(Отказ);
	
КонецПроцедуры

&НаКлиенте
Процедура ПолучитьТЧПлатежей(Команда)
	
	Если НЕ мГрафикПлатежей.Количество() = 0 Тогда
		Результат = Вопрос("Табличная часть будет очищена, продолжить?", РежимДиалогаВопрос.ДаНет);
		Если  Результат = КодВозвратаДиалога.Нет Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	ПолучитьТЧПлатежейНаСервере();
	мГрафикПлатежейОбновитьСтолбцы();
	
	Объект.ДатаНачала = Объект.ДопУсловияПоДоговору.ДатаНачалаНачисления;
	Объект.ДатаОкончания = Объект.ДопУсловияПоДоговору.ДатаОкончанияНачисления;
	
	Модифицированность = Истина;
	
КонецПроцедуры

&НаСервере
Функция СоздатьДокументПрогнозПлатежаНаСервере(УИДСтроки)

	СтруктураРезультат = новый Структура;
	СписокСообщений = Новый СписокЗначений; 
	СсылкаНаДокументПланирования = Неопределено;
	
	ВсеХорошо = Истина; 
	
	// 1. Всегда записываем (если модифицирован или новый)
	Если ВсеХорошо и Модифицированность ИЛИ Параметры.Ключ.Пустая() или НЕ Объект.Проведен Тогда
		Попытка
			ПараметрыЗаписи = Новый Структура;
			ПараметрыЗаписи.Вставить("РежимЗаписи", РежимЗаписиДокумента.Проведение);
			РезультатЗаписи = ЭтаФорма.Записать(ПараметрыЗаписи); 
			Если НЕ РезультатЗаписи Тогда
				ВсеХорошо = Ложь;
				СписокСообщений.Добавить("Не удалось записать и провести документ");
			КонецЕсли;			
		Исключение
			ВсеХорошо = Ложь;
			СписокСообщений.Добавить("Не удалось записать и провести текущий документ " + Символы.ПС + ОписаниеОшибки() );
		КонецПопытки;
	КонецЕсли;
	
	Если ВсеХорошо Тогда
		РезультатСоздания = _ДокументПрогнозированияМенеджер.СоздатьДокументПланированияИзГрафикаПлатежей(
																												Объект.Ссылка, 
																												УИДСтроки
																												);
		
		ВсеХорошо 						= РезультатСоздания.ВсеХорошо;
		СсылкаНаДокументПланирования 	= РезультатСоздания.Результат;
		
		// НОВОЕ: Копируем сообщения
		Для Каждого Сообщение Из РезультатСоздания.СписокСообщений Цикл
			СписокСообщений.Добавить(Сообщение.Значение);
		КонецЦикла;
		
		// НОВОЕ: Если создан - обновляем строку графика
		Если ВсеХорошо И СсылкаНаДокументПланирования <> Неопределено Тогда
			Отбор = Новый Структура("УИДСтроки", УИДСтроки);
			Найденные = мГрафикПлатежей.НайтиСтроки(Отбор);
			Если Найденные.Количество() > 0 Тогда
				Найденные[0].ДокументПланирования = СсылкаНаДокументПланирования; 
			КонецЕсли;
		КонецЕсли;			
		Модифицированность = Истина;
		ЗаполнитьГрафикПлатежейНаСервере();	
	КонецЕсли;
	
	СтруктураРезультат.Вставить("ВсеХорошо", ВсеХорошо);
	СтруктураРезультат.Вставить("СписокСообщений", СписокСообщений); 
	СтруктураРезультат.Вставить("СсылкаНаДокументПланирования", СсылкаНаДокументПланирования); 
	
	Возврат СтруктураРезультат;
	
	
КонецФункции

&НаКлиенте
Процедура СоздатьДокументПрогнозПлатежа(Команда)
	
	ВсеХорошо = Истина;
	ПС = Символы.ПС;
	
	СтрокаТЧ 	= Элементы.мГрафикПлатежей.ТекущиеДанные;
	ТекущийУИД 	= СтрокаТЧ.УИДСтроки;
	
	Если СтрокаТЧ = Неопределено Тогда
		Возврат;
	КонецЕсли; 	
	
	Если ЗначениеЗаполнено(СтрокаТЧ.ДокументПланирования) Тогда
		Предупреждение("Прогноз платежа для этой строки уже создан");
		//Открыть(СтрокаТЧ.ДокументПланирования.Ссылка);
		Возврат;
	КонецЕсли; 
	
	Если НЕ ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору) Тогда
		Предупреждение("Не заполнена ссылка на Дополнительные условия по договору");
		//Открыть(СтрокаТЧ.ДокументПланирования.Ссылка);
		Возврат;
	КонецЕсли; 
	
	Если НЕ ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору.ПроектДоговора) Тогда
		Предупреждение("В доп. условиях по договору не заполнена ссылка на Проект договора");
		//Открыть(СтрокаТЧ.ДокументПланирования.Ссылка);
		Возврат;
	КонецЕсли; 
	
	Если НЕ ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору.ПроектДоговора.Инициатор) Тогда
		Предупреждение("В проекте договора не заполнен Инициатор");
		//Открыть(СтрокаТЧ.ДокументПланирования.Ссылка);
		Возврат;
	КонецЕсли; 
	
	Если Модифицированность или не объект.Проведен Тогда
		Ответ = Вопрос("Документ должен быть записан и проведен. Продолжить?", РежимДиалогаВопрос.ДаНет);
		Если  Ответ = КодВозвратаДиалога.Нет Тогда
			Возврат;
		Иначе
			ПараметрыЗаписи = Новый Структура;
			ПараметрыЗаписи.Вставить("РежимЗаписи", РежимЗаписиДокумента.Проведение);
			РезультатЗаписи = ЭтаФорма.Записать(ПараметрыЗаписи);
			Если НЕ РезультатЗаписи = Истина Тогда
				ВсеХорошо = Ложь;
				Сообщить("Не удалось записать текущий документ");
				Возврат;
			КонецЕсли;
			Если не объект.Проведен Тогда
				ВсеХорошо = Ложь;
				Сообщить("Не удалось провести текущий документ");
				Возврат;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Если НЕ ВсеХорошо Тогда
		Возврат;
	КонецЕсли; 
	
	УстановитьЗаголовокФормыДокумента();
	
	ТекстВопроса = СтрШаблон("Будет создан прогноз платежа для" + ПС + 
							ПС + 
							"строка %1," + ПС +
							"%2" + ПС + 
							"%3" + ПС +
							"сумма %4" + ПС +
							ПС + 
							"Продолжить?",
							СтрокаТЧ.НомерСтрокиДляОтображения,
							Формат(СтрокаТЧ.Период, "ДФ=dd.MM.yyyy"),
							СтрокаТЧ.ЦФО,
							Формат(СтрокаТЧ.Сумма, "ЧДЦ=2")
							);
	Ответ = Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНет);
	
	Если  Ответ = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли;
	
	Результат = СоздатьДокументПрогнозПлатежаНаСервере(ТекущийУИД);  

	Если Не Результат.ВсеХорошо Тогда
		Для каждого Сообщение Из Результат.СписокСообщений Цикл
			Сообщить(Сообщение);
		КонецЦикла;
		//Возврат;
	КонецЕсли;
	
	// 3. Восстанавливаем фокус
	Если ТекущийУИД <> Неопределено Тогда
		ВосстановитьФокусНаСтрокеГрафикПлатежей(ТекущийУИД);
	КонецЕсли;	
	
КонецПроцедуры 

&НаКлиенте
Процедура СоздатьДокументыПрогнозПлатежа(Команда)
	
	ВсеХорошо = Истина;
	ПС = Символы.ПС; 
	
	
	Если НЕ ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору) Тогда
		Предупреждение("Не заполнена ссылка на Дополнительные условия по договору");
		//Открыть(СтрокаТЧ.ДокументПланирования.Ссылка);
		Возврат;
	КонецЕсли; 
	
	
	Если НЕ ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору.ПроектДоговора) Тогда
		Предупреждение("В доп. условиях по договору не заполнена ссылка на Проект договора");
		//Открыть(СтрокаТЧ.ДокументПланирования.Ссылка);
		Возврат;
	КонецЕсли; 
	
	Если НЕ ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору.ПроектДоговора.Инициатор) Тогда
		Предупреждение("В проекте договора не заполнен Инициатор");
		//Открыть(СтрокаТЧ.ДокументПланирования.Ссылка);
		Возврат;
	КонецЕсли; 
	
	
	МассивСтрок = новый Массив;
	Для каждого Строка Из мГрафикПлатежей Цикл
		Если Строка.ПакетнаяОбработка и не ЗначениеЗаполнено(Строка.ДокументПланирования) Тогда
			МассивСтрок.Добавить(Строка);
		КонецЕсли;
	КонецЦикла; 
	
	Если МассивСтрок.Количество()=0 Тогда
		Возврат;
	КонецЕсли; 	
	
	Если Модифицированность или не объект.Проведен Тогда
		Ответ = Вопрос("Документ должен быть записан и проведен. Продолжить?", РежимДиалогаВопрос.ДаНет);
		Если  Ответ = КодВозвратаДиалога.Нет Тогда
			Возврат;
		Иначе
			ПараметрыЗаписи = Новый Структура;
			ПараметрыЗаписи.Вставить("РежимЗаписи", РежимЗаписиДокумента.Проведение);
			РезультатЗаписи = ЭтаФорма.Записать(ПараметрыЗаписи);
			Если НЕ РезультатЗаписи = Истина Тогда
				ВсеХорошо = Ложь;
				Сообщить("Не удалось записать текущий документ");
				Возврат;
			КонецЕсли;
			Если не объект.Проведен Тогда
				ВсеХорошо = Ложь;
				Сообщить("Не удалось провести текущий документ");
				Возврат;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Если НЕ ВсеХорошо Тогда
		Возврат;
	КонецЕсли; 
	
	
	ТекстВопроса = СтрШаблон("Будут созданы прогнозы платежей для %1 строк. Продолжить?", МассивСтрок.Количество());	
	
	Ответ = Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНет);
	
	Если  Ответ = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли;
	
	Для каждого СтрокаТЧ Из МассивСтрок Цикл
		
		Результат = СоздатьДокументПрогнозПлатежаНаСервере(СтрокаТЧ.УИДСтроки);
		
		Если Результат.ВсеХорошо Тогда
			//СтрокаТЧ.ДокументПланирования = ОбъектПрогнозПлатежей.Ссылка;
			СтрокаТЧ.ПакетнаяОбработка = Ложь;
		КонецЕсли;
		
		Для каждого Сообщение Из Результат.СписокСообщений Цикл
			Сообщить(Сообщение);
		КонецЦикла;
		
		УИДДляФокуса = СтрокаТЧ.УИДСтроки;
		
	КонецЦикла;
	
	
	// 3. Восстанавливаем фокус
	Если УИДДляФокуса <> Неопределено Тогда
		ВосстановитьФокусНаСтрокеГрафикПлатежей(УИДДляФокуса);
	КонецЕсли;	
	 
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьТЧПлатежи(Команда)
	
	//мГрафикПлатежейОбновитьСтолбцы();	

	// 1. Запоминаем текущую строку графика
	ТекущаяСтрока = Элементы.мГрафикПлатежей.ТекущиеДанные;
	УИДДляФокуса = ?(ТекущаяСтрока <> Неопределено, ТекущаяСтрока.УИДСтроки, Неопределено);
	
	// 2. Обновляем данные
	ЗаполнитьГрафикПлатежейНаСервере();
	
	// 3. Восстанавливаем фокус
	Если УИДДляФокуса <> Неопределено Тогда
		ВосстановитьФокусНаСтрокеГрафикПлатежей(УИДДляФокуса);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция СоздатьЗНРДСНаСервере(УИДСтроки)

	СтруктураРезультат = новый Структура;
	СписокСообщений = Новый СписокЗначений; 
	СсылкаНаДокументПланирования = Неопределено;
	
	ВсеХорошо = Истина; 
	
	// 1. Всегда записываем (если модифицирован или новый)
	Если ВсеХорошо и Модифицированность ИЛИ Параметры.Ключ.Пустая() или НЕ Объект.Проведен Тогда
		Попытка
			ПараметрыЗаписи = Новый Структура;
			ПараметрыЗаписи.Вставить("РежимЗаписи", РежимЗаписиДокумента.Проведение);
			РезультатЗаписи = ЭтаФорма.Записать(ПараметрыЗаписи); 
			Если НЕ РезультатЗаписи Тогда
				ВсеХорошо = Ложь;
				СписокСообщений.Добавить("Не удалось записать и провести документ");
			КонецЕсли;			
		Исключение
			ВсеХорошо = Ложь;
			СписокСообщений.Добавить("Не удалось записать и провести текущий документ " + Символы.ПС + ОписаниеОшибки() );
		КонецПопытки;
	КонецЕсли;
	
	Если ВсеХорошо Тогда
		РезультатСоздания = _ДокументПрогнозированияМенеджер.СоздатьЗНРДСИзГрафикаПлатежей(
																							Объект.Ссылка, 
																							УИДСтроки
																							);
		
		ВсеХорошо 						= РезультатСоздания.ВсеХорошо;
		СсылкаНаДокументПланирования 	= РезультатСоздания.Результат;
		
		// НОВОЕ: Копируем сообщения
		Для Каждого Сообщение Из РезультатСоздания.СписокСообщений Цикл
			СписокСообщений.Добавить(Сообщение.Значение);
		КонецЦикла;
		
		// НОВОЕ: Если создан - обновляем строку графика
		Если ВсеХорошо И СсылкаНаДокументПланирования <> Неопределено Тогда
			Отбор = Новый Структура("УИДСтроки", УИДСтроки);
			Найденные = мГрафикПлатежей.НайтиСтроки(Отбор);
			Если Найденные.Количество() > 0 Тогда
				Найденные[0].ЗаявкаНаРасходованиеДС = СсылкаНаДокументПланирования; 
			КонецЕсли;
		КонецЕсли;			
		Модифицированность = Истина;
		ЗаполнитьГрафикПлатежейНаСервере();	
	КонецЕсли;
	
	СтруктураРезультат.Вставить("ВсеХорошо", ВсеХорошо);
	СтруктураРезультат.Вставить("СписокСообщений", СписокСообщений); 
	СтруктураРезультат.Вставить("СсылкаНаДокументПланирования", СсылкаНаДокументПланирования); 
	
	Возврат СтруктураРезультат;
	
	
КонецФункции

&НаКлиенте
Процедура СоздатьЗНРДС(Команда)
	
	ВсеХорошо = Истина;
	ПС = Символы.ПС;
	
	СтрокаТЧ = Элементы.мГрафикПлатежей.ТекущиеДанные; 
	
	Если СтрокаТЧ = Неопределено Тогда
		Возврат;
	КонецЕсли;  	
	
	Если ЗначениеЗаполнено(СтрокаТЧ.ЗаявкаНаРасходованиеДС) Тогда
		Предупреждение("Заявка на расходование ДС для этой строки уже создана");
		//Открыть(СтрокаТЧ.ДокументПланирования.Ссылка);
		Возврат;
	КонецЕсли;  
	
	Если НЕ ЗначениеЗаполнено(СтрокаТЧ.ДокументПланирования) Тогда
		Предупреждение("Для выбранной строки отсутствует Прогноз платежа");
		//Открыть(СтрокаТЧ.ДокументПланирования.Ссылка);
		Возврат;
	КонецЕсли; 
	
	Основание = СтрокаТЧ.ДокументПланирования;
	
	Если НЕ ПрогнозПлатежаУтвержден(Основание) Тогда
		Предупреждение("Прогноз платежа не утвержден");
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору) Тогда
		Предупреждение("Не заполнена ссылка на Дополнительные условия по договору");
		Возврат;
	КонецЕсли; 
	
	
	Если НЕ ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору.ПроектДоговора) Тогда
		Предупреждение("В доп. условиях по договору не заполнена ссылка на Проект договора");
		Возврат;
	КонецЕсли; 
	
	Если НЕ ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору.ПроектДоговора.Инициатор) Тогда
		Предупреждение("В проекте договора не заполнен Инициатор");
		Возврат;
	КонецЕсли; 
	
	Если Модифицированность Тогда
		Ответ = Вопрос("Требуется запись документа. Продолжить?", РежимДиалогаВопрос.ДаНет);
		Если  Ответ = КодВозвратаДиалога.Нет Тогда
			Возврат;
		Иначе
			ПараметрыЗаписи = Новый Структура;
			ПараметрыЗаписи.Вставить("РежимЗаписи", РежимЗаписиДокумента.Проведение);
			РезультатЗаписи = ЭтаФорма.Записать(ПараметрыЗаписи);
			Если НЕ РезультатЗаписи = Истина Тогда
				ВсеХорошо = Ложь;
				Сообщить("Не удалось записать текущий документ");
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Если НЕ ВсеХорошо Тогда
		Возврат;
	КонецЕсли; 
	
	ТекстВопроса= СтрШаблон("Будет создана Заявка на расходование ДС для" + ПС + 
								ПС + 
								"строка %1," + ПС +
								"%2" + ПС + 
								"%3" + ПС +
								"сумма %4" + ПС + 
								ПС +
								"на основании %5" + ПС +
								ПС + 
								"Продолжить?",
								СтрокаТЧ.НомерСтрокиДляОтображения,
								Формат(СтрокаТЧ.Период, "ДФ=dd.MM.yyyy"),
								СтрокаТЧ.ЦФО,
								Формат(СтрокаТЧ.ДокументПланирования.Сумма, "ЧДЦ=2"),
								Основание
								);
	Ответ = Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНет);
	Если  Ответ = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли;
	
	ТекущийУИД = СтрокаТЧ.УИДСтроки;
	Результат = СоздатьЗНРДСНаСервере(ТекущийУИД);

	Если Не Результат.ВсеХорошо Тогда
		Для каждого Сообщение Из Результат.СписокСообщений Цикл
			Сообщить(Сообщение);
		КонецЦикла;
		//Возврат;
	КонецЕсли;
	
	// 3. Восстанавливаем фокус
	Если ТекущийУИД <> Неопределено Тогда
		ВосстановитьФокусНаСтрокеГрафикПлатежей(ТекущийУИД);
	КонецЕсли;	
	
	
КонецПроцедуры  

&НаКлиенте
Процедура ОтобразитьПланФакт(Команда)
	
	Если элементы.мГрафикПлатежейПрогноз.Видимость = Истина Тогда
		элементы.мГрафикПлатежейПрогноз.Видимость = Ложь;
		элементы.мГрафикПлатежейФакт.Видимость = Ложь;
	Иначе
		элементы.мГрафикПлатежейПрогноз.Видимость = Истина;
		элементы.мГрафикПлатежейФакт.Видимость = Истина;
	КонецЕсли;	
	
КонецПроцедуры

&НаСервере
Процедура СохранитьТЗмГрафикПлатежей(ТекущийОбъект)
	
	ТекущийОбъект.ГрафикПлатежей.Очистить();
	Для каждого СтрокаИсточник Из мГрафикПлатежей Цикл
		СтрокаПриемник = ТекущийОбъект.ГрафикПлатежей.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаПриемник, СтрокаИсточник);
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура мГрафикПлатежейОбновитьСтолбцы()
	
	//МастерБюджет = Справочники.бит_Бюджеты.НайтиПоКоду("000000024");
	
	//Если ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору) и ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору.ДоговорКонтрагента) Тогда
	//	ОсновнаяСтатьяДДС = Объект.ДопУсловияПоДоговору.ДоговорКонтрагента.ОсновнаяСтатьяДвиженияДенежныхСредств;
	//	СтатьяОборотовДДС = Объект.ДопУсловияПоДоговору.ДоговорКонтрагента.бит_ОсновнаяСтатьяОборотов;
	//Иначе
	//	ОсновнаяСтатьяДДС = Справочники.СтатьиДвиженияДенежныхСредств.ПустаяСсылка();
	//	СтатьяОборотовДДС = Справочники.бит_СтатьиОборотов.ПустаяСсылка();
	//КонецЕсли;
	
	Если ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору) и ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору.ДоговорКонтрагента) Тогда
		ОсновнаяСтавкаНДС = Объект.ДопУсловияПоДоговору.ДоговорКонтрагента._СтавкаНДС_ОКО.СтавкаНДС;
	Иначе
		ОсновнаяСтавкаНДС = Перечисления.СтавкиНДС.ПустаяСсылка();
	КонецЕсли;  
	
	
	СписокСообщений = Новый СписокЗначений;
	ПлатежиЗаполнитьГрафикиПлатежей(СписокСообщений);
	
	Если не СписокСообщений.Количество()=0 Тогда
		Для каждого Сообщение Из СписокСообщений Цикл
			Сообщить(Сообщение);
		КонецЦикла;
	КонецЕсли;  
	
	СписокСообщений = Новый СписокЗначений;
	ПлатежиЗаполнитьЗНРДС(СписокСообщений);
	
	Если не СписокСообщений.Количество()=0 Тогда
		Для каждого Сообщение Из СписокСообщений Цикл
			Сообщить(Сообщение);
		КонецЦикла;
	КонецЕсли;
	
	СписокСообщений = Новый СписокЗначений;
	ПлатежиЗаполнитьПлатежныеПоручения(СписокСообщений);
	
	Если не СписокСообщений.Количество()=0 Тогда
		Для каждого Сообщение Из СписокСообщений Цикл
			Сообщить(Сообщение);
		КонецЦикла;
	КонецЕсли; 
	
	ПлатежиЗаполнитьСтатусы(); 
	//РассчитатьИтогПоОплаченнымЗаявкам();
	
	
	мПрогноз = 0;
	мФакт = 0;
	
	
	Счетчик = 0;
	Для каждого Строка Из мГрафикПлатежей Цикл
		Счетчик = Счетчик + 1;
		
		Строка.НомерСтроки = Счетчик;
		
		Если Не ЗначениеЗаполнено(Строка.СтавкаНДС) Тогда
			Строка.СтавкаНДС = ОсновнаяСтавкаНДС;
		КонецЕсли; 
		
		Если Не ЗначениеЗаполнено(Строка.УИДСтроки) Тогда
			Строка.УИДСтроки = Новый УникальныйИдентификатор;
		КонецЕсли; 
		
		Если ЗначениеЗаполнено(Строка.ПлатежноеПоручениеИсходящее) Тогда
			Строка.СуммаОсвоения = Строка.ПлатежноеПоручениеИсходящее.СуммаДокумента;
		ИначеЕсли ЗначениеЗаполнено(Строка.ЗаявкаНаРасходованиеДС) Тогда
			Строка.СуммаОсвоения = Строка.ЗаявкаНаРасходованиеДС.Сумма;
		ИначеЕсли ЗначениеЗаполнено(Строка.ДокументПланирования) Тогда
			Строка.СуммаОсвоения = Строка.ДокументПланирования.Сумма;
		Иначе
			Строка.СуммаОсвоения = Строка.Сумма;
		КонецЕсли;
		
		
		
		Если Строка.Статус = Перечисления._СтатусыПрогнозированияБДДС.Оплачен Тогда
			Строка.Факт = Строка.СуммаОсвоения;
			Строка.Прогноз = 0;
		Иначе
			Строка.Факт = 0;
			Строка.Прогноз = Строка.СуммаОсвоения;
		КонецЕсли; 
		
		мПрогноз = мПрогноз + Строка.Прогноз;
		мФакт = мФакт + Строка.Факт;   
		
		
	КонецЦикла;  
	
	мСумма = Формат(мГрафикПлатежей.Итог("Сумма"),"ЧДЦ=2");
	мНДС = Формат(мГрафикПлатежей.Итог("НДС"), "ЧДЦ=2");
	мСуммаБезНДС = Формат(мГрафикПлатежей.Итог("СуммаБезНДС"), "ЧДЦ=2");
	
	Элементы.мГрафикПлатежейСумма.ТекстПодвала = Формат(мСумма,"ЧДЦ=2");
	
	Элементы.мГрафикПлатежейНДС.ТекстПодвала = мНДС;
	Элементы.мГрафикПлатежейСуммаБезНДС.ТекстПодвала = мСуммаБезНДС;
	
	Объект.СуммаРасход = мСуммаБезНДС;
	Объект.СуммаНДСРасход = мНДС;
	Объект.СуммаСНДСРасход = мСумма;
	
	мИтогПоОплаченнымЗаявкам = мИтогПоСтарымЗаявкам + мФакт;
	
	мСуммаОсвоения = мПрогноз + мИтогПоОплаченнымЗаявкам;
	Элементы.мГрафикПлатежейСуммаОсвоения.ТекстПодвала = формат(мПрогноз + мФакт, "ЧДЦ=2");  
	
	мИтогоОсвоение =  мПрогноз + мИтогПоОплаченнымЗаявкам;
	
	мСуммаОстаток = мПредельнаяСуммаПоДоговору - мСуммаОсвоения - мИтогПоОплаченнымЗаявкам;
	
	Если ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору.ДоговорКонтрагента) и ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору.ДоговорКонтрагента._КарточкаДоговора) Тогда
		КарточкаДоговора = Объект.ДопУсловияПоДоговору.ДоговорКонтрагента._КарточкаДоговора;
		мПредельнаяСуммаПоДоговоруПоКарточке = КарточкаДоговора.Сумма;
		//мСуммаОсвоенияПоКарточке = мПрогноз + мИтогПоОплаченнымЗаявкам; 
		мСуммаОстатокПоКарточке = мПредельнаяСуммаПоДоговоруПоКарточке - мИтогоОсвоение;
	КонецЕсли;
	
	Элементы.мГрафикПлатежейНомерСтроки.ТекстПодвала = Счетчик;
	Элементы.мГрафикПлатежейПрогноз.ТекстПодвала = Формат(мПрогноз,"ЧДЦ=2");
	Элементы.мГрафикПлатежейФакт.ТекстПодвала = Формат(мФакт, "ЧДЦ=2"); 
	
	Если Счетчик = 0 Тогда
		ЗаголовокГруппаГрафикПлатежейГрафик = "График";
	Иначе	
		ЗаголовокГруппаГрафикПлатежейГрафик = СтрШаблон("График (%1)", Счетчик);
	КонецЕсли;
	Элементы.ГруппаГрафикПлатежейГрафик.Заголовок = ЗаголовокГруппаГрафикПлатежейГрафик;
	
КонецПроцедуры 

&НаСервере
Процедура ПлатежиЗаполнитьСтатусы()
	
	Для каждого Строка Из мГрафикПлатежей Цикл 
		Если ЗначениеЗаполнено(Строка.ЗаявкаНаРасходованиеДС) Тогда
			СтатусЗНРДС = Неопределено;
			Запрос = Новый Запрос;
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	Документбит_ЗаявкаНаРасходованиеСредств.Ссылка,
			|	ЕСТЬNULL(СтатусыОбъектов_Статус.Статус, ЗНАЧЕНИЕ(Справочник.бит_СтатусыОбъектов.ПустаяСсылка)) КАК Статус
			|ИЗ
			|	Документ.бит_ЗаявкаНаРасходованиеСредств КАК Документбит_ЗаявкаНаРасходованиеСредств
			|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.бит_СтатусыОбъектов КАК СтатусыОбъектов_Статус
			|		ПО Документбит_ЗаявкаНаРасходованиеСредств.Ссылка = СтатусыОбъектов_Статус.Объект
			|			И (СтатусыОбъектов_Статус.ВидСтатуса = ЗНАЧЕНИЕ(Перечисление.бит_ВидыСтатусовОбъектов.Статус))
			|ГДЕ
			|	Документбит_ЗаявкаНаРасходованиеСредств.Ссылка = &Ссылка
			|";
			Запрос.Параметры.Вставить("Ссылка", Строка.ЗаявкаНаРасходованиеДС); 
			
			РезультатЗапроса = Запрос.Выполнить().Выгрузить();
			РезультатЗапросаКоличество = РезультатЗапроса.Количество();
			Для каждого ВыборкаДетальныеЗаписи Из РезультатЗапроса Цикл
				СтатусЗНРДС = ВыборкаДетальныеЗаписи.Статус;
			КонецЦикла; 
			
			Если СтатусЗНРДС = Справочники.бит_СтатусыОбъектов.Заявка_Оплачена Тогда
				Строка.Статус = Перечисления._СтатусыПрогнозированияБДДС.Оплачен;
			Иначе
				Строка.Статус = Перечисления._СтатусыПрогнозированияБДДС.ВОплате;
			КонецЕсли;
		ИначеЕсли ЗначениеЗаполнено(Строка.ДокументПланирования) Тогда
			Строка.Статус = Перечисления._СтатусыПрогнозированияБДДС.Прогноз;
		Иначе
			Строка.Статус = Перечисления._СтатусыПрогнозированияБДДС.Черновик;
		КонецЕсли;	
	КонецЦикла;
	
КонецПроцедуры	

&НаСервере
Процедура ПлатежиЗаполнитьГрафикиПлатежей(СписокСообщений)
	//бит_ЗаявкаНаРасходованиеСредствОбщая
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	бит_ЗаявкаНаРасходованиеСредствОбщая.Ссылка КАК ГрафикПлатежей
	|ИЗ
	|	Документ.бит_ЗаявкаНаРасходованиеСредствОбщая КАК бит_ЗаявкаНаРасходованиеСредствОбщая
	|ГДЕ
	|	бит_ЗаявкаНаРасходованиеСредствОбщая._УИДСтрокиДокументаОснования = &УИДСтроки
	|	И НЕ бит_ЗаявкаНаРасходованиеСредствОбщая._УИДСтрокиДокументаОснования = &ПустойУИД
	|	И бит_ЗаявкаНаРасходованиеСредствОбщая._ДокументОснование = &_ДокументОснование
	|	И бит_ЗаявкаНаРасходованиеСредствОбщая.ПометкаУдаления = ЛОЖЬ";
	
	Запрос.УстановитьПараметр("_ДокументОснование", Объект.Ссылка);  
	ПустойУИД = Новый УникальныйИдентификатор("00000000-0000-0000-0000-000000000000");
	Запрос.УстановитьПараметр("ПустойУИД", ПустойУИД);
	
	Для каждого Строка Из мГрафикПлатежей Цикл 
		
		Строка.ДокументПланирования = Документы.бит_ЗаявкаНаРасходованиеСредствОбщая.ПустаяСсылка();
		
		Запрос.УстановитьПараметр("УИДСтроки", Строка.УИДСтроки);
		РезультатЗапроса = Запрос.Выполнить().Выгрузить();
		РезультатЗапросаКоличество = РезультатЗапроса.Количество();
		НовоеСообщение = "";                   
		Для каждого ВыборкаДетальныеЗаписи Из РезультатЗапроса Цикл
			Если РезультатЗапросаКоличество > 1 Тогда
				НовоеСообщение = ?(НовоеСообщение="", 
				СтрШаблон("Для строки %1 найдено более одного Прогноза платежа: %2 от %3", 
				Строка.НомерСтроки, 
				ВыборкаДетальныеЗаписи.ГрафикПлатежей.Номер,
				Формат(ВыборкаДетальныеЗаписи.ГрафикПлатежей.Дата,"ДФ=dd.MM.yyyy")
				), 
				НовоеСообщение + 
				СтрШаблон(", %2 от %3",
				Строка.НомерСтроки, 
				ВыборкаДетальныеЗаписи.ГрафикПлатежей.Номер,
				Формат(ВыборкаДетальныеЗаписи.ГрафикПлатежей.Дата,"ДФ=dd.MM.yyyy")
				)
				);			
				
				
			КонецЕсли;
			Строка.ДокументПланирования = ВыборкаДетальныеЗаписи.ГрафикПлатежей;
		КонецЦикла;
		Если РезультатЗапросаКоличество > 1 Тогда
			СписокСообщений.Добавить(НовоеСообщение);
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры	

&НаСервере
Процедура ПлатежиЗаполнитьПлатежныеПоручения(СписокСообщений)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ПлатежноеПоручениеИсходящее.Ссылка КАК ПлатежноеПоручениеИсходящее
	|ИЗ
	|	Документ.ПлатежноеПоручениеИсходящее КАК ПлатежноеПоручениеИсходящее
	|ГДЕ
	|	ПлатежноеПоручениеИсходящее.ДокументОснование = &ДокументОснование
	|	И ПлатежноеПоручениеИсходящее.ПометкаУдаления = Ложь";
	
	
	
	Для каждого Строка Из мГрафикПлатежей Цикл
		
		Строка.ПлатежноеПоручениеИсходящее = Документы.ПлатежноеПоручениеИсходящее.ПустаяСсылка();	
		
		Запрос.УстановитьПараметр("ДокументОснование", Строка.ЗаявкаНаРасходованиеДС);
		
		РезультатЗапроса = Запрос.Выполнить().Выгрузить();
		РезультатЗапросаКоличество = РезультатЗапроса.Количество();
		НовоеСообщение = "";                   
		Для каждого ВыборкаДетальныеЗаписи Из РезультатЗапроса Цикл
			Если РезультатЗапросаКоличество > 1 Тогда
				НовоеСообщение = ?(НовоеСообщение="", 
				СтрШаблон("Для строки %1 найдено более одного платежного поручения: %2 от %3", 
				Строка.НомерСтроки, 
				ВыборкаДетальныеЗаписи.ГрафикПлатежей.Номер,
				Формат(ВыборкаДетальныеЗаписи.ГрафикПлатежей.Дата,"ДФ=dd.MM.yyyy")
				), 
				НовоеСообщение + 
				СтрШаблон(", %2 от %3",
				Строка.НомерСтроки, 
				ВыборкаДетальныеЗаписи.ГрафикПлатежей.Номер,
				Формат(ВыборкаДетальныеЗаписи.ГрафикПлатежей.Дата,"ДФ=dd.MM.yyyy")
				)
				);			
				
				
			КонецЕсли;
			Строка.ПлатежноеПоручениеИсходящее = ВыборкаДетальныеЗаписи.ПлатежноеПоручениеИсходящее;
		КонецЦикла;
		Если РезультатЗапросаКоличество > 1 Тогда
			СписокСообщений.Добавить(НовоеСообщение);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура ПлатежиЗаполнитьЗНРДС(СписокСообщений)	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	бит_ЗаявкаНаРасходованиеСредств.Ссылка КАК ЗНРДС
	|ИЗ
	|	Документ.бит_ЗаявкаНаРасходованиеСредств КАК бит_ЗаявкаНаРасходованиеСредств
	|ГДЕ
	|	бит_ЗаявкаНаРасходованиеСредств.ДокументОснование = &ДокументОснование
	|	И бит_ЗаявкаНаРасходованиеСредств.ПометкаУдаления = Ложь";
	
	Для каждого Строка Из мГрафикПлатежей Цикл
		
		Строка.ЗаявкаНаРасходованиеДС = Документы.бит_ЗаявкаНаРасходованиеСредств.ПустаяСсылка();
		
		Запрос.УстановитьПараметр("ДокументОснование", Строка.ДокументПланирования);
		
		РезультатЗапроса = Запрос.Выполнить().Выгрузить();
		РезультатЗапросаКоличество = РезультатЗапроса.Количество();
		НовоеСообщение = "";                   
		Для каждого ВыборкаДетальныеЗаписи Из РезультатЗапроса Цикл
			
			Если РезультатЗапросаКоличество > 1 Тогда
				НовоеСообщение = ?(НовоеСообщение="", 
				СтрШаблон("Для строки %1 найдено более одной Заявки на расходование ДС: %2 от %3", 
				Строка.НомерСтроки, 
				ВыборкаДетальныеЗаписи.ГрафикПлатежей.Номер,
				Формат(ВыборкаДетальныеЗаписи.ГрафикПлатежей.Дата,"ДФ=dd.MM.yyyy")
				), 
				НовоеСообщение + 
				СтрШаблон(", %2 от %3",
				Строка.НомерСтроки, 
				ВыборкаДетальныеЗаписи.ГрафикПлатежей.Номер,
				Формат(ВыборкаДетальныеЗаписи.ГрафикПлатежей.Дата,"ДФ=dd.MM.yyyy")
				)
				);			
				
				
			КонецЕсли;
			Строка.ЗаявкаНаРасходованиеДС = ВыборкаДетальныеЗаписи.ЗНРДС;
		КонецЦикла;
		Если РезультатЗапросаКоличество > 1 Тогда
			СписокСообщений.Добавить(НовоеСообщение);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ПлатежиСтатьяОборотовЗаполнитьСписокВыбора()
	
	ОчиститьСообщения();
	СтрокаТЧ = Элементы.мГрафикПлатежей.ТекущиеДанные;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ГН.СтатьяОборотовНачисления
	|ПОМЕСТИТЬ ВТ_СписокСтатейБДР
	|ИЗ
	|	Документ.бит_ДополнительныеУсловияПоДоговору.ГрафикНачислений КАК ГН
	|ГДЕ
	|	ГН.Ссылка = &Ссылка
	|	И НЕ ГН.СтатьяОборотовНачисления = НЕОПРЕДЕЛЕНО
	|	И НЕ ГН.СтатьяОборотовНачисления = ЗНАЧЕНИЕ(справочник.бит_СтатьиОборотов.ПустаяСсылка)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_СписокСтатейБДР.СтатьяОборотовНачисления
	|ИЗ
	|	ВТ_СписокСтатейБДР КАК ВТ_СписокСтатейБДР
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	РС.СтатьяБДДС КАК СтатьяБДДС
	|ПОМЕСТИТЬ ВТ_Соответствия
	|ИЗ
	|	РегистрСведений._СоответствиеСтатейОборотовБДРиБДДС КАК РС
	|ГДЕ
	|	РС.СтатьяБДР В
	|			(ВЫБРАТЬ
	|				ВТ_СписокСтатейБДР.СтатьяОборотовНачисления
	|			ИЗ
	|				ВТ_СписокСтатейБДР)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Соответствия.СтатьяБДДС
	|ИЗ
	|	ВТ_Соответствия КАК ВТ_Соответствия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Соответствия.СтатьяБДДС
	|ИЗ
	|	ВТ_Соответствия КАК ВТ_Соответствия
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	ГН.Ссылка.ДоговорКонтрагента.бит_ОсновнаяСтатьяОборотов
	|ИЗ
	|	Документ.бит_ДополнительныеУсловияПоДоговору.ГрафикНачислений КАК ГН
	|ГДЕ
	|	ГН.Ссылка = &Ссылка
	|	И НЕ ГН.Ссылка.ДоговорКонтрагента.бит_ОсновнаяСтатьяОборотов = ЗНАЧЕНИЕ(справочник.бит_СтатьиОборотов.ПустаяСсылка)";
	
	
	Запрос.УстановитьПараметр("Ссылка", объект.ДопУсловияПоДоговору.Ссылка); 
	
	РезультатЗапроса	= Запрос.ВыполнитьПакет();
	МаксимальныйИндекс	= РезультатЗапроса.ВГраница();
	
	ТаблицаСтатейОборотовБДДС = РезультатЗапроса[МаксимальныйИндекс - 0].Выгрузить();
	Элементы.мГрафикПлатежейСтатьяОборотовДДС.СписокВыбора.Очистить(); 
	Для каждого Строка Из ТаблицаСтатейОборотовБДДС Цикл
		Элементы.мГрафикПлатежейСтатьяОборотовДДС.СписокВыбора.Добавить(Строка.СтатьяБДДС);
	КонецЦикла;
	
	ТаблицаСоответствияСтатейОборотовБДРиБДДС = РезультатЗапроса[МаксимальныйИндекс - 1].Выгрузить();
	Если ТаблицаСоответствияСтатейОборотовБДРиБДДС.Количество() = 0 Тогда
		ТаблицаСтатейБДР = РезультатЗапроса[МаксимальныйИндекс - 3].Выгрузить();
		Для каждого Строка Из ТаблицаСтатейБДР Цикл
			Сообщить("Не найдено соответствие для статьи оборотов БДР [" + Строка.СтатьяОборотовНачисления + "]");
		КонецЦикла;
	КонецЕсли;
	Если ТаблицаСтатейОборотовБДДС.Количество()=0 и Не ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору.ДоговорКонтрагента.бит_ОсновнаяСтатьяОборотов) Тогда
		Сообщить("В договоре не заполнена основная статья оборотов БДДС");		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПлатежиЗНРДСЗаполнитьСписокВыбора()
	
	СтрокаТЧ = Элементы.мГрафикПлатежей.ТекущиеДанные;	
	Элементы.мГрафикПлатежейЗаявкаНаРасходованиеДС.СписокВыбора.Очистить();
	Элементы.мГрафикПлатежейЗаявкаНаРасходованиеДС.СписокВыбора.Добавить(СтрокаТЧ.ДокументПланирования);
	
КонецПроцедуры

&НаКлиенте
Процедура ПлатежиПлатежноеПоручениеЗаполнитьСписокВыбора()
	
	СтрокаТЧ = Элементы.мГрафикПлатежей.ТекущиеДанные;	
	Элементы.мГрафикПлатежейПлатежноеПоручениеИсходящее.СписокВыбора.Очистить();
	Элементы.мГрафикПлатежейПлатежноеПоручениеИсходящее.СписокВыбора.Добавить(СтрокаТЧ.ДокументПланирования);
	
КонецПроцедуры

&НаКлиенте
Процедура ПлатежиДокументПланированияЗаполнитьСписокВыбора()
	
	СтрокаТЧ = Элементы.мГрафикПлатежей.ТекущиеДанные;	
	Элементы.мГрафикПлатежейДокументПланирования.СписокВыбора.Очистить();
	Элементы.мГрафикПлатежейДокументПланирования.СписокВыбора.Добавить(СтрокаТЧ.ДокументПланирования);
	
КонецПроцедуры

&НаКлиенте
Процедура ПлатежиЦФОЗаполнитьСписокВыбора()
	
	СтрокаТЧ = Элементы.мГрафикПлатежей.ТекущиеДанные;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.ЦФО КАК ЦФО
	|ИЗ
	|	Документ.бит_ДополнительныеУсловияПоДоговору.ГрафикНачислений КАК бит_ДополнительныеУсловияПоДоговоруГрафикНачислений
	|ГДЕ
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Ссылка = &Ссылка и  не бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.ЦФО = Неопределено
	|
	|СГРУППИРОВАТЬ ПО
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.ЦФО";
	
	Запрос.УстановитьПараметр("Ссылка", объект.ДопУсловияПоДоговору); 
	РезультатЗапроса = Запрос.Выполнить();
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	Элементы.мГрафикПлатежейЦФО.СписокВыбора.Очистить();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Элементы.мГрафикПлатежейЦФО.СписокВыбора.Добавить(ВыборкаДетальныеЗаписи.ЦФО);
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ПлатежиМероприятияЗаполнитьСписокВыбора()
	
	СтрокаТЧ = Элементы.мГрафикПлатежей.ТекущиеДанные;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_4 КАК Мероприятие
	|ИЗ
	|	Документ.бит_ДополнительныеУсловияПоДоговору.ГрафикНачислений КАК бит_ДополнительныеУсловияПоДоговоруГрафикНачислений
	|ГДЕ
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Ссылка = &Ссылка
	|	И НЕ бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_4 = НЕОПРЕДЕЛЕНО
	|  	И НЕ бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_4 = Значение(Справочник._МероприятияПрограмм.ПустаяСсылка)
	|СГРУППИРОВАТЬ ПО
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_4";
	
	Запрос.УстановитьПараметр("Ссылка", объект.ДопУсловияПоДоговору); 
	
	РезультатЗапроса = Запрос.Выполнить();
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	Элементы.мГрафикПлатежейМероприятиеПКВ.СписокВыбора.Очистить();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Элементы.мГрафикПлатежейМероприятиеПКВ.СписокВыбора.Добавить(ВыборкаДетальныеЗаписи.Мероприятие);
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ПлатежиПотребностьЗаполнитьСписокВыбора()
	
	СтрокаТЧ = Элементы.мГрафикПлатежей.ТекущиеДанные;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ 
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_7 КАК Потребность, бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_7.Код как Код 
	|ИЗ
	|	Документ.бит_ДополнительныеУсловияПоДоговору.ГрафикНачислений КАК бит_ДополнительныеУсловияПоДоговоруГрафикНачислений
	|ГДЕ
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Ссылка = &Ссылка
	|	И бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.ЦФО = &ЦФО  и не бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_7 = неопределено
	|
	|СГРУППИРОВАТЬ ПО
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_7";
	
	Запрос.УстановитьПараметр("Ссылка", объект.ДопУсловияПоДоговору); 
	Запрос.УстановитьПараметр("ЦФО", СтрокаТЧ.ЦФО);
	
	РезультатЗапроса = Запрос.Выполнить();
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	//СписокЦФО		= Новый СписокЗначений;	
	
	Элементы.мГрафикПлатежейАналитика_7.СписокВыбора.Очистить();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		
		Представление = СтрШаблон("%1 (%2)", ВыборкаДетальныеЗаписи.Потребность, ВыборкаДетальныеЗаписи.Код);
		НовыйЭлементСписка = Элементы.мГрафикПлатежейАналитика_7.СписокВыбора.Добавить(ВыборкаДетальныеЗаписи.Потребность, Представление);
		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ПлатежиОбъектыСтроительстваЗаполнитьСписокВыбора()
	
	СтрокаТЧ = Элементы.мГрафикПлатежей.ТекущиеДанные;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ 
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_2 КАК ОбъектСтроительства, бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_2.Код как Код 
	|ИЗ
	|	Документ.бит_ДополнительныеУсловияПоДоговору.ГрафикНачислений КАК бит_ДополнительныеУсловияПоДоговоруГрафикНачислений
	|ГДЕ
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Ссылка = &Ссылка
	|	И бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_4 = &Аналитика_4  и не бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_2 = Неопределено
	|
	|СГРУППИРОВАТЬ ПО
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_2";
	
	Запрос.УстановитьПараметр("Ссылка", объект.ДопУсловияПоДоговору); 
	Запрос.УстановитьПараметр("Аналитика_4", СтрокаТЧ.Аналитика_7.Мероприятие);
	
	РезультатЗапроса = Запрос.Выполнить();
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	//СписокЦФО		= Новый СписокЗначений;	
	
	Элементы.мГрафикПлатежейАналитика_2.СписокВыбора.Очистить();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		
		Представление = СтрШаблон("%1 (%2)", ВыборкаДетальныеЗаписи.ОбъектСтроительства, ВыборкаДетальныеЗаписи.Код);
		НовыйЭлементСписка = Элементы.мГрафикПлатежейАналитика_2.СписокВыбора.Добавить(ВыборкаДетальныеЗаписи.ОбъектСтроительства, Представление);
		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ПлатежиПроверитьНеобходимостьСброситьОбъектСтроительства()
	
	СтрокаТЧ = Элементы.мГрафикПлатежей.ТекущиеДанные;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_2 КАК ОбъектСтроительства
	|ИЗ
	|	Документ.бит_ДополнительныеУсловияПоДоговору.ГрафикНачислений КАК бит_ДополнительныеУсловияПоДоговоруГрафикНачислений
	|ГДЕ
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Ссылка = &Ссылка
	//|	И бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.ЦФО = &ЦФО
	|	И бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_4 = &Аналитика_4
	|   и не бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_2 = неопределено
	|СГРУППИРОВАТЬ ПО
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_2";
	
	Запрос.УстановитьПараметр("Ссылка", объект.ДопУсловияПоДоговору); 
	//Запрос.УстановитьПараметр("ЦФО", СтрокаТЧ.ЦФО);
	Запрос.УстановитьПараметр("Аналитика_4", СтрокаТЧ.Аналитика_7.Мероприятие);
	
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() Тогда
		СтрокаТЧ.Аналитика_2 = Неопределено;	
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПлатежиПроверитьНеобходимостьСброситьПотребность()
	
	СтрокаТЧ = Элементы.мГрафикПлатежей.ТекущиеДанные;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_7 КАК Потребность
	|ИЗ
	|	Документ.бит_ДополнительныеУсловияПоДоговору.ГрафикНачислений КАК бит_ДополнительныеУсловияПоДоговоруГрафикНачислений
	|ГДЕ
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Ссылка = &Ссылка
	|	И бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.ЦФО = &ЦФО
	|	И бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_7 = &Аналитика_7
	|   и не бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_7 = неопределено
	|СГРУППИРОВАТЬ ПО
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Аналитика_7";
	
	Запрос.УстановитьПараметр("Ссылка", объект.ДопУсловияПоДоговору); 
	Запрос.УстановитьПараметр("ЦФО", СтрокаТЧ.ЦФО);
	Запрос.УстановитьПараметр("Аналитика_7", СтрокаТЧ.Аналитика_7);
	
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() Тогда
		СтрокаТЧ.Аналитика_7 = Неопределено;	
	КонецЕсли;	
	
КонецПроцедуры

&НаСервере
Процедура ПолучитьТЧПлатежейНаСервере()
	
	мГрафикПлатежей.Очистить();
	Для каждого СтрокаИсточник Из Объект.ДопУсловияПоДоговору.ГрафикНачислений Цикл
		СтрокаПолучатель = мГрафикПлатежей.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаПолучатель, СтрокаИсточник);
	КонецЦикла;	
	
КонецПроцедуры

&НаСервере
Функция ПрогнозПлатежаУтвержден(ПрогнозПлатежаСсылка)
	
	Результат = Ложь;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЕСТЬNULL(Статусы.Статус, ЗНАЧЕНИЕ(Справочник.бит_СтатусыОбъектов.ПустаяСсылка)) КАК Статус
	|ИЗ
	|	Документ.бит_ЗаявкаНаРасходованиеСредствОбщая КАК Документбит_ЗаявкаНаРасходованиеСредствОбщая
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.бит_СтатусыОбъектов КАК Статусы
	|		ПО Документбит_ЗаявкаНаРасходованиеСредствОбщая.Ссылка = Статусы.Объект
	|			И (Статусы.ВидСтатуса = ЗНАЧЕНИЕ(Перечисление.бит_ВидыСтатусовОбъектов.Статус))
	|ГДЕ
	|	Документбит_ЗаявкаНаРасходованиеСредствОбщая.Ссылка = &Ссылка
	|	и ЕСТЬNULL(Статусы.Статус, ЗНАЧЕНИЕ(Справочник.бит_СтатусыОбъектов.ПустаяСсылка)) = &Утвержден
	|";
	Запрос.Параметры.Вставить("Ссылка", ПрогнозПлатежаСсылка); 
	Запрос.Параметры.Вставить("Утвержден", Справочники.бит_СтатусыОбъектов.НайтиПоКоду("000000031")); //Утвержден
	РезультатЗапроса = Запрос.Выполнить();
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Результат = Истина;
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции 

&НаКлиенте
Процедура ПлатежиПроверитьЗаполнениеСумм(Отказ)
	
	Для каждого Строка Из мГрафикПлатежей Цикл
		Если Строка.Сумма <= 0 Тогда
			Отказ = Истина;
			ТекстСообщения = СтрШаблон("В строке %1 на вкладке 'График платежей' не заполнена Сумма", 
			Строка.НомерСтроки);
			Сообщить(ТекстСообщения);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры 

&НаКлиенте
Процедура ПроверитьПериодПлатежей(Строка, Отказ)
	
	ДатаНачала = Объект.ДатаНачала;
	ДатаОкончания = Объект.ДатаОкончания;
	
	ДатаНачалаНачисленияПоДоговору = Объект.ДопУсловияПоДоговору.ДатаНачалаНачисления;
	ДатаОкончанияНачисленияПоДоговору = Объект.ДопУсловияПоДоговору.ДатаОкончанияНачисления;
	
	Если не (ЗначениеЗаполнено(Объект.ДатаНачала) и ЗначениеЗаполнено(Объект.ДатаОкончания)) Тогда
		Отказ = Истина;
		Сообщить("Не заполнен период на вкладке 'График платежей'"); 
		Возврат;
	КонецЕсли;
	
	
	Период = Строка.Период;
	
	Если НЕ (ДатаНачала <= Период и Период <= ДатаОкончания)  Тогда
		Отказ = Истина;
		ТекстСообщения = СтрШаблон("Период в строке %1 на вкладке 'График платежей' выходит за пределы периода оплаты работ/оказания услуг/поставки на вкладке 'График платежей'" 
		, 
		Строка.НомерСтроки);
		Сообщить(ТекстСообщения);
	КонецЕсли;  
	
	Если Не значениеЗаполнено(Строка.ДокументПланирования) и НЕ (Период >= ТекущаяДата())  Тогда
		Отказ = Истина;
		ТекстСообщения = СтрШаблон("Период в строке %1 на вкладке 'График платежей' должен быть не ранее текущей даты" 
		, 
		Строка.НомерСтроки);
		Сообщить(ТекстСообщения);
	КонецЕсли;  
	
	
КонецПроцедуры

&НаСервере
Процедура ПолучитьПредельнуюСуммуПоДоговору()
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СУММА(бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.СуммаБезНДС) КАК СуммаБезНДС,
	|	СУММА(бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.НДС) КАК НДС,
	|	СУММА(бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Сумма) КАК Сумма
	|ИЗ
	|	Документ.бит_ДополнительныеУсловияПоДоговору.ГрафикНачислений КАК бит_ДополнительныеУсловияПоДоговоруГрафикНачислений
	|ГДЕ
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Ссылка = &Ссылка
	|";
	Запрос.Параметры.Вставить("Ссылка", Объект.ДопУсловияПоДоговору); 
	
	РезультатЗапроса = Запрос.Выполнить();
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		мПредельнаяСуммаПоДоговору = ВыборкаДетальныеЗаписи.Сумма;		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ПлатежиПроверитьПериода(Отказ)
	
	Для каждого Строка Из мГрафикПлатежей Цикл
		Если Не ЗначениеЗаполнено(Строка.Период) Тогда
			Отказ = Истина;
			ТекстСообщения = СтрШаблон("В строке %1 на вкладке 'График платежей' не заполнена дата платежа", 
			Строка.НомерСтроки);
			Сообщить(ТекстСообщения);
		КонецЕсли;
		
		Если Не значениеЗаполнено(Строка.ДокументПланирования) и НЕ (Строка.Период >= НачалоДня(ТекущаяДата()))  Тогда
			Отказ = Истина;
			ТекстСообщения = СтрШаблон("В строке %1 на вкладке 'График платежей' дата платежа не может быть ранее текущей даты", 
			Строка.НомерСтроки);
			Сообщить(ТекстСообщения);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры 

&НаКлиенте
Процедура ПроверитьЗаполнениеСтатьиОборотов(Отказ)
	
	Для каждого Строка Из мГрафикПлатежей Цикл
		Если Не ЗначениеЗаполнено(Строка.СтатьяОборотовБДДС) Тогда
			Отказ = Истина;
			ТекстСообщения = СтрШаблон("В строке %1 на вкладке 'График платежей' не заполнена Статья оборотов БДДС", 
			Строка.НомерСтроки);
			Сообщить(ТекстСообщения);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры 

#КонецОбласти //ГрафикиПлатежей 

#Область ГрафикиПоступлений

&НаСервере
Функция ВалидацияНаСервере()

ТЗ_ГрафикПоступлений = РеквизитФормыВЗначение("мГрафикПоступлений");
//РезультатВалидацииГрафикаПоступлений =  _ДокументПрогнозированияМенеджер.ПроверитьЗаполнениеГрафикаПоступлений(ТЗ_ГрафикПоступлений);	

ТЗ_ГрафикПлатежей = РеквизитФормыВЗначение("мГрафикПлатежей");
//РезультатВалидацииГрафикаПлатежей =  _ДокументПрогнозированияМенеджер.ПроверитьЗаполнениеГрафикаПлатежей(ТЗ_ГрафикПлатежей);	

ТЗ_нГрафикПлатежей = РеквизитФормыВЗначение("нГрафикПлатежей");

Возврат _ДокументПрогнозированияМенеджер.ОсуществитьВалидациюДокумента(Объект, ТЗ_ГрафикПоступлений, ТЗ_ГрафикПлатежей, ТЗ_нГрафикПлатежей);

КонецФункции // ()

&НаКлиенте
Процедура ОтобразитьПланФактПоступлений(Команда)

	Если элементы.мГрафикПоступленийПрогноз.Видимость = Истина Тогда
		элементы.мГрафикПоступленийПрогноз.Видимость = Ложь;
		элементы.мГрафикПоступленийФакт.Видимость = Ложь;
	Иначе
		элементы.мГрафикПоступленийПрогноз.Видимость = Истина;
		элементы.мГрафикПоступленийФакт.Видимость = Истина;
	КонецЕсли;

КонецПроцедуры

&НаСервере
Процедура ЗаполнитьГрафикПоступленийНаСервере()
	
	// 1. Получаем данные из менеджера
	ДанныеГрафика = _ДокументПрогнозированияМенеджер.ПолучитьГрафикиПоступленийДляФормы(Объект);
	
	// 2. Загружаем в реквизит формы (ТаблицаЗначений)
	мГрафикПоступлений.Очистить();
	мГрафикПоступлений.Загрузить(ДанныеГрафика);  
	
	// 3. НОВОЕ: Рассчитываем Факт для КАЖДОЙ строки
	Для Каждого СтрокаГрафика Из мГрафикПоступлений Цикл
		
		СтрокаГрафика.Факт = _ДокументПрогнозированияМенеджер.РассчитатьФактПоГрафику(
																						Объект, 
																						СтрокаГрафика.УИДСтроки
																						);
	КонецЦикла;	
	
	// 4. Если есть выбранная строка — загружаем детализацию
	Если мГрафикПоступлений.Количество() > 0 Тогда
		// Берем первую строку как текущую
		ТекущаяСтрока = мГрафикПоступлений[0];
		УИДГрафика = ТекущаяСтрока.УИДСтроки;
		ЗагрузитьДетализациюПоГрафикуПоступлений(УИДГрафика);
	Иначе
		// Если нет строк — очищаем детализацию
		мДетализацияГрафикаПоступлений.Очистить();
	КонецЕсли;	
	
КонецПроцедуры 

&НаСервере
Процедура ЗагрузитьДетализациюПоГрафикуПоступлений(УИДГрафика)
	
	ДанныеДетализации = _ДокументПрогнозированияМенеджер.ПолучитьДетализациюПоГрафикуПоступлений(Объект, УИДГрафика);
	мДетализацияГрафикаПоступлений.Очистить();
	мДетализацияГрафикаПоступлений.Загрузить(ДанныеДетализации); 
	
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьВсеПлатежныеПоручения()
    
	КомандаПрименитьФильтрДатПриКешированииПлатежекНаСервере();

КонецПроцедуры

&НаСервере
Процедура ЗагрузитьСвободныеПлатежки()
    
    // 1. Подготовить ВТ детализации
    ВТДетализация = _ДокументПрогнозированияМенеджер.ПодготовитьВТДетализации(Объект);           
	ТЗВсеПлатежки = РеквизитФормыВЗначение("мКэшПлатежныхПоручений");
    
    // 2. Получить свободные платежки
    ТЗ = _ДокументПрогнозированияМенеджер.ПолучитьСвободныеПлатежки(ТЗВсеПлатежки, ВТДетализация);
	ТЗ.Сортировать("Дата Убыв");
	
    // 3. Загрузить в реквизит формы
    мСвободныеПлатежки.Очистить();
    мСвободныеПлатежки.Загрузить(ТЗ);
    
КонецПроцедуры

&НаКлиенте
Процедура мГрафикПоступленийПриАктивизацииСтроки(Элемент)  
	
	ТекущаяСтрокаГрафика = Элементы.мГрафикПоступлений.ТекущиеДанные; 
	Если НЕ ТекущаяСтрокаГрафика = Неопределено Тогда
		ЗагрузитьДетализациюПоГрафикуПоступлений(ТекущаяСтрокаГрафика.УИДСтроки);
		Элементы.мГрафикПоступленийДокументПланирования.СписокВыбора.Очистить();
		Элементы.мГрафикПоступленийДокументПланирования.СписокВыбора.Добавить(ТекущаяСтрокаГрафика.ДокументПланирования);
	КонецЕсли;
	ПересчитатьАгрегатыНаСервере();
	
КонецПроцедуры  

&НаКлиенте
Процедура мГрафикПоступленийПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	
	Отказ = Истина;  
	СтрокаТЧ = Элементы.мГрафикПоступлений.ТекущиеДанные; 

	Если Копирование Тогда 
	    ТекущаяСтрока = Элементы.мГрафикПоступлений.ТекущиеДанные;
	    Если ТекущаяСтрока = Неопределено Тогда
	        Сообщить("Выберите строку для копирования");
	        Возврат;
	    КонецЕсли;		
		
		УИДНовойСтроки = СкопироватьСтрокуГрафикаНаСервере(ТекущаяСтрока.УИДСтроки);
	Иначе
		УИДНовойСтроки = СоздатьСтрокуГрафикаНаСервере();  
	КонецЕсли; 
	
 	ВыделитьСозданнуюСтроку(УИДНовойСтроки);
	
КонецПроцедуры

&НаСервере
Функция СкопироватьСтрокуГрафикаНаСервере(УИДДляКопирования)
    
    Модифицированность = Истина; // Важно!
    
    УИДКопии = _ДокументПрогнозированияМенеджер.СкопироватьСтрокуГрафикаПоступлений(
																			        Объект, 
																			        УИДДляКопирования
																			  		);   
	
	ОбновитьГрафикИзОбъекта();	
	
	ПересчитатьАгрегатыНаСервере();
    
    Возврат УИДКопии;
    
КонецФункции

&НаСервере
Функция СоздатьСтрокуГрафикаНаСервере()
	
	// 1. Создаём строку в объекте
	УИДНовойСтроки = _ДокументПрогнозированияМенеджер.СоздатьСтрокуГрафикаПоступлений(Объект);

	Модифицированность = Истина;
	
	// 2. Обновляем ВЕСЬ график из объекта (просто и надёжно)
	ОбновитьГрафикИзОбъекта();
	ПересчитатьАгрегатыНаСервере();
	
	// 3. Возвращаем УИД для выделения
	Возврат УИДНовойСтроки;
	
КонецФункции

&НаСервере
Процедура ОбновитьГрафикИзОбъекта()
	
	ДанныеГрафика = _ДокументПрогнозированияМенеджер.ПолучитьГрафикиПоступленийДляФормы(Объект);
	мГрафикПоступлений.Очистить();
	мГрафикПоступлений.Загрузить(ДанныеГрафика);
	
КонецПроцедуры

&НаКлиенте
Процедура ВыделитьСозданнуюСтроку(УИДНовойСтроки)
	
	// Ищем строку с этим УИД в ОБНОВЛЁННОЙ таблице
	Для Каждого Строка Из мГрафикПоступлений Цикл
		Если Строка.УИДСтроки = УИДНовойСтроки Тогда
			Индекс = Строка.ПолучитьИдентификатор();
			Элементы.мГрафикПоступлений.ТекущаяСтрока = Индекс;
			
			// Загружаем детализацию (пустую для новой строки)
			ЗагрузитьДетализациюПоГрафикуПоступлений(УИДНовойСтроки);
			
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры 

&НаКлиенте
Процедура ВыделитьСозданнуюСтрокуДетализации(УИДНовойСтроки)
	
	// Ищем строку с этим УИД в ОБНОВЛЁННОЙ таблице
	Для Каждого Строка Из мДетализацияГрафикаПоступлений Цикл
		Если Строка.УИДСтроки = УИДНовойСтроки Тогда
			Индекс = Строка.ПолучитьИдентификатор();
			Элементы.мДетализацияГрафикаПоступлений.ТекущаяСтрока = Индекс;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Функция УдалитьСтрокуГрафикаНаСервере(УИДДляУдаления)
	
	_ДокументПрогнозированияМенеджер.УдалитьСтрокуГрафикаПоступлений(Объект, УИДДляУдаления);
	Модифицированность = Истина;	
	ОбновитьГрафикИзОбъекта();       
	ПересчитатьАгрегатыНаСервере();
	
	// Возвращаем признак успешности
	Возврат Истина;
	
КонецФункции

&НаКлиенте
Процедура мГрафикПоступленийПередУдалением(Элемент, Отказ)
    
    Отказ = Истина;
    
    ТекущаяСтрока = Элементы.мГрафикПоступлений.ТекущиеДанные;
    Если ТекущаяСтрока = Неопределено Тогда
        Возврат;
	КонецЕсли; 
	
	// Проверяем документ планирования
	Если ЗначениеЗаполнено(ТекущаяСтрока.ДокументПланирования) Тогда
	    Сообщить("Удаление запрещено: по строке создан документ планирования " + 
	             ТекущаяСтрока.ДокументПланирования);
	    Возврат;
	КонецЕсли;	
	    
    // 1. ЗАПОМИНАЕМ ПОЗИЦИЮ в таблице (индекс строки)
    ПозицияВТаблице = Неопределено;
    Для i = 0 По мГрафикПоступлений.Количество() - 1 Цикл
        Если мГрафикПоступлений[i].УИДСтроки = ТекущаяСтрока.УИДСтроки Тогда
            ПозицияВТаблице = i; // Номер строки сверху (0, 1, 2...)
            Прервать;
        КонецЕсли;
    КонецЦикла;
    
    // 2. УДАЛЯЕМ
    УдалитьСтрокуГрафикаНаСервере(ТекущаяСтрока.УИДСтроки);
    
    // 3. ВОССТАНАВЛИВАЕМ ФОКУС НА ТОЙ ЖЕ ПОЗИЦИИ
    Если ПозицияВТаблице <> Неопределено Тогда
        // Ждём обновления таблицы
        // ОбновитьГрафикИзОбъекта() уже вызвался в УдалитьСтрокуГрафикаНаСервере()
        
        Если мГрафикПоступлений.Количество() = 0 Тогда
            // Если строк не осталось
            мДетализацияГрафикаПоступлений.Очистить();
            Возврат;
        КонецЕсли;
        
        // Выбираем строку на ТОЙ ЖЕ ПОЗИЦИИ
        // Если позиция больше, чем строк осталось — берём последнюю
        НоваяПозиция = ?(ПозицияВТаблице < мГрафикПоступлений.Количество(),
                         ПозицияВТаблице,
                         мГрафикПоступлений.Количество() - 1);
        
        // Ищем строку по позиции и ставим фокус
        Если НоваяПозиция < мГрафикПоступлений.Количество() Тогда
            СтрокаНаПозиции = мГрафикПоступлений[НоваяПозиция];
            Элементы.мГрафикПоступлений.ТекущаяСтрока = СтрокаНаПозиции.ПолучитьИдентификатор();
        КонецЕсли;
    КонецЕсли;
    
КонецПроцедуры

&НаКлиенте
Процедура мДетализацияГрафикаПоступленийПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	
	Отказ = Истина; 	
	
	Если Копирование Тогда
		Возврат;
	КонецЕсли;
	
	УИДНовогоПлатежа = ДобавитьПлатежВДетализацию();
	Если УИДНовогоПлатежа <> Неопределено Тогда
		ВыделитьСозданнуюСтрокуДетализации(УИДНовогоПлатежа);
	КонецЕсли;	
	
КонецПроцедуры

&НаКлиенте
Процедура мДетализацияГрафикаПоступленийПередУдалением(Элемент, Отказ)
	
	//СтандартнаяОбработка = Ложь;	
	Отказ = Истина; 
	УдалитьПлатежИзДетализации();
	
КонецПроцедуры

&НаКлиенте
Функция ДобавитьПлатежВДетализацию()
	
	// 1. Проверяем, выбран ли график
	ТекущийГрафик = Элементы.мГрафикПоступлений.ТекущиеДанные;
	Если ТекущийГрафик = Неопределено Тогда
		Сообщить("Выберите строку графика");
		Возврат Неопределено;
	КонецЕсли;
	
	// 2. Добавляем
	УИДНовогоПлатежа = ДобавитьПлатежВДетализациюНаСервере(ТекущийГрафик.УИДСтроки);
	
	// 3. Обновляем детализацию
	ОбновитьДетализациюИзОбъекта(ТекущийГрафик.УИДСтроки); 
	
	Возврат УИДНовогоПлатежа;
	
КонецФункции

&НаСервере
Функция ДобавитьПлатежВДетализациюНаСервере(УИДГрафика)
	
	 // 1. Добавляем платеж
    УИДНовогоПлатежа = _ДокументПрогнозированияМенеджер.ДобавитьПлатежВДетализацию(Объект, УИДГрафика);
    Модифицированность = Истина; 
	
    // 2. Возвращаем УИД (если нужно)
    Возврат УИДНовогоПлатежа;
	
КонецФункции

&НаКлиенте
Процедура УдалитьПлатежИзДетализации()
    
	//ТекущийПлатеж = Элементы.мДетализацияГрафикаПоступлений.ТекущиеДанные;
	//Если ТекущийПлатеж = Неопределено Тогда
	//    Сообщить("Выберите платеж для удаления");
	//    Возврат;
	//КонецЕсли;
	//
	//// 1. ЗАПОМИНАЕМ данные ДО удаления
	//ПозицияВТаблице = Неопределено;
	//Для i = 0 По мДетализацияГрафикаПоступлений.Количество() - 1 Цикл
	//    Если мДетализацияГрафикаПоступлений[i].УИДСтроки = ТекущийПлатеж.УИДСтроки Тогда
	//        ПозицияВТаблице = i;
	//        Прервать;
	//    КонецЕсли;
	//КонецЦикла;
	//
	//УИДГрафика = ТекущийПлатеж.УИДСтрокиГрафикаПоступлений;
	//УИДДляУдаления = ТекущийПлатеж.УИДСтроки;
	//
	//// 2. УДАЛЯЕМ 
	//УдалитьПлатежИзДетализацииНаСервере(УИДДляУдаления, УИДГрафика);
	//
	//// 3. ВОССТАНАВЛИВАЕМ ФОКУС
	//Если ПозицияВТаблице <> Неопределено Тогда

	//	Если мДетализацияГрафикаПоступлений.Количество() = 0 Тогда
	//        // Если строк не осталось — просто выходим
	//        Возврат;
	//    КонецЕсли;
	//    
	//    // Берём строку на той же позиции
	//    Если ПозицияВТаблице < мДетализацияГрафикаПоступлений.Количество() Тогда
	//        // Позиция существует — берём её
	//        НоваяСтрока = мДетализацияГрафикаПоступлений[ПозицияВТаблице];
	//    Иначе
	//        // Позиция исчезла (удалили последнюю) — берём новую последнюю
	//        НоваяСтрока = мДетализацияГрафикаПоступлений[
	//            мДетализацияГрафикаПоступлений.Количество() - 1];
	//    КонецЕсли;
	//    
	//    // Ставим фокус
	//    Элементы.мДетализацияГрафикаПоступлений.ТекущаяСтрока = НоваяСтрока.ПолучитьИдентификатор();
	//    
	//КонецЕсли;

	// Проверяем выбор
	ТекущаяСтрокаДетализации = Элементы.мДетализацияГрафикаПоступлений.ТекущиеДанные;
	Если ТекущаяСтрокаДетализации = Неопределено Тогда
		Сообщить("Выберите платеж в детализации для отвязки");
		Возврат;
	КонецЕсли;
	
	// ЗАПОМИНАЕМ позицию в детализации ПЕРЕД удалением
	ПозицияВДетализации = НайтиПозициюТекущейСтроки(
													мДетализацияГрафикаПоступлений,
													ТекущаяСтрокаДетализации,
													"УИДСтроки"
													);
													
	ЭлементВДетализации = Элементы.мДетализацияГрафикаПоступлений.ТекущийЭлемент;													
	
	// ЗАПОМИНАЕМ позицию в графике
	ТекущаяСтрокаГрафика = Элементы.мГрафикПоступлений.ТекущиеДанные;
	ПозицияВГрафике = НайтиПозициюТекущейСтроки(
												мГрафикПоступлений,
												ТекущаяСтрокаГрафика,
												"УИДСтроки"
												);
	
	// Подтверждение
	Ответ = Вопрос("Отвязать платеж на сумму " + 
					Формат(ТекущаяСтрокаДетализации.СуммаПогашено, "ЧДЦ=2") + " руб.?",
					РежимДиалогаВопрос.ДаНет); 
						
	Если Ответ = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли;
	
	// Вызов серверного метода
	ОтвязатьПлатежкуНаСервере(
								ТекущаяСтрокаДетализации.УИДСтроки,
								ТекущаяСтрокаДетализации.УИДСтрокиГрафикаПоступлений
								);
	
	// ВОССТАНАВЛИВАЕМ фокус 
	// 1. В свободных платежках — на освободившуюся платежку (уже есть ВосстановитьФокусВСвободныхПлатежках)
	ВосстановитьФокусВСвободныхПлатежках();
	
	// 2. В детализации — на той же позиции (или предыдущей, если удалили последнюю)
	ВосстановитьФокусПоПозиции(
								мДетализацияГрафикаПоступлений,
								Элементы.мДетализацияГрафикаПоступлений,
								ПозицияВДетализации
								);
	
	
	// 3. В графике — без изменений
	Если ПозицияВГрафике <> Неопределено Тогда
		ВосстановитьФокусПоПозиции(
									мГрафикПоступлений,
									Элементы.мГрафикПоступлений,
									ПозицияВГрафике
									);
	КонецЕсли;
	
	//ЭтаФорма.ТекущийЭлемент = элементы.мДетализацияГрафикаПоступлений;   
	
	Если ПозицияВДетализации <> Неопределено Тогда
	    ВосстановитьФокусПоПозиции(
							        мДетализацияГрафикаПоступлений,
							        Элементы.мДетализацияГрафикаПоступлений,
							        ПозицияВДетализации
								    );	
	КонецЕсли;
	
	Элементы.мДетализацияГрафикаПоступлений.ТекущийЭлемент = ЭлементВДетализации;	
		
КонецПроцедуры

&НаСервере
Процедура ОбновитьДетализациюИзОбъекта(УИДГрафика)
	
	ДанныеДетализации = _ДокументПрогнозированияМенеджер.ПолучитьДетализациюПоГрафикуПоступлений(Объект, УИДГрафика);
	мДетализацияГрафикаПоступлений.Очистить();
	мДетализацияГрафикаПоступлений.Загрузить(ДанныеДетализации);
	
КонецПроцедуры

&НаКлиенте
Процедура мГрафикПоступленийПриИзменении(Элемент)
    
    Модифицированность = Истина;
    ТекущаяСтрока = Элемент.ТекущиеДанные;
    Если ТекущаяСтрока = Неопределено Тогда
        Возврат;
    КонецЕсли; 
    
    // ЗАПОМИНАЕМ текущую строку
    УИДТекущейСтроки = ТекущаяСтрока.УИДСтроки;
    
    ОбновитьСтрокуГрафикаНаСервере(УИДТекущейСтроки);
    
	//// Перезагружаем график
	//ОбновитьГрафикИзОбъекта();
	ПересчитатьАгрегатыНаСервере();
    
    // ВОССТАНАВЛИВАЕМ фокус
    ВосстановитьФокусНаСтроке(УИДТекущейСтроки);
    
КонецПроцедуры

&НаКлиенте
Процедура ВосстановитьФокусНаСтроке(УИДСтроки)
    
    // Ищем строку с этим УИД в обновленной таблице
    Для Каждого Строка Из мГрафикПоступлений Цикл
        Если Строка.УИДСтроки = УИДСтроки Тогда
            Элементы.мГрафикПоступлений.ТекущаяСтрока = Строка.ПолучитьИдентификатор();
            Прервать;
        КонецЕсли;
    КонецЦикла;
    
КонецПроцедуры 

&НаСервере
Процедура ОбновитьСтрокуГрафикаНаСервере(УИДСтроки)
	
	ТТЗ = РеквизитФормыВЗначение("мГрафикПоступлений");	
	_ДокументПрогнозированияМенеджер.ОбновитьСтрокуГрафикаНаСервере(Объект, УИДСтроки, ТТЗ);	
	
КонецПроцедуры

&НаКлиенте
Процедура мДетализацияГрафикаПоступленийПриИзменении(Элемент)

	Модифицированность = Истина;    
    ТекущаяСтрока = Элемент.ТекущиеДанные;
    Если ТекущаяСтрока = Неопределено Тогда
        Возврат;
	КонецЕсли; 
	
	// 1. ЗАПОМИНАЕМ позицию ПЕРЕД изменением
		ПозицияВДетализации = НайтиПозициюТекущейСтроки(
													мДетализацияГрафикаПоступлений,
													ТекущаяСтрока,
													"УИДСтроки"
													);	
	
	// Сохраняем УИД строки детализации и графика
    УИДДетализации = ТекущаяСтрока.УИДСтроки;
    УИДГрафика = ТекущаяСтрока.УИДСтрокиГрафикаПоступлений;
    
    ОбновитьСтрокуДетализацииГрафикаНаСервере(УИДДетализации, УИДГрафика);
	ПересчитатьАгрегатыНаСервере();
	
	// 4. ВОССТАНАВЛИВАЕМ фокус в детализации
		Если ПозицияВДетализации <> Неопределено Тогда
			ВосстановитьФокусПоПозиции(
										мДетализацияГрафикаПоступлений,
										Элементы.мДетализацияГрафикаПоступлений,
										ПозицияВДетализации
										);
	КонецЕсли;
	Элементы.мДетализацияГрафикаПоступлений.ТекущийЭлемент = элементы.мДетализацияГрафикаПоступленийСуммаПогашено;
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьСтрокуДетализацииГрафикаНаСервере(УИДСтроки, УИДСтрокиГрафикаПоступлений)

	// 1. Получаем новые данные из формы
	ТТЗ = РеквизитФормыВЗначение("мДетализацияГрафикаПоступлений");    
	НайденныеВТЗ = ТТЗ.НайтиСтроки(Новый Структура("УИДСтроки", УИДСтроки));
	Если НайденныеВТЗ.Количество() = 0 Тогда
	    Возврат;
	КонецЕсли;
	НовыеДанные = НайденныеВТЗ[0];

	// 2. Проверяем отрицательный прогноз 
	
	ТЗмГрафикПоступлений = РеквизитФормыВЗначение("мГрафикПоступлений");
	ОстатокПлана = _ДокументПрогнозированияМенеджер.РассчитатьОстатокПоПлану(
																			    Объект, 
																			    УИДСтрокиГрафикаПоступлений, 
																				ТЗмГрафикПоступлений
																				);
	// 3. Находим старую строку для расчета
	НайденныеВОбъекте = Объект.ДетализацияГрафикаПоступлений.НайтиСтроки(
																		    Новый Структура("УИДСтроки", УИДСтроки)
																			);
	Если НайденныеВОбъекте.Количество() > 0 Тогда
	    СтараяСумма = НайденныеВОбъекте[0].СуммаПогашено;
	    
	    // Проверяем, не уйдем ли в минус
	    Если (ОстатокПлана + СтараяСумма) < НовыеДанные.СуммаПогашено Тогда
	        // Будет отрицательный прогноз 
			
	        ТекстСообщения = СтрШаблон("Невозможно привязать %1 руб. Остаток по плану: %2 руб.", 
										?(НовыеДанные.СуммаПогашено = 0, "0,00", Формат(НовыеДанные.СуммаПогашено,"ЧДЦ=2")), 
										?(ОстатокПлана + СтараяСумма = 0, "0,00", Формат(ОстатокПлана + СтараяСумма,"ЧДЦ=2"))
										); 
			Сообщить(ТекстСообщения); 
			
		   Для Каждого Строка Из мДетализацияГрафикаПоступлений Цикл
		        Если Строка.УИДСтроки = УИДСтроки Тогда
		            Строка.СуммаПогашено = СтараяСумма;
		            Прервать;
		        КонецЕсли;
		    КонецЦикла;			
			
			Возврат;
	    КонецЕсли;
	КонецЕсли;

	// 4. Если проверка прошла — обновляем
	_ДокументПрогнозированияМенеджер.ОбновитьСтрокуДетализацииГрафикаНаСервере(
																			    Объект, 
																			    УИДСтроки, 
																			    ТТЗ
																				);	
	
 КонецПроцедуры 

&НаСервере
Процедура СохранитьПорядокГрафикаВОбъектеНаСервере()
    
    // 1. Берем ТЗ из формы (там строки в новом порядке)
    ТЗИзФормы = РеквизитФормыВЗначение("мГрафикПоступлений");
    
    // 2. Обновляем порядок в объекте
    _ДокументПрогнозированияМенеджер.ОбновитьПорядокГрафикаВОбъекте(
															        Объект,
															        ТЗИзФормы
															   		);
    
    // 3. Помечаем документ как измененный
    Модифицированность = Истина;
    
    // 4. Перезагружаем график (с новым порядком из объекта)
    ОбновитьГрафикИзОбъекта();
    
КонецПроцедуры

&НаКлиенте
Процедура КомандаПривязатьПлатежноеПоручениеКПлануПоступлений(Команда)
	
	// Быстрые проверки для блокировки кнопки
	ВыбранныйПлан = Элементы.мГрафикПоступлений.ТекущиеДанные;
	ВыбраннаяПлатежка = Элементы.мСвободныеПлатежки.ТекущиеДанные;
	
	Если ВыбранныйПлан = Неопределено 
		Или ВыбраннаяПлатежка = Неопределено Тогда
		Возврат;
	КонецЕсли; 
	
    Если ВыбраннаяПлатежка = Неопределено Тогда
        Сообщить("Выберите платежное поручение");
        Возврат;
    КонецЕсли;
    
    // 2. Проверка документа планирования
    Если НЕ ЗначениеЗаполнено(ВыбранныйПлан.ДокументПланирования) Тогда
        Сообщить("Для привязки необходимо создать документ планирования для выбранной строки");
        Возврат;
    КонецЕсли;
    
    // 3. Проверка проведения документа планирования
    Если НЕ ВыбранныйПлан.ДокументПланирования.Проведен Тогда
        Сообщить("Документ планирования " + ВыбранныйПлан.ДокументПланирования + " не проведен");
        Возврат;
    КонецЕсли;	
	
	// ЗАПОМИНАЕМ позиции ПЕРЕД действием
	ПозицияВСвободных = НайтиПозициюТекущейСтроки(
													мСвободныеПлатежки, 
													ВыбраннаяПлатежка, 
													"ПлатежноеПоручениеВходящее"
													);
	
	ПозицияВГрафике = НайтиПозициюТекущейСтроки(
												мГрафикПоступлений,
												ВыбранныйПлан,
												"УИДСтроки"
												);
	
	// Вызов серверного метода
	ПривязатьПлатежкуНаСервере(
								ВыбранныйПлан.УИДСтроки,
								ВыбраннаяПлатежка.ПлатежноеПоручениеВходящее
								);
	
	// ВОССТАНАВЛИВАЕМ фокус ВО ВСЕХ таблицах
	
	// 1. В свободных платежках — на той же позиции
	ВосстановитьФокусПоПозиции(
								мСвободныеПлатежки, 
								Элементы.мСвободныеПлатежки, 
								ПозицияВСвободных
								);
	
	// 2. В детализации — на новую строку (через ВосстановитьФокусВДетализации)
	ВосстановитьФокусВДетализации();
	
	// 3. В графике — на той же позиции
	Если ПозицияВГрафике <> Неопределено Тогда
		ВосстановитьФокусПоПозиции(
									мГрафикПоступлений, 
									Элементы.мГрафикПоступлений, 
									ПозицияВГрафике
									);
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Функция НайтиПозициюТекущейСтроки(ТЗ, ТекущиеДанные, ИмяКлючевогоПоля = "УИДСтроки")

	Если ТекущиеДанные = Неопределено Тогда
	    Возврат Неопределено;
	КонецЕсли;

	Для i = 0 По ТЗ.Количество() - 1 Цикл
	    Если ТЗ[i][ИмяКлючевогоПоля] = ТекущиеДанные[ИмяКлючевогоПоля] Тогда
	        Возврат i;
	    КонецЕсли;
	КонецЦикла;

	Возврат Неопределено;
	
КонецФункции

&НаСервере
Процедура ПривязатьПлатежкуНаСервере(УИДСтрокиГрафика, ПлатежноеПоручениеВходящее)
    
    ТЗмГрафикПоступлений = РеквизитФормыВЗначение("мГрафикПоступлений");
    
    // 1. Получаем показатели для сообщения об ошибке
    Показатели = _ДокументПрогнозированияМенеджер.РассчитатьПоказателиСтрокиГрафика(
																				        Объект,
																				        УИДСтрокиГрафика,
																				        ТЗмГрафикПоступлений
																				    );
    
    // 2. Расчет суммы через менеджер
    СуммаПривязки = _ДокументПрогнозированияМенеджер.РассчитатьСуммуПривязки(
																		        Объект,
																		        УИДСтрокиГрафика,
																		        ПлатежноеПоручениеВходящее,
																		        ТЗмГрафикПоступлений 
																		    );
    
    Если СуммаПривязки <= 0 Тогда
        // Ошибка привязки
        
        ОстатокПлатежки = _ДокументПрогнозированияМенеджер.РассчитатьСвободныйОстатокПлатежа(
            Объект, 
            ПлатежноеПоручениеВходящее
        );
        
        ТекстСообщения = "Не удалось привязать платежку. ";
        
        Если Показатели.ОстатокПлана <= 0 Тогда
            // Отрицательный или нулевой остаток плана
            ТекстОстаток = ?(Показатели.ОстатокПлана = 0, "0,00", Формат(Показатели.ОстатокПлана, "ЧДЦ=2"));
            ТекстСообщения = ТекстСообщения + "Остаток плана: " + ТекстОстаток + " руб.";
        ИначеЕсли ОстатокПлатежки <= 0 Тогда
            // Нет свободного остатка у платежки
            ТекстОстаток = ?(ОстатокПлатежки = 0, "0,00", Формат(ОстатокПлатежки, "ЧДЦ=2"));
            ТекстСообщения = ТекстСообщения + "Свободный остаток платежки: " + ТекстОстаток + " руб.";
        КонецЕсли;
        
        Сообщить(ТекстСообщения, СтатусСообщения.Информация);
        Возврат;
    КонецЕсли;
    
    // 3. Привязка через менеджер (успех)
    _ДокументПрогнозированияМенеджер.ПривязатьПлатежКПлану(
														        Объект,
														        УИДСтрокиГрафика,
														        ПлатежноеПоручениеВходящее,
														        СуммаПривязки
														    );
    
    Модифицированность = Истина;
    
    // 4. Обновление интерфейса
    ЗагрузитьДетализациюПоГрафикуПоступлений(УИДСтрокиГрафика);
    ПересчитатьАгрегатыНаСервере(); 
    
    мПлатежкаДляФокусаВДетализации = ПлатежноеПоручениеВходящее;
    
    // 5. Сообщение об успехе
    Сообщить("Платежка привязана на сумму " + Формат(СуммаПривязки, "ЧДЦ=2") + " руб.", 
    СтатусСообщения.Информация);
    
КонецПроцедуры

&НаКлиенте
Процедура ВосстановитьФокусВДетализации()
	
	Если мПлатежкаДляФокусаВДетализации = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	// Ищем платежку в таблице детализации
	Для i = 0 По мДетализацияГрафикаПоступлений.Количество() - 1 Цикл
		Если мДетализацияГрафикаПоступлений[i].ПлатежноеПоручениеВходящее = мПлатежкаДляФокусаВДетализации Тогда
			Элементы.мДетализацияГрафикаПоступлений.ТекущаяСтрока = мДетализацияГрафикаПоступлений[i].ПолучитьИдентификатор();
			Прервать;
		КонецЕсли;
	КонецЦикла;
	// Очищаем
	мПлатежкаДляФокусаВДетализации = Неопределено; 
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаОтвязатьПлатежноеПоручениеОтПланаПоступлений(Команда)

	УдалитьПлатежИзДетализации();	
	
КонецПроцедуры

&НаСервере
Процедура ОтвязатьПлатежкуНаСервере(УИДПлатежа, УИДСтрокиГрафика)

	// 0. ЗАПОМИНАЕМ платежку перед удалением
	ПлатежкаДляФокуса = Неопределено;
	Для Каждого СтрокаДет Из Объект.ДетализацияГрафикаПоступлений Цикл
		Если СтрокаДет.УИДСтроки = УИДПлатежа Тогда
			ПлатежкаДляФокуса = СтрокаДет.ПлатежноеПоручениеВходящее;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	// 1. Удаляем через менеджер
	_ДокументПрогнозированияМенеджер.УдалитьПлатежИзДетализации(
																Объект,
																УИДПлатежа
																);
	
	Модифицированность = Истина;
	
	// 2. Обновляем интерфейс
	ЗагрузитьДетализациюПоГрафикуПоступлений(УИДСтрокиГрафика);
	ПересчитатьАгрегатыНаСервере();
	
	// 3. Восстанавливаем фокус в свободных платежках
	Если ПлатежкаДляФокуса <> Неопределено Тогда
		// Передаем на клиент для установки фокуса
		мПлатежкаДляФокусаВСвободных = ПлатежкаДляФокуса;
	КонецЕсли;
	
	// 4. Сообщение
	//Сообщить("Платеж отвязан", СтатусСообщения.Информация); 
	
КонецПроцедуры

&НаКлиенте
Процедура ВосстановитьФокусВСвободныхПлатежках()
	
	Если мПлатежкаДляФокусаВСвободных = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	// Ищем платежку в таблице свободных
	Для i = 0 По мСвободныеПлатежки.Количество() - 1 Цикл
		Если мСвободныеПлатежки[i].ПлатежноеПоручениеВходящее = мПлатежкаДляФокусаВСвободных Тогда
			Элементы.мСвободныеПлатежки.ТекущаяСтрока = мСвободныеПлатежки[i].ПолучитьИдентификатор();
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	// Очищаем
	мПлатежкаДляФокусаВСвободных = Неопределено;  
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьСвободныеПлатежныеПорученияНаСервере() 
	
		ЗагрузитьВсеПлатежныеПоручения();
	 	ЗагрузитьСвободныеПлатежки();    
		
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьСвободныеПлатежныеПоручения(Команда)
	ОбновитьСвободныеПлатежныеПорученияНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура ГрафикПоступленийЗаполнитьСтатьиДДСДляВыбора()
    
    Результат = ГрафикПоступленийПолучитьСтатьиДДСДляВыбораНаСервере();
    
    // Очищаем список
    Элементы.мГрафикПоступленийСтатьяОборотовБДДС.СписокВыбора.Очистить();
    
    // Показываем сообщения, если есть
    Если НЕ Результат.ВсеХорошо Тогда
        Для Каждого Сообщение Из Результат.СписокСообщений Цикл
            Сообщить(Сообщение.Значение);
        КонецЦикла;
    КонецЕсли;
    
    // Заполняем список выбора
    Если Результат.СписокВыбора.Количество() > 0 Тогда
        Для Каждого Статья Из Результат.СписокВыбора Цикл
            Элементы.мГрафикПоступленийСтатьяОборотовБДДС.СписокВыбора.Добавить(Статья.Значение);
        КонецЦикла;
    КонецЕсли;
    
КонецПроцедуры

&НаСервере
Функция ГрафикПоступленийПолучитьМероприятияНаСервере()
    
    Возврат _ДокументПрогнозированияМенеджер.ПолучитьМероприятияДляВыбора(Объект);
    
КонецФункции

&НаКлиенте
Процедура ГрафикПоступленийЗаполнитьМероприятияДляВыбора()
    
    Результат = ГрафикПоступленийПолучитьМероприятияНаСервере();
    
    Элементы.мГрафикПоступленийМероприятиеПКВ.СписокВыбора.Очистить();
    
    // Показываем сообщения, если есть
    Если НЕ Результат.ВсеХорошо Тогда
        Для Каждого Сообщение Из Результат.СписокСообщений Цикл
            Сообщить(Сообщение.Значение);
        КонецЦикла;
    КонецЕсли;
    
    // Заполняем список выбора
    Если Результат.СписокВыбора.Количество() > 0 Тогда
        Для Каждого Статья Из Результат.СписокВыбора Цикл
            Элементы.мГрафикПоступленийМероприятиеПКВ.СписокВыбора.Добавить(Статья.Значение);
        КонецЦикла;
    КонецЕсли;
    
КонецПроцедуры

&НаСервере
Функция ГрафикПоступленийПолучитьСтатьиДДСДляВыбораНаСервере()
    
    Возврат _ДокументПрогнозированияМенеджер.ПолучитьСтатьиБДДСДляВыбора(Объект);
    
КонецФункции

&НаКлиенте
Процедура мГрафикПоступленийПередНачаломИзменения(Элемент, Отказ)

	ТекущаяСтрокаГрафика = Элементы.мГрафикПоступлений.ТекущиеДанные; 
	Если Элемент.ТекущийЭлемент.Имя = "мГрафикПоступленийДокументПланирования" Тогда
		ПоказатьЗначение(,ТекущаяСтрокаГрафика.ДокументПланирования);
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	Если НЕ ТекущаяСтрокаГрафика = Неопределено Тогда
		// Если есть документ планирования — запрещаем редактирование
		Если ЗначениеЗаполнено(ТекущаяСтрокаГрафика.ДокументПланирования) 
			//и ТекущаяСтрокаГрафика.ДокументПланирования.Проведен 
		Тогда
			//Сообщить("Редактирование запрещено: по строке создан документ планирования " + 
			//         ТекущаяСтрокаГрафика.ДокументПланирования);
	        Отказ = Истина;
	        Возврат;
		КонецЕсли;	
		ГрафикПоступленийЗаполнитьСтатьиДДСДляВыбора(); 	
		ГрафикПоступленийЗаполнитьМероприятияДляВыбора();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция СоздатьДокументПланируемоеПоступлениеДСНаСервере(УИДСтрокиГрафика)

	СтруктураРезультат = новый Структура;
	СписокСообщений = Новый СписокЗначений; 
	СсылкаНаДокументПланирования = Неопределено;
	
	ВсеХорошо = Истина; 
	
	// 1. Всегда записываем (если модифицирован или новый)
	Если ВсеХорошо и Модифицированность ИЛИ Параметры.Ключ.Пустая() или НЕ Объект.Проведен Тогда
		Попытка
			ПараметрыЗаписи = Новый Структура;
			ПараметрыЗаписи.Вставить("РежимЗаписи", РежимЗаписиДокумента.Проведение);
			РезультатЗаписи = ЭтаФорма.Записать(ПараметрыЗаписи); 
			Если НЕ РезультатЗаписи Тогда
				ВсеХорошо = Ложь;
				СписокСообщений.Добавить("Не удалось записать и провести документ");
			КонецЕсли;			
		Исключение
			ВсеХорошо = Ложь;
			СписокСообщений.Добавить("Не удалось записать и провести текущий документ " + Символы.ПС + ОписаниеОшибки() );
		КонецПопытки;
	КонецЕсли;
	
	Если ВсеХорошо Тогда
		РезультатСоздания = _ДокументПрогнозированияМенеджер.СоздатьДокументПланированияИзГрафикаПоступлений(
																												Объект.Ссылка, 
																												УИДСтрокиГрафика
																												);
		
		ВсеХорошо 						= РезультатСоздания.ВсеХорошо;
		СсылкаНаДокументПланирования 	= РезультатСоздания.Результат;
		
		// НОВОЕ: Копируем сообщения
		Для Каждого Сообщение Из РезультатСоздания.СписокСообщений Цикл
			СписокСообщений.Добавить(Сообщение.Значение);
		КонецЦикла;
		
		// НОВОЕ: Если создан - обновляем строку графика
		Если ВсеХорошо И СсылкаНаДокументПланирования <> Неопределено Тогда
			Отбор = Новый Структура("УИДСтроки", УИДСтрокиГрафика);
			Найденные = мГрафикПоступлений.НайтиСтроки(Отбор);
			Если Найденные.Количество() > 0 Тогда
				Найденные[0].ДокументПланирования = СсылкаНаДокументПланирования; 
			КонецЕсли;
		КонецЕсли;			
		Модифицированность = Истина;
		ОбновитьГрафикИзОбъекта();	
	КонецЕсли;
	
	СтруктураРезультат.Вставить("ВсеХорошо", ВсеХорошо);
	СтруктураРезультат.Вставить("СписокСообщений", СписокСообщений); 
	СтруктураРезультат.Вставить("СсылкаНаДокументПланирования", СсылкаНаДокументПланирования); 
	
	Возврат СтруктураРезультат;
	
КонецФункции

&НаКлиенте
Процедура СоздатьДокументПланируемоеПоступлениеДС(Команда) 
	
	ПС = Символы.ПС;
	ТекущиеДанные = Элементы.мГрафикПоступлений.ТекущиеДанные; 
	УИДДляФокуса = ?(ТекущиеДанные <> Неопределено, ТекущиеДанные.УИДСтроки, Неопределено);

	Если ТекущиеДанные = Неопределено Тогда
		Сообщить("Выберите строку графика");
		Возврат;
	КонецЕсли; 
	
	Если Модифицированность ИЛИ Параметры.Ключ.Пустая() ИЛИ НЕ Объект.Проведен Тогда
		Ответ = Вопрос("Документ должен быть записан и проведен. Продолжить?", РежимДиалогаВопрос.ДаНет);
		Если  Ответ = КодВозвратаДиалога.Нет Тогда
			Возврат;
		Иначе
			ПараметрыЗаписи = Новый Структура;
			ПараметрыЗаписи.Вставить("РежимЗаписи", РежимЗаписиДокумента.Проведение);
			РезультатЗаписи = ЭтаФорма.Записать(ПараметрыЗаписи);
			Если НЕ РезультатЗаписи = Истина Тогда
				ВсеХорошо = Ложь;
				Сообщить("Не удалось записать текущий документ");
				Возврат;
			КонецЕсли;
			Если не объект.Проведен Тогда
				ВсеХорошо = Ложь;
				Сообщить("Не удалось провести текущий документ");
				Возврат;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;	
	
	ТекстВопроса= СтрШаблон("Будет создан документ Планируемое поступление для" + ПС + 
								ПС + 
								"строка %1," + ПС +
								"%2" + ПС + 
								"ЦФО: %3" + ПС +
								"Инициатор: %4" + ПС +
								"сумма %5" + ПС +
								ПС + 
								"Продолжить?",
								ТекущиеДанные.НомерСтрокиДляОтображения,
								Формат(ТекущиеДанные.Период, "ДФ=dd.MM.yyyy"),
								Объект.ДопУсловияПоДоговору.ПроектДоговора.ЦФО,
								Объект.ДопУсловияПоДоговору.ПроектДоговора.Инициатор,
								Формат(ТекущиеДанные.Сумма, "ЧДЦ=2")
								);
	Ответ = Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНет);
	Если  Ответ = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли;
	
	Результат = СоздатьДокументПланируемоеПоступлениеДСНаСервере(ТекущиеДанные.УИДСтроки); 
	
	Если Не Результат.ВсеХорошо Тогда
		Для каждого Сообщение Из Результат.СписокСообщений Цикл
			Сообщить(Сообщение);
		КонецЦикла;
		//Возврат;
	КонецЕсли;
	УстановитьЗаголовокФормыДокумента();
	
	Если УИДДляФокуса <> Неопределено Тогда
	    Для Каждого Строка Из мГрафикПоступлений Цикл  // Ищем в ОБНОВЛЕННОЙ таблице
	        Если Строка.УИДСтроки = УИДДляФокуса Тогда
	            Элементы.мГрафикПоступлений.ТекущаяСтрока = Строка.ПолучитьИдентификатор(); 
	            Прервать;
	        КонецЕсли;
	    КонецЦикла;
	КонецЕсли;	
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьТЧПоступления(Команда)

	// 1. Запоминаем текущую строку графика
	ТекущаяСтрока = Элементы.мГрафикПоступлений.ТекущиеДанные;
	УИДДляФокуса = ?(ТекущаяСтрока <> Неопределено, ТекущаяСтрока.УИДСтроки, Неопределено);
	
	// 2. Обновляем данные
	ЗаполнитьГрафикПоступленийНаСервере();
	
	// 3. Восстанавливаем фокус
	Если УИДДляФокуса <> Неопределено Тогда
		ВосстановитьФокусНаСтроке(УИДДляФокуса);
	КонецЕсли;

КонецПроцедуры

&НаСервере
Процедура РассчитатьИтогПоПлатежнымПоручениям()
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СУММА(платежноепоручениевходящее.СуммаДокумента) КАК Итого,
	|	КОЛИЧЕСТВО(платежноепоручениевходящее.Ссылка) КАК Количество
	|ИЗ
	|	Документ.ПлатежноеПоручениеВходящее КАК платежноепоручениевходящее
	|ГДЕ
	|	платежноепоручениевходящее.ПометкаУдаления = ЛОЖЬ
	|	И платежноепоручениевходящее.Дата >= ДАТАВРЕМЯ(2019, 1, 1)
	|	И платежноепоручениевходящее.ДоговорКонтрагента = &ДоговорКонтрагента
	|	И НЕ платежноепоручениевходящее.ДоговорКонтрагента = НЕОПРЕДЕЛЕНО
	|	И НЕ платежноепоручениевходящее.ДоговорКонтрагента = ЗНАЧЕНИЕ(справочник.ДоговорыКонтрагентов.ПустаяСсылка)
	|	И платежноепоручениевходящее.Проведен = ИСТИНА";
	
	Запрос.Параметры.Вставить("ДоговорКонтрагента", Объект.ДопУсловияПоДоговору.ДоговорКонтрагента); 
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		мФактПоступление = ВыборкаДетальныеЗаписи.Итого; 
		Если ВыборкаДетальныеЗаписи.Количество <> 0 Тогда
			НовыйЗаголовокГруппы = СтрШаблон("%1 (%2)", "Платежные поручения входящие", ВыборкаДетальныеЗаписи.Количество);
			Элементы.ГруппаПлатежныеПорученияВходящие.Заголовок = НовыйЗаголовокГруппы; 
		КонецЕсли;		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура мГрафикПоступленийДокументПланированияНачалоВыбораИзСписка(Элемент, СтандартнаяОбработка)
    
    ТекущаяСтрока = Элементы.мГрафикПоступлений.ТекущиеДанные;
    Если ТекущаяСтрока = Неопределено Тогда
        Возврат;
    КонецЕсли;
    
    Если ТекущаяСтрока.ДокументПланирования <> Неопределено Тогда
        // Открываем документ по ссылке
        ОткрытьЗначение(ТекущаяСтрока.ДокументПланирования);
        СтандартнаяОбработка = Ложь;
    КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура мГрафикПоступленийДокументПланированияНажатие(Элемент, СтандартнаяОбработка)
	
	ТекущаяСтрокаГрафика = Элементы.мГрафикПоступлений.ТекущиеДанные; 
	Если Элемент.ТекущийЭлемент.Имя = "мГрафикПоступленийДокументПланирования" Тогда
		ПоказатьЗначение(,ТекущаяСтрокаГрафика.ДокументПланирования);
		СтандартнаяОбработка = Ложь;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПересчитатьАгрегатыНаСервере()
	
	// 1. Пересчитать свободные платежки (через менеджер)
	ТЗКэшПП = РеквизитФормыВЗначение("мКэшПлатежныхПоручений");
	ТЗДетализацияГрафикаПоступлений = Объект.ДетализацияГрафикаПоступлений.Выгрузить();
	
	ТЗСвободные = _ДокументПрогнозированияМенеджер.ПолучитьСвободныеПлатежки(
																				ТЗКэшПП,          					// кэш всех платежек
																				ТЗДетализацияГрафикаПоступлений   	// текущие привязки
																				);
													
	ТЗСвободные.Сортировать("Дата Убыв");												
	
	мСвободныеПлатежки.Очистить();
	мСвободныеПлатежки.Загрузить(ТЗСвободные);
	
	// 2. Пересчитать график (Факт, Прогноз, СуммаПлатежа)
	Для Каждого СтрокаГрафика Из мГрафикПоступлений Цикл
		// Факт = сумма СуммаПогашено по этой строке графика
		СуммаФакт = 0;
		Для Каждого СтрокаДет Из Объект.ДетализацияГрафикаПоступлений Цикл
			Если СтрокаДет.УИДСтрокиГрафикаПоступлений = СтрокаГрафика.УИДСтроки Тогда
				СуммаФакт = СуммаФакт + СтрокаДет.СуммаПогашено;
			КонецЕсли;
		КонецЦикла;
		СтрокаГрафика.Факт = СуммаФакт;
		
		Если СтрокаГрафика.ДокументПланирования <> Неопределено Тогда
			// Если есть документ планирования - берем его сумму
			Если СтрокаГрафика.ДокументПланированияСумма > 0 Тогда
				БазоваяСумма = СтрокаГрафика.ДокументПланированияСумма;
			Иначе
				// На всякий случай, если сумма не заполнена
				БазоваяСумма = СтрокаГрафика.Сумма;
			КонецЕсли;
		Иначе
			// Нет документа планирования - берем сумму из графика
			БазоваяСумма = СтрокаГрафика.Сумма;
		КонецЕсли;

		СтрокаГрафика.Прогноз = БазоваяСумма - СтрокаГрафика.Факт;
		СтрокаГрафика.СуммаПлатежа = БазоваяСумма;
		
	КонецЦикла;
	
	
	// 3. Итоги в подвалах
	// 3.1 Итоги для мГрафикПоступлений
	ИтогСумма = 0;
	ИтогСуммаПлатежа = 0;
	ИтогПрогноз = 0;
	ИтогФакт = 0; 
	ИтогДокументПланированияСумма = 0;
	
	Для Каждого СтрокаГрафика Из мГрафикПоступлений Цикл
		ИтогСумма = ИтогСумма + СтрокаГрафика.Сумма;
		ИтогСуммаПлатежа = ИтогСуммаПлатежа + СтрокаГрафика.СуммаПлатежа;
		ИтогПрогноз = ИтогПрогноз + СтрокаГрафика.Прогноз;
		ИтогФакт = ИтогФакт + СтрокаГрафика.Факт; 
		ИтогДокументПланированияСумма = ИтогДокументПланированияСумма + СтрокаГрафика.ДокументПланированияСумма;
	КонецЦикла;
	
	// Устанавливаем итоги
	Элементы.мГрафикПоступленийСумма.ТекстПодвала = Формат(ИтогСумма, "ЧДЦ=2");
	Элементы.мГрафикПоступленийСуммаПлатежа.ТекстПодвала = Формат(ИтогСуммаПлатежа, "ЧДЦ=2");
	Элементы.мГрафикПоступленийПрогноз.ТекстПодвала = Формат(ИтогПрогноз, "ЧДЦ=2");
	Элементы.мГрафикПоступленийФакт.ТекстПодвала = Формат(ИтогФакт, "ЧДЦ=2");
	Элементы.мГрафикПоступленийДокументПланированияСумма.ТекстПодвала = Формат(ИтогДокументПланированияСумма, "ЧДЦ=2");
	
	// 3.2 Итоги для мСвободныеПлатежки
	ИтогСуммаДокумента = 0;
	ИтогСуммаПогашения = 0;
	ИтогСвободныйОстаток = 0;
	
	Для Каждого Строка Из мСвободныеПлатежки Цикл
		ИтогСуммаДокумента = ИтогСуммаДокумента + Строка.СуммаДокумента;
		ИтогСуммаПогашения = ИтогСуммаПогашения + Строка.СуммаПогашения;
		ИтогСвободныйОстаток = ИтогСвободныйОстаток + Строка.СвободныйОстаток;
	КонецЦикла;
	
	Элементы.мСвободныеПлатежкиСуммаДокумента.ТекстПодвала = Формат(ИтогСуммаДокумента, "ЧДЦ=2");
	Элементы.мСвободныеПлатежкиСуммаПогашения.ТекстПодвала = Формат(ИтогСуммаПогашения, "ЧДЦ=2");
	Элементы.мСвободныеПлатежкиСвободныйОстаток.ТекстПодвала = Формат(ИтогСвободныйОстаток, "ЧДЦ=2");
	
	// Итог по ППВходящееСуммаДокумента в детализации
	ИтогСуммаПогашено = 0;
	ИтогППВСуммаДокумента = 0; // НОВОЕ

	Для Каждого СтрокаДет Из мДетализацияГрафикаПоступлений Цикл
	    ИтогСуммаПогашено = ИтогСуммаПогашено + СтрокаДет.СуммаПогашено;
	    // НОВОЕ: Сумма документа ППВ
	    Если СтрокаДет.СуммаДокумента > 0 Тогда
	        ИтогППВСуммаДокумента = ИтогППВСуммаДокумента + СтрокаДет.СуммаДокумента;
	    КонецЕсли;
	КонецЦикла;

	Элементы.мДетализацияГрафикаПоступленийСуммаПогашено.ТекстПодвала = Формат(ИтогСуммаПогашено, "ЧДЦ=2");
	Элементы.мДетализацияГрафикаПоступленийСуммаДокумента.ТекстПодвала = Формат(ИтогППВСуммаДокумента, "ЧДЦ=2"); // НОВОЕ
		
	
КонецПроцедуры

&НаКлиенте
Процедура мДетализацияГрафикаПоступленийПриАктивизацииСтроки(Элемент)  
	
	ТекущаяСтрокаДетализации = Элементы.мДетализацияГрафикаПоступлений.ТекущиеДанные;
	Если ТекущаяСтрокаДетализации = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Платежка = ТекущаяСтрокаДетализации.ПлатежноеПоручениеВходящее;
	Если Платежка = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	// Ищем эту платежку в таблице свободных платежек
	Для i = 0 По мСвободныеПлатежки.Количество() - 1 Цикл
		Если мСвободныеПлатежки[i].ПлатежноеПоручениеВходящее = Платежка Тогда
			// Устанавливаем фокус
			Элементы.мСвободныеПлатежки.ТекущаяСтрока = мСвободныеПлатежки[i].ПолучитьИдентификатор();
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ВосстановитьФокусПоПозиции(ТЗ, ЭлементУправления, Позиция)
	
	Если Позиция = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	// Если позиция существует после обновления
	Если Позиция < ТЗ.Количество() Тогда
		СтрокаНаПозиции = ТЗ[Позиция];
		ЭлементУправления.ТекущаяСтрока = СтрокаНаПозиции.ПолучитьИдентификатор();
	ИначеЕсли ТЗ.Количество() > 0 Тогда
		// Иначе ставим на последнюю
		ЭлементУправления.ТекущаяСтрока = ТЗ[ТЗ.Количество() - 1].ПолучитьИдентификатор();
	КонецЕсли;
КонецПроцедуры

&НаСервере
Функция  СоздатьДокументыПланируемоеПоступлениеДСНаСервере()
	
    СтруктураРезультат = Новый Структура;
    СписокРезультатов = Новый Массив;
    Создано = 0;
    Ошибки = 0;
    ВсеХорошо = Истина;   
	
	ТЗ = РеквизитФормыВЗначение("мГрафикПоступлений");
	РезультатВалидации = _ДокументПрогнозированияМенеджер.ПроверитьЗаполнениеГрафикаПоступлений(ТЗ);
	Если Не РезультатВалидации.ВсеХорошо  Тогда
        СтруктураРезультат.Вставить("ВсеХорошо", Ложь);
	    СтруктураРезультат.Вставить("Сообщение", "Не удалось сохранить и провести текущий документ");
	    СтруктураРезультат.Вставить("СписокРезультатов", РезультатВалидации.СписокСообщений);
	    СтруктураРезультат.Вставить("Создано", 0);
	    СтруктураРезультат.Вставить("Ошибки", 1);
	    Возврат СтруктураРезультат;
	КонецЕсли;
    
    // 0. ПРОВЕРЯЕМ ПРОВЕДЕНИЕ ОСНОВНОГО ДОКУМЕНТА
    Если НЕ Объект.Проведен ИЛИ Модифицированность Тогда
        Попытка
            ПараметрыЗаписи = Новый Структура;
            ПараметрыЗаписи.Вставить("РежимЗаписи", РежимЗаписиДокумента.Проведение);
            РезультатЗаписи = ЭтаФорма.Записать(ПараметрыЗаписи);
            
            Если НЕ РезультатЗаписи Тогда
                СтруктураРезультат.Вставить("ВсеХорошо", Ложь);
                СтруктураРезультат.Вставить("Сообщение", "Не удалось записать и провести текущий документ");
                СтруктураРезультат.Вставить("СписокРезультатов", СписокРезультатов);
                Возврат СтруктураРезультат;
            КонецЕсли;
            
            Если НЕ Объект.Проведен Тогда
                СтруктураРезультат.Вставить("ВсеХорошо", Ложь);
                СтруктураРезультат.Вставить("Сообщение", "Документ не проведен после записи");
                СтруктураРезультат.Вставить("СписокРезультатов", СписокРезультатов);
                Возврат СтруктураРезультат;
            КонецЕсли;
            
        Исключение
            СтруктураРезультат.Вставить("ВсеХорошо", Ложь);
            СтруктураРезультат.Вставить("Сообщение", "Ошибка при записи документа: " + ОписаниеОшибки());
            СтруктураРезультат.Вставить("СписокРезультатов", СписокРезультатов);
            Возврат СтруктураРезультат;
        КонецПопытки;
    КонецЕсли;
    
    // 1. Создаем документы
    Для Каждого СтрокаГрафика Из мГрафикПоступлений Цикл
        Если НЕ СтрокаГрафика.ПакетнаяОбработка Тогда
            Продолжить;
        КонецЕсли;
        
        Если ЗначениеЗаполнено(СтрокаГрафика.ДокументПланирования) Тогда
            Продолжить;
        КонецЕсли;
        
        Попытка
            Результат = _ДокументПрогнозированияМенеджер.СоздатьДокументПланированияИзГрафикаПоступлений(
                Объект.Ссылка,
                СтрокаГрафика.УИДСтроки
            );
            
            Если Результат.ВсеХорошо Тогда
                Создано = Создано + 1;
                СписокРезультатов.Добавить("Строка " + СтрокаГрафика.НомерСтрокиДляОтображения + 
                                          ": создан документ " + Результат.Результат);
            Иначе
                Ошибки = Ошибки + 1;
                ВсеХорошо = Ложь;
                Для Каждого Сообщение Из Результат.СписокСообщений Цикл
                    СписокРезультатов.Добавить("Строка " + СтрокаГрафика.НомерСтрокиДляОтображения + 
                                              ": " + Сообщение.Значение);
                КонецЦикла;
            КонецЕсли;
            
        Исключение
            Ошибки = Ошибки + 1;
            ВсеХорошо = Ложь;
            СписокРезультатов.Добавить("Строка " + СтрокаГрафика.НомерСтрокиДляОтображения + 
                                      ": ошибка " + ОписаниеОшибки());
        КонецПопытки;
        
    КонецЦикла;
    
    // 2. Обновляем график
    ОбновитьГрафикИзОбъекта();
    ПересчитатьАгрегатыНаСервере();
    
    // 3. Формируем итоговое сообщение
    ИтоговоеСообщение = "Создано документов: " + Создано + 
                       ", ошибок: " + Ошибки;
    
    СтруктураРезультат.Вставить("ВсеХорошо", ВсеХорошо);
    СтруктураРезультат.Вставить("Сообщение", ИтоговоеСообщение);
    СтруктураРезультат.Вставить("СписокРезультатов", СписокРезультатов);
    СтруктураРезультат.Вставить("Создано", Создано);
    СтруктураРезультат.Вставить("Ошибки", Ошибки);
    
    Возврат СтруктураРезультат; 	
	
КонецФункции

&НаКлиенте
Процедура СоздатьДокументыПланируемоеПоступлениеДС(Команда) 
	
	ТекущаяСтрока = Элементы.мГрафикПоступлений.ТекущиеДанные;
	УИДДляФокуса = ?(ТекущаяСтрока <> Неопределено, ТекущаяСтрока.УИДСтроки, Неопределено);

	
 	// 1. Считаем сколько нужно создать
    КоличествоДляОбработки = 0;
    Для Каждого Строка Из мГрафикПоступлений Цикл
        Если Строка.ПакетнаяОбработка 
            И НЕ ЗначениеЗаполнено(Строка.ДокументПланирования) Тогда
            КоличествоДляОбработки = КоличествоДляОбработки + 1;
        КонецЕсли;
    КонецЦикла;
    
    Если КоличествоДляОбработки = 0 Тогда
        Сообщить("Нет строк для создания документов планирования");
        Возврат;
    КонецЕсли;
    
    // 2. Сообщение о необходимости проведения
    Если НЕ Объект.Проведен ИЛИ Модифицированность Тогда
        ТекстСообщения = 
        "Для создания документов планирования необходимо:" + Символы.ПС +
        "сохранить и провести текущий документ" + Символы.ПС +
        Символы.ПС +
        "Продолжить?";
	КонецЕсли;
	
    Ответ = Вопрос(ТекстСообщения, РежимДиалогаВопрос.ДаНет);
    Если Ответ = КодВозвратаДиалога.Нет Тогда
        Возврат;
    КонецЕсли;	
    
    ТекстСообщения = 
    "Будет создано " + КоличествоДляОбработки + 
    " документов планирования. Продолжить?";
    
    Ответ = Вопрос(ТекстСообщения, РежимДиалогаВопрос.ДаНет);
    Если Ответ = КодВозвратаДиалога.Нет Тогда
        Возврат;
    КонецЕсли;	
    
    // Вызываем сервер
    Результат = СоздатьДокументыПланируемоеПоступлениеДСНаСервере();
    
    // Показываем результат
    Если НЕ Результат.ВсеХорошо ИЛИ Результат.Ошибки > 0 Тогда
        ТекстСообщения = Результат.Сообщение;
        Если Результат.СписокРезультатов.Количество() > 0 Тогда
            ТекстСообщения = ТекстСообщения + Символы.ПС + Символы.ПС + 
                            СтрСоединить(Результат.СписокРезультатов, Символы.ПС);
        КонецЕсли;
        Сообщить(ТекстСообщения, СтатусСообщения.Внимание);
    Иначе
        Сообщить(Результат.Сообщение, СтатусСообщения.Информация);
	КонецЕсли;
	УстановитьЗаголовокФормыДокумента();
	
	Если УИДДляФокуса <> Неопределено Тогда
	    Для Каждого Строка Из мГрафикПоступлений Цикл  // Ищем в ОБНОВЛЕННОЙ таблице
	        Если Строка.УИДСтроки = УИДДляФокуса Тогда
	            Элементы.мГрафикПоступлений.ТекущаяСтрока = Строка.ПолучитьИдентификатор();
	            Прервать;
	        КонецЕсли;
	    КонецЦикла;
	КонецЕсли;	
	
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаСвободныеПлатежиУстановитьПериод(Команда)

	бит_РаботаСДиалогамиКлиент.НастроитьПериодПоДатам(мСвободныеПлатежкиДатаС, мСвободныеПлатежкиДатаПо);
    КомандаПрименитьФильтрДатПриКешированииПлатежекНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура КомандаПрименитьФильтрДатПриКешированииПлатежек(Команда)
	КомандаПрименитьФильтрДатПриКешированииПлатежекНаСервере();
КонецПроцедуры

&НаСервере
Процедура КомандаПрименитьФильтрДатПриКешированииПлатежекНаСервере()

    ТЗ = _ДокументПрогнозированияМенеджер.ПолучитьВсеПлатежныеПорученияПоДоговору(Объект, мСвободныеПлатежкиДатаС, мСвободныеПлатежкиДатаПо);
    
    мКэшПлатежныхПоручений.Очистить();
    мКэшПлатежныхПоручений.Загрузить(ТЗ); 
	
    // 2. Пересчитываем свободные платежки
    ЗагрузитьСвободныеПлатежки();
	ПересчитатьАгрегатыНаСервере();

КонецПроцедуры

&НаКлиенте
Процедура мСвободныеПлатежкиДатаСПриИзменении(Элемент)
	 КомандаПрименитьФильтрДатПриКешированииПлатежекНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура мСвободныеПлатежкиДатаПоПриИзменении(Элемент)
	 КомандаПрименитьФильтрДатПриКешированииПлатежекНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура мСвободныеПлатежкиВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
    СтандартнаяОбработка = Ложь; 
    КомандаПривязатьПлатежноеПоручениеКПлануПоступлений(Неопределено);	
	
	
КонецПроцедуры

&НаКлиенте
Процедура мДетализацияГрафикаПоступленийВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	Если Не Элементы.мДетализацияГрафикаПоступлений.ТекущийЭлемент = элементы.мДетализацияГрафикаПоступленийСуммаПогашено Тогда
		СтандартнаяОбработка = Ложь; 
	    КомандаОтвязатьПлатежноеПоручениеОтПланаПоступлений(Неопределено);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти //ГрафикиПоступлений

#Область ГрафикПлатежейБездоговорнаяСхема

&НаСервере
Процедура ЗаполнитьГрафикПлатежейБНаСервере()
	
	// 1. Получаем данные из менеджера 
	нГрафикПлатежей.Очистить();
	ТЗ = нГрафикПлатежей.Выгрузить();
	ДанныеГрафика = _ДокументПрогнозированияМенеджер.ПолучитьГрафикПлатежейБДляФормы(Объект, ТЗ); 
	
	//// 2. Загружаем в реквизит формы (ТаблицаЗначений)
	нГрафикПлатежей.Очистить();
	нГрафикПлатежей.Загрузить(ДанныеГрафика);  
	
	Элементы.нГрафикПлатежейНомерСтрокиДляОтображения.ТекстПодвала 	= ДанныеГрафика.Количество(); 
	
	Элементы.нГрафикПлатежейСумма.ТекстПодвала 						= Формат(ДанныеГрафика.Итог("Сумма"), "ЧДЦ=2"); 
	Элементы.нГрафикПлатежейДокументПланированияСумма.ТекстПодвала 	= Формат(ДанныеГрафика.Итог("ДокументПланированияСумма"), "ЧДЦ=2"); 
	Элементы.нГрафикПлатежейСуммаПлатежа.ТекстПодвала 				= Формат(ДанныеГрафика.Итог("СуммаПлатежа"), "ЧДЦ=2"); 
	Элементы.нГрафикПлатежейПрогноз.ТекстПодвала 					= Формат(ДанныеГрафика.Итог("Прогноз"), "ЧДЦ=2"); 
	Элементы.нГрафикПлатежейФакт.ТекстПодвала 						= Формат(ДанныеГрафика.Итог("Факт"), "ЧДЦ=2"); 
	
	ПересчитатьШапкуГрафикаПлатежейБ(ДанныеГрафика);
	
КонецПроцедуры

&НаСервере
Процедура ПересчитатьШапкуГрафикаПлатежейБ(ДанныеГрафика)

	нСуммаПоГрафику = ДанныеГрафика.Итог("Сумма");
	нСуммаПоБюджету = _ДокументПрогнозированияМенеджер.ПолучитьСуммуПоБюджетуПлатежейБ(Объект);
	нСуммаПрогноз  = ДанныеГрафика.Итог("Прогноз");
	нСуммаФакт	= ДанныеГрафика.Итог("Факт");
	нИтогоОплата = нСуммаПрогноз + нСуммаФакт;
	нОстатокПоБюджету = нСуммаПоБюджету - нИтогоОплата;

КонецПроцедуры


&НаКлиенте
Процедура нГрафикПлатежейПриИзменении(Элемент)
	
	Если Элемент.ТекущийЭлемент.Имя = "нГрафикПлатежейПакетнаяОбработка" Тогда
		Возврат;
	КонецЕсли;

	Модифицированность = Истина;
    ТекущаяСтрока = Элемент.ТекущиеДанные;
    Если ТекущаяСтрока = Неопределено Тогда
        Возврат;
    КонецЕсли; 
    
    // ЗАПОМИНАЕМ текущую строку
    УИДТекущейСтроки = ТекущаяСтрока.УИДСтроки;
    
    ОбновитьСтроку_ГрафикаПлатежейБНаСервере(УИДТекущейСтроки);
    
	//// Перезагружаем график
	ЗаполнитьГрафикПлатежейБНаСервере();
    
    // ВОССТАНАВЛИВАЕМ фокус
    ВосстановитьФокусНаСтрокеГрафикПлатежейБ(УИДТекущейСтроки);

КонецПроцедуры 

&НаСервере
Процедура ОбновитьСтроку_ГрафикаПлатежейБНаСервере(УИДСтроки)
	
	ТТЗ = РеквизитФормыВЗначение("нГрафикПлатежей");	
	_ДокументПрогнозированияМенеджер.ОбновитьСтрокуГрафикаПлатежейНаСервере(Объект, УИДСтроки, ТТЗ);	
	
КонецПроцедуры

&НаКлиенте
Процедура ВосстановитьФокусНаСтрокеГрафикПлатежейБ(УИДСтроки)
    
    // Ищем строку с этим УИД в обновленной таблице
    Для Каждого Строка Из нГрафикПлатежей Цикл
        Если Строка.УИДСтроки = УИДСтроки Тогда
            Элементы.нГрафикПлатежей.ТекущаяСтрока = Строка.ПолучитьИдентификатор();
            Прервать;
        КонецЕсли;
    КонецЦикла;
    
КонецПроцедуры 

&НаСервере
Процедура ПересчитатьАгрегатыГрафикПлатежейБНаСервере()

КонецПроцедуры

&НаКлиенте
Процедура ОбновитьТЧПлатежиБ(Команда)

	// 1. Запоминаем текущую строку графика
	ТекущаяСтрока = Элементы.нГрафикПлатежей.ТекущиеДанные;
	УИДДляФокуса = ?(ТекущаяСтрока <> Неопределено, ТекущаяСтрока.УИДСтроки, Неопределено);
	
	// 2. Обновляем данные
	ЗаполнитьГрафикПлатежейБНаСервере();
	
	// 3. Восстанавливаем фокус
	Если УИДДляФокуса <> Неопределено Тогда
		ВосстановитьФокусНаСтрокеГрафикПлатежейБ(УИДДляФокуса);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура нГрафикПлатежейПриАктивизацииСтроки(Элемент)

	ТекущаяСтрокаГрафика = Элементы.нГрафикПлатежей.ТекущиеДанные; 
	Если НЕ ТекущаяСтрокаГрафика = Неопределено Тогда
		
		ЗагрузитьДетализациюГрафикаПлатежейНаСервере(ТекущаяСтрокаГрафика.ДокументПланирования);
		
		Элементы.нГрафикПлатежейДокументПланирования.СписокВыбора.Очистить();
		Элементы.нГрафикПлатежейДокументПланирования.СписокВыбора.Добавить(ТекущаяСтрокаГрафика.ДокументПланирования);
		
	КонецЕсли;
	//ПересчитатьАгрегатыНаСервере();
	
	
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьДетализациюГрафикаПлатежейНаСервере(ДокументПланирования)
	
	// 1. Получаем данные из менеджера 
	нДетализацияГрафикаПлатежей.Очистить();
	ТЗ = нДетализацияГрафикаПлатежей.Выгрузить();
	ДанныеДетализации = _ДокументПрогнозированияМенеджер.ПолучитьДанныеЗНРДСДляГрафикаПлатежейБДляФормы(Объект, ДокументПланирования, ТЗ); 
	
	//// 2. Загружаем в реквизит формы (ТаблицаЗначений)
	нДетализацияГрафикаПлатежей.Очистить();                   
	нДетализацияГрафикаПлатежей.Загрузить(ДанныеДетализации);	

	Элементы.нДетализацияГрафикаПлатежейЗаявкаНаРасходованиеДССумма.ТекстПодвала 	= Формат(ДанныеДетализации.Итог("ЗаявкаНаРасходованиеДССумма"), "ЧДЦ=2"); 
	Элементы.нДетализацияГрафикаПлатежейЗаявкаНаРасходованиеДСПрогноз.ТекстПодвала 	= Формат(ДанныеДетализации.Итог("ЗаявкаНаРасходованиеДСПрогноз"), "ЧДЦ=2"); 
	Элементы.нДетализацияГрафикаПлатежейЗаявкаНаРасходованиеДСФакт.ТекстПодвала 	= Формат(ДанныеДетализации.Итог("ЗаявкаНаРасходованиеДСФакт"), "ЧДЦ=2"); 

КонецПроцедуры 

 &НаКлиенте
Процедура нГрафикПлатежейПередНачаломИзменения(Элемент, Отказ)
	
	ТекущаяСтрокаГрафика = Элементы.нГрафикПлатежей.ТекущиеДанные;

	Если Элемент.ТекущийЭлемент.Имя = "нГрафикПлатежейДокументПланирования" Тогда
		ПоказатьЗначение(,ТекущаяСтрокаГрафика.ДокументПланирования);
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	
	Если НЕ ТекущаяСтрокаГрафика = Неопределено Тогда
		// Если есть документ планирования — запрещаем редактирование
		Если 
			ЗначениеЗаполнено(ТекущаяСтрокаГрафика.ДокументПланирования) 
			или 
			ТекущаяСтрокаГрафика.Период < НачалоДня(ТекущаяДата())
			//и ТекущаяСтрокаГрафика.ДокументПланирования.Проведен 
		Тогда
			//Сообщить("Редактирование запрещено: по строке создан документ планирования " + 
			//         ТекущаяСтрокаГрафика.ДокументПланирования);
	        Отказ = Истина;
	        Возврат;
		КонецЕсли;	

		ПлатежиБЦФОЗаполнитьСписокВыбора();
		ПлатежиБМероприятияЗаполнитьСписокВыбора();
		ГрафикПлатежейБЗаполнитьСтатьиДДСДляВыбора(); 
		
	КонецЕсли;	
	
КонецПроцедуры

&НаСервере
Функция ГрафикПоступленийПолучитьСтатьиДДСДляВыбораБездоговорнаяНаСервере()
    
    Возврат _ДокументПрогнозированияМенеджер.ПолучитьСтатьиБДДСДляВыбораБездоговорная(Объект);
    
КонецФункции


&НаКлиенте
Процедура ПлатежиБЦФОЗаполнитьСписокВыбора()
	
	СтрокаТЧ =	Элементы.нГрафикПлатежей.ТекущиеДанные;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.ЦФО КАК ЦФО
	|ИЗ
	|	Документ.бит_ДополнительныеУсловияПоДоговору.ГрафикНачислений КАК бит_ДополнительныеУсловияПоДоговоруГрафикНачислений
	|ГДЕ
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.Ссылка = &Ссылка и  не бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.ЦФО = Неопределено
	|
	|СГРУППИРОВАТЬ ПО
	|	бит_ДополнительныеУсловияПоДоговоруГрафикНачислений.ЦФО";
	
	Запрос.УстановитьПараметр("Ссылка", объект.ДопУсловияПоДоговору); 
	РезультатЗапроса = Запрос.Выполнить();
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	Элементы.нГрафикПлатежейЦФО.СписокВыбора.Очистить();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Элементы.нГрафикПлатежейЦФО.СписокВыбора.Добавить(ВыборкаДетальныеЗаписи.ЦФО);
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ПлатежиБМероприятияЗаполнитьСписокВыбора()
	
    Результат = ГрафикПоступленийПолучитьМероприятияНаСервере();

	Элементы.нГрафикПлатежейМероприятиеПКВ.СписокВыбора.Очистить();
    
    // Показываем сообщения, если есть
    Если НЕ Результат.ВсеХорошо Тогда
        Для Каждого Сообщение Из Результат.СписокСообщений Цикл
            Сообщить(Сообщение.Значение);
        КонецЦикла;
    КонецЕсли;
    
    // Заполняем список выбора
    Если Результат.СписокВыбора.Количество() > 0 Тогда
        Для Каждого Статья Из Результат.СписокВыбора Цикл
            Элементы.нГрафикПлатежейМероприятиеПКВ.СписокВыбора.Добавить(Статья.Значение);
        КонецЦикла;
    КонецЕсли;
    

	
КонецПроцедуры

&НаКлиенте
Процедура ГрафикПлатежейБЗаполнитьСтатьиДДСДляВыбора()
    
    Результат = ГрафикПоступленийПолучитьСтатьиДДСДляВыбораБездоговорнаяНаСервере();
    
    // Очищаем список
    Элементы.нГрафикПлатежейСтатьяОборотовБДДС.СписокВыбора.Очистить();
    
    // Показываем сообщения, если есть
    Если НЕ Результат.ВсеХорошо Тогда
        Для Каждого Сообщение Из Результат.СписокСообщений Цикл
            Сообщить(Сообщение.Значение);
        КонецЦикла;
    КонецЕсли;
    
    // Заполняем список выбора
    Если Результат.СписокВыбора.Количество() > 0 Тогда
        Для Каждого Статья Из Результат.СписокВыбора Цикл
            Элементы.нГрафикПлатежейСтатьяОборотовБДДС.СписокВыбора.Добавить(Статья.Значение);
        КонецЦикла;
    КонецЕсли;
    
КонецПроцедуры

&НаКлиенте
Процедура нДетализацияГрафикаПлатежейПередНачаломИзменения(Элемент, Отказ)
	
	СтрокаТЧ = Элементы.нДетализацияГрафикаПлатежей.ТекущиеДанные;

	Если Элемент.ТекущийЭлемент.Имя = "нДетализацияГрафикаПлатежейЗаявкаНаРасходованиеДС" Тогда
		ПоказатьЗначение(,СтрокаТЧ.ЗаявкаНаРасходованиеДС);
		Отказ = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура нГрафикПлатежейПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	
	Отказ = Истина;  
	СтрокаТЧ = Элементы.нГрафикПлатежей.ТекущиеДанные; 

	Если Копирование Тогда 
	    ТекущаяСтрока = Элементы.нГрафикПлатежей.ТекущиеДанные;
	    Если ТекущаяСтрока = Неопределено Тогда
	        Сообщить("Выберите строку для копирования");
	        Возврат;
	    КонецЕсли;		
		
		УИДНовойСтроки = СкопироватьСтрокуГрафикаПлатежейБНаСервере(ТекущаяСтрока.УИДСтроки);
	Иначе
		УИДНовойСтроки = СоздатьСтрокуГрафикаПлатежейБНаСервере();  
	КонецЕсли; 
	
    ВосстановитьФокусНаСтрокеГрафикПлатежейБ(УИДНовойСтроки);

КонецПроцедуры

&НаСервере
Функция СкопироватьСтрокуГрафикаПлатежейБНаСервере(УИДДляКопирования)
    
    Модифицированность = Истина; 
    
    УИДКопии = _ДокументПрогнозированияМенеджер.СкопироватьСтрокуГрафикаПлатежей(
																			        Объект, 
																			        УИДДляКопирования
																			  		);   
	
	ЗаполнитьГрафикПлатежейБНаСервере();
	
    Возврат УИДКопии;
    
КонецФункции

&НаСервере
Функция СоздатьСтрокуГрафикаПлатежейБНаСервере()
	
	// 1. Создаём строку в объекте
	УИДНовойСтроки = _ДокументПрогнозированияМенеджер.СоздатьСтрокуГрафикаПлатежей(Объект);

	Модифицированность = Истина;
	
	// 2. Обновляем ВЕСЬ график из объекта (просто и надёжно)
	ЗаполнитьГрафикПлатежейБНаСервере();
 	
	// 3. Возвращаем УИД для выделения
	Возврат УИДНовойСтроки;
	
КонецФункции

&НаКлиенте
Процедура нГрафикПлатежейПередУдалением(Элемент, Отказ)
	
	Отказ = Истина;
    
    ТекущаяСтрока = Элементы.нГрафикПлатежей.ТекущиеДанные;
    Если ТекущаяСтрока = Неопределено Тогда
        Возврат;
	КонецЕсли; 
	
	// Проверяем документ планирования
	Если ЗначениеЗаполнено(ТекущаяСтрока.ДокументПланирования) Тогда
	    Сообщить("Удаление запрещено: по строке создан документ планирования " + 
	             ТекущаяСтрока.ДокументПланирования);
	    Возврат;
	КонецЕсли;	
	    
    // 1. ЗАПОМИНАЕМ ПОЗИЦИЮ в таблице (индекс строки)
    ПозицияВТаблице = Неопределено;
    Для i = 0 По нГрафикПлатежей.Количество() - 1 Цикл
        Если нГрафикПлатежей[i].УИДСтроки = ТекущаяСтрока.УИДСтроки Тогда
            ПозицияВТаблице = i; // Номер строки сверху (0, 1, 2...)
            Прервать;
        КонецЕсли;
    КонецЦикла;
    
    // 2. УДАЛЯЕМ
    УдалитьСтрокуГрафикаПлатежейБНаСервере(ТекущаяСтрока.УИДСтроки);
    
    // 3. ВОССТАНАВЛИВАЕМ ФОКУС НА ТОЙ ЖЕ ПОЗИЦИИ
    Если ПозицияВТаблице <> Неопределено Тогда
        // Ждём обновления таблицы
        // ОбновитьГрафикИзОбъекта() уже вызвался в УдалитьСтрокуГрафикаНаСервере()
        
        Если нГрафикПлатежей.Количество() = 0 Тогда
            // Если строк не осталось
            
            Возврат;
        КонецЕсли;
        
        // Выбираем строку на ТОЙ ЖЕ ПОЗИЦИИ
        // Если позиция больше, чем строк осталось — берём последнюю
        НоваяПозиция = ?(ПозицияВТаблице < нГрафикПлатежей.Количество(),
                         ПозицияВТаблице,
                         нГрафикПлатежей.Количество() - 1);
        
        // Ищем строку по позиции и ставим фокус
        Если НоваяПозиция < нГрафикПлатежей.Количество() Тогда
            СтрокаНаПозиции = нГрафикПлатежей[НоваяПозиция];
            Элементы.нГрафикПлатежей.ТекущаяСтрока = СтрокаНаПозиции.ПолучитьИдентификатор();
        КонецЕсли;
    КонецЕсли;
	

КонецПроцедуры

&НаСервере
Функция УдалитьСтрокуГрафикаПлатежейБНаСервере(УИДДляУдаления)
	
	_ДокументПрогнозированияМенеджер.УдалитьСтрокуГрафикаПлатежей(Объект, УИДДляУдаления);
	Модифицированность = Истина;	
	ЗаполнитьГрафикПлатежейБНаСервере();
	Возврат Истина;
	
КонецФункции

&НаКлиенте
Процедура нДетализацияГрафикаПлатежейПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	Отказ = Истина;
КонецПроцедуры

&НаКлиенте
Процедура нДетализацияГрафикаПлатежейПередУдалением(Элемент, Отказ)
	Отказ = Истина;
КонецПроцедуры

&НаКлиенте
Процедура СоздатьДокументПрогнозПлатежаБ(Команда)

	
	ВсеХорошо = Истина;
	ПС = Символы.ПС;
	
	СтрокаТЧ 	= Элементы.нГрафикПлатежей.ТекущиеДанные;
	ТекущийУИД 	= СтрокаТЧ.УИДСтроки;
	
	Если СтрокаТЧ = Неопределено Тогда
		Возврат;
	КонецЕсли; 	
	
	Если ЗначениеЗаполнено(СтрокаТЧ.ДокументПланирования) Тогда
		Предупреждение("Прогноз платежа для этой строки уже создан");
		//Открыть(СтрокаТЧ.ДокументПланирования.Ссылка);
		Возврат;
	КонецЕсли; 
	
	Если НЕ ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору) Тогда
		Предупреждение("Не заполнена ссылка на Дополнительные условия по договору");
		//Открыть(СтрокаТЧ.ДокументПланирования.Ссылка);
		Возврат;
	КонецЕсли; 
	
	Если НЕ ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору.ПроектДоговора) Тогда
		Предупреждение("В доп. условиях по договору не заполнена ссылка на Проект договора");
		//Открыть(СтрокаТЧ.ДокументПланирования.Ссылка);
		Возврат;
	КонецЕсли; 
	
	Если НЕ ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору.ПроектДоговора.Инициатор) Тогда
		Предупреждение("В проекте договора не заполнен Инициатор");
		//Открыть(СтрокаТЧ.ДокументПланирования.Ссылка);
		Возврат;
	КонецЕсли; 
	
	Если Модифицированность или не объект.Проведен Тогда
		Ответ = Вопрос("Документ должен быть записан и проведен. Продолжить?", РежимДиалогаВопрос.ДаНет);
		Если  Ответ = КодВозвратаДиалога.Нет Тогда
			Возврат;
		Иначе
			ПараметрыЗаписи = Новый Структура;
			ПараметрыЗаписи.Вставить("РежимЗаписи", РежимЗаписиДокумента.Проведение);
			РезультатЗаписи = ЭтаФорма.Записать(ПараметрыЗаписи);
			Если НЕ РезультатЗаписи = Истина Тогда
				ВсеХорошо = Ложь;
				Сообщить("Не удалось записать текущий документ");
				Возврат;
			КонецЕсли;
			Если не объект.Проведен Тогда
				ВсеХорошо = Ложь;
				Сообщить("Не удалось провести текущий документ");
				Возврат;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Если НЕ ВсеХорошо Тогда
		Возврат;
	КонецЕсли; 
	
	УстановитьЗаголовокФормыДокумента();
	
	ТекстВопроса = СтрШаблон("Будет создан прогноз платежа для" + ПС + 
							ПС + 
							"строка %1," + ПС +
							"%2" + ПС + 
							"%3" + ПС +
							"сумма %4" + ПС +
							ПС + 
							"Продолжить?",
							СтрокаТЧ.НомерСтрокиДляОтображения,
							Формат(СтрокаТЧ.Период, "ДФ=dd.MM.yyyy"),
							СтрокаТЧ.ЦФО,
							Формат(СтрокаТЧ.Сумма, "ЧДЦ=2")
							);
	Ответ = Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНет);
	
	Если  Ответ = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли;
	
	Результат = СоздатьДокументПрогнозПлатежаБНаСервере(ТекущийУИД);  

	Если Не Результат.ВсеХорошо Тогда
		Для каждого Сообщение Из Результат.СписокСообщений Цикл
			Сообщить(Сообщение);
		КонецЦикла;
		//Возврат;
	КонецЕсли;
	
	// 3. Восстанавливаем фокус
	Если ТекущийУИД <> Неопределено Тогда
		
		ВосстановитьФокусНаСтрокеГрафикПлатежейБ(ТекущийУИД);
	КонецЕсли;	
	
КонецПроцедуры

&НаСервере
Функция СоздатьДокументПрогнозПлатежаБНаСервере(УИДСтроки)

	СтруктураРезультат = новый Структура;
	СписокСообщений = Новый СписокЗначений; 
	СсылкаНаДокументПланирования = Неопределено;
	
	ВсеХорошо = Истина; 
	
	// 1. Всегда записываем (если модифицирован или новый)
	Если ВсеХорошо и Модифицированность ИЛИ Параметры.Ключ.Пустая() или НЕ Объект.Проведен Тогда
		Попытка
			ПараметрыЗаписи = Новый Структура;
			ПараметрыЗаписи.Вставить("РежимЗаписи", РежимЗаписиДокумента.Проведение);
			РезультатЗаписи = ЭтаФорма.Записать(ПараметрыЗаписи); 
			Если НЕ РезультатЗаписи Тогда
				ВсеХорошо = Ложь;
				СписокСообщений.Добавить("Не удалось записать и провести документ");
			КонецЕсли;			
		Исключение
			ВсеХорошо = Ложь;
			СписокСообщений.Добавить("Не удалось записать и провести текущий документ " + Символы.ПС + ОписаниеОшибки() );
		КонецПопытки;
	КонецЕсли;
	
	Если ВсеХорошо Тогда
		РезультатСоздания = _ДокументПрогнозированияМенеджер.СоздатьДокументПланированияИзГрафикаПлатежей(
																												Объект.Ссылка, 
																												УИДСтроки
																												);
		
		ВсеХорошо 						= РезультатСоздания.ВсеХорошо;
		СсылкаНаДокументПланирования 	= РезультатСоздания.Результат;
		
		// НОВОЕ: Копируем сообщения
		Для Каждого Сообщение Из РезультатСоздания.СписокСообщений Цикл
			СписокСообщений.Добавить(Сообщение.Значение);
		КонецЦикла;
		
		// НОВОЕ: Если создан - обновляем строку графика
		Если ВсеХорошо И СсылкаНаДокументПланирования <> Неопределено Тогда
			Отбор = Новый Структура("УИДСтроки", УИДСтроки);
			Найденные = нГрафикПлатежей.НайтиСтроки(Отбор);
			Если Найденные.Количество() > 0 Тогда
				Найденные[0].ДокументПланирования = СсылкаНаДокументПланирования; 
			КонецЕсли;
		КонецЕсли;			
		Модифицированность = Истина;
		
		ЗаполнитьГрафикПлатежейБНаСервере();	
		
	КонецЕсли;
	
	СтруктураРезультат.Вставить("ВсеХорошо", ВсеХорошо);
	СтруктураРезультат.Вставить("СписокСообщений", СписокСообщений); 
	СтруктураРезультат.Вставить("СсылкаНаДокументПланирования", СсылкаНаДокументПланирования); 
	
	Возврат СтруктураРезультат;
	
	
КонецФункции

&НаКлиенте
Процедура СоздатьДокументыПрогнозПлатежаБ(Команда)
	
	ВсеХорошо = Истина;
	ПС = Символы.ПС; 
	
	
	Если НЕ ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору) Тогда
		Предупреждение("Не заполнена ссылка на Дополнительные условия по договору");
		//Открыть(СтрокаТЧ.ДокументПланирования.Ссылка);
		Возврат;
	КонецЕсли; 
	
	
	Если НЕ ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору.ПроектДоговора) Тогда
		Предупреждение("В доп. условиях по договору не заполнена ссылка на Проект договора");
		//Открыть(СтрокаТЧ.ДокументПланирования.Ссылка);
		Возврат;
	КонецЕсли; 
	
	Если НЕ ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору.ПроектДоговора.Инициатор) Тогда
		Предупреждение("В проекте договора не заполнен Инициатор");
		//Открыть(СтрокаТЧ.ДокументПланирования.Ссылка);
		Возврат;
	КонецЕсли; 
	
	
	МассивСтрок = новый Массив;
	Для каждого Строка Из нГрафикПлатежей Цикл
		Если Строка.ПакетнаяОбработка и не ЗначениеЗаполнено(Строка.ДокументПланирования) Тогда
			МассивСтрок.Добавить(Строка);
		КонецЕсли;
	КонецЦикла; 
	
	Если МассивСтрок.Количество()=0 Тогда
		Возврат;
	КонецЕсли; 	
	
	Если Модифицированность или не объект.Проведен Тогда
		Ответ = Вопрос("Документ должен быть записан и проведен. Продолжить?", РежимДиалогаВопрос.ДаНет);
		Если  Ответ = КодВозвратаДиалога.Нет Тогда
			Возврат;
		Иначе
			ПараметрыЗаписи = Новый Структура;
			ПараметрыЗаписи.Вставить("РежимЗаписи", РежимЗаписиДокумента.Проведение);
			РезультатЗаписи = ЭтаФорма.Записать(ПараметрыЗаписи);
			Если НЕ РезультатЗаписи = Истина Тогда
				ВсеХорошо = Ложь;
				Сообщить("Не удалось записать текущий документ");
				Возврат;
			КонецЕсли;
			Если не объект.Проведен Тогда
				ВсеХорошо = Ложь;
				Сообщить("Не удалось провести текущий документ");
				Возврат;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Если НЕ ВсеХорошо Тогда
		Возврат;
	КонецЕсли; 
	
	
	ТекстВопроса = СтрШаблон("Будут созданы прогнозы платежей для %1 строк. Продолжить?", МассивСтрок.Количество());	
	
	Ответ = Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНет);
	
	Если  Ответ = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли;
	
	Для каждого СтрокаТЧ Из МассивСтрок Цикл
		
		Результат = СоздатьДокументПрогнозПлатежаБНаСервере(СтрокаТЧ.УИДСтроки);
		
		Если Результат.ВсеХорошо Тогда
			//СтрокаТЧ.ДокументПланирования = ОбъектПрогнозПлатежей.Ссылка;
			СтрокаТЧ.ПакетнаяОбработка = Ложь;
		КонецЕсли;
		
		Для каждого Сообщение Из Результат.СписокСообщений Цикл
			Сообщить(Сообщение);
		КонецЦикла;
		
		УИДДляФокуса = СтрокаТЧ.УИДСтроки;
		
	КонецЦикла;
	
	
	// 3. Восстанавливаем фокус
	Если УИДДляФокуса <> Неопределено Тогда
		
		ВосстановитьФокусНаСтрокеГрафикПлатежейБ(УИДДляФокуса);
	КонецЕсли;	
	 
	
	
КонецПроцедуры

&НаКлиенте
Процедура СоздатьЗНРДСБ(Команда)
	
	ВсеХорошо = Истина;
	ПС = Символы.ПС;
	
	СтрокаТЧ = Элементы.нГрафикПлатежей.ТекущиеДанные; 
	
	Если СтрокаТЧ = Неопределено Тогда
		Возврат;
	КонецЕсли;  	
	
	//Если ЗначениеЗаполнено(СтрокаТЧ.ЗаявкаНаРасходованиеДС) Тогда
	//	Предупреждение("Заявка на расходование ДС для этой строки уже создана");
	//	//Открыть(СтрокаТЧ.ДокументПланирования.Ссылка);
	//	Возврат;
	//КонецЕсли;  
	
	Если НЕ ЗначениеЗаполнено(СтрокаТЧ.ДокументПланирования) Тогда
		Предупреждение("Для выбранной строки отсутствует Прогноз платежа");
		//Открыть(СтрокаТЧ.ДокументПланирования.Ссылка);
		Возврат;
	КонецЕсли; 
	
	Основание = СтрокаТЧ.ДокументПланирования;
	
	Если НЕ ПрогнозПлатежаУтвержден(Основание) Тогда
		Предупреждение("Прогноз платежа не утвержден");
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору) Тогда
		Предупреждение("Не заполнена ссылка на Дополнительные условия по договору");
		Возврат;
	КонецЕсли; 
	
	
	Если НЕ ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору.ПроектДоговора) Тогда
		Предупреждение("В доп. условиях по договору не заполнена ссылка на Проект договора");
		Возврат;
	КонецЕсли; 
	
	Если НЕ ЗначениеЗаполнено(Объект.ДопУсловияПоДоговору.ПроектДоговора.Инициатор) Тогда
		Предупреждение("В проекте договора не заполнен Инициатор");
		Возврат;
	КонецЕсли; 
	
	Если Модифицированность Тогда
		Ответ = Вопрос("Требуется запись документа. Продолжить?", РежимДиалогаВопрос.ДаНет);
		Если  Ответ = КодВозвратаДиалога.Нет Тогда
			Возврат;
		Иначе
			ПараметрыЗаписи = Новый Структура;
			ПараметрыЗаписи.Вставить("РежимЗаписи", РежимЗаписиДокумента.Проведение);
			РезультатЗаписи = ЭтаФорма.Записать(ПараметрыЗаписи);
			Если НЕ РезультатЗаписи = Истина Тогда
				ВсеХорошо = Ложь;
				Сообщить("Не удалось записать текущий документ");
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Если НЕ ВсеХорошо Тогда
		Возврат;
	КонецЕсли; 
	
	ТекстВопроса= СтрШаблон("Будет создана Заявка на расходование ДС для" + ПС + 
								ПС + 
								"строка %1," + ПС +
								"%2" + ПС + 
								"%3" + ПС +
								"сумма %4" + ПС + 
								ПС +
								"на основании %5" + ПС +
								ПС + 
								"Продолжить?",
								СтрокаТЧ.НомерСтрокиДляОтображения,
								Формат(СтрокаТЧ.Период, "ДФ=dd.MM.yyyy"),
								СтрокаТЧ.ЦФО,
								Формат(СтрокаТЧ.ДокументПланирования.Сумма, "ЧДЦ=2"),
								Основание
								);
	Ответ = Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНет);
	Если  Ответ = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли;
	
	ТекущийУИД = СтрокаТЧ.УИДСтроки;
	Результат = СоздатьЗНРДСБНаСервере(ТекущийУИД);

	Если Не Результат.ВсеХорошо Тогда
		Для каждого Сообщение Из Результат.СписокСообщений Цикл
			Сообщить(Сообщение);
		КонецЦикла;
		//Возврат;
	КонецЕсли;  
	
	// 3. Восстанавливаем фокус
	Если ТекущийУИД <> Неопределено Тогда
		ВосстановитьФокусНаСтрокеГрафикПлатежейБ(ТекущийУИД);
	КонецЕсли;	
	
    Если Результат.СсылкаНаЗНРДС <> Неопределено Тогда
		ВосстановитьФокусНаСтрокеДетализацииГрафикаПлатежейБ(Результат.СсылкаНаЗНРДС);	
	КонецЕсли; 
	
КонецПроцедуры

&НаСервере
Функция СоздатьЗНРДСБНаСервере(УИДСтроки)

	СтруктураРезультат = новый Структура;
	СписокСообщений = Новый СписокЗначений; 
	СсылкаНаЗНРДС = Неопределено;
	
	ВсеХорошо = Истина; 
	
	// 1. Всегда записываем (если модифицирован или новый)
	Если ВсеХорошо и Модифицированность ИЛИ Параметры.Ключ.Пустая() или НЕ Объект.Проведен Тогда
		Попытка
			ПараметрыЗаписи = Новый Структура;
			ПараметрыЗаписи.Вставить("РежимЗаписи", РежимЗаписиДокумента.Проведение);
			РезультатЗаписи = ЭтаФорма.Записать(ПараметрыЗаписи); 
			Если НЕ РезультатЗаписи Тогда
				ВсеХорошо = Ложь;
				СписокСообщений.Добавить("Не удалось записать и провести документ");
			КонецЕсли;			
		Исключение
			ВсеХорошо = Ложь;
			СписокСообщений.Добавить("Не удалось записать и провести текущий документ " + Символы.ПС + ОписаниеОшибки() );
		КонецПопытки;
	КонецЕсли;
	
	Если ВсеХорошо Тогда
		РезультатСоздания = _ДокументПрогнозированияМенеджер.СоздатьЗНРДСИзГрафикаПлатежей(
																							Объект.Ссылка, 
																							УИДСтроки
																							);
		
		ВсеХорошо 						= РезультатСоздания.ВсеХорошо;
		СсылкаНаЗНРДС				 	= РезультатСоздания.Результат;
		
		// НОВОЕ: Копируем сообщения
		Для Каждого Сообщение Из РезультатСоздания.СписокСообщений Цикл
			СписокСообщений.Добавить(Сообщение.Значение);
		КонецЦикла;
		
		//// НОВОЕ: Если создан - обновляем строку графика
		Если ВсеХорошо И СсылкаНаЗНРДС <> Неопределено Тогда
			Отбор = Новый Структура("УИДСтроки", УИДСтроки);
			Найденные = нГрафикПлатежей.НайтиСтроки(Отбор);
			Если Найденные.Количество() > 0 Тогда
				ДокументПланирования = Найденные[0].ДокументПланирования; 
			КонецЕсли;
		КонецЕсли;			
		Модифицированность = Истина;
		
		ЗагрузитьДетализациюГрафикаПлатежейНаСервере(ДокументПланирования);
			
	КонецЕсли;
	
	СтруктураРезультат.Вставить("ВсеХорошо", ВсеХорошо);
	СтруктураРезультат.Вставить("СписокСообщений", СписокСообщений); 
	СтруктураРезультат.Вставить("СсылкаНаЗНРДС", СсылкаНаЗНРДС); 
	
	Возврат СтруктураРезультат;
	
	
КонецФункции

&НаКлиенте
Процедура ВосстановитьФокусНаСтрокеДетализацииГрафикаПлатежейБ(ЗНРДС_Ссылка)
    
    // Ищем строку с этим УИД в обновленной таблице
    Для Каждого Строка Из нДетализацияГрафикаПлатежей Цикл
        Если Строка.ЗаявкаНаРасходованиеДС = ЗНРДС_Ссылка Тогда
            Элементы.нДетализацияГрафикаПлатежей.ТекущаяСтрока = Строка.ПолучитьИдентификатор();
            Прервать;
        КонецЕсли;
    КонецЦикла;
    
КонецПроцедуры 

&НаКлиенте
Процедура ОтобразитьПланФактБ(Команда)
	
	Если элементы.нГрафикПлатежейПрогноз.Видимость = Истина Тогда
		элементы.нГрафикПлатежейПрогноз.Видимость = Ложь;
		элементы.нГрафикПлатежейФакт.Видимость = Ложь;
	Иначе
		элементы.нГрафикПлатежейПрогноз.Видимость = Истина;
		элементы.нГрафикПлатежейФакт.Видимость = Истина;
	КонецЕсли;	
	
КонецПроцедуры

#КонецОбласти
